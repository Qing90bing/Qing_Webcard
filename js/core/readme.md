# 核心模块 (Core)

## 目录概述

`core` 目录是整个Web应用的心脏。这里存放着驱动应用启动、协调各模块以及管理全局状态的核心脚本。理解本目录下的文件是掌握整个应用工作流程的关键。

本目录下的脚本是应用最先加载和执行的，为所有其他组件的运行提供了基础和环境。

---

## 文件详解

### `main.js` - 应用总入口 (Application Entry Point)

#### 职责

`main.js` 是整个应用启动的指挥中心。它的核心职责是在网页的DOM（文档对象模型）完全加载后，按照一个精心设计的、正确的顺序，去导入并初始化应用的所有其他功能模块（如时钟、天气、背景、设置等）。

可以把它理解为项目的“总监”，它决定了谁先上场，谁后上场，以确保所有依赖关系都能被正确处理。

#### 启动流程

当浏览器解析完 `index.html` 并触发 `DOMContentLoaded` 事件后，`main.js` 会执行以下一系列关键步骤：

1.  **加载设置**: 首先调用 `settings.js` 中的 `loadSettings()` 函数，从浏览器缓存 (`localStorage`) 中读取用户上一次的配置。这是第一步，因为后续几乎所有模块的初始化都依赖于这些设置。
2.  **初始化核心UI与工具**: 初始化一些不依赖其他模块的基础功能，例如背景的交叉渐变效果器、全局工具提示 (`tooltip`) 等。
3.  **初始化提供接口的模块**: 初始化那些会返回实例或函数供其他模块使用的组件，例如时钟模块 (`clock.js`)，它初始化后会返回一个实例，以便其他模块可以调用它的方法（如更新时间格式）。
4.  **初始化所有其他模块**: 按需初始化应用的所有其余功能和UI模块，如问候语、时间胶囊、天气、主题、各项设置面板等。
5.  **应用视觉设置**: 根据第一步加载的配置，调用各模块的 "apply" 函数，将用户的个性化设置（如主题、背景、毛玻璃效果）应用到页面上，更新页面的外观。
6.  **更新设置界面**: 最后，调用更新函数，确保设置面板中的所有开关、滑块和选项都准确地反映出当前加载的配置状态。

#### > 给初学者的小贴士：什么是“依赖”？

在这个项目中，你会看到 `main.js` 中 `import` 语句的顺序和初始化的顺序是经过思考的。这就是在管理“依赖”。

举个例子：
`time-format-settings.js` (时间格式设置) 需要在用户更改设置后，立刻让时钟显示新的格式。这意味着它需要“依赖”时钟模块，并能调用时钟的更新方法。因此，在 `main.js` 中，必须先初始化时钟模块，得到它的实例，然后才能把这个实例传递给时间格式设置模块进行初始化。

`main.js` 的主要工作之一就是理清这些依赖关系，确保一切按部就班。

---

### `settings.js` - 全局设置中心 (Global Settings Hub)

#### 职责

`settings.js` 是应用的“记忆中枢”。它负责定义、管理、持久化（保存）和加载所有用户的个性化配置。任何需要被用户定制并且在下次访问时保持不变的选项，其“状态”都由这个文件统一管理。

#### 核心对象与函数

-   `appSettings` (导出的对象)
    -   这是一个用 `export let` 导出的JavaScript对象，它定义了应用所有设置的“默认值”。
    -   项目中的任何其他模块都可以 `import { appSettings } from './settings.js'` 来读取当前的设置值。
    -   例如，天气模块通过读取 `appSettings.weather.city` 来知道要查询哪个城市的天气。

-   `saveSettings()` (函数)
    -   当用户在设置面板中更改了任何选项后，对应的模块会更新 `appSettings` 对象中的值，然后调用此函数。
    -   它的作用是将 `appSettings` 这个JavaScript对象转换成一个JSON格式的字符串，并将其存储在浏览器的 `localStorage` 中。这样，即使用户关闭了浏览器，设置也能被保存下来。

-   `loadSettings()` (函数)
    -   这是在应用启动时（由 `main.js`）调用的第一个关键函数。
    -   它会尝试从 `localStorage` 中读取之前保存的JSON字符串。
    -   如果读取成功，它会将JSON字符串解析回JavaScript对象，并用它来覆盖 `appSettings` 中的默认值。

#### > 技术实现细节：如何保证更新后不出错？

`loadSettings()` 函数在合并加载的设置和默认设置时，使用了一种健壮的“深度合并”策略，这对于应用的后续更新至关重要。

**代码片段示例:**
```javascript
// 从 localStorage 加载的设置
const parsedSettings = JSON.parse(savedSettings);

// 深度合并
appSettings = {
    ...appSettings, // 先展开默认设置
    ...parsedSettings, // 然后用加载的设置覆盖
    // 对嵌套的对象再进行一次合并
    background: { ...appSettings.background, ...(parsedSettings.background || {}) },
    weather: { ...appSettings.weather, ...(parsedSettings.weather || {}) },
    // ... 其他嵌套对象
};
```

**这样做的好处是：**
假设在未来的新版本中，我们增加了一个新的设置项，比如 `appearance.fontSize`。
-   对于新用户，他们会使用包含 `fontSize` 的新版默认设置。
-   对于老用户，他们的 `localStorage` 中存的设置对象里没有 `fontSize` 这一项。如果没有深度合并，直接用老对象覆盖新对象，`fontSize` 就会丢失，可能导致bug。
-   通过上面的合并方式，`...appSettings` 会先提供一个包含默认 `fontSize` 的基础，然后 `...parsedSettings` 只会覆盖那些老用户已经设定过的项，新的 `fontSize` 设置得以保留其默认值。这保证了应用的**向前兼容性**。
