<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qing90bing的主页</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css" />
    <script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- CSS Variables and Theming --- */
        body.theme-dark {
            --immersive-bg-color: #111827;
            --bg-color: #0d1a26;
            --card-bg-color: rgba(30, 41, 59, 0.7);
            --card-border-color: rgba(255, 255, 255, 0.1);
            --card-hover-bg-color: rgba(30, 41, 59, 0.75);
            --card-hover-border-color: rgba(255, 255, 255, 0.2);
            --text-color-primary: #e5e7eb; /* gray-200 */
            --text-color-secondary: #9ca3af; /* gray-400 */
            --text-color-tertiary: #6b7280; /* gray-500 */
            --accent-color: #38bdf8; /* sky-400 */
            --accent-color-highlight: rgba(56, 189, 248, 0.15);
            --progress-bar-bg: rgba(255, 255, 255, 0.1);
            --link-color: #e5e7eb;
            --link-hover-color: #fff;
            --separator-color: rgba(255, 255, 255, 0.1);
            --status-past: #6b7280; /* gray-500 */
            --status-yesterday: #eab308; /* yellow-500 */
            --status-today: #22c55e; /* green-500 */
            --status-tomorrow: #60a5fa; /* blue-400 */
        }
        body.theme-light {
            --immersive-bg-color: #f9fafb;
            --bg-color: #f1f5f9; /* slate-100 */
            --card-bg-color: rgba(255, 255, 255, 0.7);
            --card-border-color: rgba(0, 0, 0, 0.08);
            --card-hover-bg-color: rgba(255, 255, 255, 0.75);
            --card-hover-border-color: rgba(0, 0, 0, 0.12);
            --text-color-primary: #1e293b; /* slate-800 */
            --text-color-secondary: #475569; /* slate-600 */
            --text-color-tertiary: #64748b; /* slate-500 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-color-highlight: rgba(59, 130, 246, 0.1);
            --progress-bar-bg: rgba(0, 0, 0, 0.08);
            --link-color: #1e293b;
            --link-hover-color: #000;
            --separator-color: rgba(0, 0, 0, 0.1);
            --status-past: #64748b; /* slate-500 */
            --status-yesterday: #ca8a04; /* yellow-600 */
            --status-today: #16a34a; /* green-600 */
            --status-tomorrow: #2563eb; /* blue-600 */
        }

        /* 自定义样式 */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* 防止出现双滚动条 */
        }
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            transition: color 0.3s ease;
        }

        /* 背景图片容器 */
        #bg-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .bg-layer.active {
            opacity: 1;
        }

        .glass-card {
            background: var(--card-bg-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid var(--card-border-color);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            background: var(--card-hover-bg-color);
            border: 1px solid var(--card-hover-border-color);
        }

        /* Override for settings window to disable hover effect */
        #settings-window.glass-card:hover {
            background: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
        }

        #time-display, .runtime-number, #countdown-display, #holiday-list-container, #time-capsule-card {
            font-variant-numeric: tabular-nums;
        }
        
        #time-display {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            text-shadow: 0 0 10px var(--accent-color);
        }

        .simplebar-scrollbar:before {
            background-color: var(--accent-color);
            border-radius: 4px;
        }
        .simplebar-track.simplebar-vertical {
            width: 8px;
        }

        /* [FIXED] Q弹动画 - 移除了opacity属性以修复背景透明问题 */
        @keyframes bounce-in {
            0% { transform: scale(0.95); }
            60% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .bounce-in {
            animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* 进度条样式 */
        .progress-bar {
            background-color: var(--progress-bar-bg);
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-inner {
            background-color: var(--accent-color);
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }
        
        /* 高亮最近的节日 */
        .highlight-holiday {
            background-color: var(--accent-color-highlight);
            border-left: 3px solid var(--accent-color);
        }

        #holiday-list-container {
            transition: opacity 0.1s ease-in-out;
        }
        #holiday-list-year {
            transition: opacity 0.1s ease-in-out, color 0.2s ease-in-out;
        }
        #holiday-list-year:hover {
            color: var(--accent-color);
        }

        #holiday-list-container-wrapper {
            --fade-top-size: 40px;
            --fade-bottom-size: 40px;
            -webkit-mask-image: linear-gradient(transparent, black var(--fade-top-size), black calc(100% - var(--fade-bottom-size)), transparent);
            mask-image: linear-gradient(transparent, black var(--fade-top-size), black calc(100% - var(--fade-bottom-size)), transparent);
        }

        /* [FIX] Suppress the browser's default focus outline on the scrollable area */
        #settings-window [data-simplebar]:focus {
            outline: none;
        }

        #settings-window [data-simplebar] {
            --fade-top-size: 24px;
            --fade-bottom-size: 24px;
            -webkit-mask-image: linear-gradient(transparent, black var(--fade-top-size), black calc(100% - var(--fade-bottom-size)), transparent);
            mask-image: linear-gradient(transparent, black var(--fade-top-size), black calc(100% - var(--fade-bottom-size)), transparent);
        }

        #back-to-today-btn {
            display: flex;
            border: 1px solid var(--card-border-color);
            background-color: var(--accent-color);
            opacity: 0;
            transform: scale(0.9);
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, visibility 0.2s, background-color 0.2s ease;
        }
        #back-to-today-btn:hover {
            opacity: 0.85 !important;
        }
        #back-to-today-btn.visible {
            opacity: 0.7;
            transform: scale(1);
            visibility: visible;
            pointer-events: auto;
        }

        #main-wrapper {
            height: 100vh;
            transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        
        /* --- Settings Modal States --- */
        #settings-overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0s linear 0.2s;
        }
        #settings-window {
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.15s ease-in-out;
            height: 680px; /* [FIX] Set a fixed height for consistency */
            max-height: 85vh; /* Add a responsive max-height for smaller viewports */
        }

        body.settings-open #main-wrapper {
            transform: scale(0.98);
            filter: blur(8px);
            opacity: 0;
            pointer-events: none;
        }
        body.settings-open #settings-overlay {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }
        body.settings-open #settings-window {
            transform: scale(1);
            opacity: 1;
        }

    /* --- [NEW] Immersive Time View --- */
    #immersive-time-view {
        position: fixed;
        inset: 0;
        z-index: 100; /* Higher than settings overlay */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: var(--immersive-bg-color);
        color: var(--text-color-primary);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out, background-color 0.3s ease;
    }

    #exit-immersive-btn {
        position: absolute;
        top: 2rem;  /* 32px */
        right: 2rem; /* 32px */
        width: 3rem;  /* 48px */
        height: 3rem; /* 48px */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        color: var(--text-color-secondary);
        background-color: transparent;
        cursor: pointer;
        border: none; /* remove default button border */
        opacity: 0;
        visibility: hidden;
        /* Combine transitions for a cleaner rule */
        transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out, opacity 0.3s ease-in-out, visibility 0s linear 0.3s;
    }
    #exit-immersive-btn.visible {
        opacity: 1;
        visibility: visible;
        transition-delay: 0s;
    }
    #exit-immersive-btn:hover {
        color: var(--text-color-primary);
        background-color: rgba(255, 255, 255, 0.1);
    }
    body.theme-light #exit-immersive-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    #exit-immersive-btn:active {
        transform: scale(0.95);
    }
    #exit-immersive-btn svg {
        width: 1.75rem; /* 28px */
        height: 1.75rem; /* 28px */
    }
    
    #immersive-date-display {
        font-size: 2.25rem; /* text-4xl */
        line-height: 2.5rem;
        color: var(--text-color-secondary);
        transition: color 0.3s ease;
    }
    #immersive-time-display {
        font-size: 8rem; /* text-9xl */
        line-height: 1;
        font-weight: 700;
        margin-top: 1rem;
        margin-bottom: 1rem;
        font-variant-numeric: tabular-nums;
        font-family: 'Inter', sans-serif;
        text-shadow: 0 0 20px var(--accent-color);
        transition: color 0.3s ease, text-shadow 0.3s ease;
    }
    #immersive-greeting {
        font-size: 1.875rem; /* text-3xl */
        line-height: 2.25rem;
        color: var(--text-color-secondary);
        transition: color 0.3s ease;
    }
    
    /* State when immersive view is active */
    body.immersive-active #main-wrapper {
        opacity: 0;
        filter: blur(4px);
        transform: scale(0.98);
        pointer-events: none;
        transition: opacity 0.3s ease-in-out, filter 0.3s ease-in-out, transform 0.3s ease-in-out;
    }
    body.immersive-active #immersive-time-view {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    @media (max-width: 1023px) {
        html, body {
            height: auto;
            overflow-y: auto;
        }
        #main-wrapper {
            height: auto;
        }
        #holiday-list-card {
            height: 50vh;
        }
    }

    /* Animations for Year Input */
    @keyframes fade-in-anim {
        from { opacity: 0; transform: scale(0.98); }
        to { opacity: 1; transform: scale(1); }
    }

    @keyframes fade-out-anim {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.98); }
    }

    .animate-fade-in {
        animation: fade-in-anim 0.1s ease-out forwards;
    }

    .animate-fade-out {
        animation: fade-out-anim 0.1s ease-in forwards;
    }
    
    /* Shake animation for error feedback */
    @keyframes shake-anim {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-3px); }
      40%, 60% { transform: translateX(3px); }
    }

    #year-input.invalid {
        border-color: #ef4444 !important; /* red-500, a consistent error color */
        animation: shake-anim 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    /* GitHub Chart Placeholder Styles */
    #gh-chart-container {
        position: relative;
    }
    #gh-chart-spinner {
        position: absolute;
        top: 0.75rem; /* 12px */
        right: 0.75rem; /* 12px */
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 10;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        opacity: 0;
        visibility: hidden;
    }
    #gh-chart-spinner.visible {
        opacity: 1;
        visibility: visible;
    }
    #gh-chart-wrapper {
        aspect-ratio: 892 / 140;
        border-radius: 0.375rem; /* 6px */
        overflow: hidden;
    }


    #gh-chart-img.loaded {
        opacity: 1;
    }

    #gh-chart-link.visible {
        visibility: visible;
    }

    #gh-chart-error.visible {
        display: flex;
    }

    /* --- [NEW] Preview Loader and Animations --- */
    #preview-loader {
        position: absolute;
        top: 0.75rem; /* 12px */
        right: 0.75rem; /* 12px */
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 10;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        opacity: 0;
        visibility: hidden;
    }
    #preview-loader.visible {
        opacity: 1;
        visibility: visible;
    }

    /* --- [NEW] Weather Loader --- */
    #weather-content-wrapper {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .weather-icon-initial {
        opacity: 0;
    }
    .weather-icon-loaded {
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }
    #weather-loader {
        position: absolute;
        top: 0.75rem; /* 12px */
        right: 0.75rem; /* 12px */
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 10;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        opacity: 0;
        visibility: hidden;
    }
    #weather-loader.visible {
        opacity: 1;
        visibility: visible;
    }
    #weather-data-container {
        transition: opacity 0.3s ease-in-out;
    }

    .weather-hover-zone:hover + #weather-refresh-btn,
    #weather-refresh-btn:hover {
        opacity: 1;
        visibility: visible;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @keyframes breathing {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .breathing-effect {
        animation: breathing 2s ease-in-out infinite;
    }
    
    /* Utility to hide elements cleanly */
    .hidden {
      display: none !important;
    }

    /* --- Settings UI Styles --- */
    #background-preview-container {
        transition: max-height 0.35s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.3s ease-in-out;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
    }
    #background-preview-container.visible {
        max-height: 400px;
        opacity: 1;
        margin-top: 0.75rem;
    }
    #bg-preview-wrapper {
        border: 1px solid var(--card-border-color);
    }

    #bg-preview-wrapper.visible {
        max-height: 200px;
        opacity: 1;
    }
    #bg-preview-img {
        transition: opacity 0.3s ease-in-out;
        background-color: var(--progress-bar-bg); /* [FIX] Add placeholder background */
    }

    #bg-preview-download-btn.visible {
        transform: scale(1) !important;
    }

    #bg-preview-download-btn:hover {
        transform: scale(1.1) !important;
    }

    #bg-preview-refresh-btn.visible {
        transform: scale(1) !important;
    }

    #bg-preview-refresh-btn:hover {
        transform: scale(1.1) !important;
    }

    #bg-preview-download-btn:active,
    #bg-preview-refresh-btn:active {
        transform: scale(1) !important;
        transition: transform 0.1s;
    }

    .setting-section {
        border-top: 1px solid var(--separator-color);
        padding-top: 1.5rem;
    }
    .setting-section:first-child {
        border-top: none;
        padding-top: 0;
    }
    .setting-radio-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out;
        border: 1px solid transparent;
    }
    .setting-radio-label:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    .setting-radio-input {
        display: none; /* Hide original radio button */
    }
    .setting-radio-input:checked + .setting-radio-label {
        background-color: rgba(56, 189, 248, 0.15);
        border-color: rgba(56, 189, 248, 0.5);
    }
    .custom-radio-button {
        width: 1.25em;
        height: 1.25em;
        border: 2px solid #9ca3af; /* gray-400 */
        border-radius: 50%;
        /* margin-right is replaced by parent gap */
        display: flex;
        align-items: center;
        justify-content: center;
        transition: border-color 0.2s;
        flex-shrink: 0;
    }
    .setting-radio-input:checked + .setting-radio-label .custom-radio-button {
        border-color: #38bdf8; /* sky-500 */
    }
    .custom-radio-button::after {
        content: '';
        width: 0.75em;
        height: 0.75em;
        background-color: #38bdf8; /* sky-500 */
        border-radius: 50%;
        transform: scale(0);
        transition: transform 0.15s ease-in-out;
    }
    .setting-radio-input:checked + .setting-radio-label .custom-radio-button::after {
        transform: scale(1);
    }
    .setting-description {
        font-size: 0.8rem;
        color: var(--text-color-secondary);
        line-height: 1.3;
        transition: color 0.2s ease-in-out;
    }
    .setting-radio-input:checked + .setting-radio-label .setting-description {
        color: var(--text-color-primary);
    }
    .setting-description.text-center {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    #default-bg-options {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-in-out, padding-top 0.3s ease;
        opacity: 0;
        padding-left: 0.5rem; /* Symmetrical padding */
        padding-right: 0.5rem; /* Symmetrical padding */
    }
    #default-bg-options.open {
        max-height: 300px; /* Adjust as needed */
        opacity: 1;
        padding-top: 0.75rem;
        padding-bottom: 0.5rem; /* Add space for hover effect */
    }
    .thumb-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.75rem;
        justify-content: center;
    }
    .thumb-item {
        aspect-ratio: 16 / 9;
        border-radius: 0.5rem; /* Softer corners */
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s, transform 0.2s;
        position: relative;
        background-color: rgba(255, 255, 255, 0.05);
    }
    .thumb-item:hover {
        transform: scale(1.05);
    }
    .thumb-item:active {
        transform: scale(0.98);
    }
    .thumb-item.active {
        border-color: #38bdf8; /* sky-500 */
    }
    .thumb-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .thumb-item .thumb-overlay {
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.875rem;
    }

    .theme-swatch {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        cursor: pointer;
        padding: 4px;
        border: 2px solid transparent;
        transition: border-color 0.2s, transform 0.2s;
    }
    .theme-swatch:hover {
        transform: scale(1.1);
    }
    .theme-swatch.active {
        border-color: var(--accent-color);
        transform: scale(1.1);
    }
    .swatch-color {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    body.theme-light .swatch-color {
        border-color: rgba(0, 0, 0, 0.2);
    }

    .setting-btn-group {
        display: flex;
        border-radius: 0.8rem;
        background-color: var(--progress-bar-bg);
    }
    .theme-slider {
        background-color: var(--accent-color);
        
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        /* The magic bounce transition */
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .setting-btn {
        flex-grow: 1;
        padding: 0.5rem 0.5rem;
        background-color: transparent;
        color: var(--text-color-secondary);
        border: none;
        cursor: pointer;
        transition: color 0.2s ease-in-out;
        font-size: 0.875rem;
        font-weight: 500; /* Make all text slightly bolder */
    }
    /* No border needed for the new design */
    .setting-btn:not(:last-child) {
       border-right: none;
    }
    .setting-btn.active {
        color: white;
    }
    .setting-btn:hover:not(.active) {
        color: var(--text-color-primary);
    }

    .progress-bar-text {
        color: var(--text-color-primary);
        text-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    body.theme-light .progress-bar-text {
        /* In light mode, the primary text is dark, so a light shadow is better for contrast against the accent-colored bar */
        text-shadow: 0 0 4px rgba(255,255,255,0.5);
    }
    
    /* --- Toggle Switch --- */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--text-color-tertiary);
        transition: .3s;
        border-radius: 28px;
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-radius: 50%;
    }
    input:checked + .toggle-slider {
        background-color: var(--accent-color);
    }
    input:focus + .toggle-slider {
        box-shadow: 0 0 1px var(--accent-color);
    }
    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    /* --- [NEW] Manual City Input Styles --- */
    #weather-city-input {
        transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        appearance: none;
        -webkit-appearance: none; /* Removes inner shadow on iOS */
        padding-right: 2.5rem; /* Make space for the icon */
    }
    #weather-city-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px var(--accent-color-highlight);
    }
    #weather-city-input.invalid {
        border-color: #ef4444 !important; /* red-500 */
        animation: shake-anim 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    #save-city-btn, #confirm-city-icon {
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, color 0.2s ease-in-out;
    }
    #city-input-error {
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        transform: translateY(-4px);
        opacity: 0;
    }
    #city-input-error.visible {
        transform: translateY(0);
        opacity: 1;
    }

    /* --- [NEW] Hitokoto Settings Styles --- */
    #hitokoto-custom-options {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-in-out, padding-top 0.3s ease, margin-top 0.3s ease;
        opacity: 0;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    #hitokoto-custom-options.open {
        max-height: 500px; /* Adjust as needed */
        opacity: 1;
        padding-top: 0.75rem;
        margin-top: 0.5rem;
    }
    .hitokoto-checkbox-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.75rem;
    }
    .hitokoto-checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.3rem 0.5rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease-in-out;
    }
    .hitokoto-checkbox-label:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    .hitokoto-checkbox-label.invalid {
        animation: shake-anim 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    #hitokoto-validation-msg {
        color: #ef4444; /* red-500 */
        font-weight: 500;
        font-size: 0.875rem;
        opacity: 0; /* Initially hidden */
    }
    #hitokoto-validation-msg.visible {
        animation: fade-in-out 3s ease-in-out forwards;
    }
    @keyframes fade-in-out {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
    }
    .custom-checkbox {
        width: 1.15em;
        height: 1.15em;
        border: 2px solid #9ca3af;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: border-color 0.2s, background-color 0.2s;
    }
    .custom-checkbox svg {
        width: 0.8em;
        height: 0.8em;
        color: white;
        transform: scale(0);
        transition: transform 0.15s ease-in-out;
    }
    .hitokoto-checkbox-input:checked + .hitokoto-checkbox-label .custom-checkbox {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
    }
    .hitokoto-checkbox-input:checked + .hitokoto-checkbox-label .custom-checkbox svg {
        transform: scale(1);
    }
    #hitokoto-save-btn {
        color: var(--text-color-secondary);
        transition: color 0.2s, transform 0.2s;
        font-weight: 500;
    }
    #hitokoto-save-btn:hover {
        color: var(--text-color-primary);
    }
    #hitokoto-save-btn:active {
        transform: scale(0.97);
    }
    </style>
</head>
<body>
    <div id="bg-wrapper">
        <div class="bg-layer"></div>
        <div class="bg-layer"></div>
    </div>
    <div id="main-wrapper">
        <div class="flex items-center justify-center min-h-screen px-8 sm:px-16 lg:px-24">
            <main class="grid grid-cols-1 lg:grid-cols-4 gap-5 w-full max-w-6xl">

                <div class="lg:col-span-1 space-y-5 flex flex-col">
                    <div class="glass-card flex items-center justify-center p-5 gap-4">
                        <h1 class="text-3xl font-bold" style="color: var(--text-color-primary);">Qing90bing</h1>
                    </div>

                    <div id="countdown-card" class="glass-card p-5 cursor-pointer flex flex-col h-48">
                        <h2 class="text-xl font-semibold mb-3 text-center flex-shrink-0" style="color: var(--text-color-primary);">日历倒计时</h2>
                        <div id="countdown-display" class="text-center text-lg leading-relaxed flex-col justify-center items-center" style="color: var(--accent-color);">正在计算...</div>
                    </div>
                    
                    <div id="profile-card" class="glass-card p-5 flex flex-col justify-between flex-grow cursor-pointer">
                        <div class="relative px-4 py-2">
                            <span class="absolute top-0 left-0 text-6xl font-serif -translate-y-4 -translate-x-2 select-none" style="color: var(--separator-color);">“</span>
                            <p class="text-lg" style="color: var(--text-color-primary);">Hello, World!</p>
                            <p class="mt-1" style="color: var(--text-color-secondary);">一个建立于21世纪的小站，存活于互联网的边缘</p>
                            <span class="absolute bottom-0 right-0 text-6xl font-serif translate-y-6 translate-x-2 select-none" style="color: var(--separator-color);">”</span>
                        </div>
                        <div class="mt-8">
                            <p class="text-sm " style="color: var(--text-color-secondary);">与我联系:</p>
                            <div class="flex items-center gap-2">
                                <a href="https://github.com/Qing90bing" target="_blank" title="GitHub" class="p-2 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                    <i class="fa-brands fa-github fa-xl"></i>
                                </a>
                                <a href="mailto:1879495519@qq.com" target="_blank" title="Email" class="p-2 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                    <i class="fa-solid fa-envelope fa-xl"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="right-column" class="lg:col-span-3 space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div id="time-card" class="glass-card p-5 flex flex-col justify-center items-center cursor-pointer">
                            <div id="date-display" class="text-lg" style="color: var(--text-color-secondary);"></div>
                            <div id="time-display" class="text-6xl my-1" style="color: var(--text-color-primary);"></div>
                            <div id="greeting" class="text-sm" style="color: var(--text-color-secondary);"></div>
                        </div>
                        <div id="hitokoto-card" class="glass-card p-5 flex flex-col justify-center cursor-pointer min-h-[120px] md:min-h-full">
                            <p id="hitokoto-text" class="text-center transition-opacity duration-500 ease-in-out" style="color: var(--text-color-primary);">正在加载一言...</p>
                            <p id="hitokoto-from" class="text-right text-sm mt-2 transition-opacity duration-500 ease-in-out" style="color: var(--text-color-secondary);"></p>
                        </div>
                    </div>
                    
                    <div class="glass-card p-5">
                        <div id="main-card-view-wrapper">
                            <!-- GitHub View -->
                            <div id="github-view">
                                <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color-primary);">
                                   <svg class="inline-block w-6 h-6 mr-2 -mt-1" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                                   GitHub 贡献图
                                </h2>
                                <div id="gh-chart-container" class="w-full rounded-md p-2 min-h-[140px] flex items-center justify-center" style="background-color: var(--progress-bar-bg);">
                                    <div id="gh-chart-spinner"></div>
                                    <div id="gh-chart-wrapper" class="relative">
                                        <div id="gh-chart-error" class="absolute inset-0 hidden flex-col items-center justify-center cursor-pointer rounded-md transition-all hover:bg-white/10">
                                            <svg class="w-8 h-8" style="color: var(--text-color-tertiary);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.695v-2.286c0-1.033-.842-1.875-1.875-1.875H10.5a1.875 1.875 0 00-1.875 1.875v2.286m7.5 0l-3.181 3.183m0 0L12 21.354l-3.181-3.183m0 0l-3.181-3.183"></path></svg>
                                            <p id="gh-chart-error-message" class="mt-2 text-sm" style="color: var(--text-color-secondary);">加载贡献图失败，点击重试</p>
                                        </div>
                                        <a href="https://github.com/Qing90bing" target="_blank" id="gh-chart-link" class="invisible">
                                            <img id="gh-chart-img" data-src="https://ghchart.rshah.org/Qing90bing?theme=dark" alt="Qing90bing's GitHub Contribution Graph" class="w-full h-full block opacity-0 transition-opacity duration-500"/>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <!-- Weather View -->
                            <div id="weather-view" class="hidden">
                                 <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color-primary);"><svg class="inline-block w-6 h-6 mr-2 -mt-1" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Pro v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2025 Fonticons, Inc.--><path d="M32 400C32 479.5 96.5 544 176 544L480 544C550.7 544 608 486.7 608 416C608 364.4 577.5 319.9 533.5 299.7C540.2 286.6 544 271.7 544 256C544 203 501 160 448 160C430.3 160 413.8 164.8 399.6 173.1C375.5 127.3 327.4 96 272 96C192.5 96 128 160.5 128 240C128 248 128.7 255.9 129.9 263.5C73 282.7 32 336.6 32 400z"/></svg>天气信息</h2>
                                 <div id="weather-content-wrapper" class="w-full rounded-md p-4 relative min-h-[140px]" style="background-color: var(--progress-bar-bg);">
                                    <div class="weather-hover-zone absolute top-0 left-0 w-1/2 h-full z-10"></div>
                                    <button id="weather-refresh-btn" title="手动刷新" class="absolute top-3 left-3 w-8 h-8 flex items-center justify-center rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-200 active:scale-90 z-20 opacity-0 invisible"><i class="fas fa-sync-alt"></i></button>
                                    <div id="weather-loader"></div>
                                    <div id="weather-data-container">
                                        <!-- Weather content will be injected here -->
                                        <p style="color: var(--text-color-secondary);">正在加载天气...</p>
                                    </div>
                                 </div>
                            </div>
                        </div>

                        <h2 class="text-xl font-semibold mb-4 mt-4" style="color: var(--text-color-primary);">
                            <svg class="inline-block w-6 h-6 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                            网站列表
                        </h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                            <a href="https://qing90bing.github.io/QingNoteblog/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 active:scale-95 transform-gpu" style="color: var(--text-color-primary);">
                                <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span class="font-medium">博客</span>
                            </a>
                            <a href="https://qing90bing.github.io/Qing_Music/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 active:scale-95 transform-gpu" style="color: var(--text-color-primary);">
                                <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3"></path></svg>
                                <span class="font-medium">音乐</span>
                            </a>
                            <a href="https://qing90bing.github.io/Qing_Start/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 active:scale-95 transform-gpu" style="color: var(--text-color-primary);">
                                <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                <span class="font-medium">起始页</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Holiday List Card -->
                <div id="holiday-list-card" class="lg:col-span-3 glass-card p-5 hidden flex flex-col">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold" style="color: var(--text-color-primary);"><svg fill="currentColor" class="inline-block w-6 h-6 mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128 0c17.7 0 32 14.3 32 32V64H288V32c0-17.7 14.3-32 32-32s32 14.3 32 32V64h48c26.5 0 48 21.5 48 48v48H0V112C0 85.5 21.5 64 48 64H96V32c0-17.7 14.3-32 32-32zM0 192H448V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V192zm64 80v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16zm128 0v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H208c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H336zM64 400v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H208zm112 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H336c-8.8 0-16 7.2-16 16z"/></svg>节日倒数列表</h2>
                        <div class="flex items-center gap-3">
                            <button id="back-to-today-btn" title="回到今天" class="w-8 h-8 rounded-full transition-all active:scale-95 flex-shrink-0 flex items-center justify-center font-bold text-white text-base">今</button>
                            <button id="close-holiday-list" title="关闭" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-center items-center h-8 relative">
                        <!-- Display Mode -->
                        <div id="year-display-controls" class="flex items-center gap-4 text-lg">
                            <button id="prev-year" title="上一年" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <span id="holiday-list-year" class="font-bold w-16 text-center cursor-pointer" style="color: var(--text-color-primary);"></span>
                            <button id="next-year" title="下一年" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <!-- Edit Mode -->
                        <div id="year-edit-controls" class="hidden flex items-center gap-2 text-lg">
                            <input type="text" id="year-input" class="font-bold w-20 text-center rounded-md border focus:ring-0 px-1 py-0.5 text-lg" style="background-color: var(--card-bg-color); color: var(--text-color-primary); border-color: var(--separator-color); outline: none;">
                            <button id="confirm-year-btn" title="确认" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--status-today);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                            <button id="cancel-year-btn" title="取消" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: #ef4444;">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <!-- Error Message for input validation -->
                        <div id="year-input-error" class="hidden absolute -bottom-6 text-sm font-bold" style="color: #ef4444;"></div>
                    </div>
                    <div class="relative flex-1 min-h-0">
                        <!-- Warning is now absolutely positioned inside this container -->
                        <div id="year-range-warning" class="absolute top-0 left-0 right-0 z-10 hidden flex items-center justify-center text-amber-400 text-sm font-semibold"></div>
                        <div id="holiday-list-container-wrapper" class="absolute inset-0">
                           <div id="holiday-list-container" class="space-y-4">
                               <!-- Holiday list will be dynamically inserted here -->
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Time Capsule Card -->
                <div id="time-capsule-card" class="lg:col-span-3 glass-card p-5 hidden flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold" style="color: var(--text-color-primary);"><svg fill="currentColor" class="inline-block w-6 h-6 mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M0 32C0 14.3 14.3 0 32 0H64 320h32c17.7 0 32 14.3 32 32s-14.3 32-32 32V75c0 42.4-16.9 83.1-46.9 113.1L237.3 256l67.9 67.9c30 30 46.9 70.7 46.9 113.1v11c17.7 0 32 14.3 32 32s-14.3 32-32 32H320 64 32c-17.7 0-32-14.3-32-32s14.3-32 32-32V437c0-42.4 16.9-83.1 46.9-113.1L146.7 256 78.9 188.1C48.9 158.1 32 117.4 32 75V64C14.3 64 0 49.7 0 32zM96 64V75c0 25.5 10.1 49.9 28.1 67.9L192 210.7l67.9-67.9c18-18 28.1-42.4 28.1-67.9V64H96zm0 384H288V437c0-25.5-10.1-49.9-28.1-67.9L192 301.3l-67.9 67.9c-18 18-28.1 42.4-28.1 67.9v11z"/></svg>时光胶囊</h2>
                        <div class="flex items-center gap-4">
                            <button id="open-settings-btn" title="设置" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <i class="fas fa-gear fa-lg w-6 h-6 flex items-center justify-center"></i>
                            </button>
                            <button id="close-time-capsule" title="关闭" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-5">
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>今日已过 <span id="day-passed">0</span> 小时</span>
                                <span>剩余 <span id="day-left">24</span> 小时</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="day-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="day-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>本周已过 <span id="week-passed">0</span> 天</span>
                                <span>剩余 <span id="week-left">7</span> 天</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="week-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="week-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>本月已过 <span id="month-passed">0</span> 天</span>
                                <span>剩余 <span id="month-left">30</span> 天</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="month-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="month-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>今年已过 <span id="year-passed">0</span> 天</span>
                                <span>剩余 <span id="year-left">365</span> 天</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="year-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="year-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center" style="color: var(--text-color-secondary);">
                        <p id="site-runtime-display">正在计算...</p>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4" style="z-index: 50;">
        <div id="settings-window" class="glass-card w-full max-w-2xl p-5 flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center ">
                <h2 class="text-xl font-semibold flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></svg>设置</h2>
                <button id="close-settings-btn" title="关闭" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--text-color-secondary);">
                    <i class="fas fa-times fa-lg w-6 h-6 flex items-center justify-center"></i>
                </button>
            </div>
            <!-- Content -->
            <div class="flex-grow flex-1 min-h-0" data-simplebar>
                <div class="space-y-6 p-3">
                    <!-- 1. Background Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 96C0 60.7 28.7 32 64 32l384 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6l96 0 32 0 208 0c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/></svg>背景来源</h3>
                        <div id="background-settings-content">
                            <!-- Background options will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- 2. Theme Color Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-2 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M512 256c0 .9 0 1.8 0 2.7c-.4 36.5-33.6 61.3-70.1 61.3H344c-26.5 0-48 21.5-48 48c0 3.4 .4 6.7 1 9.9c2.1 10.2 6.5 20 10.8 29.9c6.1 13.8 12.1 27.5 12.1 42c0 31.8-21.6 60.7-53.4 62c-3.5 .1-7 .2-10.6 .2C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm0-96a32 32 0 1 0 0-64 32 32 0 1 0 0 64zM288 96a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm96 96a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/></svg>主题模式</h3>
                        <div id="theme-settings-content" class="flex flex-wrap">
                            <!-- Theme color swatches will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- NEW: Time Format Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm57.1 350.1L224.9 294c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h48c6.6 0 12 5.4 12 12v137.7l63.5 46.2c5.4 3.9 6.5 11.4 2.6 16.8l-28.2 38.8c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>时间格式</h3>
                        <div id="time-format-settings-content">
                            <!-- Time format options will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- 3. GitHub/Weather Toggle -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 60.7 28.7 32 64 32l320 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zm64 64l0 256 128 0 0-256-128 0zm320 0l-128 0 0 256 128 0 0-256z"/></svg>主卡片视图</h3>
                        <div id="view-toggle-content">
                            <!-- The toggle switch for GitHub/Weather will be inserted here -->
                        </div>
                    </div>

                    <!-- 4. Hitokoto Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" width="1024pt" height="1024pt" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" opacity="1.00" d=" M 504.63 19.74 C 510.94 18.73 517.82 18.56 523.72 21.44 C 536.31 27.78 548.23 35.34 560.39 42.45 C 566.80 45.20 572.36 49.45 578.55 52.60 C 584.51 56.73 591.37 59.35 597.14 63.79 C 601.84 66.40 606.91 68.37 611.18 71.72 C 627.90 81.47 645.09 90.40 661.68 100.34 C 668.72 105.16 676.65 108.48 683.78 113.16 C 688.90 116.60 694.41 119.37 699.76 122.40 C 707.70 127.57 716.15 131.88 724.27 136.77 C 732.78 141.10 740.57 146.67 749.04 151.07 C 756.21 155.28 763.14 159.89 770.71 163.38 C 776.68 166.09 781.58 170.66 787.70 173.08 C 791.89 174.65 794.89 178.27 799.11 179.77 C 804.53 181.55 808.92 185.32 813.91 187.94 C 818.23 190.26 822.52 192.65 826.53 195.49 C 832.90 199.17 839.32 202.77 845.68 206.47 C 852.70 211.25 860.40 214.92 867.59 219.42 C 874.68 224.69 882.87 228.11 890.40 232.67 C 897.91 235.86 904.15 241.26 911.61 244.55 C 917.72 248.14 923.69 252.00 930.12 255.03 C 935.28 257.19 938.63 262.13 940.96 267.01 C 942.24 271.59 943.57 276.21 944.18 280.94 C 944.26 431.29 944.10 581.65 944.23 732.00 C 944.13 737.44 944.80 742.99 943.42 748.33 C 942.44 751.91 942.19 755.81 940.03 758.95 C 937.64 762.46 934.82 765.84 931.07 767.94 C 920.48 774.50 909.12 779.70 898.72 786.57 C 890.72 790.92 882.75 795.35 874.85 799.87 C 869.36 803.85 863.17 806.69 857.61 810.54 C 854.92 812.33 851.70 813.13 849.08 815.03 C 846.93 816.53 844.91 818.23 842.59 819.47 C 832.35 824.33 822.96 830.74 812.94 836.01 C 801.05 843.11 788.51 849.06 776.91 856.65 C 769.03 860.59 761.78 865.65 754.08 869.94 C 739.78 877.87 725.59 885.99 711.61 894.48 C 708.34 896.25 704.75 897.45 701.86 899.86 C 699.10 902.06 695.86 903.46 692.65 904.83 C 688.48 906.60 685.38 910.10 681.33 912.08 C 670.31 917.47 660.26 924.56 649.48 930.38 C 643.83 934.24 637.53 936.95 631.71 940.53 C 626.08 943.64 620.74 947.29 614.85 949.91 C 610.05 951.96 606.12 955.56 601.28 957.54 C 596.76 959.36 593.39 963.08 588.99 965.11 C 580.47 969.18 572.80 974.73 564.71 979.56 C 556.94 983.30 549.59 987.83 542.07 992.05 C 536.38 996.03 530.02 998.87 523.81 1001.94 C 518.07 1004.76 511.45 1004.98 505.25 1003.93 C 499.73 1002.72 495.39 998.87 490.20 996.86 C 486.33 995.41 483.33 992.49 479.74 990.55 C 468.16 985.03 457.90 977.20 446.53 971.30 C 441.06 967.24 434.36 965.26 429.12 960.88 C 425.09 957.54 419.86 956.29 415.61 953.32 C 412.16 950.89 408.09 949.60 404.52 947.40 C 397.04 942.71 389.18 938.67 381.43 934.45 C 369.93 927.19 357.86 920.89 346.39 913.58 C 339.98 910.56 334.46 905.99 328.01 903.05 C 325.14 901.73 322.60 899.85 319.94 898.17 C 308.01 891.87 296.51 884.75 284.71 878.20 C 278.94 874.10 272.26 871.55 266.58 867.34 C 252.94 859.73 239.24 852.21 225.88 844.13 C 218.87 840.98 212.55 836.57 205.69 833.13 C 197.13 829.06 190.03 822.53 181.33 818.72 C 174.65 814.12 167.13 811.08 160.44 806.52 C 143.76 796.83 126.98 787.32 110.23 777.77 C 104.25 773.91 97.89 770.67 91.67 767.24 C 87.36 764.18 83.44 759.98 81.91 754.82 C 81.24 751.22 80.03 747.71 79.77 744.05 C 79.65 590.03 79.87 436.00 79.67 281.97 C 79.68 277.75 80.96 273.69 81.93 269.62 C 82.99 264.88 86.37 261.06 89.99 258.01 C 97.18 252.74 105.30 248.93 112.81 244.15 C 119.81 241.38 125.54 236.33 132.38 233.26 C 136.79 231.25 140.47 227.97 144.93 226.08 C 152.89 222.78 159.44 217.05 166.99 213.00 C 171.95 210.42 176.75 207.55 181.46 204.54 C 195.78 197.08 209.09 187.85 223.45 180.48 C 227.28 178.96 230.60 176.51 234.08 174.37 C 247.28 167.79 259.72 159.87 272.39 152.36 C 290.80 142.16 308.90 131.43 327.19 121.06 C 332.12 118.93 336.40 115.67 341.08 113.10 C 349.62 108.55 357.67 103.17 365.81 97.96 C 377.22 92.30 387.72 84.98 399.14 79.34 C 405.93 75.36 413.08 72.06 419.71 67.79 C 426.37 65.18 431.45 59.92 438.00 57.09 C 454.35 46.85 471.63 38.18 487.98 27.94 C 493.46 25.08 498.64 21.52 504.63 19.74 M 339.46 301.66 C 339.21 305.49 339.82 309.28 340.27 313.07 C 340.71 323.05 341.67 332.99 342.32 342.95 C 342.36 442.30 342.29 541.65 342.36 641.00 C 342.11 654.95 344.63 669.22 351.25 681.62 C 354.62 687.98 359.64 693.29 365.00 698.04 C 376.73 707.89 391.54 713.33 406.47 715.99 C 417.29 717.76 428.04 720.23 439.04 720.46 C 444.07 720.49 449.04 721.43 454.07 721.48 C 459.09 721.49 463.92 723.24 468.95 723.25 C 483.53 723.19 498.12 723.80 512.69 723.26 C 522.15 721.83 531.73 722.96 541.23 722.24 C 553.79 720.76 566.49 722.17 579.05 720.65 C 589.61 720.27 600.18 719.64 610.69 718.47 C 626.03 717.55 641.33 716.22 656.65 715.11 C 666.15 713.71 675.81 713.85 685.27 712.12 C 685.77 703.76 685.32 695.37 685.46 687.00 C 685.33 674.84 685.76 662.66 685.31 650.51 C 678.79 650.46 672.54 652.62 666.13 653.50 C 645.86 657.50 625.33 659.82 604.82 662.17 C 589.15 662.95 573.58 665.20 557.89 665.73 C 546.61 666.92 535.23 665.88 523.98 667.41 C 506.99 667.57 489.99 667.61 473.00 667.33 C 464.46 666.41 455.85 666.51 447.37 665.06 C 433.64 663.59 418.97 661.90 407.61 653.30 C 400.44 647.99 398.88 638.34 398.39 630.02 C 398.34 592.92 398.25 555.83 398.40 518.74 C 403.72 515.84 409.85 515.14 415.58 513.40 C 433.87 508.37 452.11 503.16 470.40 498.12 C 531.66 480.08 592.55 460.35 651.31 435.19 C 658.43 432.13 665.83 429.59 672.57 425.71 C 667.79 412.38 661.56 399.62 656.42 386.42 C 654.40 381.52 652.55 376.43 649.08 372.34 C 641.43 376.06 634.28 380.70 626.63 384.43 C 617.13 388.86 608.07 394.20 598.31 398.08 C 585.88 403.01 573.61 408.40 560.89 412.59 C 512.03 430.12 462.40 445.43 412.30 458.96 C 407.47 460.19 402.75 461.94 397.78 462.48 C 397.41 428.66 397.71 394.83 397.60 361.00 C 397.75 352.98 397.19 344.91 398.32 336.94 C 398.99 325.17 400.06 313.44 401.43 301.74 C 393.63 301.24 385.80 301.63 377.99 301.51 C 365.15 301.62 352.30 301.32 339.46 301.66 Z" /></svg>一言</h3>
                        <div id="hitokoto-settings-content">
                            <!-- Hitokoto settings will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- [NEW] Immersive Time View -->
    <div id="immersive-time-view">
        <button id="exit-immersive-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                <path fill="currentColor" d="M384 128L448 128L448 544C448 561.7 462.3 576 480 576L512 576C529.7 576 544 561.7 544 544C544 526.3 529.7 512 512 512L512 128C512 92.7 483.3 64 448 64L352 64L352 64L192 64C156.7 64 128 92.7 128 128L128 512C110.3 512 96 526.3 96 544C96 561.7 110.3 576 128 576L352 576C369.7 576 384 561.7 384 544L384 128zM256 320C256 302.3 270.3 288 288 288C305.7 288 320 302.3 320 320C320 337.7 305.7 352 288 352C270.3 352 256 337.7 256 320z"/>
            </svg>
        </button>
        <div class="flex flex-col items-center justify-center text-center">
            <div id="immersive-date-display"></div>
            <div id="immersive-time-display"></div>
            <div id="immersive-greeting"></div>
        </div>
    </div>
    
    <script>
        // --- 初始状态和常量 ---
        const DEFAULT_BG_IMAGES = [
            'https://s21.ax1x.com/2025/08/10/pVdEmM6.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEnsK.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEuqO.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEQde.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEMZD.jpg'
        ];
        const lunarInfo = [0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2, 0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977, 0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970, 0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950, 0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557, 0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0, 0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0, 0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6, 0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570, 0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0, 0x0c960, 0xd954, 0x0d4a0, 0xda50, 0x07552, 0x056a0, 0xabb7, 0x025d0, 0x092d0, 0x0cab5, 0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930, 0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530, 0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45, 0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0];
        const solarTerm = ["小寒", "大寒", "立春", "雨水", "惊蛰", "春分", "清明", "谷雨", "立夏", "小满", "芒种", "夏至", "小暑", "大暑", "立秋", "处暑", "白露", "秋分", "寒露", "霜降", "立冬", "小雪", "大雪", "冬至"];
        const sTermInfo = [0, 21208, 42467, 63836, 85337, 107014, 128867, 150921, 173149, 195551, 218072, 240693, 263343, 285989, 308563, 331033, 353350, 375494, 397447, 419210, 440795, 462224, 483532, 504758];
        const sFtv = [
            { date: "0101", name: "元旦", start: 1949 },
            { date: "0110", name: "警察节", start: 2021 },
            { date: "0214", name: "情人节" },
            { date: "0308", name: "妇女节", start: 1949 },
            { date: "0312", name: "植树节", start: 1979 },
            { date: "0315", name: "消费者日", start: 1983 },
            { date: "0401", name: "愚人节" },
            { date: "0501", name: "劳动节", start: 1949 },
            { date: "0504", name: "青年节", start: 1949 },
            { date: "0512", name: "护士节", start: 1912 },
            { date: "0601", name: "儿童节", start: 1949 },
            { date: "0701", name: "建党节", start: 1921 },
            { date: "0801", name: "建军节", start: 1927 },
            { date: "0815", name: "日本投降日", start: 1945 },
            { date: "0903", name: "抗战胜利纪念日", start: 1945 },
            { date: "0910", name: "教师节", start: 1985 },
            { date: "0918", name: "九一八事变", start: 1931 },
            { date: "1001", name: "国庆节", start: 1949 },
            { date: "1213", name: "国家公祭日", start: 2014 },
            { date: "1224", name: "平安夜" },
            { date: "1225", name: "圣诞节" },
        ];
        const lFtv = [
            { date: "0101", name: "春节" },
            { date: "0115", name: "元宵节" },
            { date: "0202", name: "龙抬头" },
            { date: "0505", name: "端午节" },
            { date: "0707", name: "七夕" },
            { date: "0715", name: "中元节" },
            { date: "0815", name: "中秋节" },
            { date: "0909", name: "重阳节" },
            { date: "1208", name: "腊八节" },
            { date: "1223", name: "北方小年" },
            { date: "1224", name: "南方小年" },
        ];
        let holidayListDisplayedYear = new Date().getFullYear();
        let hasManuallyScrolled = false;
        let holidayListSimpleBar; // Instance for the holiday list scrollbar
        let settingsSimpleBar = null; // Instance for the settings scrollbar
        let isFetchingWeather = false; // Lock to prevent multiple weather requests

        // --- [NEW] Reusable Cross-fade Logic ---
        function createCrossfader(layers) {
            let activeIndex = 0;

            // Return an update function that handles the cross-fade
            const update = (newUrl, isBackgroundImage = false) => {
                return new Promise((resolve, reject) => {
                    const nextIndex = (activeIndex + 1) % 2;
                    const activeLayer = layers[activeIndex];
                    const nextLayer = layers[nextIndex];

                    if (!nextLayer || !activeLayer) {
                        return reject('Cross-fade layers not found.');
                    }

                    const preloader = new Image();
                    preloader.src = newUrl;

                    preloader.onload = () => {
                        // Apply the new image to the hidden layer
                        if (isBackgroundImage) {
                            nextLayer.style.backgroundImage = `url('${newUrl}')`;
                        } else {
                            nextLayer.src = newUrl;
                        }

                        // Trigger the cross-fade
                        activeLayer.classList.remove('active');
                        nextLayer.classList.add('active');
                        
                        // Update the active index for the next cycle
                        activeIndex = nextIndex;
                        resolve(); // Transition has started
                    };

                    preloader.onerror = () => {
                        console.error(`Crossfader failed to load image: ${newUrl}`);
                        reject('Image load error');
                    };
                });
            };
            
            return { update };
        }

        let backgroundFader;
        // previewFader is no longer needed

        let latestBgRequestId = 0;
        let latestPreviewRequestId = 0;

        // --- DOM 元素获取 (部分移至DOMContentLoaded) ---
        const countdownCard = document.getElementById('countdown-card');
        const profileCard = document.getElementById('profile-card');
        const rightColumn = document.getElementById('right-column');
        const timeCapsuleCard = document.getElementById('time-capsule-card');
        const holidayListCard = document.getElementById('holiday-list-card');
        let rightColumnInitialHeight = 0;
        let cachedRightColumnHeight = 0; // Cache the height of the right column

        // --- [NEW] Year Input Feature Elements ---
        const yearDisplayControls = document.getElementById('year-display-controls');
        const yearEditControls = document.getElementById('year-edit-controls');
        const holidayListYearSpan = document.getElementById('holiday-list-year');
        const yearInput = document.getElementById('year-input');
        const confirmYearBtn = document.getElementById('confirm-year-btn');
        const cancelYearBtn = document.getElementById('cancel-year-btn');
        const yearInputError = document.getElementById('year-input-error');
        const yearRangeWarning = document.getElementById('year-range-warning');
        
        // --- 动态时钟功能 ---
        function updateTime() {
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            const now = new Date();

            if (appSettings.timeFormat === '12h') {
                timeDisplay.classList.add('flex', 'items-baseline', 'justify-center');
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                const strHours = String(hours).padStart(2, '0');
                // Use a smaller gap and font-bold for the AM/PM
                timeDisplay.innerHTML = `<span>${strHours}:${minutes}:${seconds}</span><span class="text-3xl font-bold ml-2">${ampm}</span>`;
            } else { // 24h format
                // Ensure flex classes are removed and content is cleared for 24h mode
                timeDisplay.classList.remove('flex', 'items-baseline', 'justify-center');
                timeDisplay.innerHTML = ''; // Clear old content first
                timeDisplay.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            }

            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            dateDisplay.textContent = `${now.getFullYear()}年${String(now.getMonth() + 1).padStart(2, '0')}月${String(now.getDate()).padStart(2, '0')}日 ${weekdays[now.getDay()]}`;
        }

        // --- 问候语功能 ---
        function updateGreeting() {
            const greetingEl = document.getElementById('greeting');
            const now = new Date();
            const hour = now.getHours();
            const month = now.getMonth() + 1; // getMonth() 返回 0-11, +1 变为 1-12

            // 定义问候语库
            const greetings = {
                spring: { // 春季 (3-5月)
                    morning: [
                        "早上好，春意盎然，愿你的一天如诗如画。🌿",
                        "清晨的露水，伴着花香，道一声早安。🌸",
                        "春日黎明，万物复苏，今天也要活力满满！",
                        "早安，愿春风为你吹来一天的好运。🍃",
                        "听，窗外是不是有鸟儿在歌唱？早安！🐦",
                        "新的一天，从一个清新的春日早晨开始。",
                        "一年之计在于春，一日之计在于晨，加油！",
                        "拉开窗帘，让第一缕春光拥抱你。☀️"
                    ],
                    afternoon: [
                        "下午好，春日暖阳，适合小憩片刻。☀️",
                        "午后时光，泡杯花茶，享受春日的悠闲吧。🍵",
                        "愿你心情如春日午后的阳光，明媚不忧伤。",
                        "春天到，别春困，起来活动一下筋骨吧！",
                        "天气这么好，不去公园散散步吗？",
                        "午后的阳光，暖得让人想打瞌睡。😴",
                        "泡一壶龙井，静品春日的午后时光。",
                        "春雷阵阵，说不定会有一场春雨，记得带伞。"
                    ],
                    evening: [
                        "晚上好，春风拂面，一天的疲惫都消散了。🎑",
                        "夜幕降临，静享春夜的温柔与宁静。",
                        "春夜的星空格外明朗，祝你晚安好梦。✨",
                        "在温柔的春夜里，和世界道一句晚安。",
                        "春天的晚霞总是格外温柔，晚上好。",
                        "忙碌了一天，是时候享受一顿美味的晚餐了。🍲",
                        "晚风轻轻，吹来青草和泥土的芬芳。",
                        "今晚月色真美，风也温柔，祝你愉快。"
                    ],
                    night: [
                        "夜深了，春夜微凉，记得盖好被子。🌙",
                        "晚安，愿你在梦里与最美的春天相遇。",
                        "放下手机，闭上眼睛，聆听春虫的鸣叫。😴",
                        "夜阑人静，祝你安眠，明日又是崭新的一天。",
                        "春夜宁静，宜读一本闲书，安然入睡。",
                        "把今天份的开心打包，睡个好觉吧。",
                        "晚安，愿你的梦里繁花似锦。🌸",
                        "夜了，全世界都睡了，你也要早点休息。"
                    ]
                },
                summer: { // 夏季 (6-8月)
                    morning: [
                        "早上好，夏日清晨，阳光正好，微风不燥。☀️",
                        "早安！今天也是元气满满的一天，别怕热！",
                        "夏日的清晨，是西瓜味的，是冰汽水味的。🍉",
                        "蝉鸣声声，唤醒了夏天的早晨，早安！",
                        "早安！今天的太阳也很热情呢！",
                        "赶在热浪来临前，享受清晨的片刻凉爽吧。",
                        "又是被阳光叫醒的一天，你好呀！🌞",
                        "新的一天，像加了冰块的汽水，充满活力！"
                    ],
                    afternoon: [
                        "下午好，夏日炎炎，记得多喝水防暑哦。💧",
                        "午后困倦，来根冰棍提提神吧！🍦",
                        "心静自然凉，愿你拥有一个清爽的下午。",
                        "夏日午后，宜开空调，宜听音乐，宜想你。😉",
                        "热到融化的下午，你还好吗？",
                        "“哪儿凉快哪儿待着去”绝对是夏天最真诚的祝福。",
                        "可能会有雷阵雨，出门记得带伞哦。⛈️",
                        "这个钟点，唯有空调和西瓜不可辜负。🍉"
                    ],
                    evening: [
                        "晚上好，夏夜晚风，吹散白天的燥热。🎐",
                        "提着一瓶汽水，坐在台阶上，感受夏天的晚风。",
                        "属于夏天的夜晚，是烧烤、小龙虾和冰啤酒。🍻",
                        "晚风轻踩着云朵，月亮在贩售快乐，晚安！",
                        "晚风吹走了热气，带来了夏夜的惬意。",
                        "又到了可以去夜市逛吃逛吃的季节！",
                        "小时候的夏夜，是蒲扇、凉席和满天繁星。✨",
                        "晚上好，去散散步吧，说不定能看到萤火虫。"
                    ],
                    night: [
                        "夜深了，晚安，愿你的梦里有凉爽的夏风。🌌",
                        "仲夏夜之梦，愿你拥抱整片星空。✨",
                        "关掉空调，可能会热；不关，可能会感冒。你看着办吧！",
                        "晚安，月亮警察已就位，请安心入睡。👮",
                        "嘘，静下心来，听听窗外的虫鸣。",
                        "晚安，空调调到26度刚刚好哦。😉",
                        "别熬夜了，你的皮肤和头发都需要休息。",
                        "祝你做个凉爽的梦，梦里没有蚊子。🦟"
                    ]
                },
                autumn: { // 秋季 (9-11月)
                    morning: [
                        "早上好，秋高气爽，天朗气清，又是美好的一天。🍁",
                        "早安，空气中有了秋天的味道，深呼吸一下吧。",
                        "秋日的晨光，温柔地洒在每一片落叶上，早安。",
                        "天凉了，记得多穿件衣服，别感冒了哦。🧥",
                        "秋日的天空，蓝得像一块画布，早安。",
                        "早晨的空气微凉，记得添一件薄外套。",
                        "秋天，是一个让一切都沉静下来的季节，早。",
                        "又是被梦想叫醒的一天，加油，打工人！"
                    ],
                    afternoon: [
                        "下午好，秋日的午后，阳光温暖得刚刚好。☕️",
                        "捧一杯热茶，读一本好书，享受秋日的静谧。",
                        "秋天是收获的季节，愿你的努力都有回报。",
                        "午安，愿秋风带走你的烦恼和疲惫。🍂",
                        "秋日的午后，每一帧都像电影画面。🎬",
                        "阳光正好，温度也正好，一切都刚刚好。",
                        "来块烤红薯或是糖炒栗子怎么样？🌰",
                        "下午犯困的话，就看看窗外的蓝天白云吧。"
                    ],
                    evening: [
                        "晚上好，秋风送爽，月色宜人。🌕",
                        "丹桂飘香的夜晚，适合思念和团圆。",
                        "秋天的夜晚，是思念的季节，也是养膘的季节。",
                        "晚来秋，天凉如水，早点休息吧。",
                        "晚上好，今天你看到美丽的落日了吗？",
                        "秋天的夜晚，总让人感觉格外宁静和舒适。",
                        "天气转凉，晚餐要吃得暖暖和和的。",
                        "月亮挂在枝头，像一颗熟透的果子。晚安。"
                    ],
                    night: [
                        "夜深了，秋意渐浓，晚安好梦。🌙",
                        "愿你伴着窗外的桂花香，甜甜地进入梦乡。",
                        "天阶夜色凉如水，卧看牵牛织女星。晚安。",
                        "被子要盖厚一点了，夜里会降温的。😴",
                        "夜深了，把心事放一边，好好睡觉最重要。",
                        "最舒服的事，莫过于在微凉的秋夜里盖着柔软的被子。",
                        "晚安，愿你梦里有金色的麦田和果实。",
                        "明天会更好，快睡吧。"
                    ]
                },
                winter: { // 冬季 (12-2月)
                    morning: [
                        "早上好，虽然天气寒冷，但也要拥抱阳光哦。❄️",
                        "早安，冬天最幸福的事，就是醒来时窗外有阳光。",
                        "起床大作战开始了！祝你成功！💪",
                        "冬日清晨，来一杯热饮，温暖一整天。☕️",
                        "早安！今天你和你的床分离成功了吗？",
                        "窗户上结了霜花，冬天真的来啦。❄️",
                        "吃一顿热气腾腾的早餐，是对冬天早晨最大的尊重。",
                        "呼一口气都是白色的，这才是冬天的感觉。"
                    ],
                    afternoon: [
                        "下午好，晒晒冬日的太阳，整个人都暖洋洋的。",
                        "泡个热水脚，是对冬天下午最好的尊重。",
                        "天气这么冷，不如…吃顿火锅？🍲",
                        "午安，愿这个冬天，有人与你立黄昏，有人问你粥可温。",
                        "冬日的午后短暂又珍贵，多晒晒太阳吧。",
                        "一杯热可可，一份好心情，送给这个下午的你。☕️",
                        "外面天寒地冻，还是待在室内最舒服了。",
                        "离天黑又近了一步，珍惜白天的时光。"
                    ],
                    evening: [
                        "晚上好，窗外天寒地冻，屋内温暖如春。",
                        "冬天最适合窝在沙发里，看一部温暖的电影。🎬",
                        "雪落下的声音，是冬夜的交响曲。",
                        "晚来天欲雪，能饮一杯无？",
                        "晚上好，回家路上注意保暖呀。",
                        "冬夜的灯火，看起来总是格外温暖。",
                        "忙了一天，窝在沙发里就是最大的幸福。",
                        "天冷了，今晚吃点热乎的吧！"
                    ],
                    night: [
                        "夜深了，钻进温暖的被窝，和世界说晚安。🛌",
                        "晚安，愿你一夜无梦，安睡到天亮。",
                        "冬天，是适合早睡的季节，晚安。",
                        "请查收你的冬日限定好梦。🌙",
                        "晚安，让温暖的被窝治愈你的一切。",
                        "听着窗外的风声，安稳地睡吧。",
                        "别熬夜了，对得起这么冷的天吗？快去睡觉！",
                        "晚安，愿你梦里阳光普照，春暖花开。"
                    ]
                },
                default: [ // 默认/备用问候语
                    "你好呀，今天过得怎么样？",
                    "愿你眼里的星星，永远闪亮。",
                    "无论天气如何，记得带上自己的阳光。",
                    "希望你今天也能开心！",
                    "嘿，陌生人，祝你今天开心。",
                    "生活或许不易，但请别忘了微笑。😊",
                    "每一天都是一份独一无二的礼物。",
                    "偷偷告诉你，你很棒！",
                    "愿你所到之处，皆为热土；愿你所遇之人，皆为良善。"
                ]
            };

            // 判断季节
            let season = 'default';
            if (month >= 3 && month <= 5) {
                season = 'spring';
            } else if (month >= 6 && month <= 8) {
                season = 'summer';
            } else if (month >= 9 && month <= 11) {
                season = 'autumn';
            } else { // 12, 1, 2月
                season = 'winter';
            }

            // 判断时间段
            let timeOfDay = 'night';
            if (hour >= 5 && hour < 12) {
                timeOfDay = 'morning';
            } else if (hour >= 12 && hour < 18) {
                timeOfDay = 'afternoon';
            } else if (hour >= 18 && hour < 22) {
                timeOfDay = 'evening';
            }

            // 获取对应的问候语列表
            const availableGreetings = greetings[season][timeOfDay] || greetings.default;
            
            // 随机选择一条问候语并显示
            const randomGreeting = availableGreetings[Math.floor(Math.random() * availableGreetings.length)];
            greetingEl.textContent = randomGreeting;
        }

        // --- [REFACTORED] 日历计算核心函数 ---
        function lYearDays(y) { let i, sum = 348; for (i = 0x8000; i > 0x8; i >>= 1) sum += (lunarInfo[y - 1900] & i) ? 1 : 0; return (sum + leapDays(y)); }
        function leapDays(y) { if (leapMonth(y)) return ((lunarInfo[y - 1900] & 0x10000) ? 30 : 29); else return (0); }
        function leapMonth(y) { return (lunarInfo[y - 1900] & 0xf); }
        function monthDays(y, m) { return ((lunarInfo[y - 1900] & (0x10000 >> m)) ? 30 : 29); }
        function Dianaday(objDate) {
            const msPerDay = 86400000; // 24 * 60 * 60 * 1000
            const utcTarget = Date.UTC(objDate.getFullYear(), objDate.getMonth(), objDate.getDate());
            const utcBase = Date.UTC(1900, 0, 31);
            var offset = (utcTarget - utcBase) / msPerDay;

            var i, leap = 0, temp = 0;
            this.dayCyl = offset + 40; this.monCyl = 14; for (i = 1900; i < 2050 && offset > 0; i++) { temp = lYearDays(i); offset -= temp; this.monCyl += 12; } if (offset < 0) { offset += temp; i--; this.monCyl -= 12; } this.year = i; this.yearCyl = i - 1864; leap = leapMonth(i); this.isLeap = false; for (i = 1; i < 13 && offset > 0; i++) { if (leap > 0 && i == (leap + 1) && this.isLeap == false) { --i; this.isLeap = true; temp = leapDays(this.year); } else { temp = monthDays(this.year, i); } if (this.isLeap == true && i == (leap + 1)) this.isLeap = false; offset -= temp; if (this.isLeap == false) this.monCyl++; } if (offset == 0 && leap > 0 && i == leap + 1) if (this.isLeap) { this.isLeap = false; } else { this.isLeap = true; --i; --this.monCyl; } if (offset < 0) { offset += temp; --i; --this.monCyl; } this.month = i; this.day = offset + 1;
        }
        
        // --- [NEW] 三伏天特定日期 ---
        // 由于三伏天计算复杂且与底层日历数据强相关，为保证准确性，此处使用预先查定的日期
        // 数据来源：公开的天文日历信息
        const sanfuData = {
            2023: { rufu: '07-11', zhongfu: '07-21', mofu: '08-10' },
            2024: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2025: { rufu: '07-20', zhongfu: '07-30', mofu: '08-09' },
            2026: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2027: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2028: { rufu: '07-19', zhongfu: '07-29', mofu: '08-08' },
            2029: { rufu: '07-14', zhongfu: '07-24', mofu: '08-13' },
            2030: { rufu: '07-19', zhongfu: '07-29', mofu: '08-08' },
        };

        function getSanfuDates(year) {
            const dates = sanfuData[year];
            if (!dates) return [];
            
            const rufuDateParts = dates.rufu.split('-');
            const zhongfuDateParts = dates.zhongfu.split('-');
            const mofuDateParts = dates.mofu.split('-');

            return [
                { name: '入伏', date: new Date(year, parseInt(rufuDateParts[0]) - 1, parseInt(rufuDateParts[1])) },
                { name: '中伏', date: new Date(year, parseInt(zhongfuDateParts[0]) - 1, parseInt(zhongfuDateParts[1])) },
                { name: '末伏', date: new Date(year, parseInt(mofuDateParts[0]) - 1, parseInt(mofuDateParts[1])) }
            ];
        }
        
        function getAllHolidaysForYear(year) {
            let allEvents = [];
            
            function getSolarDateForLunar(targetYear, lunarMonth, lunarDay) {
                for (let i = 0; i < 366; i++) {
                    const checkDate = new Date(targetYear, 0, 1);
                    checkDate.setDate(checkDate.getDate() + i);
                    if (checkDate.getFullYear() !== targetYear) break;
                    const lunarDateInfo = new Dianaday(checkDate);
                    if (lunarDateInfo.month === lunarMonth && lunarDateInfo.day === lunarDay && !lunarDateInfo.isLeap) return checkDate;
                }
                return null;
            }

            // 公历节日
            sFtv.forEach(holiday => {
                if (holiday.start && year < holiday.start) {
                    return;
                }
                const month = parseInt(holiday.date.substr(0, 2));
                const day = parseInt(holiday.date.substr(2, 2));
                allEvents.push({ name: holiday.name, date: new Date(year, month - 1, day) });
            });

            // 农历节日
            const allLunarHolidays = [...lFtv, { date: "1230", name: "除夕" }];
            allLunarHolidays.forEach(holiday => {
                const name = holiday.name;
                if (name === '除夕') {
                    // To find the New Year's Eve that falls within a given Gregorian year, we find the
                    // Spring Festival of that same year and calculate the day before it.
                    const cnyDate = getSolarDateForLunar(year, 1, 1);
                    if (cnyDate) {
                        let eveDate = new Date(cnyDate);
                        eveDate.setDate(eveDate.getDate() - 1);
                        // Only add it if the calculated Eve date actually falls in the target year.
                        if (eveDate.getFullYear() === year) {
                            allEvents.push({ name: '除夕', date: eveDate });
                        }
                    }
                } else {
                    const lMonth = parseInt(holiday.date.substr(0, 2));
                    const lDay = parseInt(holiday.date.substr(2, 2));
                    const holidayDate = getSolarDateForLunar(year, lMonth, lDay);
                    if (holidayDate) allEvents.push({ name: holiday.name, date: holidayDate });
                }
            });

            // 节气
            solarTerm.forEach((termName, i) => {
                const offDate = new Date((31556925974.7 * (year - 1900) + sTermInfo[i] * 60000) + Date.UTC(1900, 0, 6, 2, 5));
                allEvents.push({ name: termName, date: new Date(offDate.getUTCFullYear(), offDate.getUTCMonth(), offDate.getUTCDate()) });
            });

            // 周日计算的节日
            const mayFirst = new Date(year, 4, 1);
            const mothersDay = new Date(year, 4, 1 + (7 - mayFirst.getDay() + 7) % 7 + 7);
            allEvents.push({ name: '母亲节', date: mothersDay });

            const juneFirst = new Date(year, 5, 1);
            const fathersDay = new Date(year, 5, 1 + (7 - juneFirst.getDay() + 7) % 7 + 14);
            allEvents.push({ name: '父亲节', date: fathersDay });

            const novFirst = new Date(year, 10, 1);
            const thanksgivingDay = new Date(year, 10, 1 + (4 - novFirst.getDay() + 7) % 7 + 21);
            allEvents.push({ name: '感恩节', date: thanksgivingDay });
            
            // 添加三伏天
            const sanfuDates = getSanfuDates(year);
            allEvents.push(...sanfuDates);

            // 排序并返回
            return allEvents.sort((a, b) => a.date - b.date);
        }

        // --- 主倒计时卡片更新 ---
        function updateCountdown() {
            const countdownDisplay = document.getElementById('countdown-display');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const currentYearEvents = getAllHolidaysForYear(now.getFullYear());
            const nextYearEvents = getAllHolidaysForYear(now.getFullYear() + 1);

            const upcomingEvents = [...currentYearEvents, ...nextYearEvents].filter(event => event.date >= today);

            if (upcomingEvents.length > 0) {
                const nextHoliday = upcomingEvents[0];
                const diffTime = nextHoliday.date - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    countdownDisplay.innerHTML = `<span style="color: var(--text-color-primary);">距离</span><br><span class="text-2xl font-bold" style="color: var(--text-color-primary);">${nextHoliday.name}</span><br><strong class="text-4xl font-bold" style="color: var(--accent-color);">今天</strong>`;
                } else if (diffDays === 1) {
                    countdownDisplay.innerHTML = `<span style="color: var(--text-color-primary);">距离</span><br><span class="text-2xl font-bold" style="color: var(--text-color-primary);">${nextHoliday.name}</span><br><strong class="text-4xl font-bold" style="color: var(--accent-color);">明天</strong>`;
                } else {
                    countdownDisplay.innerHTML = `<span style="color: var(--text-color-primary);">距离</span><br><strong class="text-2xl" style="color: var(--text-color-primary);">${nextHoliday.name}</strong><br><span class="font-bold text-5xl align-baseline">${diffDays}</span><span class="text-lg align-baseline ml-1">天</span>`;
                }
            } else {
                countdownDisplay.textContent = '所有节日都已计算完毕！';
            }
        }

        // --- 节日列表视图更新 ---
        function displayHolidayList(year, isAnimated = false) {
            const container = document.getElementById('holiday-list-container');
            const yearDisplay = document.getElementById('holiday-list-year');

            const updateContent = () => {
                yearDisplay.textContent = year;
            
                const allHolidays = getAllHolidaysForYear(year);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                const firstUpcoming = [...getAllHolidaysForYear(now.getFullYear()), ...getAllHolidaysForYear(now.getFullYear() + 1)]
                    .filter(e => e.date >= today)[0];

                const holidaysByMonth = allHolidays.reduce((acc, holiday) => {
                    const month = holiday.date.getMonth();
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(holiday);
                    return acc;
                }, {});

                let html = '';
                for (let month = 0; month < 12; month++) {
                    if (holidaysByMonth[month]) {
                        html += `<div class="mb-3"><h3 class="text-lg font-semibold border-b pb-1 mb-2" style="color: var(--text-color-secondary); border-color: var(--separator-color);">${month + 1}月</h3>`;
                        holidaysByMonth[month].forEach(holiday => {
                            const diffTime = holiday.date - today;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            let statusText = '';
                            if (holiday.date.getFullYear() < now.getFullYear() || (holiday.date.getFullYear() === now.getFullYear() && diffDays < -1)) {
                                statusText = `<span style="color: var(--status-past);">已过</span>`;
                            } else if (diffDays === -1) {
                                statusText = `<span style="color: var(--status-yesterday);">昨天</span>`;
                            } else if (diffDays === 0) {
                                statusText = `<span style="color: var(--status-today); font-weight: bold;">今天</span>`;
                            } else if (diffDays === 1) {
                                statusText = `<span style="color: var(--status-tomorrow); font-weight: bold;">明天</span>`;
                            } else {
                                statusText = `<span style="color: var(--accent-color);">${diffDays} 天</span>`;
                            }
                            
                            const isHighlighted = firstUpcoming && firstUpcoming.name === holiday.name && firstUpcoming.date.getTime() === holiday.date.getTime();
                            const highlightClass = isHighlighted ? 'highlight-holiday' : '';

                            html += `
                                <div class="flex justify-between items-center p-2 rounded-lg ${highlightClass}">
                                    <div>
                                        <span style="color: var(--text-color-primary);">${holiday.name}</span>
                                        <span class="text-xs ml-2" style="color: var(--text-color-secondary);">${String(holiday.date.getMonth() + 1).padStart(2, '0')}-${String(holiday.date.getDate()).padStart(2, '0')}</span>
                                    </div>
                                    ${statusText}
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                }
                container.innerHTML = html;
                // [NEW] Update button visibility after content is rendered
                setTimeout(updateTodayButtonVisibility, 50);
            };

            if (isAnimated) {
                container.style.opacity = 0;
                yearDisplay.style.opacity = 0;
                setTimeout(() => {
                    updateContent();
                    container.style.opacity = 1;
                    yearDisplay.style.opacity = 1;
                }, 100);
            } else {
                updateContent();
            }
        }

        // [NEW] Custom smooth scroll implementation for speed control
        function customSmoothScrollTo(targetElement, options) {
            const { duration = 300, block = 'center' } = options;
            // SimpleBar creates a specific wrapper for the scrollable content.
            const scrollContainer = document.getElementById('holiday-list-container-wrapper').querySelector('.simplebar-content-wrapper');

            if (!scrollContainer || !targetElement) return;

            let targetY;
            if (block === 'center') {
                targetY = targetElement.offsetTop + (targetElement.offsetHeight / 2) - (scrollContainer.offsetHeight / 2);
            } else if (block === 'start') {
                targetY = targetElement.offsetTop;
            } else { // 'end'
                targetY = targetElement.offsetTop + targetElement.offsetHeight - scrollContainer.offsetHeight;
            }
            
            // Ensure targetY is within scrollable bounds
            targetY = Math.max(0, Math.min(targetY, scrollContainer.scrollHeight - scrollContainer.clientHeight));

            const startY = scrollContainer.scrollTop;
            const distance = targetY - startY;
            let startTime = null;

            // easeInOutCubic easing function for a slightly smoother start/end
            function ease(t, b, c, d) {
                t /= d / 2;
                if (t < 1) return c / 2 * t * t * t + b;
                t -= 2;
                return c / 2 * (t * t * t + 2) + b;
            }

            function animation(currentTime) {
                if (startTime === null) startTime = currentTime;
                const timeElapsed = currentTime - startTime;
                const run = ease(timeElapsed, startY, distance, duration);
                scrollContainer.scrollTop = run;
                if (timeElapsed < duration) {
                    requestAnimationFrame(animation);
                }
            }

            requestAnimationFrame(animation);
        }

        // [NEW] Core function to scroll to the target festival
        const scrollToTargetFestival = (isAnimated = true) => {
            // Use a timeout to ensure the DOM has updated, e.g., after a year change
            setTimeout(() => {
                const container = document.getElementById('holiday-list-container');
                if (!container) return;

                let targetElement = container.querySelector('.highlight-holiday');

                // If no highlighted holiday in the current view (e.g., all passed for the year)
                if (!targetElement) {
                    // As per user request, find the last festival of the displayed year
                    const allHolidays = container.querySelectorAll('.flex.justify-between.items-center');
                    if (allHolidays.length > 0) {
                        targetElement = allHolidays[allHolidays.length - 1];
                    }
                }

                if (targetElement) {
                    if (isAnimated) {
                        customSmoothScrollTo(targetElement, { duration: 300, block: 'center' });
                    } else {
                        targetElement.scrollIntoView({ behavior: 'auto', block: 'center' });
                    }
                }
            }, 160); // Must be slightly longer than the list update animation (150ms)
        };

        // [NEW] Logic for the "Today" button's visibility
        let todayButtonObserver;
        function updateTodayButtonVisibility() {
            const backToTodayBtn = document.getElementById('back-to-today-btn');
            const currentYear = new Date().getFullYear();

            if (todayButtonObserver) {
                todayButtonObserver.disconnect();
            }

            if (holidayListDisplayedYear !== currentYear) {
                backToTodayBtn.classList.add('visible'); // Always show for other years
                return;
            }

            // Logic for the current year
            const container = document.getElementById('holiday-list-container');
            let targetElement = container.querySelector('.highlight-holiday');

            if (!targetElement) {
                const allHolidays = container.querySelectorAll('.flex.justify-between.items-center');
                if (allHolidays.length > 0) {
                    targetElement = allHolidays[allHolidays.length - 1];
                }
            }

            if (targetElement) {
                const scrollWrapper = document.getElementById('holiday-list-container-wrapper');
                todayButtonObserver = new IntersectionObserver((entries) => {
                    const [entry] = entries;
                    // Show button if target is NOT visible
                    if (entry.isIntersecting) {
                        backToTodayBtn.classList.remove('visible');
                    } else {
                        backToTodayBtn.classList.add('visible');
                    }
                }, {
                    root: scrollWrapper,
                    threshold: 0.5 // 50% of the element is visible
                });
                todayButtonObserver.observe(targetElement);
            } else {
                // No target element found, hide the button
                backToTodayBtn.classList.remove('visible');
            }
        }

        // --- Hitokoto 一言 功能 ---
        let isUpdatingQuote = false;
        async function fetchHitokoto() {
            if (isUpdatingQuote) return;
            isUpdatingQuote = true;
            const hitokotoText = document.getElementById('hitokoto-text');
            const hitokotoFrom = document.getElementById('hitokoto-from');
            hitokotoText.classList.add('opacity-0');
            hitokotoFrom.classList.add('opacity-0');
            try {
                await new Promise(resolve => setTimeout(resolve, 500));

                let apiUrl = 'https://v1.hitokoto.cn/?encode=json';
                if (appSettings.hitokoto.mode === 'custom' && appSettings.hitokoto.categories.length > 0) {
                    const categoryParams = appSettings.hitokoto.categories.map(cat => `c=${cat}`).join('&');
                    apiUrl += `&${categoryParams}`;
                }

                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                hitokotoText.textContent = data.hitokoto;
                hitokotoFrom.textContent = `— 「${data.from || '未知来源'}」`;
            } catch (error) {
                console.error("获取一言失败:", error);
                hitokotoText.textContent = '获取一言失败，请稍后再试。';
                hitokotoFrom.textContent = '';
            } finally {
                hitokotoText.classList.remove('opacity-0');
                hitokotoFrom.classList.remove('opacity-0');
                setTimeout(() => { isUpdatingQuote = false; }, 600);
            }
        }

        // --- 时光胶囊功能 ---
        function updateTimeCapsule() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const dayOfMonth = now.getDate();
            const dayOfWeek = now.getDay(); // 0 for Sunday, 1 for Monday, etc.
            const hour = now.getHours();

            // 1. 今日进度
            const dayPassed = hour;
            const dayLeft = 24 - dayPassed;
            const dayPercent = (dayPassed / 24) * 100;
            document.getElementById('day-passed').textContent = dayPassed;
            document.getElementById('day-left').textContent = dayLeft;
            document.getElementById('day-percent').textContent = `${dayPercent.toFixed(1)}%`;
            document.getElementById('day-progress').style.width = `${dayPercent}%`;

            // 2. 本周进度 (周一为第一天)
            const weekPassed = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const weekLeft = 7 - weekPassed;
            const weekPercent = ((weekPassed + (hour / 24)) / 7) * 100;
            document.getElementById('week-passed').textContent = weekPassed;
            document.getElementById('week-left').textContent = weekLeft;
            document.getElementById('week-percent').textContent = `${weekPercent.toFixed(1)}%`;
            document.getElementById('week-progress').style.width = `${weekPercent}%`;

            // 3. 本月进度
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthPassed = dayOfMonth;
            const monthLeft = daysInMonth - monthPassed;
            const monthPercent = (monthPassed / daysInMonth) * 100;
            document.getElementById('month-passed').textContent = monthPassed;
            document.getElementById('month-left').textContent = monthLeft;
            document.getElementById('month-percent').textContent = `${monthPercent.toFixed(1)}%`;
            document.getElementById('month-progress').style.width = `${monthPercent}%`;

            // 4. 今年进度
            const startOfYear = new Date(year, 0, 1);
            const endOfYear = new Date(year, 11, 31);
            const totalDaysInYear = (endOfYear - startOfYear) / (1000 * 60 * 60 * 24) + 1;
            const yearPassed = Math.ceil((now - startOfYear) / (1000 * 60 * 60 * 24));
            const yearLeft = totalDaysInYear - yearPassed;
            const yearPercent = (yearPassed / totalDaysInYear) * 100;
            document.getElementById('year-passed').textContent = yearPassed;
            document.getElementById('year-left').textContent = yearLeft;
            document.getElementById('year-percent').textContent = `${yearPercent.toFixed(1)}%`;
            document.getElementById('year-progress').style.width = `${yearPercent}%`;
        }
        
        // --- 网站运行时间 ---
        function updateSiteRuntime() {
             const startTime = new Date('2025-07-30T18:30:00');
            const now = new Date();
            const diff = now - startTime;

            const displayElement = document.getElementById('site-runtime-display');
            if (!displayElement) return;

            if (diff < 0) {
                displayElement.textContent = '小破站尚未启航...';
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            displayElement.innerHTML = `小破站已经在风雨中度过了 <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${days}</span> 天 <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${hours}</span> 小时 <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${minutes}</span> 分 <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${seconds}</span> 秒`;
        }

        // --- GitHub Chart Loader Logic ---
        function setupGitHubChartLoader() {
            const spinner = document.getElementById('gh-chart-spinner');
            const errorContainer = document.getElementById('gh-chart-error');
            const errorMessage = document.getElementById('gh-chart-error-message');
            const imgLink = document.getElementById('gh-chart-link');
            const img = document.getElementById('gh-chart-img');

            const loadImage = () => {
                // Show new spinner, hide error
                spinner.classList.add('visible');
                errorContainer.classList.add('hidden');
                errorContainer.classList.remove('flex');

                const originalSrc = img.dataset.src;
                const baseUrl = originalSrc.split('?')[0];
                // Reconstruct URL to safely add cache-busting parameter
                img.src = `${baseUrl}?theme=dark&v=${new Date().getTime()}`;
            };

            img.onload = () => {
                spinner.classList.remove('visible');
                imgLink.classList.remove('invisible');
                imgLink.classList.add('visible');
                img.classList.add('loaded');
            };

            img.onerror = () => {
                spinner.classList.remove('visible');
                errorContainer.classList.remove('hidden');
                errorContainer.classList.add('flex');
                errorMessage.textContent = '贡献图加载失败，请检查网络并重试。';
            };

            errorContainer.addEventListener('click', () => {
                loadImage();
            });

            // Initial load
            loadImage();
        }


        // --- [NEW] Settings Management ---
        let appSettings = {
            background: {
                source: 'default',
                specifier: 'random'
            },
            theme: 'system', // 'system', 'light', 'dark'
            timeFormat: '24h', // '12h' or '24h'
            view: 'github', // 'github' or 'weather'
            weather: {
                source: 'auto', // 'auto' or 'manual'
                city: null, // User-overridden city
                lastFetchedCity: null // City from last successful fetch
            },
            hitokoto: {
                mode: 'default', // 'default' or 'custom'
                categories: ['a'] // Array of selected category codes
            }
        };

        const WEATHER_TIPS = {
            spring: {
                morning: {
                    clear: ["春日悠悠，阳光唤醒万物，也唤醒你。", "早上好，今天适合踏青，记得防晒哦。", "一年之计在于春，一日之计在于晨，加油！"],
                    cloudy: ["早安，云朵遮不住你的好心情。", "微风拂面，春意盎然，多云天也很舒服。", "泡一杯香茗，静待云散风清。"],
                    overcast: ["天空虽阴，但满是春天气息。", "阴天，宜静心思考，规划新的一周。", "记得带件薄外套，小心春寒料峭。"],
                    rain: ["春雨贵如油，早安。出门带伞，小心路滑。", "细雨蒙蒙，春天低语，宜窗边阅读。", "雨天微凉，注意保暖，热茶更惬意。"],
                    fog: ["雾气弥漫的清晨，仿佛置身仙境。", "大雾天气，出行请注意安全，减速慢行。", "雾散之后，便是清新的世界，请耐心等待。"],
                    windy: ["春风拂面，带来花草讯息。戴好帽子哦。", "风有点大，请关好门窗，防止杨絮飞入。", "在风中，感受春天的力量与活力。"],
                    default: ["早安，愿你的一天如春日般充满希望。"]
                },
                afternoon: {
                    clear: ["午后阳光正好，适合公园散步。", "春日暖阳，不妨小憩片刻，恢复精力。", "紫外线渐强，午后出门别忘防晒。"],
                    cloudy: ["多云午后，无烈日，宜户外活动。", "天空如画布，云朵是自由的画笔，下午好。", "喝杯下午茶，享受这份宁静的春日时光。"],
                    overcast: ["阴天午后，适合室内运动或看电影。", "天气微凉，一件针织衫会让你更舒适。", "虽然没有阳光，但心情要保持明媚哦。"],
                    rain: ["春雨绵绵，午后听雨别有风味。", "雨天路滑，外出请注意脚下安全。", "下雨天和巧克力更配哦！"],
                    fog: ["午后雾未散，视野受限，少外出。", "室内开窗通风时，注意雾中的湿气。", "一杯热咖啡，可以驱散雾气带来的沉闷。"],
                    windy: ["风和日丽，正是放风筝的好时节。", "春风得意，衣角飞扬，愿你心情轻快。", "风大的午后，皮肤容易干燥，记得保湿。"],
                    default: ["下午好，愿春风带走你的疲惫。"]
                },
                evening: {
                    clear: ["晴朗夜晚，星空璀璨，适合散步。", "春天的夜晚，微风和煦，月色温柔。", "忙碌了一天，享受这宁静的春夜吧。"],
                    cloudy: ["云遮月光，但城市灯火依然温暖。", "多云夜晚，宜朋友小聚或独自静享。", "晚安，愿你梦里有繁花和星辰。"],
                    overcast: ["阴沉夜晚，宜点灯读几页闲书。", "天气转凉，睡前记得关好窗户。", "今夜，让温暖的被窝治愈你一天的疲惫。"],
                    rain: ["听，窗外雨打芭蕉，是春夜的交响曲。", "雨夜，宜早睡，伴着雨声安然入梦。", "睡前喝杯温牛奶，驱散雨夜的湿冷。"],
                    fog: ["夜雾渐浓，早点回家，注意安全。", "雾中的城市，别有一番朦胧的美感。", "晚安，愿你的梦境清晰而美好。"],
                    windy: ["晚风轻拂，吹散一天的烦恼。", "风大的夜晚，可能会有些声响，不用担心。", "听着风声入睡，仿佛睡在自然的怀抱里。"],
                    default: ["晚安，愿你拥抱一个温柔的春夜。"]
                }
            },
            summer: {
                morning: {
                    clear: ["夏日炎炎，早安！出门记得防晒补水。", "阳光正好，微风不燥，是夏日最美的清晨。", "元气满满的一天，从冰美式开始！"],
                    cloudy: ["多云的早晨，躲避了烈日，享受片刻凉爽。", "早安，今天或有阵雨，出门请带伞。", "云层是天然的遮阳伞，早起锻炼正合适。"],
                    overcast: ["阴天的早晨，闷热感或会加重，注意通风。", "虽无太阳，紫外线仍在，防晒别松懈。", "阴天，让夏日的浮躁沉淀下来，早安。"],
                    rain: ["夏日雷雨多，早安。雷鸣时请远离窗户。", "一场大雨为夏天降温，空气都清新了。", "雨天出行，注意安全，当心积水。"],
                    hot: ["清晨已热浪滚滚，今天注定热情似火。", "防暑降温是今日主题，早安！", "绿豆汤、西瓜，你的解暑神器备好了吗？"],
                    windy: ["清晨的风，吹走了些许闷热，带来一丝清凉。", "风大的早晨，适合在室内做些舒缓运动。", "听，是夏天的风在唱歌。"],
                    default: ["早安，愿你拥有一个充满活力的夏日开端。"]
                },
                afternoon: {
                    clear: ["烈日当空，酷暑难耐，午后少出门。", "下午好，冰饮西瓜是此刻最好的慰藉。", "心静自然凉，但空调可能是更好的选择。"],
                    cloudy: ["多云天紫外线仍强，备好防晒用具。", "午后犯困，小睡一会或听音乐提神。", "天气闷热，谨防中暑，多补充电解质。"],
                    overcast: ["阴沉的午后，或有雷阵雨，请提前准备。", "室内昏暗，开盏灯让心情也明亮。", "这样的天气，最适合在空调房里追剧了。"],

                    rain: ["午后暴雨，来去匆匆，稍等片刻再出门。", "雨后的空气格外清新，适合开窗通风。", "雨声是最好的白噪音，适合午睡。"],
                    hot: ["热！下午最热，请多保重。", "减少外出，静心养神，平安度夏。", "如果可以，游泳是下午最好的选择。"],
                    windy: ["大风吹过，或会带来降雨，注意天气变化。", "风大的午后，不宜进行水上活动。", "在室内感受风的凉意，也是一种享受。"],
                    default: ["下午好，炎炎夏日，记得保持心平气和。"]
                },
                evening: {
                    clear: ["日落余晖，晚霞似火，一天中最美。", "夏夜晚风吹散燥热，适合出门纳凉。", "萤火虫、星空、冰西瓜，是夏夜的浪漫。"],
                    cloudy: ["云层遮住了月亮，但挡不住夏夜的惬意。", "晚饭后，和家人朋友散散步，聊聊天吧。", "多云的夜晚，蚊虫可能较多，注意防蚊。"],
                    overcast: ["阴沉的夜晚，闷热依旧，开空调会更舒适。", "晚安，愿你摆脱烦闷，拥有清爽的梦。", "睡前冲个温水澡，有助于睡眠。"],
                    rain: ["雨后夜晚，凉爽舒适，宜安然入睡。", "听着雨声，放下手机，让身心都得到放松。", "晚来风急，雨声潺潺，祝你好梦。"],
                    hot: ["夜晚依旧闷热，空调电扇是好伙伴。", "睡前喝点温水，补充身体流失的水分。", "一张凉席，一个好梦，晚安。"],
                    windy: ["晚风送爽，终于可以大口呼吸了。", "风大的夜晚，晾晒的衣物要收好哦。", "在风声中，结束这喧嚣的一天吧。"],
                    default: ["晚安，愿夏夜的凉风吹走你所有的疲惫。"]
                }
            },
            autumn: {
                morning: {
                    clear: ["秋高气爽，天朗气清，早安！", "金色的阳光洒满大地，是收获的颜色。", "天气微凉，出门记得加件薄外套。"],
                    cloudy: ["多云的早晨，秋意更浓。", "云层之上，是湛蓝的秋日天空。", "一杯热咖啡，开启元气满满的一天。"],
                    overcast: ["秋日阴天，别有一番萧瑟之美。", "天气转凉，注意保暖，预防感冒。", "阴天，让心绪沉淀，适合深度阅读。"],
                    rain: ["一场秋雨一场寒，注意及时添衣。", "秋雨绵绵，洗尽尘埃，空气格外清新。", "雨天路滑，早安，出行请慢行。"],
                    fog: ["秋雾弥漫，能见度低，晨练可改为室内。", "开车请打开雾灯，保持安全车距。", "云开雾散时，便是秋日好“枫”光。"],
                    windy: ["秋风瑟瑟，落叶纷飞。戴好围巾保暖。", "风起，是秋天在提醒你加衣服啦。", "大风天空气干燥，多喝水润燥。"],
                    default: ["早安，愿你的心情如秋日般静美。"]
                },
                afternoon: {
                    clear: ["秋日午后，阳光正好，不冷不热最宜人。", "泡一壶桂花茶，享受这份秋日限定。", "天气干燥，别忘了给皮肤补水。"],
                    cloudy: ["多云的下午，适合去郊外走走，看看红叶。", "没有阳光直射，是摄影的好时机。", "秋乏来袭，起来走动走动，伸个懒腰吧。"],
                    overcast: ["阴天的午后，适合逛逛博物馆或书店。", "一杯暖暖的下午茶，能驱散阴天的沉闷。", "天色暗得早，请合理安排时间哦。"],
                    rain: ["秋雨淅沥，宜窝在沙发看暖心电影。", "雨水带来了降温，注意保暖。", "这种天气，吃顿热腾腾的火锅吧？"],
                    fog: ["午后有雾，不如在家整理房间，换个好心情。", "雾天湿气重，可以打开除湿机。", "迷雾之中，更要看清前行的方向。"],
                    windy: ["风吹走了夏日的暑气，带来了秋的讯息。", "登高望远，感受秋风拂面的辽阔。", "风干物燥，注意用火安全。"],
                    default: ["下午好，愿秋日的宁静能抚平你的烦忧。"]
                },
                evening: {
                    clear: ["皓月当空，秋夜静谧，宜赏月，宜思念。", "天凉如水，晚归的人记得多穿一件。", "晚安，愿你梦里有桂花香和金色麦浪。"],
                    cloudy: ["云遮月，星稀疏，但秋夜的凉爽依然。", "适合与家人围坐，共享天伦之乐。", "夜深了，早点休息，养足精神。"],
                    overcast: ["阴冷的秋夜，宜早睡，宜好梦。", "睡前用热水泡泡脚，有助于驱寒保暖。", "晚安，明天又会是新的一天。"],
                    rain: ["窗外雨声滴答，是秋夜的催眠曲。", "雨夜寒意重，盖好被子，别着凉。", "听雨入眠，一夜安睡到天明。"],
                    fog: ["夜雾四起，非必要不外出。", "在家享受一个安静的夜晚吧。", "晚安，愿你拨开生活的迷雾，找到方向。"],
                    windy: ["风声鹤唳，关好门窗，安心入睡。", "秋风起，蟹脚痒，是品尝大闸蟹的好时节。", "在风声中，静静地与世界道晚安。"],
                    default: ["晚安，愿你在这收获的季节里，收获好梦。"]
                }
            },
            winter: {
                morning: {
                    clear: ["冬日暖阳珍贵，早安，出门晒太阳吧！", "晴朗的冬晨，天空湛蓝，心情也随之明媚。", "虽冷，但有阳光的早晨总是充满希望。"],
                    cloudy: ["没有太阳的冬晨更冷，多穿一点哦。", "起床大作战成功了吗？为你点赞！", "一杯热可可，温暖你的整个早晨。"],
                    overcast: ["阴沉的早晨，仿佛世界都按下了静音键。", "注意保暖，特别是头部和脚部。", "一顿热腾腾的早餐，是对冬天最大的尊重。"],
                    snow: ["下雪啦！银装素裹的世界，早安。", "瑞雪兆丰年，今天会是充满惊喜的一天。", "出门请注意防滑，慢走欣赏雪景。"],
                    fog: ["大雾锁城，今天的世界充满了神秘感。", "能见度极低，出行注意安全，优选公交。", "待在室内，也是一种安全的选择。"],
                    windy: ["寒风凛冽如刀割，戴好帽子围巾手套！", "今天的风，是冬天的信使。", "大风天，体感温度更低，注意防寒。"],
                    cold: ["今天“冻”力十足，你是“抗冻”勇士！", "离开温暖的被窝，是今天最大的挑战。", "多喝热水，是冬天里最朴素的关心。"],
                    default: ["早安，愿你有暖阳照身，有热茶暖心。"]
                },
                afternoon: {
                    clear: ["午后阳光正好，是晒太阳补钙的好时机。", "找个朝南的窗边，感受猫一样的午后。", "天气虽冷，但阳光能带来温暖和力量。"],
                    cloudy: ["多云的午后，光线柔和，适合在室内拍照。", "室外寒冷，不如在家做运动暖暖身子。", "一杯姜茶，可以帮你驱散寒意。"],
                    overcast: ["阴冷的下午，最适合和朋友一起吃火锅。", "天色昏暗，开盏暖黄灯，营造温馨氛围。", "离天黑又近了一步，珍惜白天的时光。"],
                    snow: ["雪还在下，不如堆雪人打雪仗找回童趣。", "雪景虽美，但户外不宜久留，小心冻伤。", "一杯热红酒，配上窗外的雪景，绝了。"],
                    fog: ["雾气沉沉，不如静心读一本想读的书。", "减少外出，享受一个安逸的下午。", "大雾天空气质量或不佳，尽量少开窗。"],
                    windy: ["狂风呼啸，是冬天的咆哮。在家最安全。", "检查窗户是否关紧，以防冷风侵入。", "这样的天气，宜“猫冬”，不宜出门。"],
                    cold: ["滴水成冰的下午，你还好吗？", "用一个热水袋捂捂手，会舒服很多。", "天寒地冻，但我们对生活的热情不结冰。"],
                    default: ["下午好，越是寒冷，越要活得热气腾腾。"]
                },
                evening: {
                    clear: ["冬夜的星空，清澈而寒冷，别有一番风味。", "天气寒冷，早点结束忙碌，回家取暖吧。", "晚安，愿你梦里春暖花开。"],
                    cloudy: ["没有星月的夜晚，更显宁静。", "适合窝在沙发里，看一部治愈的电影。", "睡前用热水泡脚，可以提高睡眠质量。"],
                    overcast: ["阴冷冬夜，宜与家人闲坐，灯火可亲。", "窗外天寒地冻，屋内温暖如春是幸福。", "晚安，盖好被子，别让寒气入侵。"],
                    snow: ["雪夜，宜围炉夜话，宜静思，宜好梦。", "窗外的世界一片洁白，内心也变得宁静。", "晚安，雪花会为你覆盖一整夜的温柔。"],
                    fog: ["夜雾茫茫，早点休息，明天又是新的一天。", "所有看不清的，时间都会给你答案。", "祝你有个清晰温暖的梦。"],
                    windy: ["听着窗外的风声，感觉被窝里格外温暖。", "风会带走所有不开心，晚安。", "今夜，宜拥抱，宜取暖。"],
                    cold: ["这是需要勇气才能离开被窝的夜晚。", "晚安，请查收一份来自冬夜的温暖。", "睡个好觉，为身体充满抵御严寒的能量。"],
                    default: ["晚安，愿你在这寒冷的冬夜里，被温柔以待。"]
                }
            },
            default: {
                default: [
                    "愿你眼里的星星，永远闪亮。",
                    "生活或许不易，但请别忘了微笑。😊",
                    "每一天都是一份独一无二的礼物。",
                    "无论天气如何，记得带上自己的阳光。",
                    "嘿，陌生人，祝你今天开心。"
                ]
            }
        };

        function getWeatherTip(weatherData) {
            const now = new Date();
            const month = now.getMonth() + 1;
            const hour = now.getHours();

            // 1. Determine Season
            let season = 'default';
            if (month >= 3 && month <= 5) season = 'spring';
            else if (month >= 6 && month <= 8) season = 'summer';
            else if (month >= 9 && month <= 11) season = 'autumn';
            else season = 'winter';

            // 2. Determine Time of Day
            let timeOfDay = 'night';
            if (hour >= 5 && hour < 12) timeOfDay = 'morning';
            else if (hour >= 12 && hour < 18) timeOfDay = 'afternoon';
            else if (hour >= 18 && hour < 22) timeOfDay = 'evening';

            // 3. Determine Weather Condition
            let condition = 'default';
            const tempC = parseInt(weatherData.tempC, 10);
            const weatherDesc = weatherData.weatherDesc.toLowerCase();
            const windSpeed = parseInt(weatherData.windSpeedKmph, 10);

            if (tempC > 32) condition = 'hot';
            else if (tempC < 0) condition = 'cold';
            else if (weatherDesc.includes('snow') || weatherDesc.includes('sleet') || weatherDesc.includes('blizzard')) condition = 'snow';
            else if (weatherDesc.includes('rain') || weatherDesc.includes('shower') || weatherDesc.includes('drizzle')) condition = 'rain';
            else if (weatherDesc.includes('fog') || weatherDesc.includes('mist')) condition = 'fog';
            else if (weatherDesc.includes('haze') || weatherDesc.includes('smoke') || weatherDesc.includes('dust')) condition = 'haze';
            else if (windSpeed > 25) condition = 'windy';
            else if (weatherDesc.includes('overcast')) condition = 'overcast';
            else if (weatherDesc.includes('cloudy')) condition = 'cloudy';
            else if (weatherDesc.includes('clear') || weatherDesc.includes('sunny')) condition = 'clear';

            // 4. Retrieve Tip with Fallbacks
            let tips = WEATHER_TIPS[season]?.[timeOfDay]?.[condition];

            if (!tips || tips.length === 0) {
                tips = WEATHER_TIPS[season]?.[timeOfDay]?.default;
            }
            if (!tips || tips.length === 0) {
                // Fallback to season-level default if time-of-day default is missing
                tips = WEATHER_TIPS[season]?.default?.default;
            }
            if (!tips || tips.length === 0) {
                // Ultimate fallback
                tips = WEATHER_TIPS.default.default;
            }
            
            // 5. Return a random tip from the selected array
            return tips[Math.floor(Math.random() * tips.length)];
        }

        // --- [NEW] Weather API Fallback Logic ---

        function setWeatherSpinner(isSpinning) {
            const refreshBtn = document.getElementById('weather-refresh-btn');
            if (refreshBtn) {
                const icon = refreshBtn.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-spin', isSpinning);
                }
            }
        }

        function getWeatherIconName(weatherData) {
            const { weatherDesc: desc, windSpeedKmph: wind, isDay, weatherCode } = weatherData;
            const weatherDesc = desc.toLowerCase();
            const iconPrefix = 'https://basmilius.github.io/weather-icons/production/fill/all/';
            let iconName = 'not-available.svg';

            if (weatherDesc.includes('thunder') && weatherDesc.includes('snow')) {
                iconName = isDay ? 'thunderstorms-day-snow.svg' : 'thunderstorms-night-snow.svg';
            } else if (weatherDesc.includes('thunder') && weatherDesc.includes('rain')) {
                iconName = isDay ? 'thunderstorms-day-rain.svg' : 'thunderstorms-night-rain.svg';
            } else if (weatherDesc.includes('thunder')) {
                iconName = isDay ? 'thunderstorms-day.svg' : 'thunderstorms-night.svg';
            } else if (weatherDesc.includes('snow') || weatherDesc.includes('blizzard')) {
                iconName = isDay ? 'partly-cloudy-day-snow.svg' : 'partly-cloudy-night-snow.svg';
                if (weatherDesc.includes('heavy') || weatherDesc.includes('blizzard')) iconName = 'snow.svg';
            } else if (weatherDesc.includes('sleet')) {
                iconName = isDay ? 'partly-cloudy-day-sleet.svg' : 'partly-cloudy-night-sleet.svg';
            } else if (weatherDesc.includes('rain') || weatherDesc.includes('shower')) {
                if (weatherDesc.includes('light') || weatherDesc.includes('drizzle')) {
                    iconName = isDay ? 'partly-cloudy-day-drizzle.svg' : 'partly-cloudy-night-drizzle.svg';
                } else if (weatherDesc.includes('heavy')) {
                    iconName = 'rain.svg';
                } else {
                    iconName = isDay ? 'partly-cloudy-day-rain.svg' : 'partly-cloudy-night-rain.svg';
                }
            } else if (weatherDesc.includes('hail')) {
                iconName = 'hail.svg';
            } else if (weatherDesc.includes('fog')) {
                iconName = isDay ? 'fog-day.svg' : 'fog-night.svg';
            } else if (weatherDesc.includes('haze') || weatherDesc.includes('smoke') || weatherDesc.includes('dust')) {
                iconName = isDay ? 'haze-day.svg' : 'haze-night.svg';
            } else if (parseInt(wind) > 30) {
                iconName = 'wind.svg';
            } else if (weatherDesc.includes('overcast')) {
                iconName = isDay ? 'overcast-day.svg' : 'overcast-night.svg';
            } else if (weatherDesc.includes('cloudy')) {
                iconName = isDay ? 'partly-cloudy-day.svg' : 'partly-cloudy-night.svg';
            } else if (weatherDesc.includes('clear') || weatherDesc.includes('sunny')) {
                iconName = isDay ? 'clear-day.svg' : 'clear-night.svg';
            } else {
                // Fallback to code if description is not specific enough
                const codeStr = String(weatherCode);
                switch (codeStr) {
                    case '113': iconName = isDay ? 'clear-day.svg' : 'clear-night.svg'; break;
                    case '116': iconName = isDay ? 'partly-cloudy-day.svg' : 'partly-cloudy-night.svg'; break;
                    case '119': iconName = 'cloudy.svg'; break;
                    case '122': iconName = 'overcast.svg'; break;
                    case '143': iconName = 'fog.svg'; break; // Generic fog
                    case '176': case '263': case '266': case '293': case '296': case '353':
                        iconName = isDay ? 'partly-cloudy-day-rain.svg' : 'partly-cloudy-night-rain.svg'; break;
                    case '179': case '323': case '326': case '368':
                        iconName = isDay ? 'partly-cloudy-day-snow.svg' : 'partly-cloudy-night-snow.svg'; break;
                    case '182': case '317': case '362': case '365':
                        iconName = isDay ? 'partly-cloudy-day-sleet.svg' : 'partly-cloudy-night-sleet.svg'; break;
                    case '185': iconName = isDay ? 'partly-cloudy-day-drizzle.svg' : 'partly-cloudy-night-drizzle.svg'; break;
                    case '200': case '386': case '389':
                        iconName = isDay ? 'thunderstorms-day-rain.svg' : 'thunderstorms-night-rain.svg'; break;
                    case '227': case '230': iconName = 'wind.svg'; break;
                    case '248': case '260': iconName = 'fog.svg'; break;
                    case '281': case '284': case '311': case '314': iconName = 'sleet.svg'; break;
                    case '299': case '302': case '305': case '308': case '356': case '359': iconName = 'rain.svg'; break;
                    case '329': case '332': case '335': case '338': case '371': iconName = 'snow.svg'; break;
                    case '350': case '374': case '377': iconName = 'hail.svg'; break;
                    case '392': case '395': iconName = isDay ? 'thunderstorms-day-snow.svg' : 'thunderstorms-night-snow.svg'; break;
                }
            }
            return iconPrefix + iconName;
        }

        function getWeatherDataHtml(weatherData) {
            const iconUrl = getWeatherIconName(weatherData);
            
            const sunriseTime = appSettings.timeFormat === '24h' ? convert12hto24h(weatherData.sunrise) : weatherData.sunrise.replace(' ', '');
            const sunsetTime = appSettings.timeFormat === '24h' ? convert12hto24h(weatherData.sunset) : weatherData.sunset.replace(' ', '');

            return `
                <div class="flex gap-x-8 items-stretch w-full">
                    <!-- Column 1: 图标和主温度 (固定宽度, 居中) -->
                    <div class="flex-shrink-0 flex flex-col items-center justify-center w-32">
                        <img id="weather-icon-img" src="${iconUrl}" alt="${weatherData.weatherDesc}" class="w-16 h-16 weather-icon-initial">
                        <p class="font-bold text-3xl" style="color: var(--text-color-primary);">${weatherData.tempC}°</p>
                    </div>

                    <!-- Column 2: Location, Condition, Tip (Flexible, Left-aligned) -->
                    <div class="flex-1 flex flex-col text-left justify-between">
                        <p class="font-bold text-xl truncate" style="color: var(--text-color-primary);" title="${weatherData.location}">${weatherData.location}</p>
                        <p class="text-base font-medium" style="color: var(--text-color-secondary);">${weatherData.weatherDesc}</p>
                        <p class="text-base font-medium" style="color: var(--text-color-secondary);">最高 ${weatherData.maxTempC}° 最低 ${weatherData.minTempC}°</p>
                        <p class="text-sm" style="color: var(--text-color-tertiary);">${weatherData.tip}</p>
                    </div>

                    <!-- Column 3: 详细信息 (固定宽度, 左对齐) -->
                    <div class="flex-shrink-0 flex flex-col text-sm justify-between w-56">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center w-20">
                                <i class="far fa-sun fa-fw w-5 text-center" style="color: var(--text-color-secondary);"></i>
                                <span class="ml-2" style="color: var(--text-color-secondary);">日出/落</span>
                            </div>
                            <span class="font-semibold" style="color: var(--text-color-primary);">${sunriseTime} / ${sunsetTime}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center w-20">
                                <i class="fas fa-temperature-half fa-fw w-5 text-center" style="color: var(--text-color-secondary);"></i>
                                <span class="ml-2" style="color: var(--text-color-secondary);">体感</span>
                            </div>
                            <span class="font-semibold" style="color: var(--text-color-primary);">${weatherData.feelsLikeC}°</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center w-20">
                                <i class="fas fa-droplet fa-fw w-5 text-center" style="color: var(--text-color-secondary);"></i>
                                <span class="ml-2" style="color: var(--text-color-secondary);">湿度</span>
                            </div>
                            <span class="font-semibold" style="color: var(--text-color-primary);">${weatherData.humidity}%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center w-20">
                                <i class="fas fa-wind fa-fw w-5 text-center" style="color: var(--text-color-secondary);"></i>
                                <span class="ml-2" style="color: var(--text-color-secondary);">风速</span>
                            </div>
                            <span class="font-semibold" style="color: var(--text-color-primary);">${weatherData.windSpeedKmph} km/h</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWeatherData(newHtml, isError = false) {
            const weatherLoader = document.getElementById('weather-loader');
            const dataContainer = document.getElementById('weather-data-container');
            const wrapper = document.getElementById('weather-content-wrapper');
            
            if (!dataContainer || !wrapper) return;

            // 1. Fade out current content
            dataContainer.style.opacity = 0;

            // 2. After fade-out, update content and fade back in
            setTimeout(() => {
                setWeatherSpinner(false); // Stop spinner on success or error
                isFetchingWeather = false; // Release the lock
                dataContainer.innerHTML = newHtml;
                if (weatherLoader) {
                    weatherLoader.classList.remove('visible');
                }

                // Handle icon fade-in after image load
                const iconImg = document.getElementById('weather-icon-img');
                if (iconImg) {
                    const fadeInIcon = () => {
                        iconImg.classList.remove('weather-icon-initial');
                        iconImg.classList.add('weather-icon-loaded');
                    };
                    if (iconImg.complete) {
                        fadeInIcon();
                    } else {
                        iconImg.onload = fadeInIcon;
                    }
                }

                dataContainer.style.opacity = 1; // Fade in new content

                // This was in the old render function, so keep it for error cases
                if (isError) {
                    appSettings.weather.lastFetchedCity = '加载失败';
                    updateSettingsUI();
                }
            }, 300); // Match CSS transition duration
        }

        function convert12hto24h(time12h) {
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');

            if (hours === '12') {
                hours = '00';
            }

            if (modifier.toUpperCase() === 'PM') {
                hours = parseInt(hours, 10) + 12;
            }

            return `${String(hours).padStart(2, '0')}:${minutes}`;
        }

        // API Handler for wttr.in
        async function handleWttrIn(locationQuery, locationName) {
            const response = await fetch(`https://wttr.in/${encodeURIComponent(locationQuery)}?format=j1`);
            if (!response.ok) {
                throw new Error(`wttr.in API returned status ${response.status}`);
            }
            const data = await response.json();

            const current = data.current_condition[0];
            const forecast = data.weather[0];
            const nearestArea = data.nearest_area[0];
            const astronomy = forecast.astronomy[0];

            // Helper to convert 12h AM/PM time to a comparable number
            const timeToMinutes = (timeStr) => {
                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':').map(Number);
                if (modifier === 'PM' && hours < 12) {
                    hours += 12;
                }
                if (modifier === 'AM' && hours === 12) { // 12 AM is midnight
                    hours = 0;
                }
                return hours * 60 + minutes;
            };

            const now = new Date();
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
            const sunriseMinutes = timeToMinutes(astronomy.sunrise);
            const sunsetMinutes = timeToMinutes(astronomy.sunset);
            const isDay = currentTimeMinutes >= sunriseMinutes && currentTimeMinutes < sunsetMinutes;

            const standardizedData = {
                location: nearestArea.areaName[0].value,
                country: nearestArea.country[0].value,
                tempC: current.temp_C,
                feelsLikeC: current.FeelsLikeC,
                weatherCode: current.weatherCode,
                weatherDesc: current.weatherDesc[0].value,
                maxTempC: forecast.maxtempC,
                minTempC: forecast.mintempC,
                windSpeedKmph: current.windspeedKmph,
                humidity: current.humidity,
                sunrise: astronomy.sunrise, // Pass raw 12h string e.g. "6:04 AM"
                sunset: astronomy.sunset,   // Pass raw 12h string e.g. "7:12 PM"
                isDay: isDay,
                tip: "" // Tip will be generated after the object is created
            };
            
            // Generate tip after all data is available
            standardizedData.tip = getWeatherTip(standardizedData);

            appSettings.weather.lastFetchedCity = `${standardizedData.location}, ${standardizedData.country}`;
            saveSettings();
            return standardizedData;
        }
        
        // API Handler for Open-Meteo
        async function handleOpenMeteo(locationQuery, locationName) {
            // 1. Geocoding step
            const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationQuery)}&count=1&language=en&format=json`);
            if (!geoResponse.ok) {
                throw new Error(`Open-Meteo Geocoding API failed with status ${geoResponse.status}`);
            }
            const geoData = await geoResponse.json();
            if (!geoData.results || geoData.results.length === 0) {
                throw new Error(`Open-Meteo could not find location for "${locationQuery}"`);
            }
            const { latitude, longitude, name: foundName, country } = geoData.results[0];

            // 2. Forecast step
            const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&wind_speed_unit=kmh&timezone=auto`;
            const forecastResponse = await fetch(forecastUrl);
            if (!forecastResponse.ok) {
                throw new Error(`Open-Meteo Forecast API failed with status ${forecastResponse.status}`);
            }
            const forecastData = await forecastResponse.json();

            // 3. Parsing and Standardization step
            const WMO_CODES = {
                0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing rime fog',
                51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
                61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                66: 'Light freezing rain', 67: 'Heavy freezing rain',
                71: 'Slight snow fall', 73: 'Moderate snow fall', 75: 'Heavy snow fall',
                77: 'Snow grains',
                80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                85: 'Slight snow showers', 86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail',
            };

            const current = forecastData.current;
            const daily = forecastData.daily;
            const weatherDesc = WMO_CODES[current.weather_code] || 'Unknown';

            const standardizedData = {
                location: foundName,
                country: country,
                tempC: current.temperature_2m,
                feelsLikeC: current.apparent_temperature,
                weatherDesc: weatherDesc,
                maxTempC: daily.temperature_2m_max[0],
                minTempC: daily.temperature_2m_min[0],
                windSpeedKmph: current.wind_speed_10m,
                humidity: current.relative_humidity_2m,
                tip: "" // Tip will be generated after the object is created
            };

            // Generate tip after all data is available
            standardizedData.tip = getWeatherTip(standardizedData);

            appSettings.weather.lastFetchedCity = `${standardizedData.location}, ${standardizedData.country}`;
            saveSettings();
            return standardizedData;
        }

        // Controller that tries a list of API handlers in order.
        async function tryWeatherApis(locationQuery, locationName) {
            const apiHandlers = [
                handleWttrIn,
                handleOpenMeteo,
            ];

            for (const handler of apiHandlers) {
                try {
                    const weatherData = await handler(locationQuery, locationName);
                    if (weatherData) {
                        const html = getWeatherDataHtml(weatherData);
                        renderWeatherData(html);
                        return; // Success, exit the loop.
                    }
                } catch (error) {
                    console.warn(`API handler ${handler.name} failed:`, error);
                    // Log the error and continue to the next handler.
                }
            }

            // If all handlers failed
            const errorHtml = `<div class="text-center"><p style="color: var(--accent-color);">天气信息当前不可用。</p><p class="text-xs mt-2" style="color: var(--text-color-tertiary);">请检查您的网络连接或稍后重试。</p></div>`;
            renderWeatherData(errorHtml, true);
        }

        // Main entry point for the weather feature.
        async function fetchAndDisplayWeather() {
            if (isFetchingWeather) {
                console.log("Weather fetch already in progress. Ignoring request.");
                return;
            }
            isFetchingWeather = true;

            const weatherLoader = document.getElementById('weather-loader');
            const dataContainer = document.getElementById('weather-data-container');
            const wrapper = document.getElementById('weather-content-wrapper');

            if (!weatherLoader || !dataContainer || !wrapper) return;

            // --- [FIX] Fade out old content before showing loader ---
            dataContainer.style.opacity = 0;

            setTimeout(async () => {
                // Show loader and set initial state after fade out
                weatherLoader.classList.add('visible');
                dataContainer.innerHTML = `<p class="text-center" style="color: var(--text-color-secondary);">正在获取天气...</p>`;
                dataContainer.style.opacity = 1; // Fade in the "Loading..." text

                let locationQuery = appSettings.weather.city;
                let locationName = locationQuery;

                // This part remains the same: get the location first.
                if (appSettings.weather.source === 'auto' && !locationQuery) {
                    try {
                        const ipResponse = await fetch('https://cors.eu.org/http://ip-api.com/json');
                        if (!ipResponse.ok) throw new Error('IP API request failed');
                        const ipData = await ipResponse.json();
                        locationQuery = ipData.city || 'auto:ip';
                        locationName = ipData.city;
                    } catch (e) {
                        setWeatherSpinner(false);
                        isFetchingWeather = false; // Release the lock on early error
                        console.error("IP-based geolocation failed.", e);
                        const errorHtml = `<div class="text-center"><p style="color: var(--accent-color);">无法自动确定您的位置</p><p class="text-xs mt-2" style="color: var(--text-color-tertiary);">请在设置中手动输入城市。</p></div>`;
                        renderWeatherData(errorHtml, true);
                        return;
                    }
                }

                if (!locationQuery) {
                    const errorHtml = `<div class="text-center"><p style="color: var(--accent-color);">未设置城市</p><p class="text-xs mt-2" style="color: var(--text-color-tertiary);">请在设置中手动输入一个城市名称。</p></div>`;
                    renderWeatherData(errorHtml, true);
                    return;
                }
                
                // Hand off to the controller function.
                await tryWeatherApis(locationQuery, locationName || locationQuery);
            }, 300); // Match CSS transition duration
        }


        function saveSettings() {
            localStorage.setItem('qing-homepage-settings', JSON.stringify(appSettings));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('qing-homepage-settings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Merge saved settings with defaults to ensure compatibility with future updates
                    appSettings = {
                        ...appSettings,
                        ...parsedSettings,
                        background: { ...appSettings.background, ...(parsedSettings.background || {}) },
                        weather: { ...appSettings.weather, ...(parsedSettings.weather || {}) },
                    };

                    // Backward compatibility: If old setting `view: 'weather'` exists, but new `weather.source` doesn't, default it.
                    if (appSettings.view === 'weather' && !appSettings.weather.source) {
                        appSettings.weather.source = 'auto';
                    }
                } catch (e) {
                    console.error("Failed to parse settings from localStorage", e);
                    // If parsing fails, use default settings
                }
            }
        }
        
        let currentBgUrl = ''; // Holds the resolved URL of the current background
        let currentImageBlob = null; // Holds the raw image data for original-quality download
        let currentImageExtension = 'jpg'; // Holds the file extension for the blob

        // --- [NEW] Download Image Helper ---
        function downloadImage() {
            const downloadBtn = document.getElementById('bg-preview-download-btn');
            if (!downloadBtn) return;
            
            const originalIcon = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const restoreIcon = () => {
                downloadBtn.innerHTML = originalIcon;
            };

            // Prioritize downloading the original blob if it exists
            if (currentImageBlob) {
                try {
                    const objectUrl = URL.createObjectURL(currentImageBlob);
                    const a = document.createElement('a');
                    a.href = objectUrl;
                    a.download = `background-${Date.now()}.${currentImageExtension}`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(objectUrl);
                    setTimeout(restoreIcon, 100);
                } catch (error) {
                    console.error('Blob download failed:', error);
                    if (currentBgUrl) window.open(currentBgUrl, '_blank');
                    restoreIcon();
                }
            } else {
                // Fallback to canvas method for static images or if blob capture failed
                console.warn("No image blob available, falling back to canvas download.");
                try {
                    const img = document.getElementById('bg-preview-img');
                    if (!img || !img.src || !img.complete || img.naturalWidth === 0) {
                        throw new Error('Preview image is not available or ready for canvas download.');
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob((blob) => {
                        if (!blob) throw new Error('Canvas toBlob returned null.');
                        const objectUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = objectUrl;
                        a.download = `background-${Date.now()}.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(objectUrl);
                        restoreIcon();
                    }, 'image/png');
                } catch (error) {
                    console.error('Canvas download fallback failed:', error);
                    if (currentBgUrl) window.open(currentBgUrl, '_blank');
                    restoreIcon();
                }
            }
        }

        const showPreview = (displayUrl, originalUrl) => {
            const requestId = ++latestPreviewRequestId;
            const previewImg = document.getElementById('bg-preview-img');
            const loader = document.getElementById('preview-loader');
            const downloadBtn = document.getElementById('bg-preview-download-btn');
            const refreshBtn = document.getElementById('bg-preview-refresh-btn');

            if (!previewImg || !loader) return;

            // --- [NEW] Stop loading indicators ---
            previewImg.classList.remove('breathing-effect');
            loader.classList.remove('visible');
            
            // Ensure action buttons are visible
            downloadBtn.classList.add('visible');
            refreshBtn.classList.add('visible');

            currentBgUrl = originalUrl; // Store the original URL for the download fallback.

            // --- [NEW] Implement Fade-out, then Fade-in animation ---
            const preloader = new Image();
            preloader.src = displayUrl;

            preloader.onload = () => {
                if (requestId !== latestPreviewRequestId) return; // Ignore outdated request

                // [FIX] Make the image visible before fading it in
                previewImg.classList.remove('hidden');

                // 1. Set transition time and fade out
                previewImg.style.transition = 'opacity 0.2s ease-in-out';
                previewImg.style.opacity = 0;

                // 2. After fade-out, change src and fade back in
                setTimeout(() => {
                    previewImg.src = preloader.src;
                    previewImg.style.opacity = 1;
                }, 200); // Wait for fade-out to complete
            };

            preloader.onerror = () => {
                if (requestId !== latestPreviewRequestId) return;
                console.error(`Preview image failed to load: ${displayUrl}`);
                // If new image fails, just stop loading and show the old image
                previewImg.style.opacity = 1; 
            };
        };

        async function applyCurrentBackground() {
            const requestId = ++latestBgRequestId;
            const { source, specifier } = appSettings.background;

            const stopSpinner = () => {
                const refreshBtn = document.getElementById('bg-preview-refresh-btn');
                if (refreshBtn) {
                    const icon = refreshBtn.querySelector('i');
                    if (icon) icon.classList.remove('fa-spin');
                }
            };

            const hidePreview = () => {
                const container = document.getElementById('background-preview-container');
                const previewImg = document.getElementById('bg-preview-img');
                const loader = document.getElementById('preview-loader');

                if (container) container.classList.remove('visible');
                if (previewImg) previewImg.classList.remove('breathing-effect');
                if (loader) loader.classList.remove('visible');
            };
            
            const handleError = (error, source) => {
                if (requestId !== latestBgRequestId) return; // Ignore error from outdated request
                console.error(`Error fetching background from source: ${source}`, error);
                stopSpinner();
                const randomFallbackUrl = DEFAULT_BG_IMAGES[Math.floor(Math.random() * DEFAULT_BG_IMAGES.length)];
                backgroundFader.update(randomFallbackUrl, true);
                hidePreview();
            };

            try {
                const isDynamicSource = ['bing', 'anime', 'random'].includes(source);
                
                // --- [NEW] Immediate UI feedback for dynamic sources ---
                if (isDynamicSource) {
                    const container = document.getElementById('background-preview-container');
                    const previewImg = document.getElementById('bg-preview-img');
                    const loader = document.getElementById('preview-loader');

                    if (container && previewImg && loader) {
                        // Ensure the container is visible to show the loading state
                        if (!container.classList.contains('visible')) {
                             container.classList.add('visible');
                        }
                        previewImg.classList.add('breathing-effect');
                        loader.classList.add('visible');
                    }
                }

                let finalUrl; // The original URL of the image
                let displayUrl; // The URL to be used for display (object URL for dynamic, same as finalUrl for static)

                if (!isDynamicSource) {
                    hidePreview();
                    finalUrl = (specifier && specifier !== 'random' && DEFAULT_BG_IMAGES.includes(specifier))
                        ? specifier
                        : DEFAULT_BG_IMAGES[Math.floor(Math.random() * DEFAULT_BG_IMAGES.length)];
                    displayUrl = finalUrl;
                } else {
                    // Step 1: Get the original dynamic URL
                    if (source === 'bing') {
                        const bingApiResponse = await fetch('https://cors.eu.org/https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=zh-CN');
                        if (!bingApiResponse.ok) throw new Error('Bing API request failed');
                        const bingData = await bingApiResponse.json();
                        finalUrl = `https://www.bing.com${bingData.images[0].urlbase}_1920x1080.jpg`;
                    } else { // anime or random
                        const apiUrl = source === 'anime' 
                            ? 'https://api.sretna.cn/api/anime.php' // 防挂 https://www.dmoe.cc/random.php
                            : 'https://imgapi.cn/api.php?zd=zsy&fl=fengjing&gs=images';
                        finalUrl = `${apiUrl}?v=${new Date().getTime()}`;
                    }

                    // Step 2: Fetch the image data through the proxy, get a blob, and create an object URL
                    const imageResponse = await fetch(`https://cors.eu.org/${finalUrl}`);
                    if (!imageResponse.ok) throw new Error(`Failed to fetch image from proxy: ${finalUrl}`);
                    
                    const imageBlob = await imageResponse.blob();
                    currentImageBlob = imageBlob; // Store the blob globally for download
                    const contentType = imageResponse.headers.get('content-type');
                    const mimeToExt = {
                        'image/jpeg': 'jpg',
                        'image/png': 'png',
                        'image/gif': 'gif',
                        'image/bmp': 'bmp',
                        'image/webp': 'webp'
                    };
                    currentImageExtension = mimeToExt[contentType] || 'jpg'; // Store the extension

                    displayUrl = URL.createObjectURL(imageBlob);
                }

                if (requestId !== latestBgRequestId) {
                    if (displayUrl.startsWith('blob:')) URL.revokeObjectURL(displayUrl);
                    return; // Outdated request, abort.
                }

                // Step 3: Use the urls to update the UI
                if (isDynamicSource) {
                    showPreview(displayUrl, finalUrl); // Pass both URLs to showPreview
                }
                await backgroundFader.update(displayUrl, true);
                
                stopSpinner();

            } catch (error) {
                handleError(error, source);
            }
        }

        function updateBgSettingsUI() {
            const { source, specifier } = appSettings.background;

            // Update radio buttons
            const radio = document.querySelector(`input[name="background-source"][value="${source}"]`);
            if (radio) {
                radio.checked = true;
            }

            // Update thumbnail selection
            const defaultOptionsContainer = document.getElementById('default-bg-options');
            const allThumbs = defaultOptionsContainer.querySelectorAll('.thumb-item');
            allThumbs.forEach(thumb => thumb.classList.remove('active'));
            
            const activeThumb = defaultOptionsContainer.querySelector(`.thumb-item[data-bg-url="${specifier}"]`);
            if (activeThumb) {
                activeThumb.classList.add('active');
            }

            // Show/hide thumbnail section
            if (source === 'default') {
                defaultOptionsContainer.classList.add('open');
            } else {
                defaultOptionsContainer.classList.remove('open');
            }
        }

        function updateThemeSettingsUI(isInstant = false) {
            const slider = document.querySelector('.theme-slider');
            const parent = slider ? slider.parentElement : null;
            const currentTheme = appSettings.theme;
            const activeButton = document.querySelector(`.setting-btn[data-theme='${currentTheme}']`);

            if (!slider || !parent || !activeButton) {
                return; // Exit if any required element is missing
            }

            if (isInstant) {
                slider.style.transition = 'none';
            }

            // Update active classes on all buttons
            document.querySelectorAll('.setting-btn-group .setting-btn').forEach(btn => {
                btn.classList.toggle('active', btn === activeButton);
            });

            // Use getBoundingClientRect for precise positioning
            const parentRect = parent.getBoundingClientRect();
            const buttonRect = activeButton.getBoundingClientRect();

            const left = buttonRect.left - parentRect.left;
            const width = buttonRect.width;

            slider.style.width = `${width}px`;
            slider.style.transform = `translateX(${left}px)`;

            if (isInstant) {
                // Force reflow to apply styles synchronously before re-enabling the transition
                void slider.offsetHeight;
                slider.style.transition = '';
            }
        }

        function initializeThemeSlider() {
            const settingsWindow = document.getElementById('settings-window');
            if (!settingsWindow) return;

            // 1. Temporarily make the modal measurable but invisible to the user
            const originalTransition = settingsWindow.style.transition;
            settingsWindow.style.transition = 'none';
            settingsWindow.style.visibility = 'hidden';
            settingsWindow.style.display = 'flex'; // Ensure it's not display:none

            // 2. Force it to its final "open" state to get correct dimensions
            document.body.classList.add('settings-open');
            
            // 3. Now, take the measurement and set the slider's state instantly
            updateThemeSettingsUI(true);

            // 4. Immediately revert all changes so the user sees nothing.
            // This happens synchronously before the browser can paint.
            document.body.classList.remove('settings-open');
            settingsWindow.style.display = ''; // Revert to default
            settingsWindow.style.visibility = ''; // Revert to default
            settingsWindow.style.transition = originalTransition;
        }
        
        // --- [NEW] Settings Panel UI Generation ---
        function setupSettingsUI() {
            // --- 1. Background Settings ---
            const bgSettingsContainer = document.getElementById('background-settings-content');
            if (bgSettingsContainer) {
                const bgOptions = [
                    { value: 'default', label: '默认图片', description: '随机选择一张内置图片作为背景' },
                    { value: 'bing', label: '每日一Bing', description: '展示 Bing 搜索的每日壁纸' },
                    { value: 'anime', label: '随机动漫', description: '从公共动漫图库随机加载一张高清壁纸' },
                    { value: 'random', label: '随机图片', description: '从公共图库中随机加载一张风景图' }
                ];

                let bgSettingsHTML = '';
                bgOptions.forEach(option => {
                    bgSettingsHTML += `
                        <div>
                            <input type="radio" id="bg-radio-${option.value}" name="background-source" value="${option.value}" class="setting-radio-input">
                            <label for="bg-radio-${option.value}" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>${option.label}</span>
                                    <div class="setting-description">${option.description}</div>
                                </div>
                            </label>
                        </div>
                    `;
                });
                
                let defaultOptionsHTML = `
                    <div id="default-bg-options">
                        <div class="thumb-container">
                            <div class="thumb-item" data-bg-url="random">
                                <div class="thumb-overlay">随机</div>
                            </div>
                `;
                DEFAULT_BG_IMAGES.forEach((url, index) => {
                    defaultOptionsHTML += `
                        <div class="thumb-item" data-bg-url="${url}">
                            <img src="${url}" alt="Default Background ${index + 1}" loading="lazy">
                        </div>
                    `;
                });
                defaultOptionsHTML += `</div></div>`;

                bgSettingsContainer.innerHTML = bgSettingsHTML + defaultOptionsHTML;

                // --- [NEW] Add background preview area ---
                const previewHTML = `
                    <div id="background-preview-container">
                        <div id="bg-preview-wrapper" class="relative w-full aspect-[16/9] rounded-lg overflow-hidden bg-white/5 transition-all duration-300 ease-in-out">
                            <img id="bg-preview-img" src="${DEFAULT_BG_IMAGES[0]}" alt="背景预览" class="w-full h-full object-cover hidden" crossorigin="anonymous">
                            <div id="preview-loader"></div>
                            <a id="bg-preview-download-btn" href="#" download="background.jpg" title="保存该图片" class="absolute bottom-2 right-2 w-9 h-9 rounded-full bg-black/40 text-white flex items-center justify-center hover:bg-black/60 transition-all scale-0 duration-300">
                                <i class="fas fa-download"></i>
                            </a>
                            <button id="bg-preview-refresh-btn" title="换一张" class="absolute bottom-2 right-12 w-9 h-9 rounded-full bg-black/40 text-white flex items-center justify-center hover:bg-black/60 transition-all scale-0 duration-300">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                bgSettingsContainer.insertAdjacentHTML('beforeend', previewHTML);
            }

            // --- 2. Theme Mode Settings ---
            const themeSettingsContainer = document.getElementById('theme-settings-content').parentElement;
            if (themeSettingsContainer) {
                const container = themeSettingsContainer.querySelector('#theme-settings-content');
                container.innerHTML = `
                <div class="setting-description text-center mb-3">选择主题，或跟随系统设置自动切换</div>
                    <div class="setting-btn-group w-full relative">
                        <div class="theme-slider absolute h-full rounded-xl transition-all duration-300"></div>
                        <button class="setting-btn relative z-10" data-theme="system"><i class="fas fa-desktop fa-fw mr-2"></i>跟随系统</button>
                        <button class="setting-btn relative z-10" data-theme="light"><i class="fas fa-sun fa-fw mr-2"></i>日间模式</button>
                        <button class="setting-btn relative z-10" data-theme="dark"><i class="fas fa-moon fa-fw mr-2"></i>夜间模式</button>
                    </div>
                `;
            }

            // --- NEW: Time Format Settings ---
            const timeFormatContainer = document.getElementById('time-format-settings-content');
            if (timeFormatContainer) {
                timeFormatContainer.innerHTML = `
                    <div class="space-y-2">
                        <div>
                            <input type="radio" id="time-format-24h" name="time-format" value="24h" class="setting-radio-input">
                            <label for="time-format-24h" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>24小时制（ 19:30 ）</span>
                                    <div class="setting-description">以 00:00 至 23:59 的格式显示时间</div>
                                </div>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="time-format-12h" name="time-format" value="12h" class="setting-radio-input">
                            <label for="time-format-12h" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>12小时制（ 7:30 AM / 7:30 PM ）</span>
                                    <div class="setting-description">使用 AM/PM 来区分上午和下午，符合部分用户习惯</div>
                                </div>
                            </label>
                        </div>
                    </div>
                `;
            }

            // --- 3. View Toggle Settings ---
            const viewToggleContainer = document.getElementById('view-toggle-content');
            if (viewToggleContainer) {
                viewToggleContainer.innerHTML = `
                    <div class="space-y-2">
                        <div>
                            <input type="radio" id="view-radio-github" name="view-source" value="github" class="setting-radio-input">
                            <label for="view-radio-github" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>显示 GitHub 贡献图</span>
                                    <div class="setting-description">主卡片区域展示您的 GitHub 提交活动图表</div>
                                </div>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="view-radio-weather-auto" name="view-source" value="weather-auto" class="setting-radio-input">
                            <label for="view-radio-weather-auto" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>天气信息（ IP 自动定位 ）</span>
                                    <div class="setting-description">根据您的网络位置自动获取并显示当地的天气情况</div>
                                </div>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="view-radio-weather-manual" name="view-source" value="weather-manual" class="setting-radio-input">
                            <label for="view-radio-weather-manual" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>天气信息（ 手动输入 ）</span>
                                    <div class="setting-description">手动输入城市名称来获取指定地点的天气预报</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div id="manual-city-input-wrapper" class="mt-2 pl-4 pr-2" style="max-height: 0; overflow: hidden; transition: all 0.3s ease-in-out;">
                        <div class="relative flex items-center">
                            <input type="text" id="weather-city-input" placeholder="输入城市后回车 (例如: 北京)" class="w-full rounded-md border px-3 py-1.5 text-sm" style="background-color: var(--progress-bar-bg); color: var(--text-color-primary); border-color: var(--separator-color);">
                            <button id="save-city-btn" title="保存" class="absolute right-1 p-1 rounded-full text-gray-400 hover:text-white">
                                <i class="fas fa-save w-5 h-5 flex items-center justify-center"></i>
                            </button>
                            <div id="confirm-city-icon" class="absolute right-1 p-1 hidden opacity-0" style="color: var(--status-today);">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </div>
                        <div id="city-input-error" class="text-xs mt-1 pl-1 hidden" style="color: #ef4444;"></div>
                    </div>
                `;
            }

            // --- 4. Hitokoto Settings ---
            const hitokotoContainer = document.getElementById('hitokoto-settings-content');
            if (hitokotoContainer) {
                const categories = [
                    { id: 'a', name: '动画' }, { id: 'b', name: '漫画' }, { id: 'c', name: '游戏' },
                    { id: 'd', name: '文学' }, { id: 'e', name: '原创' }, { id: 'f', name: '网络' },
                    { id: 'g', name: '其他' }, { id: 'h', name: '影视' }, { id: 'i', name: '诗词' },
                    { id: 'j', name: '网易云' }, { id: 'k', name: '哲学' }, { id: 'l', name: '抖机灵' }
                ];

                let checkboxesHTML = categories.map(cat => `
                    <div>
                        <input type="checkbox" id="hitokoto-cat-${cat.id}" name="hitokoto-category" value="${cat.id}" class="setting-radio-input hitokoto-checkbox-input">
                        <label for="hitokoto-cat-${cat.id}" class="hitokoto-checkbox-label">
                            <span class="custom-checkbox">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </span>
                            <span>${cat.name}</span>
                        </label>
                    </div>
                `).join('');

                hitokotoContainer.innerHTML = `
                    <div class="space-y-2">
                        <div>
                            <input type="radio" id="hitokoto-mode-default" name="hitokoto-mode" value="default" class="setting-radio-input">
                            <label for="hitokoto-mode-default" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>默认</span>
                                    <div class="setting-description">随机从所有分类中获取句子</div>
                                </div>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="hitokoto-mode-custom" name="hitokoto-mode" value="custom" class="setting-radio-input">
                            <label for="hitokoto-mode-custom" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>自定义</span>
                                    <div class="setting-description">手动选择想要获取的句子分类</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div id="hitokoto-custom-options">
                        <div class="border-t border-[var(--separator-color)] pt-3">
                            <div class="hitokoto-checkbox-container">
                                ${checkboxesHTML}
                            </div>
                             <div class="mt-4 flex items-center">
                                <div class="flex-shrink-0">
                                    <input type="checkbox" id="hitokoto-select-all" class="setting-radio-input hitokoto-checkbox-input">
                                    <label for="hitokoto-select-all" class="hitokoto-checkbox-label font-medium">
                                        <span class="custom-checkbox">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                        </span>
                                        <span>全选 / 全不选</span>
                                    </label>
                                </div>
                                <div class="flex-grow text-center">
                                    <div id="hitokoto-validation-msg" class="inline-flex items-center">
                                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                        <span>必须保留一个类型</span>
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <button id="hitokoto-save-btn" title="保存" class="p-2 rounded-full hover:bg-white/10 transition-all active:scale-95 relative w-9 h-9">
                                        <i class="fas fa-save fa-lg absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transition-opacity duration-300"></i>
                                        <div id="hitokoto-confirm-icon" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-300" style="color: var(--status-today);">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function updateTimeFormatUI() {
            const selectedFormat = appSettings.timeFormat;
            const radio = document.querySelector(`input[name="time-format"][value="${selectedFormat}"]`);
            if (radio) {
                radio.checked = true;
            }
        }

        function updateViewToggleUI() {
            const cityInputWrapper = document.getElementById('manual-city-input-wrapper');
            const cityInput = document.getElementById('weather-city-input');

            let selectedViewValue;
            if (appSettings.view === 'github') {
                selectedViewValue = 'github';
            } else { // view is 'weather'
                selectedViewValue = `weather-${appSettings.weather.source}`;
            }

            const radio = document.querySelector(`input[name="view-source"][value="${selectedViewValue}"]`);
            if (radio) {
                radio.checked = true;
            }

            const isManual = appSettings.view === 'weather' && appSettings.weather.source === 'manual';
            cityInputWrapper.style.maxHeight = isManual ? '60px' : '0';
            cityInputWrapper.style.marginTop = isManual ? '0.75rem' : '0';

            if (isManual) {
                cityInput.placeholder = appSettings.weather.city || '输入城市后回车 (例如: 北京)';
                cityInput.value = appSettings.weather.city || '';
            }
        }

        function updateHitokotoSettingsUI() {
            const { mode, categories } = appSettings.hitokoto;

            // Update radio buttons
            const radio = document.querySelector(`input[name="hitokoto-mode"][value="${mode}"]`);
            if (radio) {
                radio.checked = true;
            }

            // Show/hide custom options panel
            const customOptionsContainer = document.getElementById('hitokoto-custom-options');
            if (mode === 'custom') {
                customOptionsContainer.classList.add('open');
            } else {
                customOptionsContainer.classList.remove('open');
            }

            // Update checkboxes
            const allCheckboxes = document.querySelectorAll('input[name="hitokoto-category"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = categories.includes(checkbox.value);
            });

            // Update "Select All" checkbox state
            const selectAllCheckbox = document.getElementById('hitokoto-select-all');
            if (selectAllCheckbox) {
                const allCategories = Array.from(allCheckboxes).map(cb => cb.value);
                selectAllCheckbox.checked = categories.length === allCategories.length;
            }
        }

        function updateSettingsUI() {
            updateBgSettingsUI();
            // updateThemeSettingsUI(); // This is now handled by a dedicated initializer
            updateTimeFormatUI();
            updateViewToggleUI();
            updateHitokotoSettingsUI();
        }

        // --- [NEW] View (GitHub/Weather) Management ---
        function applyCurrentView() {
            const githubView = document.getElementById('github-view');
            const weatherView = document.getElementById('weather-view');
            
            if (appSettings.view === 'weather') {
                githubView.classList.add('hidden');
                weatherView.classList.remove('hidden');
                fetchAndDisplayWeather();
            } else {
                weatherView.classList.add('hidden');
                githubView.classList.remove('hidden');
            }
        }

        function applyCurrentTheme() {
            const body = document.body;
            // Clear all theme-* classes before adding the new one
            body.classList.forEach(className => {
                if (className.startsWith('theme-')) {
                    body.classList.remove(className);
                }
            });

            let themeToApply;
            if (appSettings.theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                themeToApply = prefersDark ? 'theme-dark' : 'theme-light';
            } else {
                themeToApply = `theme-${appSettings.theme}`;
            }
            body.classList.add(themeToApply);
        }

        // --- [NEW] Immersive Time View Logic ---
        let immersiveTimeInterval = null;

        function updateImmersiveTime() {
            // We need to call the original updateTime to get the most up-to-date values,
            // then copy them over. This avoids code duplication.
            updateTime();
            
            const timeDisplay = document.getElementById('time-display').innerHTML;
            const dateDisplay = document.getElementById('date-display').textContent;
            const greeting = document.getElementById('greeting').textContent;
            
            // For 12h format, the time is in a span, so innerHTML is needed.
            document.getElementById('immersive-time-display').innerHTML = timeDisplay;
            document.getElementById('immersive-date-display').textContent = dateDisplay;
            document.getElementById('immersive-greeting').textContent = greeting;
        }


        // --- 交互事件监听 ---
        function setupEventListeners() {
            // --- Theme Settings Listeners ---
            document.querySelectorAll('.setting-btn-group .setting-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    appSettings.theme = theme;
                    applyCurrentTheme();
                    saveSettings();
                    updateThemeSettingsUI(); // Update active state
                });
            });

            // --- Background Settings Listeners ---
            const bgRadioButtons = document.querySelectorAll('input[name="background-source"]');
            const defaultOptionsContainer = document.getElementById('default-bg-options');

            bgRadioButtons.forEach(radio => {
                radio.addEventListener('change', () => {
                    const source = radio.value;
                    appSettings.background.source = source;

                    if (source === 'default') {
                        defaultOptionsContainer.classList.add('open');
                        // When switching to default, immediately apply the currently selected default image
                        applyCurrentBackground();
                    } else {
                        defaultOptionsContainer.classList.remove('open');
                        applyCurrentBackground();
                    }
                    saveSettings();
                });
            });

            const thumbItems = defaultOptionsContainer.querySelectorAll('.thumb-item');
            thumbItems.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    // This listener only matters when the 'default' source is active
                    if (appSettings.background.source !== 'default') {
                        // To be safe, check the 'default' radio
                        document.getElementById('bg-radio-default').checked = true;
                        appSettings.background.source = 'default';
                    }
                    
                    const specifier = thumb.dataset.bgUrl;
                    appSettings.background.specifier = specifier;
                    
                    // Update UI immediately for responsiveness
                    thumbItems.forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                    
                    applyCurrentBackground();
                    saveSettings();
                });
            });

            // --- [NEW] Preview Buttons Listeners ---
            const refreshBtn = document.getElementById('bg-preview-refresh-btn');
            const downloadBtn = document.getElementById('bg-preview-download-btn');

            if (refreshBtn) {
                refreshBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    if (icon && !icon.classList.contains('fa-spin')) {
                        icon.classList.add('fa-spin');
                        applyCurrentBackground();
                    }
                });
            }

            if (downloadBtn) {
                downloadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    downloadImage(); // Call the new function without arguments
                });
            }


            // --- Time Format Listeners ---
            document.querySelectorAll('input[name="time-format"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    appSettings.timeFormat = radio.value;
                    saveSettings();
                    updateTime(); // Immediately update the main clock
                    // If weather view is active, re-render it to update sunrise/sunset
                    if (appSettings.view === 'weather') {
                        applyCurrentView();
                    }
                });
            });

            // --- View Toggle Listeners ---
            const cityInput = document.getElementById('weather-city-input');
            const saveCityBtn = document.getElementById('save-city-btn');
            const confirmCityIcon = document.getElementById('confirm-city-icon');
            const cityInputError = document.getElementById('city-input-error');

            const saveCity = () => {
                const newCity = cityInput.value.trim();

                // Validation for length
                if (newCity.length > 20) {
                    cityInput.classList.add('invalid');
                    cityInputError.textContent = '内容过长 (最多20个字符)';
                    cityInputError.classList.add('visible');
                    cityInputError.classList.remove('hidden');
                    return;
                }

                // Clear previous errors
                cityInput.classList.remove('invalid');
                cityInputError.classList.remove('visible');
                // Use a timeout to hide it after the transition
                setTimeout(() => { cityInputError.classList.add('hidden'); }, 200);

                // Save logic
                appSettings.weather.city = newCity;
                applyCurrentView();
                saveSettings();
                cityInput.blur();

                // Feedback animation
                saveCityBtn.style.opacity = '0';
                confirmCityIcon.classList.remove('hidden');
                setTimeout(() => { 
                    confirmCityIcon.style.opacity = '1';
                    confirmCityIcon.style.transform = 'scale(1)';
                }, 10);

                setTimeout(() => {
                    confirmCityIcon.style.opacity = '0';
                    confirmCityIcon.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        confirmCityIcon.classList.add('hidden');
                        saveCityBtn.style.opacity = '1';
                    }, 200);
                }, 2000); 
            };

            document.querySelectorAll('input[name="view-source"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const value = radio.value;
                    if (value === 'github') {
                        appSettings.view = 'github';
                    } else {
                        appSettings.view = 'weather';
                        if (value === 'weather-auto') {
                            appSettings.weather.source = 'auto';
                            appSettings.weather.city = null; 
                        } else { // weather-manual
                            appSettings.weather.source = 'manual';
                        }
                    }
                    
                    applyCurrentView();
                    updateViewToggleUI();
                    saveSettings();
                });
            });

            cityInput.addEventListener('focus', () => {
                cityInput.classList.remove('invalid');
                cityInputError.classList.remove('visible');
                setTimeout(() => { cityInputError.classList.add('hidden'); }, 200);
            });

            cityInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveCity();
                }
            });

            saveCityBtn.addEventListener('click', saveCity);


            // --- Settings Modal Logic ---
            const openSettingsBtn = document.getElementById('open-settings-btn');
            const settingsOverlay = document.getElementById('settings-overlay');
            const closeSettingsBtn = document.getElementById('close-settings-btn');

            function openSettings() {
                updateSettingsUI(); // Refresh UI to match saved settings
                const settingsWindow = document.getElementById('settings-window');
                
                // [REMOVED] The problematic height calculation is gone.
                // The height is now controlled by CSS for consistency.

                document.body.classList.add('settings-open');

                // Initialize SimpleBar on the content area if it hasn't been already
                if (!settingsSimpleBar) {
                    const contentWrapper = settingsWindow.querySelector('[data-simplebar]');
                    if (contentWrapper) {
                        settingsSimpleBar = new SimpleBar(contentWrapper);
                        const scrollElement = settingsSimpleBar.getScrollElement();
                        const maskContainer = contentWrapper; // The element with the mask is the one with data-simplebar
                        const maxFadeSize = 24; // Corresponds to the CSS variable

                        const updateSettingsMask = () => {
                            const { scrollTop, scrollHeight, clientHeight } = scrollElement;
                            const tolerance = 1;
                            // If content is not scrollable, remove fades
                            if (scrollHeight <= clientHeight + tolerance) {
                                maskContainer.style.setProperty('--fade-top-size', '0px');
                                maskContainer.style.setProperty('--fade-bottom-size', '0px');
                                return;
                            }
                            const scrollBottom = scrollHeight - clientHeight - scrollTop;
                            const topFade = Math.min(scrollTop, maxFadeSize);
                            const bottomFade = Math.min(scrollBottom, maxFadeSize);
                            maskContainer.style.setProperty('--fade-top-size', `${topFade}px`);
                            maskContainer.style.setProperty('--fade-bottom-size', `${bottomFade}px`);
                        };

                        scrollElement.addEventListener('scroll', updateSettingsMask);
                        // Call once to set initial state, delayed to allow rendering
                        setTimeout(updateSettingsMask, 50);
                    }
                }
            }

            function closeSettings() {
                document.body.classList.remove('settings-open');
                const bgPreviewContainer = document.getElementById('background-preview-container');
                if (bgPreviewContainer) {
                    bgPreviewContainer.classList.remove('visible');
                }
            }

            openSettingsBtn.addEventListener('click', openSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);

            settingsOverlay.addEventListener('click', (e) => {
                if (e.target === settingsOverlay) {
                    closeSettings();
                }
            });

                        document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Priority 0: Close immersive view
                    if (document.body.classList.contains('immersive-active')) {
                        // Programmatically click the exit button to ensure cleanup logic runs
                        document.getElementById('exit-immersive-btn').click();
                        return;
                    }
                    
                    // Priority 1: Close settings modal if it's open
                    if (document.body.classList.contains('settings-open')) {
                        closeSettings();
                        return;
                    }

                    // Priority 2: Close holiday list card if it's open
                    if (!holidayListCard.classList.contains('hidden')) {
                        holidayListCard.classList.add('hidden');
                        rightColumn.classList.remove('hidden');
                        animateRightColumnIn();
                        return;
                    }

                    // Priority 3: Close time capsule card if it's open
                    if (!timeCapsuleCard.classList.contains('hidden')) {
                        timeCapsuleCard.classList.add('hidden');
                        rightColumn.classList.remove('hidden');
                        animateRightColumnIn();
                        return;
                    }
                }
            });
            // --- End Settings Modal Logic ---

            const animateRightColumnIn = () => {
                const elementsToAnimate = rightColumn.querySelectorAll(':scope > div');
                elementsToAnimate.forEach(el => {
                    el.classList.remove('bounce-in');
                    void el.offsetWidth;
                    el.classList.add('bounce-in');
                });
            };

            // 切换到时光胶囊
            profileCard.addEventListener('click', (e) => { // 1. 接收 event 对象，命名为 e
                // 2. 增加判断：如果点击的目标是 <a> 标签或其内部元素，则直接返回
                if (e.target.closest('a')) {
                    return;
                }

                // If the time capsule is already visible, hide it and show the main column.
                if (!timeCapsuleCard.classList.contains('hidden')) {
                    timeCapsuleCard.classList.add('hidden');
                    rightColumn.classList.remove('hidden');
                    animateRightColumnIn();
                } else { // Otherwise, show it.
                    rightColumn.classList.add('hidden');
                    holidayListCard.classList.add('hidden');
                    timeCapsuleCard.classList.remove('hidden');
                    timeCapsuleCard.classList.add('bounce-in');
                    updateTimeCapsule();
                }
            });

            // 关闭时光胶囊
            document.getElementById('close-time-capsule').addEventListener('click', (e) => {
                e.stopPropagation();
                timeCapsuleCard.classList.add('hidden');
                rightColumn.classList.remove('hidden');
                animateRightColumnIn();
            });

            // 切换到节日列表
            countdownCard.addEventListener('click', () => {
                if (!holidayListCard.classList.contains('hidden')) {
                    holidayListCard.classList.add('hidden');
                    rightColumn.classList.remove('hidden');
                    animateRightColumnIn();
                } else {
                    hasManuallyScrolled = false; // Reset scroll flag
                    rightColumn.classList.add('hidden');
                    timeCapsuleCard.classList.add('hidden');
                    holidayListCard.classList.remove('hidden');
                    holidayListCard.classList.add('bounce-in');
                    holidayListDisplayedYear = new Date().getFullYear();
                    displayHolidayList(holidayListDisplayedYear, true);
                    updateWarningMessage(holidayListDisplayedYear);
                    
                    // Only initialize SimpleBar and listeners once to prevent bugs
                    if (!holidayListSimpleBar) {
                        holidayListSimpleBar = new SimpleBar(document.getElementById('holiday-list-container-wrapper'));
                        const scrollElement = holidayListSimpleBar.getScrollElement();
                        const maskContainer = document.getElementById('holiday-list-container-wrapper');
                        const maxFadeSize = 40;

                        const updateMask = () => {
                            const { scrollTop, scrollHeight, clientHeight } = scrollElement;
                            const tolerance = 1;
                            if (scrollHeight <= clientHeight + tolerance) {
                                maskContainer.style.setProperty('--fade-top-size', '0px');
                                maskContainer.style.setProperty('--fade-bottom-size', '0px');
                                return;
                            }
                            const scrollBottom = scrollHeight - clientHeight - scrollTop;
                            const topFade = Math.min(scrollTop, maxFadeSize);
                            const bottomFade = Math.min(scrollBottom, maxFadeSize);
                            maskContainer.style.setProperty('--fade-top-size', `${topFade}px`);
                            maskContainer.style.setProperty('--fade-bottom-size', `${bottomFade}px`);
                        };

                        scrollElement.addEventListener('scroll', updateMask);
                        
                        // Also handle the original manual scroll flag listener
                        scrollElement.addEventListener('scroll', () => {
                            hasManuallyScrolled = true;
                        }, { once: true });

                        // Call once after a short delay to ensure layout is calculated correctly
                        setTimeout(updateMask, 50);
                    }

                    // Initial scroll is now animated
                    setTimeout(() => {
                        scrollToTargetFestival(true);
                    }, 50);
                }
            });

            // 关闭节日列表
            document.getElementById('close-holiday-list').addEventListener('click', (e) => {
                e.stopPropagation();
                holidayListCard.classList.add('hidden');
                rightColumn.classList.remove('hidden');
                animateRightColumnIn();
            });

            // "回到今天"按钮逻辑
            document.getElementById('back-to-today-btn').addEventListener('click', () => {
                const currentYear = new Date().getFullYear();
                if (holidayListDisplayedYear !== currentYear) {
                    handleYearChange(currentYear);
                }
                scrollToTargetFestival(true);
            });

            // [NEW] Warning message logic
            const updateWarningMessage = (year) => {
                const yearWarning = document.getElementById('year-range-warning');
                if (year < 1900 || year > 2049) {
                    yearWarning.innerHTML = `<svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span>${year}年的农历节日可能不准确</span>`;
                    if (yearWarning.classList.contains('hidden')) {
                        yearWarning.classList.remove('hidden', 'animate-fade-out');
                        yearWarning.classList.add('animate-fade-in');
                        setTimeout(() => yearWarning.classList.remove('animate-fade-in'), 100);
                    }
                } else {
                    if (!yearWarning.classList.contains('hidden')) {
                        yearWarning.classList.add('animate-fade-out');
                        setTimeout(() => {
                            yearWarning.classList.add('hidden');
                            yearWarning.classList.remove('animate-fade-out');
                        }, 100);
                    }
                }
            };

            // 节日列表年份切换
            const handleYearChange = (newYear) => {
                const yearBeforeChange = holidayListDisplayedYear;
                const currentSystemYear = new Date().getFullYear();
                
                holidayListDisplayedYear = newYear;
                displayHolidayList(holidayListDisplayedYear, true);
                updateWarningMessage(newYear); // Centralized call to handle warning

                // Check for smart scroll condition
                if (hasManuallyScrolled && holidayListDisplayedYear === currentSystemYear && yearBeforeChange !== currentSystemYear) {
                    scrollToTargetFestival(true);
                    hasManuallyScrolled = false; // Reset flag after use
                }
            };

            document.getElementById('prev-year').addEventListener('click', () => {
                handleYearChange(holidayListDisplayedYear - 1);
            });
            document.getElementById('next-year').addEventListener('click', () => {
                handleYearChange(holidayListDisplayedYear + 1);
            });

            // --- [NEW] Year Input Logic ---
            const enterEditMode = () => {
                yearDisplayControls.classList.add('animate-fade-out');
                setTimeout(() => {
                    yearDisplayControls.classList.add('hidden');
                    yearDisplayControls.classList.remove('animate-fade-out');

                    yearEditControls.classList.remove('hidden');
                    yearEditControls.classList.add('animate-fade-in');
                    yearInput.value = holidayListDisplayedYear;
                    yearInput.focus();
                    yearInput.select();

                    setTimeout(() => {
                        yearEditControls.classList.remove('animate-fade-in');
                    }, 100);
                }, 100);
            };

            const exitEditMode = () => {
                yearInput.classList.remove('invalid');
                yearInputError.classList.add('hidden');

                yearEditControls.classList.add('animate-fade-out');
                setTimeout(() => {
                    yearEditControls.classList.add('hidden');
                    yearEditControls.classList.remove('animate-fade-out');

                    yearDisplayControls.classList.remove('hidden');
                    yearDisplayControls.classList.add('animate-fade-in');
                    setTimeout(() => {
                        yearDisplayControls.classList.remove('animate-fade-in');
                    }, 100);
                }, 100);
            };

            const submitNewYear = () => {
                const newYear = parseInt(yearInput.value, 10);
                // Relaxed validation as per user request.
                if (!isNaN(newYear) && newYear > 0 && newYear < 9999) {
                    handleYearChange(newYear);
                    exitEditMode();
                } else {
                    yearInputError.textContent = '请输入有效的4位年份';
                    yearInputError.classList.remove('hidden');
                    yearInput.classList.add('invalid');
                    setTimeout(() => {
                        yearInput.classList.remove('invalid');
                    }, 500);
                    setTimeout(() => {
                         yearInputError.classList.add('hidden');
                    }, 2500);
                }
            };

            holidayListYearSpan.addEventListener('click', enterEditMode);
            confirmYearBtn.addEventListener('click', submitNewYear);
            cancelYearBtn.addEventListener('click', exitEditMode);
            yearInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { submitNewYear(); }
                else if (e.key === 'Escape') { exitEditMode(); }
            });

            // 点击一言卡片刷新
            document.getElementById('hitokoto-card').addEventListener('click', fetchHitokoto);
            
            // 天气刷新按钮
            document.getElementById('weather-refresh-btn').addEventListener('click', () => {
                setWeatherSpinner(true);
                fetchAndDisplayWeather();
            });

            // --- [NEW] Hitokoto Settings Listeners ---
            const hitokotoModeRadios = document.querySelectorAll('input[name="hitokoto-mode"]');
            const customOptionsContainer = document.getElementById('hitokoto-custom-options');
            const categoryCheckboxes = document.querySelectorAll('input[name="hitokoto-category"]');
            const selectAllCheckbox = document.getElementById('hitokoto-select-all');
            const saveBtn = document.getElementById('hitokoto-save-btn');

            hitokotoModeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const newMode = radio.value;
                    appSettings.hitokoto.mode = newMode;
                    if (newMode === 'default') {
                        customOptionsContainer.classList.remove('open');
                        saveSettings();
                        fetchHitokoto(); // Immediately fetch on switching to default
                    } else {
                        customOptionsContainer.classList.add('open');
                        // If entering custom mode and no categories are checked (e.g. first time), check the first one.
                        const checkedCount = document.querySelectorAll('input[name="hitokoto-category"]:checked').length;
                        if (checkedCount === 0) {
                            const firstCategoryCheckbox = document.getElementById('hitokoto-cat-a');
                            if (firstCategoryCheckbox) {
                                firstCategoryCheckbox.checked = true;
                            }
                        }
                    }
                });
            });

            selectAllCheckbox.addEventListener('change', () => {
                categoryCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
            });

            categoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checkedCount = document.querySelectorAll('input[name="hitokoto-category"]:checked').length;
                    
                    // Prevent unchecking the last box
                    if (checkedCount === 0) {
                        checkbox.checked = true;
                    }

                    // Update "Select All" checkbox state
                    selectAllCheckbox.checked = checkedCount === categoryCheckboxes.length;
                });
            });

            saveBtn.addEventListener('click', () => {
                const selectedCategories = Array.from(document.querySelectorAll('input[name="hitokoto-category"]:checked')).map(cb => cb.value);
                
                if (selectedCategories.length === 0) {
                    const validationMsg = document.getElementById('hitokoto-validation-msg');
                    // Add the class to trigger the animation
                    validationMsg.classList.add('visible');
                    // Remove the class after the animation is done to allow it to be re-triggered
                    setTimeout(() => {
                        validationMsg.classList.remove('visible');
                    }, 3000);
                    return;
                }

                appSettings.hitokoto.categories = selectedCategories;
                saveSettings();
                fetchHitokoto();

                // --- [FIX] Refined Save button animation & spam prevention ---
                const saveIcon = saveBtn.querySelector('i');
                const confirmIcon = document.getElementById('hitokoto-confirm-icon');
                
                saveBtn.disabled = true; // Disable button
                saveIcon.style.opacity = '0';
                
                setTimeout(() => {
                    confirmIcon.style.opacity = '1';

                    setTimeout(() => {
                        confirmIcon.style.opacity = '0';
                        setTimeout(() => {
                            saveIcon.style.opacity = '1';
                            saveBtn.disabled = false; // Re-enable button
                        }, 300);
                    }, 3000);
                }, 300);
            });

            // --- [NEW] Immersive Time Listeners ---
            const immersiveView = document.getElementById('immersive-time-view');
            const timeCard = document.getElementById('time-card');
            const exitImmersiveBtn = document.getElementById('exit-immersive-btn');

            const handleImmersiveMouseMove = (event) => {
                const { clientX, clientY } = event;
                const { innerWidth, innerHeight } = window;
                if (clientX > innerWidth / 2 && clientY < innerHeight / 2) {
                    exitImmersiveBtn.classList.add('visible');
                } else {
                    exitImmersiveBtn.classList.remove('visible');
                }
            };

            const handleImmersiveMouseLeave = () => {
                exitImmersiveBtn.classList.remove('visible');
            };

            timeCard.addEventListener('click', (event) => {
                // Do not trigger if a sub-element that is a link was clicked
                if (event.target.closest('a')) {
                    return;
                }
                document.body.classList.add('immersive-active');
                updateImmersiveTime(); // Initial population
                if (immersiveTimeInterval) clearInterval(immersiveTimeInterval);
                immersiveTimeInterval = setInterval(updateImmersiveTime, 1000);

                // Add mouse listeners for the exit button
                immersiveView.addEventListener('mousemove', handleImmersiveMouseMove);
                immersiveView.addEventListener('mouseleave', handleImmersiveMouseLeave);
            });

            exitImmersiveBtn.addEventListener('click', () => {
                document.body.classList.remove('immersive-active');
                if (immersiveTimeInterval) {
                    clearInterval(immersiveTimeInterval);
                    immersiveTimeInterval = null;
                }
                
                // Clean up button visibility and remove listeners
                exitImmersiveBtn.classList.remove('visible');
                immersiveView.removeEventListener('mousemove', handleImmersiveMouseMove);
                immersiveView.removeEventListener('mouseleave', handleImmersiveMouseLeave);
            });
        }

        // --- 页面加载时执行的函数 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            // Initialize Faders
            const bgLayers = document.querySelectorAll('#bg-wrapper .bg-layer');
            backgroundFader = createCrossfader(Array.from(bgLayers));

            // --- [FIX] Correct Initialization Order ---
            // 1. Build the settings panel UI first, so other functions can find its elements.
            setupSettingsUI();
            setupEventListeners();

            // 2. Pre-calculate the theme slider's correct position before it's ever shown.
            initializeThemeSlider();
            
            // 3. Now apply all other settings.
            applyCurrentTheme();
            applyCurrentBackground();
            applyCurrentView();
            updateSettingsUI();

            // 3. Initial data fetches and updates.
            updateTime();
            updateGreeting();
            updateCountdown();
            fetchHitokoto();
            setupGitHubChartLoader();
            updateSiteRuntime();
            updateTimeCapsule();
            
            // 4. Defer non-critical layout calculations.
            setTimeout(() => {
                if (window.innerWidth >= 1024) {
                    cachedRightColumnHeight = rightColumn.offsetHeight;
                }
            }, 100);
            
            setInterval(updateTime, 1000);
            setInterval(updateSiteRuntime, 1000);
            setInterval(updateGreeting, 1800000); 
            setInterval(updateCountdown, 3600000); 
            setInterval(updateTimeCapsule, 60000);

            // [NEW] Auto-refresh weather data every 30 minutes
            setInterval(() => {
                if (appSettings.view === 'weather') {
                    fetchAndDisplayWeather();
                }
            }, 30 * 60 * 1000);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (appSettings.theme === 'system') {
                    applyCurrentTheme();
                }
            });
        });
    </script>
</body>
</html>
