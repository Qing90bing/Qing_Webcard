<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qing90bingÁöÑ‰∏ªÈ°µ</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css" />
    <script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="bg-wrapper">
        <div class="bg-layer"></div>
        <div class="bg-layer"></div>
    </div>
    <div id="main-wrapper">
        <div class="flex items-center justify-center min-h-screen px-8 sm:px-16 lg:px-24">
            <main class="grid grid-cols-1 lg:grid-cols-4 gap-5 w-full max-w-6xl">

                <div class="lg:col-span-1 space-y-5 flex flex-col">
                    <div id="about-card-trigger" class="glass-card flex items-center justify-center p-5 gap-4 cursor-pointer">
                        <h1 class="text-3xl font-bold" style="color: var(--text-color-primary);">Qing90bing</h1>
                    </div>

                    <div id="countdown-card" class="glass-card p-5 cursor-pointer flex flex-col h-48">
                        <h2 class="text-xl font-semibold mb-3 text-center flex-shrink-0" style="color: var(--text-color-primary);">Êó•ÂéÜÂÄíËÆ°Êó∂</h2>
                        <div id="countdown-display" class="text-center text-lg leading-relaxed flex-col justify-center items-center" style="color: var(--accent-color);">Ê≠£Âú®ËÆ°ÁÆó...</div>
                    </div>
                    
                    <div id="profile-card" class="glass-card p-5 flex flex-col justify-between flex-grow cursor-pointer">
                        <div class="relative px-4 py-2">
                            <span class="absolute top-0 left-0 text-6xl font-serif -translate-y-4 -translate-x-2 select-none" style="color: var(--separator-color);">‚Äú</span>
                            <p class="text-lg" style="color: var(--text-color-primary);">Hello, World!</p>
                            <p class="mt-1" style="color: var(--text-color-secondary);">‰∏Ä‰∏™Âª∫Á´ã‰∫é21‰∏ñÁ∫™ÁöÑÂ∞èÁ´ôÔºåÂ≠òÊ¥ª‰∫é‰∫íËÅîÁΩëÁöÑËæπÁºò:)</p>
                            <span class="absolute bottom-0 right-0 text-6xl font-serif translate-y-6 translate-x-2 select-none" style="color: var(--separator-color);">‚Äù</span>
                        </div>
                        <div class="mt-8">
                            <p class="text-sm " style="color: var(--text-color-secondary);">‰∏éÊàëËÅîÁ≥ª:</p>
                            <div class="flex items-center gap-2">
                                <a href="https://github.com/Qing90bing" target="_blank" data-tooltip="GitHub" class="tooltip-container p-2 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                    <i class="fa-brands fa-github fa-xl"></i>
                                </a>
                                <a href="mailto:1879495519@qq.com" target="_blank" data-tooltip="Email" class="tooltip-container p-2 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                    <i class="fa-solid fa-envelope fa-xl"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="right-column" class="lg:col-span-3 space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div id="time-card" class="glass-card p-5 flex flex-col justify-center items-center cursor-pointer">
                            <div id="date-display" class="text-lg" style="color: var(--text-color-secondary);"></div>
                            <div id="time-display" class="text-5xl lg:text-6xl my-1" style="color: var(--text-color-primary);"></div>
                            <div id="greeting" class="text-sm" style="color: var(--text-color-secondary);"></div>
                        </div>
                        <div id="hitokoto-card" class="glass-card p-5 flex flex-col justify-center cursor-pointer min-h-[120px] md:min-h-full">
                            <p id="hitokoto-text" class="text-center transition-opacity duration-500 ease-in-out" style="color: var(--text-color-primary);">Ê≠£Âú®Âä†ËΩΩ‰∏ÄË®Ä...</p>
                            <p id="hitokoto-from" class="text-right text-sm mt-2 transition-opacity duration-500 ease-in-out" style="color: var(--text-color-secondary);"></p>
                        </div>
                    </div>
                    
                    <div class="glass-card p-5">
                        <div id="main-card-view-wrapper">
                            <!-- GitHub View -->
                            <div id="github-view">
                                <h2 class="text-xl font-semibold mb-3" style="color: var(--text-color-primary);">
                                   <svg class="inline-block w-6 h-6 mr-2 -mt-1" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                                   GitHub Ë¥°ÁåÆÂõæ
                                </h2>
                                <div id="gh-chart-container" class="w-full rounded-md p-2 min-h-[140px] flex items-center justify-center" style="background-color: var(--progress-bar-bg);">
                                    <div id="gh-chart-spinner"></div>
                                    <div id="gh-chart-loading" class="hidden text-center">
                                        <p style="color: var(--text-color-secondary);">Ê≠£Âú®Ëé∑Âèñ GitHub Ë¥°ÁåÆÂõæ...</p>
                                    </div>
                                    <div id="gh-chart-wrapper" class="relative">
                                        <div id="gh-chart-error" class="absolute inset-0 hidden flex-col items-center justify-center cursor-pointer rounded-md transition-all icon-btn">
                                            <i class="fas fa-sync-alt fa-2x" style="color: var(--text-color-tertiary);"></i>
                                            <p id="gh-chart-error-message" class="mt-2 text-sm" style="color: var(--text-color-secondary);">Âä†ËΩΩË¥°ÁåÆÂõæÂ§±Ë¥•ÔºåÁÇπÂáªÈáçËØï</p>
                                        </div>
                                        <a href="https://github.com/Qing90bing" target="_blank" id="gh-chart-link" class="invisible">
                                            <img id="gh-chart-img" data-src="https://ghchart.rshah.org/Qing90bing?theme=dark" alt="Qing90bing's GitHub Contribution Graph" class="w-full h-full block opacity-0 transition-opacity duration-500"/>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <!-- Weather View -->
                            <div id="weather-view" class="hidden">
                                 <h2 class="text-xl font-semibold mb-3" style="color: var(--text-color-primary);"><svg class="inline-block w-6 h-6 mr-2 -mt-1" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Pro v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2025 Fonticons, Inc.--><path d="M32 400C32 479.5 96.5 544 176 544L480 544C550.7 544 608 486.7 608 416C608 364.4 577.5 319.9 533.5 299.7C540.2 286.6 544 271.7 544 256C544 203 501 160 448 160C430.3 160 413.8 164.8 399.6 173.1C375.5 127.3 327.4 96 272 96C192.5 96 128 160.5 128 240C128 248 128.7 255.9 129.9 263.5C73 282.7 32 336.6 32 400z"/></svg>Â§©Ê∞î‰ø°ÊÅØ</h2>
                                 <div id="weather-content-wrapper" class="w-full rounded-md p-4 relative min-h-[140px]" style="background-color: var(--progress-bar-bg);">
                                    <div class="weather-hover-zone absolute top-0 left-0 w-1/2 h-full z-10"></div>
                                    <button id="weather-refresh-btn" data-tooltip="ÊâãÂä®Âà∑Êñ∞" class="tooltip-container absolute top-3 left-3 w-8 h-8 flex items-center justify-center rounded-full text-white/60 hover:text-white icon-btn transition-all duration-200 active:scale-90 z-20 opacity-0 invisible"><i class="fas fa-sync-alt"></i></button>
                                    <div id="weather-loader"></div>
                                    <div id="weather-data-container">
                                        <!-- Weather content will be injected here -->
                                        <p style="color: var(--text-color-secondary);">Ê≠£Âú®Âä†ËΩΩÂ§©Ê∞î...</p>
                                    </div>
                                 </div>
                            </div>
                        </div>

                        <h2 class="text-xl font-semibold mb-1 mt-4" style="color: var(--text-color-primary);">
                            <svg class="inline-block w-6 h-6 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                            ÁΩëÁ´ôÂàóË°®
                        </h2>
                        <div id="link-slider-container">
                            <div class="slider-wrapper">
                                <div class="slider-track">
                                    <a href="https://qing90bing.github.io/QingNoteblog/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 active:scale-95 transform-gpu card-slide" style="color: var(--text-color-primary);">
                                        <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span class="font-medium">ÂçöÂÆ¢</span>
                                    </a>
                                    <a href="https://qing90bing.github.io/Qing_Music/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 active:scale-95 transform-gpu card-slide" style="color: var(--text-color-primary);">
                                        <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3"></path></svg>
                                        <span class="font-medium">Èü≥‰πê</span>
                                    </a>
                                    <a href="https://qing90bing.github.io/Qing_Start/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 active:scale-95 transform-gpu card-slide" style="color: var(--text-color-primary);">
                                        <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                        <span class="font-medium">Ëµ∑ÂßãÈ°µ</span>
                                    </a>
                                    <a href="https://qing90bing.github.io/Qing_Lab/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 active:scale-95 transform-gpu card-slide" style="color: var(--text-color-primary);">
                                        <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="currentColor" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M96 24c0-13.3 10.7-24 24-24L328 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-8 0 0 169.6 120.7 211.2c4.8 8.4 7.3 17.9 7.3 27.6 0 30.7-24.9 55.6-55.6 55.6L55.6 512c-30.7 0-55.6-24.9-55.6-55.6 0-9.7 2.5-19.2 7.3-27.6L128 217.6 128 48 120 48c-13.3 0-24-10.7-24-24zm80 24l0 176c0 4.2-1.1 8.3-3.2 11.9l-38.9 68.1 180.1 0-38.9-68.1c-2.1-3.6-3.2-7.7-3.2-11.9l0-176-96 0zM106.5 352L49 452.6c-.7 1.1-1 2.4-1 3.8 0 4.2 3.4 7.6 7.6 7.6l336.8 0c4.2 0 7.6-3.4 7.6-7.6 0-1.3-.3-2.6-1-3.8l-57.5-100.6-235 0z"/></svg>
                                        <span class="font-medium">ÂÆûÈ™åÈ°πÁõÆ</span>
                                    </a>
                                </div>
                            </div>
                            <div class="slider-dots"></div>
                        </div>
                    </div>
                </div>

                <!-- Holiday List Card -->
                <div id="holiday-list-card" class="lg:col-span-3 glass-card p-5 hidden flex flex-col">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold" style="color: var(--text-color-primary);"><svg fill="currentColor" class="inline-block w-6 h-6 mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128 0c17.7 0 32 14.3 32 32V64H288V32c0-17.7 14.3-32 32-32s32 14.3 32 32V64h48c26.5 0 48 21.5 48 48v48H0V112C0 85.5 21.5 64 48 64H96V32c0-17.7 14.3-32 32-32zM0 192H448V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V192zm64 80v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16zm128 0v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H208c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H336zM64 400v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H208zm112 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H336c-8.8 0-16 7.2-16 16z"/></svg>ËäÇÊó•ÂÄíÊï∞</h2>
                        <div class="flex items-center gap-3">
                            <button id="back-to-today-btn" data-tooltip="ÂõûÂà∞‰ªäÂ§©" class="tooltip-container w-8 h-8 rounded-full transition-all active:scale-95 flex-shrink-0 flex items-center justify-center font-bold text-white text-base">‰ªä</button>
                            <button id="close-holiday-list" data-tooltip="ÂÖ≥Èó≠" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-center items-center h-8 relative">
                        <!-- Display Mode -->
                        <div id="year-display-controls" class="flex items-center gap-4 text-lg">
                            <button id="prev-year" data-tooltip="‰∏ä‰∏ÄÂπ¥" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <span id="holiday-list-year" class="font-bold w-16 text-center cursor-pointer" style="color: var(--text-color-primary);"></span>
                            <button id="next-year" data-tooltip="‰∏ã‰∏ÄÂπ¥" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <!-- Edit Mode -->
                        <div id="year-edit-controls" class="hidden flex items-center gap-2 text-lg">
                            <input type="text" id="year-input" class="font-bold w-20 text-center rounded-md border focus:ring-0 px-1 py-0.5 text-lg" style="background-color: var(--card-bg-color); color: var(--text-color-primary); border-color: var(--separator-color); outline: none;">
                            <button id="confirm-year-btn" data-tooltip="Á°ÆËÆ§" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--status-today);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                            <button id="cancel-year-btn" data-tooltip="ÂèñÊ∂à" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: #ef4444;">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <!-- Error Message for input validation -->
                        <div id="year-input-error" class="hidden absolute -bottom-6 text-sm font-bold" style="color: #ef4444;"></div>
                    </div>
                    <div class="relative flex-1 min-h-0">
                        <!-- Warning is now absolutely positioned inside this container -->
                        <div id="year-range-warning" class="absolute top-0 left-0 right-0 z-10 hidden flex items-center justify-center text-amber-400 text-sm font-semibold"></div>
                        <div id="holiday-list-container-wrapper" class="absolute inset-0">
                           <div id="holiday-list-container" class="space-y-4">
                               <!-- Holiday list will be dynamically inserted here -->
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Time Capsule Card -->
                <div id="time-capsule-card" class="lg:col-span-3 glass-card p-5 hidden flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold" style="color: var(--text-color-primary);"><svg fill="currentColor" class="inline-block w-6 h-6 mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M0 32C0 14.3 14.3 0 32 0H64 320h32c17.7 0 32 14.3 32 32s-14.3 32-32 32V75c0 42.4-16.9 83.1-46.9 113.1L237.3 256l67.9 67.9c30 30 46.9 70.7 46.9 113.1v11c17.7 0 32 14.3 32 32s-14.3 32-32 32H320 64 32c-17.7 0-32-14.3-32-32s14.3-32 32-32V437c0-42.4 16.9-83.1 46.9-113.1L146.7 256 78.9 188.1C48.9 158.1 32 117.4 32 75V64C14.3 64 0 49.7 0 32zM96 64V75c0 25.5 10.1 49.9 28.1 67.9L192 210.7l67.9-67.9c18-18 28.1-42.4 28.1-67.9V64H96zm0 384H288V437c0-25.5-10.1-49.9-28.1-67.9L192 301.3l-67.9 67.9c-18 18-28.1 42.4-28.1 67.9v11z"/></svg>Êó∂ÂÖâËÉ∂Âõä</h2>
                        <div class="flex items-center gap-4">
                            <button id="open-settings-btn" data-tooltip="ËÆæÁΩÆ" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <i class="fas fa-gear fa-lg w-6 h-6 flex items-center justify-center"></i>
                            </button>
                            <button id="close-time-capsule" data-tooltip="ÂÖ≥Èó≠" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-5">
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>‰ªäÊó•Â∑≤Ëøá <span id="day-passed">0</span> Â∞èÊó∂</span>
                                <span>Ââ©‰Ωô <span id="day-left">24</span> Â∞èÊó∂</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="day-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="day-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>Êú¨Âë®Â∑≤Ëøá <span id="week-passed">0</span> Â§©</span>
                                <span>Ââ©‰Ωô <span id="week-left">7</span> Â§©</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="week-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="week-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>Êú¨ÊúàÂ∑≤Ëøá <span id="month-passed">0</span> Â§©</span>
                                <span>Ââ©‰Ωô <span id="month-left">30</span> Â§©</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="month-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="month-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>‰ªäÂπ¥Â∑≤Ëøá <span id="year-passed">0</span> Â§©</span>
                                <span>Ââ©‰Ωô <span id="year-left">365</span> Â§©</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="year-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="year-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                    </div>
                    <!-- [NEW] ‰ªäÊó•‰∫∫ÂìÅ -->
                    <div class="border-t border-white/10 pt-5 mt-5">
                        <h2 class="text-xl font-semibold mb-2 flex items-center" style="color: var(--text-color-primary);">
                            <svg class="inline-block w-6 h-6 mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor"><path d="M224 224C224 171 267 128 320 128C373 128 416 171 416 224C416 266.7 388.1 302.9 349.5 315.4C321.1 324.6 288 350.7 288 392L288 416C288 433.7 302.3 448 320 448C337.7 448 352 433.7 352 416L352 392C352 390.3 352.6 387.9 355.5 384.7C358.5 381.4 363.4 378.2 369.2 376.3C433.5 355.6 480 295.3 480 224C480 135.6 408.4 64 320 64C231.6 64 160 135.6 160 224C160 241.7 174.3 256 192 256C209.7 256 224 241.7 224 224zM320 576C342.1 576 360 558.1 360 536C360 513.9 342.1 496 320 496C297.9 496 280 513.9 280 536C280 558.1 297.9 576 320 576z"/></svg>
                            ‰ªäÊó•‰∫∫ÂìÅ
                        </h2>
                        <div id="luck-container" class="flex flex-col sm:flex-row items-center justify-center h-40 sm:h-28 transition-all duration-500 ease-in-out gap-4">
                            <div id="particle-container"></div>
                            <button id="luck-button" class="text-white font-bold py-2 px-6 rounded-full transform active:scale-90 whitespace-nowrap flex-shrink-0">
                                ÂºÄÁõ≤Áõí
                            </button>

                            <div id="luck-result" class="text-center text-lg" style="color: var(--text-color-primary); overflow: hidden;">
                                <!-- Result will be injected here -->
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto text-center" style="color: var(--text-color-secondary);">
                        <p id="site-runtime-display">Ê≠£Âú®ËÆ°ÁÆó...</p>
                    </div>
                </div>

                <!-- About Card -->
                <div id="about-card" class="lg:col-span-3 glass-card p-5 hidden flex flex-col">
                    <!-- Header with Title and Close Button -->
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold" style="color: var(--text-color-primary);">
                            <i class="fas fa-info-circle inline-block w-6 h-6 mr-2 -mt-1"></i>ÂÖ≥‰∫é
                        </h2>
                        <button id="close-about-card" data-tooltip="ÂÖ≥Èó≠" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Main Content Area -->
                    <div class="flex-1 flex flex-col sm:flex-row gap-8 sm:gap-4 mt-4 sm:mt-0">
                        <!-- Left Column -->
                        <div class="flex flex-col items-center justify-center w-full sm:w-1/3">
                            <img id="about-card-logo" src="favicon.svg" alt="Website Icon" class="w-24 h-24 cursor-pointer">
                            <p class="mt-4 font-semibold flex items-center justify-center" style="color: var(--text-color-primary);">V1.0.0<span class="ml-2 rounded-md bg-sky-500/90 px-2 py-0.5 text-xs font-bold text-white">Beta</span></p>
                            
                            <p class="mt-2 text-sm text-center px-2" style="color: var(--text-color-secondary);">
                                ‰∏Ä‰∏™ÁÆÄÁ∫¶ÁöÑ‰∏™‰∫∫‰∏ªÈ°µÈ°πÁõÆüéà
                            </p>

                            <!-- [NEW] Developer Icon Placeholder -->
                            <div id="developer-icon-container">
                                <div id="developer-icon" data-tooltip="ÂºÄÂèëËÄÖÈÄâÈ°π" class="tooltip-container w-8 h-8 mx-auto cursor-pointer">
                                    <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M64 160C64 124.7 92.7 96 128 96L512 96C547.3 96 576 124.7 576 160L576 400L512 400L512 160L128 160L128 400L64 400L64 160zM0 467.2C0 456.6 8.6 448 19.2 448L620.8 448C631.4 448 640 456.6 640 467.2C640 509.6 605.6 544 563.2 544L76.8 544C34.4 544 0 509.6 0 467.2zM281 273L250 304L281 335C290.4 344.4 290.4 359.6 281 368.9C271.6 378.2 256.4 378.3 247.1 368.9L199.1 320.9C189.7 311.5 189.7 296.3 199.1 287L247.1 239C256.5 229.6 271.7 229.6 281 239C290.3 248.4 290.4 263.6 281 272.9zM393 239L441 287C450.4 296.4 450.4 311.6 441 320.9L393 368.9C383.6 378.3 368.4 378.3 359.1 368.9C349.8 359.5 349.7 344.3 359.1 335L390.1 304L359.1 273C349.7 263.6 349.7 248.4 359.1 239.1C368.5 229.8 383.7 229.7 393 239.1z"/></svg>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div id="commit-history-panel" class="relative flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold flex items-center" style="color: var(--text-color-primary);">
                                    <i class="fas fa-history mr-2"></i>Êõ¥Êñ∞Êó•Âøó
                                </h3>
                                <button id="refresh-commits-btn" data-tooltip="Âà∑Êñ∞" class="tooltip-container w-8 h-8 rounded-full flex items-center justify-center text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)] transition-colors duration-200">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div id="recent-commits-container" class="space-y-4 pr-2 " style="overflow-y: auto; max-height: 27rem;">
                                <!-- Commits will be loaded here. The initial p tag is removed as JS will handle the loading state. -->
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
        <!-- [NEW] New Year Theme Audio & Controls -->
        <audio id="new-year-audio" preload="auto" src="Wishing_you_prosperity_Liu_Dehua.mp3"></audio>
        <button id="new-year-music-btn" data-tooltip="Êí≠Êîæ/ÊöÇÂÅúÈü≥‰πê" class="tooltip-container fixed bottom-4 right-4 w-16 h-16 z-50">
            <div class="music-player-vinyl">
                <img src="https://s21.ax1x.com/2025/08/30/pVckhWT.jpg" alt="Album Art" class="album-art">
            </div>
            <div class="vinyl-overlay">
                <i class="fas fa-play icon-play"></i>
                <i class="fas fa-pause icon-pause"></i>
            </div>
        </button>
    </div>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="fixed inset-0 backdrop-blur-sm flex items-center justify-center p-4" style="z-index: 50;">
        <div id="settings-window" class="glass-card w-full max-w-2xl p-5 flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center ">
                <h2 class="text-xl font-semibold flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></svg>ËÆæÁΩÆ</h2>
                <button id="close-settings-btn" data-tooltip="ÂÖ≥Èó≠" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                    <i class="fas fa-times fa-lg w-6 h-6 flex items-center justify-center"></i>
                </button>
            </div>
            <!-- Content -->
            <div class="flex-grow flex-1 min-h-0" data-simplebar>
                <div class="space-y-6 p-2 sm:p-3">
                    <!-- 1. Background Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 96C0 60.7 28.7 32 64 32l384 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6l96 0 32 0 208 0c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/></svg>ËÉåÊôØÊù•Ê∫ê</h3>
                        <div id="background-settings-content">
                            <!-- Background options will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- 2. Theme Color Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-2 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M512 256c0 .9 0 1.8 0 2.7c-.4 36.5-33.6 61.3-70.1 61.3H344c-26.5 0-48 21.5-48 48c0 3.4 .4 6.7 1 9.9c2.1 10.2 6.5 20 10.8 29.9c6.1 13.8 12.1 27.5 12.1 42c0 31.8-21.6 60.7-53.4 62c-3.5 .1-7 .2-10.6 .2C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm0-96a32 32 0 1 0 0-64 32 32 0 1 0 0 64zM288 96a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm96 96a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/></svg>‰∏ªÈ¢òÊ®°Âºè</h3>
                        <div id="theme-settings-content" class="flex flex-wrap">
                            <!-- Theme color swatches will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- NEW: Time Format Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm57.1 350.1L224.9 294c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h48c6.6 0 12 5.4 12 12v137.7l63.5 46.2c5.4 3.9 6.5 11.4 2.6 16.8l-28.2 38.8c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>Êó∂Èó¥Ê†ºÂºè</h3>
                        <div id="time-format-settings-content">
                            <!-- Time format options will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- 3. GitHub/Weather Toggle -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 60.7 28.7 32 64 32l320 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zm64 64l0 256 128 0 0-256-128 0zm320 0l-128 0 0 256 128 0 0-256z"/></svg>‰∏ªÂç°ÁâáËßÜÂõæ</h3>
                        <div id="view-toggle-content">
                            <!-- The toggle switch for GitHub/Weather will be inserted here -->
                        </div>
                    </div>

                    <!-- [NEW] Appearance Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);">
                            <svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor"><path d="M288 80c-65.2 0-118.8 29.6-159.9 67.7C89.6 183.5 63 226 49.4 256c13.6 30 40.2 72.5 78.6 108.3C169.2 402.4 222.8 432 288 432s118.8-29.6 159.9-67.7C486.4 328.5 513 286 526.6 256c-13.6-30-40.2-72.5-78.6-108.3C406.8 109.6 353.2 80 288 80zM288 368c-61.9 0-112-50.1-112-112s50.1-112 112-112 112 50.1 112 112-50.1 112-112 112zm0-200c-48.6 0-88 39.4-88 88s39.4 88 88 88 88-39.4 88-88-39.4-88-88-88z"/></svg>
                            Â§ñËßÇËÆæÁΩÆ
                        </h3>
                        <div id="appearance-settings-content">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between p-2">
                                    <div>
                                        <span class="font-medium">ÂºÄÂêØÊØõÁéªÁíÉÊïàÊûú</span>
                                        <div class="setting-description">Âç°ÁâáËÉåÊôØÂ∞ÜÂëàÁé∞ÂçäÈÄèÊòéÁöÑÊ®°Á≥äÊïàÊûú„ÄÇ</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="glass-effect-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <!-- Card Border Radius Slider -->
                                <div class="p-2 space-y-2 pt-3">
                                    <div class="flex justify-between items-center">
                                        <label for="card-border-radius-slider" class="font-medium">Âç°ÁâáÂúÜËßí</label>
                                        <span id="card-border-radius-value" class="text-sm font-mono" style="color: var(--text-color-secondary);">16px</span>
                                    </div>
                                    <input type="range" id="card-border-radius-slider" min="0" max="32" value="16" class="w-full h-2 rounded-lg appearance-none cursor-pointer setting-slider">
                                </div>
                                <!-- Card Blur Amount Slider -->
                                <div class="relative" id="blur-setting-container">
                                    <div class="p-2 space-y-2" id="blur-setting-content-wrapper">
                                        <div class="flex justify-between items-center">
                                            <label for="card-blur-amount-slider" class="font-medium">ËÉåÊôØÊ®°Á≥äÂ∫¶</label>
                                            <span id="card-blur-amount-value" class="text-sm font-mono" style="color: var(--text-color-secondary);">16px</span>
                                        </div>
                                        <div>
                                            <input type="range" id="card-blur-amount-slider" min="0" max="40" value="16" class="w-full h-2 rounded-lg appearance-none cursor-pointer setting-slider">
                                        </div>
                                    </div>
                                    <div id="blur-slider-overlay" class="absolute inset-0 bg-[var(--card-bg-color)] bg-opacity-80 rounded-lg flex items-center justify-center text-sm font-bold cursor-not-allowed">
                                        <i class="fas fa-lock mr-2"></i>
                                        <span>ËØ∑ÂÖàÂºÄÂêØÊØõÁéªÁíÉÊïàÊûú</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Hitokoto Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><svg class="inline-block w-5 h-5 mr-2" width="1024pt" height="1024pt" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" opacity="1.00" d=" M 504.63 19.74 C 510.94 18.73 517.82 18.56 523.72 21.44 C 536.31 27.78 548.23 35.34 560.39 42.45 C 566.80 45.20 572.36 49.45 578.55 52.60 C 584.51 56.73 591.37 59.35 597.14 63.79 C 601.84 66.40 606.91 68.37 611.18 71.72 C 627.90 81.47 645.09 90.40 661.68 100.34 C 668.72 105.16 676.65 108.48 683.78 113.16 C 688.90 116.60 694.41 119.37 699.76 122.40 C 707.70 127.57 716.15 131.88 724.27 136.77 C 732.78 141.10 740.57 146.67 749.04 151.07 C 756.21 155.28 763.14 159.89 770.71 163.38 C 776.68 166.09 781.58 170.66 787.70 173.08 C 791.89 174.65 794.89 178.27 799.11 179.77 C 804.53 181.55 808.92 185.32 813.91 187.94 C 818.23 190.26 822.52 192.65 826.53 195.49 C 832.90 199.17 839.32 202.77 845.68 206.47 C 852.70 211.25 860.40 214.92 867.59 219.42 C 874.68 224.69 882.87 228.11 890.40 232.67 C 897.91 235.86 904.15 241.26 911.61 244.55 C 917.72 248.14 923.69 252.00 930.12 255.03 C 935.28 257.19 938.63 262.13 940.96 267.01 C 942.24 271.59 943.57 276.21 944.18 280.94 C 944.26 431.29 944.10 581.65 944.23 732.00 C 944.13 737.44 944.80 742.99 943.42 748.33 C 942.44 751.91 942.19 755.81 940.03 758.95 C 937.64 762.46 934.82 765.84 931.07 767.94 C 920.48 774.50 909.12 779.70 898.72 786.57 C 890.72 790.92 882.75 795.35 874.85 799.87 C 869.36 803.85 863.17 806.69 857.61 810.54 C 854.92 812.33 851.70 813.13 849.08 815.03 C 846.93 816.53 844.91 818.23 842.59 819.47 C 832.35 824.33 822.96 830.74 812.94 836.01 C 801.05 843.11 788.51 849.06 776.91 856.65 C 769.03 860.59 761.78 865.65 754.08 869.94 C 739.78 877.87 725.59 885.99 711.61 894.48 C 708.34 896.25 704.75 897.45 701.86 899.86 C 699.10 902.06 695.86 903.46 692.65 904.83 C 688.48 906.60 685.38 910.10 681.33 912.08 C 670.31 917.47 660.26 924.56 649.48 930.38 C 643.83 934.24 637.53 936.95 631.71 940.53 C 626.08 943.64 620.74 947.29 614.85 949.91 C 610.05 951.96 606.12 955.56 601.28 957.54 C 596.76 959.36 593.39 963.08 588.99 965.11 C 580.47 969.18 572.80 974.73 564.71 979.56 C 556.94 983.30 549.59 987.83 542.07 992.05 C 536.38 996.03 530.02 998.87 523.81 1001.94 C 518.07 1004.76 511.45 1004.98 505.25 1003.93 C 499.73 1002.72 495.39 998.87 490.20 996.86 C 486.33 995.41 483.33 992.49 479.74 990.55 C 468.16 985.03 457.90 977.20 446.53 971.30 C 441.06 967.24 434.36 965.26 429.12 960.88 C 425.09 957.54 419.86 956.29 415.61 953.32 C 412.16 950.89 408.09 949.60 404.52 947.40 C 397.04 942.71 389.18 938.67 381.43 934.45 C 369.93 927.19 357.86 920.89 346.39 913.58 C 339.98 910.56 334.46 905.99 328.01 903.05 C 325.14 901.73 322.60 899.85 319.94 898.17 C 308.01 891.87 296.51 884.75 284.71 878.20 C 278.94 874.10 272.26 871.55 266.58 867.34 C 252.94 859.73 239.24 852.21 225.88 844.13 C 218.87 840.98 212.55 836.57 205.69 833.13 C 197.13 829.06 190.03 822.53 181.33 818.72 C 174.65 814.12 167.13 811.08 160.44 806.52 C 143.76 796.83 126.98 787.32 110.23 777.77 C 104.25 773.91 97.89 770.67 91.67 767.24 C 87.36 764.18 83.44 759.98 81.91 754.82 C 81.24 751.22 80.03 747.71 79.77 744.05 C 79.65 590.03 79.87 436.00 79.67 281.97 C 79.68 277.75 80.96 273.69 81.93 269.62 C 82.99 264.88 86.37 261.06 89.99 258.01 C 97.18 252.74 105.30 248.93 112.81 244.15 C 119.81 241.38 125.54 236.33 132.38 233.26 C 136.79 231.25 140.47 227.97 144.93 226.08 C 152.89 222.78 159.44 217.05 166.99 213.00 C 171.95 210.42 176.75 207.55 181.46 204.54 C 195.78 197.08 209.09 187.85 223.45 180.48 C 227.28 178.96 230.60 176.51 234.08 174.37 C 247.28 167.79 259.72 159.87 272.39 152.36 C 290.80 142.16 308.90 131.43 327.19 121.06 C 332.12 118.93 336.40 115.67 341.08 113.10 C 349.62 108.55 357.67 103.17 365.81 97.96 C 377.22 92.30 387.72 84.98 399.14 79.34 C 405.93 75.36 413.08 72.06 419.71 67.79 C 426.37 65.18 431.45 59.92 438.00 57.09 C 454.35 46.85 471.63 38.18 487.98 27.94 C 493.46 25.08 498.64 21.52 504.63 19.74 M 339.46 301.66 C 339.21 305.49 339.82 309.28 340.27 313.07 C 340.71 323.05 341.67 332.99 342.32 342.95 C 342.36 442.30 342.29 541.65 342.36 641.00 C 342.11 654.95 344.63 669.22 351.25 681.62 C 354.62 687.98 359.64 693.29 365.00 698.04 C 376.73 707.89 391.54 713.33 406.47 715.99 C 417.29 717.76 428.04 720.23 439.04 720.46 C 444.07 720.49 449.04 721.43 454.07 721.48 C 459.09 721.49 463.92 723.24 468.95 723.25 C 483.53 723.19 498.12 723.80 512.69 723.26 C 522.15 721.83 531.73 722.96 541.23 722.24 C 553.79 720.76 566.49 722.17 579.05 720.65 C 589.61 720.27 600.18 719.64 610.69 718.47 C 626.03 717.55 641.33 716.22 656.65 715.11 C 666.15 713.71 675.81 713.85 685.27 712.12 C 685.77 703.76 685.32 695.37 685.46 687.00 C 685.33 674.84 685.76 662.66 685.31 650.51 C 678.79 650.46 672.54 652.62 666.13 653.50 C 645.86 657.50 625.33 659.82 604.82 662.17 C 589.15 662.95 573.58 665.20 557.89 665.73 C 546.61 666.92 535.23 665.88 523.98 667.41 C 506.99 667.57 489.99 667.61 473.00 667.33 C 464.46 666.41 455.85 666.51 447.37 665.06 C 433.64 663.59 418.97 661.90 407.61 653.30 C 400.44 647.99 398.88 638.34 398.39 630.02 C 398.34 592.92 398.25 555.83 398.40 518.74 C 403.72 515.84 409.85 515.14 415.58 513.40 C 433.87 508.37 452.11 503.16 470.40 498.12 C 531.66 480.08 592.55 460.35 651.31 435.19 C 658.43 432.13 665.83 429.59 672.57 425.71 C 667.79 412.38 661.56 399.62 656.42 386.42 C 654.40 381.52 652.55 376.43 649.08 372.34 C 641.43 376.06 634.28 380.70 626.63 384.43 C 617.13 388.86 608.07 394.20 598.31 398.08 C 585.88 403.01 573.61 408.40 560.89 412.59 C 512.03 430.12 462.40 445.43 412.30 458.96 C 407.47 460.19 402.75 461.94 397.78 462.48 C 397.41 428.66 397.71 394.83 397.60 361.00 C 397.75 352.98 397.19 344.91 398.32 336.94 C 398.99 325.17 400.06 313.44 401.43 301.74 C 393.63 301.24 385.80 301.63 377.99 301.51 C 365.15 301.62 352.30 301.32 339.46 301.66 Z" /></svg>‰∏ÄË®Ä</h3>
                        <div id="hitokoto-settings-content">
                            <!-- Hitokoto settings will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- [NEW] Reset Settings Section -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);"><i class="fas fa-undo fa-fw w-5 h-5 mr-2"></i>ÈáçÁΩÆ</h3>
                        <div class="p-2">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium">ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ</span>
                                    <div class="setting-description">Â∞ÜÊâÄÊúâËÆæÁΩÆÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÂÄº,Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ</div>
                                </div>
                                <button id="reset-settings-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg text-white font-semibold text-sm transition-colors duration-200 bg-red-600 hover:bg-red-700 active:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-gray-800">
                                    ÈáçÁΩÆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- [NEW] Developer Settings Modal -->
    <div id="developer-settings-overlay" class="fixed inset-0 backdrop-blur-sm flex items-center justify-center p-4" style="z-index: 60;">
        <div id="developer-settings-window" class="glass-card w-full max-w-2xl p-5 flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center ">
                <h2 class="text-xl font-semibold flex items-center" style="color: var(--text-color-primary);">
                    <svg fill="currentColor" class="inline-block w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M64 160C64 124.7 92.7 96 128 96L512 96C547.3 96 576 124.7 576 160L576 400L512 400L512 160L128 160L128 400L64 400L64 160zM0 467.2C0 456.6 8.6 448 19.2 448L620.8 448C631.4 448 640 456.6 640 467.2C640 509.6 605.6 544 563.2 544L76.8 544C34.4 544 0 509.6 0 467.2zM281 273L250 304L281 335C290.4 344.4 290.4 359.6 281 368.9C271.6 378.2 256.4 378.3 247.1 368.9L199.1 320.9C189.7 311.5 189.7 296.3 199.1 287L247.1 239C256.5 229.6 271.7 229.6 281 239C290.3 248.4 290.4 263.6 281 272.9zM393 239L441 287C450.4 296.4 450.4 311.6 441 320.9L393 368.9C383.6 378.3 368.4 378.3 359.1 368.9C349.8 359.5 349.7 344.3 359.1 335L390.1 304L359.1 273C349.7 263.6 349.7 248.4 359.1 239.1C368.5 229.8 383.7 229.7 393 239.1z"/></svg>
                    ÂºÄÂèëËÄÖÈÄâÈ°π
                </h2>
                <button id="close-developer-settings-btn" data-tooltip="ÂÖ≥Èó≠" class="tooltip-container p-1 rounded-full icon-btn transition-all active:scale-95" style="color: var(--text-color-secondary);">
                    <i class="fas fa-times fa-lg w-6 h-6 flex items-center justify-center"></i>
                </button>
            </div>
            <!-- Content -->
            <div class="flex-grow flex-1 min-h-0" data-simplebar>
                <div class="space-y-6 p-2 sm:p-3">
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);">
                            <i class="fas fa-toggle-on fa-fw w-5 h-5 mr-2"></i>ÊÄªÂºÄÂÖ≥
                        </h3>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2">
                                <div>
                                    <span class="font-medium">ÂºÄÂêØÂºÄÂèëËÄÖÈÄâÈ°π</span>
                                    <div class="setting-description">ÊÄªÂºÄÂÖ≥ÔºåÊéßÂà∂ÊâÄÊúâÂºÄÂèëËÄÖÂäüËÉΩ</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="dev-options-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- [NEW] New Year Theme Toggle -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-color-primary);">
                            <i class="fas fa-gifts fa-fw w-5 h-5 mr-2"></i>ËäÇÊó•‰∏ªÈ¢ò
                        </h3>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2">
                                <div>
                                    <span class="font-medium">Âº∫Âà∂ÂºÄÂêØÊñ∞Âπ¥‰∏ªÈ¢ò</span>
                                    <div class="setting-description">Áî®‰∫éÊµãËØïÊñ∞Âπ¥‰∏ªÈ¢òÁöÑËÉåÊôØÂíåÈü≥‰πê</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="force-new-year-theme-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- Future developer options will go here -->
                </div>
            </div>
        </div>
    </div>

    <!-- [NEW] Reset Confirmation Modal -->
    <div id="reset-confirm-overlay" class="fixed inset-0 backdrop-blur-sm flex items-center justify-center p-4 hidden" style="z-index: 70;">
        <div id="reset-confirm-window" class="glass-card w-full max-w-md p-6 flex flex-col">
            <!-- State 1: Confirmation -->
            <div id="reset-confirm-state">
                <h2 class="text-xl font-semibold flex items-center" style="color: var(--text-color-primary);">
                    <i class="fas fa-exclamation-triangle fa-fw w-5 h-5 mr-2 text-amber-400"></i>Á°ÆËÆ§ÈáçÁΩÆÔºü
                </h2>
                <p class="text-base my-4" style="color: var(--text-color-secondary);">
                    Ê≠§Êìç‰ΩúÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞‰øùÂ≠òÁöÑËÆæÁΩÆÂπ∂ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÂÄº„ÄÇËØ•ËøáÁ®ã<strong>‰∏çÂèØÈÄÜ</strong>ÔºåÁÇπÂáªÈáçÁΩÆ‰ºöÂà∑Êñ∞ÁΩëÈ°µÔºåÊÇ®Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü
                </p>
                <div class="flex justify-end gap-4 mt-4">
                    <button id="cancel-reset-btn" class="px-4 py-2 rounded-lg font-semibold transition-colors duration-200 bg-gray-500/20 hover:bg-gray-500/40">ÂèñÊ∂à</button>
                    <button id="confirm-reset-btn" class="px-4 py-2 rounded-lg text-white font-semibold transition-colors duration-200 bg-red-600 hover:bg-red-700">Á°ÆËÆ§ÈáçÁΩÆ</button>
                </div>
            </div>
            <!-- State 2: Success Message -->
            <div id="reset-success-state" class="hidden text-center">
                <h2 class="text-xl font-semibold flex items-center justify-center" style="color: var(--text-color-primary);">
                    <i class="fas fa-check-circle fa-fw w-5 h-5 mr-2 text-green-400"></i>ÈáçÁΩÆÊàêÂäüÔºÅ
                </h2>
                <p class="text-base my-4" style="color: var(--text-color-secondary);">
                    È°µÈù¢Âç≥Â∞ÜËá™Âä®Âà∑Êñ∞...
                </p>
            </div>
        </div>
    </div>

    <!-- [NEW] Immersive Time View -->
    <div id="immersive-time-view">
        <button id="exit-immersive-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                <path fill="currentColor" d="M384 128L448 128L448 544C448 561.7 462.3 576 480 576L512 576C529.7 576 544 561.7 544 544C544 526.3 529.7 512 512 512L512 128C512 92.7 483.3 64 448 64L352 64L352 64L192 64C156.7 64 128 92.7 128 128L128 512C110.3 512 96 526.3 96 544C96 561.7 110.3 576 128 576L352 576C369.7 576 384 561.7 384 544L384 128zM256 320C256 302.3 270.3 288 288 288C305.7 288 320 302.3 320 320C320 337.7 305.7 352 288 352C270.3 352 256 337.7 256 320z"/>
            </svg>
        </button>
        <div class="flex flex-col items-center justify-center text-center">
            <div id="immersive-date-display"></div>
            <div id="immersive-time-display"></div>
            <div id="immersive-greeting"></div>
        </div>
    </div>

    <script>
        // --- ÂàùÂßãÁä∂ÊÄÅÂíåÂ∏∏Èáè ---
        const DEFAULT_BG_IMAGES = [
            'https://s21.ax1x.com/2025/08/10/pVdEmM6.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEnsK.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEuqO.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEQde.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEMZD.jpg'
        ];
        const lunarInfo = [0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2, 0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977, 0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970, 0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950, 0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557, 0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0, 0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0, 0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6, 0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570, 0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0, 0x0c960, 0xd954, 0x0d4a0, 0xda50, 0x07552, 0x056a0, 0xabb7, 0x025d0, 0x092d0, 0x0cab5, 0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930, 0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530, 0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45, 0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0];
        const solarTerm = ["Â∞èÂØí", "Â§ßÂØí", "Á´ãÊò•", "Èõ®Ê∞¥", "ÊÉäËõ∞", "Êò•ÂàÜ", "Ê∏ÖÊòé", "Ë∞∑Èõ®", "Á´ãÂ§è", "Â∞èÊª°", "ËäíÁßç", "Â§èËá≥", "Â∞èÊöë", "Â§ßÊöë", "Á´ãÁßã", "Â§ÑÊöë", "ÁôΩÈú≤", "ÁßãÂàÜ", "ÂØíÈú≤", "ÈúúÈôç", "Á´ãÂÜ¨", "Â∞èÈõ™", "Â§ßÈõ™", "ÂÜ¨Ëá≥"];
        const sTermInfo = [0, 21208, 42467, 63836, 85337, 107014, 128867, 150921, 173149, 195551, 218072, 240693, 263343, 285989, 308563, 331033, 353350, 375494, 397447, 419210, 440795, 462224, 483532, 504758];
        const sFtv = [
            { date: "0101", name: "ÂÖÉÊó¶", start: 1949 },
            { date: "0110", name: "Ë≠¶ÂØüËäÇ", start: 2021 },
            { date: "0214", name: "ÊÉÖ‰∫∫ËäÇ" },
            { date: "0308", name: "Â¶áÂ•≥ËäÇ", start: 1949 },
            { date: "0312", name: "Ê§çÊ†ëËäÇ", start: 1979 },
            { date: "0315", name: "Ê∂àË¥πËÄÖÊó•", start: 1983 },
            { date: "0401", name: "ÊÑö‰∫∫ËäÇ" },
            { date: "0501", name: "Âä≥Âä®ËäÇ", start: 1949 },
            { date: "0504", name: "ÈùíÂπ¥ËäÇ", start: 1949 },
            { date: "0512", name: "Êä§Â£´ËäÇ", start: 1912 },
            { date: "0601", name: "ÂÑøÁ´•ËäÇ", start: 1949 },
            { date: "0701", name: "Âª∫ÂÖöËäÇ", start: 1921 },
            { date: "0707", name: "‰∏É‰∏É‰∫ãÂèò", start: 1937 },
            { date: "0801", name: "Âª∫ÂÜõËäÇ", start: 1927 },
            { date: "0815", name: "Êó•Êú¨ÊäïÈôçÊó•", start: 1945 },
            { date: "0903", name: "ÊäóÊàòËÉúÂà©Á∫™ÂøµÊó•", start: 1945 },
            { date: "0910", name: "ÊïôÂ∏àËäÇ", start: 1985 },
            { date: "0918", name: "‰πù‰∏ÄÂÖ´‰∫ãÂèò", start: 1931 },
            { date: "1001", name: "ÂõΩÂ∫ÜËäÇ", start: 1949 },
            { date: "1213", name: "ÂõΩÂÆ∂ÂÖ¨Á•≠Êó•", start: 2014 },
            { date: "1224", name: "Âπ≥ÂÆâÂ§ú" },
            { date: "1225", name: "Âú£ËØûËäÇ" },
        ];
        const lFtv = [
            { date: "0101", name: "Êò•ËäÇ" },
            { date: "0115", name: "ÂÖÉÂÆµËäÇ" },
            { date: "0202", name: "ÈæôÊä¨Â§¥" },
            { date: "0505", name: "Á´ØÂçàËäÇ" },
            { date: "0707", name: "‰∏ÉÂ§ï" },
            { date: "0715", name: "‰∏≠ÂÖÉËäÇ" },
            { date: "0815", name: "‰∏≠ÁßãËäÇ" },
            { date: "0909", name: "ÈáçÈò≥ËäÇ" },
            { date: "1208", name: "ËÖäÂÖ´ËäÇ" },
            { date: "1223", name: "ÂåóÊñπÂ∞èÂπ¥" },
            { date: "1224", name: "ÂçóÊñπÂ∞èÂπ¥" },
        ];
        let holidayListDisplayedYear = new Date().getFullYear();
        let hasManuallyScrolled = false;
        let holidayListSimpleBar; // Instance for the holiday list scrollbar
        let settingsSimpleBar = null; // Instance for the settings scrollbar
        let isFetchingWeather = false; // Lock to prevent multiple weather requests
        let cachedCommitsHTML = null;
        let areCommitsCached = false;
        let aboutCardHasAnimated = false;

        // --- [NEW] Reusable Cross-fade Logic ---
        function createCrossfader(layers) {
            let activeIndex = 0;

            // Return an update function that handles the cross-fade
            const update = (newUrl, isBackgroundImage = false) => {
                return new Promise((resolve, reject) => {
                    const nextIndex = (activeIndex + 1) % 2;
                    const activeLayer = layers[activeIndex];
                    const nextLayer = layers[nextIndex];

                    if (!nextLayer || !activeLayer) {
                        return reject('Cross-fade layers not found.');
                    }

                    const preloader = new Image();
                    preloader.src = newUrl;

                    preloader.onload = () => {
                        // Apply the new image to the hidden layer
                        if (isBackgroundImage) {
                            nextLayer.style.backgroundImage = `url('${newUrl}')`;
                        } else {
                            nextLayer.src = newUrl;
                        }

                        // Trigger the cross-fade
                        activeLayer.classList.remove('active');
                        nextLayer.classList.add('active');
                        
                        // Update the active index for the next cycle
                        activeIndex = nextIndex;
                        resolve(); // Transition has started
                    };

                    preloader.onerror = () => {
                        console.error(`Crossfader failed to load image: ${newUrl}`);
                        reject('Image load error');
                    };
                });
            };
            
            return { update };
        }

        let backgroundFader;
        // previewFader is no longer needed

        let latestBgRequestId = 0;
        let latestPreviewRequestId = 0;

        // --- DOM ÂÖÉÁ¥†Ëé∑Âèñ (ÈÉ®ÂàÜÁßªËá≥DOMContentLoaded) ---
        const countdownCard = document.getElementById('countdown-card');
        const profileCard = document.getElementById('profile-card');
        const rightColumn = document.getElementById('right-column');
        const timeCapsuleCard = document.getElementById('time-capsule-card');
        const holidayListCard = document.getElementById('holiday-list-card');
        const aboutCard = document.getElementById('about-card');
        let rightColumnInitialHeight = 0;
        let cachedRightColumnHeight = 0; // Cache the height of the right column

        // --- [NEW] Year Input Feature Elements ---
        const yearDisplayControls = document.getElementById('year-display-controls');
        const yearEditControls = document.getElementById('year-edit-controls');
        const holidayListYearSpan = document.getElementById('holiday-list-year');
        const yearInput = document.getElementById('year-input');
        const confirmYearBtn = document.getElementById('confirm-year-btn');
        const cancelYearBtn = document.getElementById('cancel-year-btn');
        const yearInputError = document.getElementById('year-input-error');
        const yearRangeWarning = document.getElementById('year-range-warning');
        
        // --- Âä®ÊÄÅÊó∂ÈíüÂäüËÉΩ ---
        function updateTime() {
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            const now = new Date();

            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const colon = `<span class="time-colon">:</span>`;

            if (appSettings.timeFormat === '12h') {
                timeDisplay.classList.add('flex', 'items-baseline', 'justify-center');
                let h12 = hours % 12;
                h12 = h12 ? h12 : 12; // the hour '0' should be '12'
                const strH12 = String(h12).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                const timeString = `${strH12}${colon}${minutes}${colon}${seconds}`;
                timeDisplay.innerHTML = `<span>${timeString}</span><span class="text-3xl font-bold ml-2">${ampm}</span>`;
            } else { // 24h format
                timeDisplay.classList.remove('flex', 'items-baseline', 'justify-center');
                const strH24 = String(hours).padStart(2, '0');
                timeDisplay.innerHTML = `${strH24}${colon}${minutes}${colon}${seconds}`;
            }

            const weekdays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
            dateDisplay.textContent = `${now.getFullYear()}Âπ¥${String(now.getMonth() + 1).padStart(2, '0')}Êúà${String(now.getDate()).padStart(2, '0')}Êó• ${weekdays[now.getDay()]}`;
        }

        // --- ÈóÆÂÄôËØ≠ÂäüËÉΩ ---
        function updateGreeting() {
            const greetingEl = document.getElementById('greeting');
            const now = new Date();
            const hour = now.getHours();
            const month = now.getMonth() + 1; // getMonth() ËøîÂõû 0-11, +1 Âèò‰∏∫ 1-12

            // ÂÆö‰πâÈóÆÂÄôËØ≠Â∫ì
            const greetings = {
                spring: { // Êò•Â≠£ (3-5Êúà)
                    morning: [
                        "Êó©‰∏äÂ•ΩÔºåÊò•ÊÑèÁõéÁÑ∂ÔºåÊÑø‰Ω†ÁöÑ‰∏ÄÂ§©Â¶ÇËØóÂ¶ÇÁîª„ÄÇüåø",
                        "Ê∏ÖÊô®ÁöÑÈú≤Ê∞¥Ôºå‰º¥ÁùÄËä±È¶ôÔºåÈÅì‰∏ÄÂ£∞Êó©ÂÆâ„ÄÇüå∏",
                        "Êò•Êó•ÈªéÊòéÔºå‰∏áÁâ©Â§çËãèÔºå‰ªäÂ§©‰πüË¶ÅÊ¥ªÂäõÊª°Êª°ÔºÅ",
                        "Êó©ÂÆâÔºåÊÑøÊò•È£é‰∏∫‰Ω†ÂêπÊù•‰∏ÄÂ§©ÁöÑÂ•ΩËøê„ÄÇüçÉ",
                        "Âê¨ÔºåÁ™óÂ§ñÊòØ‰∏çÊòØÊúâÈ∏üÂÑøÂú®Ê≠åÂî±ÔºüÊó©ÂÆâÔºÅüê¶",
                        "Êñ∞ÁöÑ‰∏ÄÂ§©Ôºå‰ªé‰∏Ä‰∏™Ê∏ÖÊñ∞ÁöÑÊò•Êó•Êó©Êô®ÂºÄÂßã„ÄÇ",
                        "‰∏ÄÂπ¥‰πãËÆ°Âú®‰∫éÊò•Ôºå‰∏ÄÊó•‰πãËÆ°Âú®‰∫éÊô®ÔºåÂä†Ê≤πÔºÅ",
                        "ÊãâÂºÄÁ™óÂ∏òÔºåËÆ©Á¨¨‰∏ÄÁºïÊò•ÂÖâÊã•Êä±‰Ω†„ÄÇ‚òÄÔ∏è"
                    ],
                    afternoon: [
                        "‰∏ãÂçàÂ•ΩÔºåÊò•Êó•ÊöñÈò≥ÔºåÈÄÇÂêàÂ∞èÊÜ©ÁâáÂàª„ÄÇ‚òÄÔ∏è",
                        "ÂçàÂêéÊó∂ÂÖâÔºåÊ≥°ÊùØËä±Ëå∂Ôºå‰∫´ÂèóÊò•Êó•ÁöÑÊÇ†Èó≤Âêß„ÄÇüçµ",
                        "ÊÑø‰Ω†ÂøÉÊÉÖÂ¶ÇÊò•Êó•ÂçàÂêéÁöÑÈò≥ÂÖâÔºåÊòéÂ™ö‰∏çÂøß‰º§„ÄÇ",
                        "Êò•Â§©Âà∞ÔºåÂà´Êò•Âõ∞ÔºåËµ∑Êù•Ê¥ªÂä®‰∏Ä‰∏ãÁ≠ãÈ™®ÂêßÔºÅ",
                        "Â§©Ê∞îËøô‰πàÂ•ΩÔºå‰∏çÂéªÂÖ¨Âõ≠Êï£Êï£Ê≠•ÂêóÔºü",
                        "ÂçàÂêéÁöÑÈò≥ÂÖâÔºåÊöñÂæóËÆ©‰∫∫ÊÉ≥ÊâìÁûåÁù°„ÄÇüò¥",
                        "Ê≥°‰∏ÄÂ£∂Èæô‰∫ïÔºåÈùôÂìÅÊò•Êó•ÁöÑÂçàÂêéÊó∂ÂÖâ„ÄÇ",
                        "Êò•Èõ∑ÈòµÈòµÔºåËØ¥‰∏çÂÆö‰ºöÊúâ‰∏ÄÂú∫Êò•Èõ®ÔºåËÆ∞ÂæóÂ∏¶‰ºû„ÄÇ"
                    ],
                    evening: [
                        "Êôö‰∏äÂ•ΩÔºåÊò•È£éÊãÇÈù¢Ôºå‰∏ÄÂ§©ÁöÑÁñ≤ÊÉ´ÈÉΩÊ∂àÊï£‰∫Ü„ÄÇüéë",
                        "Â§úÂπïÈôç‰∏¥ÔºåÈùô‰∫´Êò•Â§úÁöÑÊ∏©Êüî‰∏éÂÆÅÈùô„ÄÇ",
                        "Êò•Â§úÁöÑÊòüÁ©∫Ê†ºÂ§ñÊòéÊúóÔºåÁ•ù‰Ω†ÊôöÂÆâÂ•ΩÊ¢¶„ÄÇ‚ú®",
                        "Âú®Ê∏©ÊüîÁöÑÊò•Â§úÈáåÔºåÂíå‰∏ñÁïåÈÅì‰∏ÄÂè•ÊôöÂÆâ„ÄÇ",
                        "Êò•Â§©ÁöÑÊôöÈúûÊÄªÊòØÊ†ºÂ§ñÊ∏©ÊüîÔºåÊôö‰∏äÂ•Ω„ÄÇ",
                        "ÂøôÁ¢å‰∫Ü‰∏ÄÂ§©ÔºåÊòØÊó∂ÂÄô‰∫´Âèó‰∏ÄÈ°øÁæéÂë≥ÁöÑÊôöÈ§ê‰∫Ü„ÄÇüç≤",
                        "ÊôöÈ£éËΩªËΩªÔºåÂêπÊù•ÈùíËçâÂíåÊ≥•ÂúüÁöÑËä¨Ëä≥„ÄÇ",
                        "‰ªäÊôöÊúàËâ≤ÁúüÁæéÔºåÈ£é‰πüÊ∏©ÊüîÔºåÁ•ù‰Ω†ÊÑâÂø´„ÄÇ"
                    ],
                    night: [
                        "Â§úÊ∑±‰∫ÜÔºåÊò•Â§úÂæÆÂáâÔºåËÆ∞ÂæóÁõñÂ•ΩË¢´Â≠ê„ÄÇüåô",
                        "ÊôöÂÆâÔºåÊÑø‰Ω†Âú®Ê¢¶Èáå‰∏éÊúÄÁæéÁöÑÊò•Â§©Áõ∏ÈÅá„ÄÇ",
                        "Êîæ‰∏ãÊâãÊú∫ÔºåÈó≠‰∏äÁúºÁùõÔºåËÅÜÂê¨Êò•Ëô´ÁöÑÈ∏£Âè´„ÄÇüò¥",
                        "Â§úÈòë‰∫∫ÈùôÔºåÁ•ù‰Ω†ÂÆâÁú†ÔºåÊòéÊó•ÂèàÊòØÂ¥≠Êñ∞ÁöÑ‰∏ÄÂ§©„ÄÇ",
                        "Êò•Â§úÂÆÅÈùôÔºåÂÆúËØª‰∏ÄÊú¨Èó≤‰π¶ÔºåÂÆâÁÑ∂ÂÖ•Áù°„ÄÇ",
                        "Êää‰ªäÂ§©‰ªΩÁöÑÂºÄÂøÉÊâìÂåÖÔºåÁù°‰∏™Â•ΩËßâÂêß„ÄÇ",
                        "ÊôöÂÆâÔºåÊÑø‰Ω†ÁöÑÊ¢¶ÈáåÁπÅËä±‰ººÈî¶„ÄÇüå∏",
                        "Â§ú‰∫ÜÔºåÂÖ®‰∏ñÁïåÈÉΩÁù°‰∫ÜÔºå‰Ω†‰πüË¶ÅÊó©ÁÇπ‰ºëÊÅØ„ÄÇ"
                    ]
                },
                summer: { // Â§èÂ≠£ (6-8Êúà)
                    morning: [
                        "Êó©‰∏äÂ•ΩÔºåÂ§èÊó•Ê∏ÖÊô®ÔºåÈò≥ÂÖâÊ≠£Â•ΩÔºåÂæÆÈ£é‰∏çÁá•„ÄÇ‚òÄÔ∏è",
                        "Êó©ÂÆâÔºÅ‰ªäÂ§©‰πüÊòØÂÖÉÊ∞îÊª°Êª°ÁöÑ‰∏ÄÂ§©ÔºåÂà´ÊÄïÁÉ≠ÔºÅ",
                        "Â§èÊó•ÁöÑÊ∏ÖÊô®ÔºåÊòØË•øÁìúÂë≥ÁöÑÔºåÊòØÂÜ∞Ê±ΩÊ∞¥Âë≥ÁöÑ„ÄÇüçâ",
                        "ËùâÈ∏£Â£∞Â£∞ÔºåÂî§ÈÜí‰∫ÜÂ§èÂ§©ÁöÑÊó©Êô®ÔºåÊó©ÂÆâÔºÅ",
                        "Êó©ÂÆâÔºÅ‰ªäÂ§©ÁöÑÂ§™Èò≥‰πüÂæàÁÉ≠ÊÉÖÂë¢ÔºÅ",
                        "Ëµ∂Âú®ÁÉ≠Êµ™Êù•‰∏¥ÂâçÔºå‰∫´ÂèóÊ∏ÖÊô®ÁöÑÁâáÂàªÂáâÁàΩÂêß„ÄÇ",
                        "ÂèàÊòØË¢´Èò≥ÂÖâÂè´ÈÜíÁöÑ‰∏ÄÂ§©Ôºå‰Ω†Â•ΩÂëÄÔºÅ",
                        "Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÂÉèÂä†‰∫ÜÂÜ∞ÂùóÁöÑÊ±ΩÊ∞¥ÔºåÂÖÖÊª°Ê¥ªÂäõÔºÅ"
                    ],
                    afternoon: [
                        "‰∏ãÂçàÂ•ΩÔºåÂ§èÊó•ÁÇéÁÇéÔºåËÆ∞ÂæóÂ§öÂñùÊ∞¥Èò≤ÊöëÂì¶„ÄÇüíß",
                        "ÂçàÂêéÂõ∞ÂÄ¶ÔºåÊù•Ê†πÂÜ∞Ê£çÊèêÊèêÁ•ûÂêßÔºÅüç¶",
                        "ÂøÉÈùôËá™ÁÑ∂ÂáâÔºåÊÑø‰Ω†Êã•Êúâ‰∏Ä‰∏™Ê∏ÖÁàΩÁöÑ‰∏ãÂçà„ÄÇ",
                        "Â§èÊó•ÂçàÂêéÔºåÂÆúÂºÄÁ©∫Ë∞ÉÔºåÂÆúÂê¨Èü≥‰πêÔºåÂÆúÊÉ≥‰Ω†„ÄÇüòâ",
                        "ÁÉ≠Âà∞ËûçÂåñÁöÑ‰∏ãÂçàÔºå‰Ω†ËøòÂ•ΩÂêóÔºü",
                        "‚ÄúÂì™ÂÑøÂáâÂø´ÂæÖÁùÄÂéª‚ÄùÔºåÊòØÂ§èÂ§©ÊúÄÁúüËØöÁöÑÁ•ùÁ¶è„ÄÇ",
                        "Ëøô‰∏™ÈíüÁÇπÔºåÂîØÊúâÁ©∫Ë∞ÉÂíåË•øÁìú‰∏çÂèØËæúË¥ü„ÄÇüçâ"
                    ],
                    evening: [
                        "Êôö‰∏äÂ•ΩÔºåÂ§èÂ§úÊôöÈ£éÔºåÂêπÊï£ÁôΩÂ§©ÁöÑÁá•ÁÉ≠„ÄÇüéê",
                        "ÊèêÁùÄ‰∏ÄÁì∂Ê±ΩÊ∞¥ÔºåÂùêÂú®Âè∞Èò∂‰∏äÔºåÊÑüÂèóÂ§èÂ§©ÁöÑÊôöÈ£é„ÄÇ",
                        "Â±û‰∫éÂ§èÂ§©ÁöÑÂ§úÊôöÔºåÊòØÁÉßÁÉ§„ÄÅÂ∞èÈæôËôæÂíåÂÜ∞Âï§ÈÖí„ÄÇüçª",
                        "ÊôöÈ£éËΩªË∏©ÁùÄ‰∫ëÊúµÔºåÊúà‰∫ÆÂú®Ë¥©ÂîÆÂø´‰πêÔºåÊôöÂÆâÔºÅ",
                        "ÊôöÈ£éÂêπËµ∞‰∫ÜÁÉ≠Ê∞îÔºåÂ∏¶Êù•‰∫ÜÂ§èÂ§úÁöÑÊÉ¨ÊÑè„ÄÇ",
                        "ÂèàÂà∞‰∫ÜÂèØ‰ª•ÂéªÂ§úÂ∏ÇÈÄõÂêÉÈÄõÂêÉÁöÑÂ≠£ËäÇÔºÅ",
                        "Â∞èÊó∂ÂÄôÁöÑÂ§èÂ§úÔºåÊòØËí≤Êâá„ÄÅÂáâÂ∏≠ÂíåÊª°Â§©ÁπÅÊòü„ÄÇ‚ú®",
                        "Êôö‰∏äÂ•ΩÔºåÂéªÊï£Êï£Ê≠•ÂêßÔºåËØ¥‰∏çÂÆöËÉΩÁúãÂà∞Ëê§ÁÅ´Ëô´„ÄÇ"
                    ],
                    night: [
                        "Â§úÊ∑±‰∫ÜÔºåÊôöÂÆâÔºåÊÑø‰Ω†ÁöÑÊ¢¶ÈáåÊúâÂáâÁàΩÁöÑÂ§èÈ£é„ÄÇüåå",
                        "‰ª≤Â§èÂ§ú‰πãÊ¢¶ÔºåÊÑø‰Ω†Êã•Êä±Êï¥ÁâáÊòüÁ©∫„ÄÇ‚ú®",
                        "ÊôöÂÆâÔºåÊúà‰∫ÆË≠¶ÂØüÂ∑≤Â∞±‰ΩçÔºåËØ∑ÂÆâÂøÉÂÖ•Áù°„ÄÇüëÆ",
                        "ÂòòÔºåÈùô‰∏ãÂøÉÊù•ÔºåÂê¨Âê¨Á™óÂ§ñÁöÑËô´È∏£„ÄÇ",
                        "ÊôöÂÆâÔºåÁ©∫Ë∞ÉË∞ÉÂà∞26Â∫¶ÂàöÂàöÂ•ΩÂì¶„ÄÇüòâ",
                        "Âà´ÁÜ¨Â§ú‰∫ÜÔºå‰Ω†ÁöÑÁöÆËÇ§ÂíåÂ§¥ÂèëÈÉΩÈúÄË¶Å‰ºëÊÅØ„ÄÇ",
                        "Á•ù‰Ω†ÂÅö‰∏™ÂáâÁàΩÁöÑÊ¢¶ÔºåÊ¢¶ÈáåÊ≤°ÊúâËöäÂ≠ê„ÄÇü¶ü"
                    ]
                },
                autumn: { // ÁßãÂ≠£ (9-11Êúà)
                    morning: [
                        "Êó©‰∏äÂ•ΩÔºåÁßãÈ´òÊ∞îÁàΩÔºåÊÑø‰Ω†‰ªäÂ§©‰πüÂøÉÊÉÖËàíÁïÖ„ÄÇüçÅ",
                        "Êó©ÂÆâÔºåÁ©∫Ê∞î‰∏≠Êúâ‰∫ÜÁßãÂ§©ÁöÑÂë≥ÈÅìÔºåÊ∑±ÂëºÂê∏‰∏Ä‰∏ãÂêß„ÄÇ",
                        "ÁßãÊó•ÁöÑÊô®ÂÖâÔºåÊ∏©ÊüîÂú∞Ê¥íÂú®ÊØè‰∏ÄÁâáËêΩÂè∂‰∏äÔºåÊó©ÂÆâ„ÄÇ",
                        "Â§©Âáâ‰∫ÜÔºåËÆ∞ÂæóÂ§öÁ©ø‰ª∂Ë°£ÊúçÔºåÂà´ÊÑüÂÜí‰∫ÜÂì¶„ÄÇüß•",
                        "ÁßãÊó•ÁöÑÂ§©Á©∫ÔºåËìùÂæóÂÉè‰∏ÄÂùóÁîªÂ∏ÉÔºåÊó©ÂÆâ„ÄÇ",
                        "Êó©Êô®ÁöÑÁ©∫Ê∞îÂæÆÂáâÔºåËÆ∞ÂæóÊ∑ª‰∏Ä‰ª∂ËñÑÂ§ñÂ•ó„ÄÇ",
                        "ÁßãÂ§©ÔºåÊòØ‰∏Ä‰∏™ËÆ©‰∏ÄÂàáÈÉΩÊ≤âÈùô‰∏ãÊù•ÁöÑÂ≠£ËäÇÔºåÊó©„ÄÇ",
                        "ÂèàÊòØË¢´Ê¢¶ÊÉ≥Âè´ÈÜíÁöÑ‰∏ÄÂ§©ÔºåÂä†Ê≤πÔºåÊâìÂ∑•‰∫∫ÔºÅ"
                    ],
                    afternoon: [
                        "‰∏ãÂçàÂ•ΩÔºåÁßãÊó•ÁöÑÂçàÂêéÔºåÈò≥ÂÖâÊ∏©ÊöñÂæóÂàöÂàöÂ•Ω„ÄÇ‚òïÔ∏è",
                        "Êçß‰∏ÄÊùØÁÉ≠Ëå∂ÔºåËØª‰∏ÄÊú¨Â•Ω‰π¶Ôºå‰∫´ÂèóÁßãÊó•ÁöÑÈùôË∞ß„ÄÇ",
                        "ÁßãÂ§©ÊòØÊî∂Ëé∑ÁöÑÂ≠£ËäÇÔºåÊÑø‰Ω†ÁöÑÂä™ÂäõÈÉΩÊúâÂõûÊä•„ÄÇ",
                        "ÂçàÂÆâÔºåÊÑøÁßãÈ£éÂ∏¶Ëµ∞‰Ω†ÁöÑÁÉ¶ÊÅºÂíåÁñ≤ÊÉ´„ÄÇüçÇ",
                        "ÁßãÊó•ÁöÑÂçàÂêéÔºåÊØè‰∏ÄÂ∏ßÈÉΩÂÉèÁîµÂΩ±ÁîªÈù¢„ÄÇüé¨",
                        "Èò≥ÂÖâÊ≠£Â•ΩÔºåÊ∏©Â∫¶‰πüÊ≠£Â•ΩÔºå‰∏ÄÂàáÈÉΩÂàöÂàöÂ•Ω„ÄÇ",
                        "Êù•ÂùóÁÉ§Á∫¢ËñØÊàñÊòØÁ≥ñÁÇíÊ†óÂ≠êÊÄé‰πàÊ†∑Ôºüüå∞",
                        "‰∏ãÂçàÁäØÂõ∞ÁöÑËØùÔºåÂ∞±ÁúãÁúãÁ™óÂ§ñÁöÑËìùÂ§©ÁôΩ‰∫ëÂêß„ÄÇ"
                    ],
                    evening: [
                        "Êôö‰∏äÂ•ΩÔºåÁßãÈ£éÈÄÅÁàΩÔºåÊúàËâ≤ÂÆú‰∫∫„ÄÇüåï",
                        "‰∏πÊ°ÇÈ£òÈ¶ôÁöÑÂ§úÊôöÔºåÈÄÇÂêàÊÄùÂøµÂíåÂõ¢ÂúÜ„ÄÇ",
                        "ÁßãÂ§©ÁöÑÂ§úÊôöÔºåÊòØÊÄùÂøµÁöÑÂ≠£ËäÇÔºå‰πüÊòØÂÖªËÜòÁöÑÂ≠£ËäÇ„ÄÇ",
                        "ÊôöÊù•ÁßãÔºåÂ§©ÂáâÂ¶ÇÊ∞¥ÔºåÊó©ÁÇπ‰ºëÊÅØÂêß„ÄÇ",
                        "Êôö‰∏äÂ•ΩÔºå‰ªäÂ§©‰Ω†ÁúãÂà∞Áæé‰∏ΩÁöÑËêΩÊó•‰∫ÜÂêóÔºü",
                        "ÁßãÂ§©ÁöÑÂ§úÊôöÔºåÊÄªËÆ©‰∫∫ÊÑüËßâÊ†ºÂ§ñÂÆÅÈùôÂíåËàíÈÄÇ„ÄÇ",
                        "Â§©Ê∞îËΩ¨ÂáâÔºåÊôöÈ§êË¶ÅÂêÉÂæóÊöñÊöñÂíåÂíåÁöÑ„ÄÇ",
                        "Êúà‰∫ÆÊåÇÂú®ÊûùÂ§¥ÔºåÂÉè‰∏ÄÈ¢óÁÜüÈÄèÁöÑÊûúÂ≠ê„ÄÇÊôöÂÆâ„ÄÇ"
                    ],
                    night: [
                        "Â§úÊ∑±‰∫ÜÔºåÁßãÊÑèÊ∏êÊµìÔºåÊôöÂÆâÂ•ΩÊ¢¶„ÄÇüåô",
                        "ÊÑø‰Ω†‰º¥ÁùÄÁ™óÂ§ñÁöÑÊ°ÇËä±È¶ôÔºåÁîúÁîúÂú∞ËøõÂÖ•Ê¢¶‰π°„ÄÇ",
                        "Â§©Èò∂Â§úËâ≤ÂáâÂ¶ÇÊ∞¥ÔºåÂçßÁúãÁâµÁâõÁªáÂ•≥Êòü„ÄÇÊôöÂÆâ„ÄÇ",
                        "Ë¢´Â≠êË¶ÅÁõñÂéö‰∏ÄÁÇπ‰∫ÜÔºåÂ§úÈáå‰ºöÈôçÊ∏©ÁöÑ„ÄÇüò¥",
                        "Â§úÊ∑±‰∫ÜÔºåÊääÂøÉ‰∫ãÊîæ‰∏ÄËæπÔºåÂ•ΩÂ•ΩÁù°ËßâÊúÄÈáçË¶Å„ÄÇ",
                        "ÁßãÂ§úÂæÆÂáâÔºåÁõñÁùÄÊüîËΩØÁöÑË¢´Â≠êÔºåÊúÄÊòØËàíÊúç„ÄÇüò¥",
                        "ÊôöÂÆâÔºåÊÑø‰Ω†Ê¢¶ÈáåÊúâÈáëËâ≤ÁöÑÈ∫¶Áî∞ÂíåÊûúÂÆû„ÄÇ",
                        "ÊòéÂ§©‰ºöÊõ¥Â•ΩÔºåÂø´Áù°Âêß„ÄÇ"
                    ]
                },
                winter: { // ÂÜ¨Â≠£ (12-2Êúà)
                    morning: [
                        "Êó©‰∏äÂ•ΩÔºåËôΩÁÑ∂Â§©Ê∞îÂØíÂÜ∑Ôºå‰ΩÜ‰πüË¶ÅÊã•Êä±Èò≥ÂÖâÂì¶„ÄÇ‚ùÑÔ∏è",
                        "Êó©ÂÆâÔºåÂÜ¨Êó•ÈÜíÊù•ÊúâÈò≥ÂÖâÔºåÂ∞±ÊòØÊúÄÂπ∏Á¶èÁöÑ‰∫ã„ÄÇ",
                        "Ëµ∑Â∫äÂ§ß‰ΩúÊàòÂºÄÂßã‰∫ÜÔºÅÁ•ù‰Ω†ÊàêÂäüÔºÅüí™",
                        "ÂÜ¨Êó•Ê∏ÖÊô®ÔºåÊù•‰∏ÄÊùØÁÉ≠È•ÆÔºåÊ∏©Êöñ‰∏ÄÊï¥Â§©„ÄÇ‚òïÔ∏è",
                        "Êó©ÂÆâÔºÅ‰ªäÂ§©‰Ω†Âíå‰Ω†ÁöÑÂ∫äÂàÜÁ¶ªÊàêÂäü‰∫ÜÂêóÔºü",
                        "Á™óÊà∑‰∏äÁªì‰∫ÜÈúúËä±ÔºåÂÜ¨Â§©ÁúüÁöÑÊù•Âï¶„ÄÇ‚ùÑÔ∏è",
                        "ÁÉ≠Ê∞îËÖæËÖæÁöÑÊó©È§êÔºåÊòØÂØπÂÜ¨Â§©Êó©Êô®ÊúÄÂ§ßÁöÑÂ∞äÈáç„ÄÇ",
                        "Âëº‰∏ÄÂè£Ê∞îÈÉΩÊòØÁôΩËâ≤ÁöÑÔºåËøôÊâçÊòØÂÜ¨Â§©ÁöÑÊÑüËßâ„ÄÇ"
                    ],
                    afternoon: [
                        "‰∏ãÂçàÂ•ΩÔºåÊôíÊôíÂÜ¨Êó•ÁöÑÂ§™Èò≥ÔºåÊï¥‰∏™‰∫∫ÈÉΩÊöñÊ¥ãÊ¥ãÁöÑ„ÄÇ",
                        "Ê≥°‰∏™ÁÉ≠Ê∞¥ËÑöÔºåÊòØÂØπÂÜ¨Â§©‰∏ãÂçàÊúÄÂ•ΩÁöÑÂ∞äÈáç„ÄÇ",
                        "Â§©Ê∞îËøô‰πàÂÜ∑Ôºå‰∏çÂ¶Ç‚Ä¶ÂêÉÈ°øÁÅ´ÈîÖÔºüüç≤",
                        "ÊÑøËøô‰∏™ÂÜ¨Â§©ÔºåÊúâ‰∫∫‰∏é‰Ω†Á´ãÈªÑÊòèÔºåÈóÆ‰Ω†Á≤•ÂèØÊ∏©„ÄÇ",
                        "ÂÜ¨Êó•ÁöÑÂçàÂêéÁü≠ÊöÇÂèàÁèçË¥µÔºåÂ§öÊôíÊôíÂ§™Èò≥Âêß„ÄÇ",
                        "‰∏ÄÊùØÁÉ≠ÂèØÂèØÔºå‰∏Ä‰ªΩÂ•ΩÂøÉÊÉÖÔºåÈÄÅÁªô‰∏ãÂçàÁöÑ‰Ω†„ÄÇ‚òïÔ∏è",
                        "Â§ñÈù¢Â§©ÂØíÂú∞ÂÜªÔºåËøòÊòØÂæÖÂú®ÂÆ§ÂÜÖÊúÄËàíÊúç‰∫Ü„ÄÇ",
                        "Á¶ªÂ§©ÈªëÂèàËøë‰∫Ü‰∏ÄÊ≠•ÔºåÁèçÊÉúÁôΩÂ§©ÁöÑÊó∂ÂÖâ„ÄÇ"
                    ],
                    evening: [
                        "Êôö‰∏äÂ•ΩÔºåÁ™óÂ§ñÂ§©ÂØíÂú∞ÂÜªÔºåÂ±ãÂÜÖÊ∏©ÊöñÂ¶ÇÊò•„ÄÇ",
                        "ÂÜ¨Â§©ÊúÄÈÄÇÂêàÁ™ùÂú®Ê≤ôÂèëÈáåÔºåÁúã‰∏ÄÈÉ®Ê∏©ÊöñÁöÑÁîµÂΩ±„ÄÇüé¨",
                        "Èõ™ËêΩ‰∏ãÁöÑÂ£∞Èü≥ÔºåÊòØÂÜ¨Â§úÁöÑ‰∫§ÂìçÊõ≤„ÄÇ",
                        "ÊôöÊù•Â§©Ê¨≤Èõ™ÔºåËÉΩÈ•Æ‰∏ÄÊùØÊó†Ôºü",
                        "Êôö‰∏äÂ•ΩÔºåÂõûÂÆ∂Ë∑Ø‰∏äÊ≥®ÊÑè‰øùÊöñÂëÄ„ÄÇ",
                        "ÂÜ¨Â§úÁöÑÁÅØÁÅ´ÔºåÁúãËµ∑Êù•ÊÄªÊòØÊ†ºÂ§ñÊ∏©Êöñ„ÄÇ",
                        "Âøô‰∫Ü‰∏ÄÂ§©ÔºåÁ™ùÂú®Ê≤ôÂèëÈáåÂ∞±ÊòØÊúÄÂ§ßÁöÑÂπ∏Á¶è„ÄÇ",
                        "Â§©ÂÜ∑‰∫ÜÔºå‰ªäÊôöÂêÉÁÇπÁÉ≠‰πéÁöÑÂêßÔºÅ"
                    ],
                    night: [
                        "Â§úÊ∑±‰∫ÜÔºåÈíªËøõÊ∏©ÊöñÁöÑË¢´Á™ùÔºåÂíå‰∏ñÁïåËØ¥ÊôöÂÆâ„ÄÇüõå",
                        "ÊôöÂÆâÔºåÊÑø‰Ω†‰∏ÄÂ§úÊó†Ê¢¶ÔºåÂÆâÁù°Âà∞Â§©‰∫Æ„ÄÇ",
                        "ÂÜ¨Â§©ÔºåÊòØÈÄÇÂêàÊó©Áù°ÁöÑÂ≠£ËäÇÔºåÊôöÂÆâ„ÄÇ",
                        "ËØ∑Êü•Êî∂‰Ω†ÁöÑÂÜ¨Êó•ÈôêÂÆöÂ•ΩÊ¢¶„ÄÇüåô",
                        "ÊôöÂÆâÔºåËÆ©Ê∏©ÊöñÁöÑË¢´Á™ùÊ≤ªÊÑà‰Ω†ÁöÑ‰∏ÄÂàá„ÄÇ",
                        "Âê¨ÁùÄÁ™óÂ§ñÁöÑÈ£éÂ£∞ÔºåÂÆâÁ®≥Âú∞Áù°Âêß„ÄÇ",
                        "Âà´ÁÜ¨Â§ú‰∫ÜÔºåÂØπÂæóËµ∑Ëøô‰πàÂÜ∑ÁöÑÂ§©ÂêóÔºüÂø´ÂéªÁù°ËßâÔºÅ",
                        "ÊôöÂÆâÔºåÊÑø‰Ω†Ê¢¶ÈáåÈò≥ÂÖâÊôÆÁÖßÔºåÊò•ÊöñËä±ÂºÄ„ÄÇ"
                    ]
                },
                default: [ // ÈªòËÆ§/Â§áÁî®ÈóÆÂÄôËØ≠
                    "‰Ω†Â•ΩÂëÄÔºå‰ªäÂ§©ËøáÂæóÊÄé‰πàÊ†∑Ôºü",
                    "ÊÑø‰Ω†ÁúºÈáåÁöÑÊòüÊòüÔºåÊ∞∏ËøúÈó™‰∫Æ„ÄÇ",
                    "Êó†ËÆ∫Â§©Ê∞îÂ¶Ç‰ΩïÔºåËÆ∞ÂæóÂ∏¶‰∏äËá™Â∑±ÁöÑÈò≥ÂÖâ„ÄÇ",
                    "Â∏åÊúõ‰Ω†‰ªäÂ§©‰πüËÉΩÂºÄÂøÉÔºÅ",
                    "ÂòøÔºåÈôåÁîü‰∫∫ÔºåÁ•ù‰Ω†‰ªäÂ§©ÂºÄÂøÉ„ÄÇ",
                    "ÁîüÊ¥ªÊàñËÆ∏‰∏çÊòìÔºå‰ΩÜËØ∑Âà´Âøò‰∫ÜÂæÆÁ¨ë„ÄÇüòä",
                    "ÊØè‰∏ÄÂ§©ÈÉΩÊòØ‰∏Ä‰ªΩÁã¨‰∏ÄÊó†‰∫åÁöÑÁ§ºÁâ©„ÄÇ",
                    "ÂÅ∑ÂÅ∑ÂëäËØâ‰Ω†Ôºå‰Ω†ÂæàÊ£íÔºÅ",
                    "ÊÑø‰Ω†ÊâÄÂà∞‰πãÂ§ÑÁöÜÁÉ≠ÂúüÔºåÊâÄÈÅá‰πã‰∫∫ÁöÜËâØÂñÑ„ÄÇ"
                ]
            };

            // Âà§Êñ≠Â≠£ËäÇ
            let season = 'default';
            if (month >= 3 && month <= 5) {
                season = 'spring';
            } else if (month >= 6 && month <= 8) {
                season = 'summer';
            } else if (month >= 9 && month <= 11) {
                season = 'autumn';
            } else { // 12, 1, 2Êúà
                season = 'winter';
            }

            // Âà§Êñ≠Êó∂Èó¥ÊÆµ
            let timeOfDay = 'night';
            if (hour >= 5 && hour < 12) {
                timeOfDay = 'morning';
            } else if (hour >= 12 && hour < 18) {
                timeOfDay = 'afternoon';
            } else if (hour >= 18 && hour < 22) {
                timeOfDay = 'evening';
            }

            // Ëé∑ÂèñÂØπÂ∫îÁöÑÈóÆÂÄôËØ≠ÂàóË°®
            const availableGreetings = greetings[season][timeOfDay] || greetings.default;
            
            // ÈöèÊú∫ÈÄâÊã©‰∏ÄÊù°ÈóÆÂÄôËØ≠Âπ∂ÊòæÁ§∫
            const randomGreeting = availableGreetings[Math.floor(Math.random() * availableGreetings.length)];
            greetingEl.textContent = randomGreeting;
        }

        // --- [REFACTORED] Êó•ÂéÜËÆ°ÁÆóÊ†∏ÂøÉÂáΩÊï∞ ---
        function lYearDays(y) { let i, sum = 348; for (i = 0x8000; i > 0x8; i >>= 1) sum += (lunarInfo[y - 1900] & i) ? 1 : 0; return (sum + leapDays(y)); }
        function leapDays(y) { if (leapMonth(y)) return ((lunarInfo[y - 1900] & 0x10000) ? 30 : 29); else return (0); }
        function leapMonth(y) { return (lunarInfo[y - 1900] & 0xf); }
        function monthDays(y, m) { return ((lunarInfo[y - 1900] & (0x10000 >> m)) ? 30 : 29); }
        function Dianaday(objDate) {
            const msPerDay = 86400000; // 24 * 60 * 60 * 1000
            const utcTarget = Date.UTC(objDate.getFullYear(), objDate.getMonth(), objDate.getDate());
            const utcBase = Date.UTC(1900, 0, 31);
            var offset = (utcTarget - utcBase) / msPerDay;

            var i, leap = 0, temp = 0;
            this.dayCyl = offset + 40; this.monCyl = 14; for (i = 1900; i < 2050 && offset > 0; i++) { temp = lYearDays(i); offset -= temp; this.monCyl += 12; } if (offset < 0) { offset += temp; i--; this.monCyl -= 12; } this.year = i; this.yearCyl = i - 1864; leap = leapMonth(i); this.isLeap = false; for (i = 1; i < 13 && offset > 0; i++) { if (leap > 0 && i == (leap + 1) && this.isLeap == false) { --i; this.isLeap = true; temp = leapDays(this.year); } else { temp = monthDays(this.year, i); } if (this.isLeap == true && i == (leap + 1)) this.isLeap = false; offset -= temp; if (this.isLeap == false) this.monCyl++; } if (offset == 0 && leap > 0 && i == leap + 1) if (this.isLeap) { this.isLeap = false; } else { this.isLeap = true; --i; --this.monCyl; } if (offset < 0) { offset += temp; --i; --this.monCyl; } this.month = i; this.day = offset + 1;
        }
        
        // --- [NEW] ‰∏â‰ºèÂ§©ÁâπÂÆöÊó•Êúü ---
        // Áî±‰∫é‰∏â‰ºèÂ§©ËÆ°ÁÆóÂ§çÊùÇ‰∏î‰∏éÂ∫ïÂ±ÇÊó•ÂéÜÊï∞ÊçÆÂº∫Áõ∏ÂÖ≥Ôºå‰∏∫‰øùËØÅÂáÜÁ°ÆÊÄßÔºåÊ≠§Â§Ñ‰ΩøÁî®È¢ÑÂÖàÊü•ÂÆöÁöÑÊó•Êúü
        // Êï∞ÊçÆÊù•Ê∫êÔºöÂÖ¨ÂºÄÁöÑÂ§©ÊñáÊó•ÂéÜ‰ø°ÊÅØ
        const sanfuData = {
            2023: { rufu: '07-11', zhongfu: '07-21', mofu: '08-10' },
            2024: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2025: { rufu: '07-20', zhongfu: '07-30', mofu: '08-09' },
            2026: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2027: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2028: { rufu: '07-19', zhongfu: '07-29', mofu: '08-08' },
            2029: { rufu: '07-14', zhongfu: '07-24', mofu: '08-13' },
            2030: { rufu: '07-19', zhongfu: '07-29', mofu: '08-08' },
        };

        function getSanfuDates(year) {
            const dates = sanfuData[year];
            if (!dates) return [];
            
            const rufuDateParts = dates.rufu.split('-');
            const zhongfuDateParts = dates.zhongfu.split('-');
            const mofuDateParts = dates.mofu.split('-');

            return [
                { name: 'ÂÖ•‰ºè', date: new Date(year, parseInt(rufuDateParts[0]) - 1, parseInt(rufuDateParts[1])) },
                { name: '‰∏≠‰ºè', date: new Date(year, parseInt(zhongfuDateParts[0]) - 1, parseInt(zhongfuDateParts[1])) },
                { name: 'Êú´‰ºè', date: new Date(year, parseInt(mofuDateParts[0]) - 1, parseInt(mofuDateParts[1])) }
            ];
        }
        
        function getAllHolidaysForYear(year) {
            let allEvents = [];
            
            function getSolarDateForLunar(targetYear, lunarMonth, lunarDay) {
                for (let i = 0; i < 366; i++) {
                    const checkDate = new Date(targetYear, 0, 1);
                    checkDate.setDate(checkDate.getDate() + i);
                    if (checkDate.getFullYear() !== targetYear) break;
                    const lunarDateInfo = new Dianaday(checkDate);
                    if (lunarDateInfo.month === lunarMonth && lunarDateInfo.day === lunarDay && !lunarDateInfo.isLeap) return checkDate;
                }
                return null;
            }

            // ÂÖ¨ÂéÜËäÇÊó•
            sFtv.forEach(holiday => {
                if (holiday.start && year < holiday.start) {
                    return;
                }
                const month = parseInt(holiday.date.substr(0, 2));
                const day = parseInt(holiday.date.substr(2, 2));
                allEvents.push({ name: holiday.name, date: new Date(year, month - 1, day) });
            });

            // ÂÜúÂéÜËäÇÊó•
            const allLunarHolidays = [...lFtv, { date: "1230", name: "Èô§Â§ï" }];
            allLunarHolidays.forEach(holiday => {
                const name = holiday.name;
                if (name === 'Èô§Â§ï') {
                    // To find the New Year's Eve that falls within a given Gregorian year, we find the
                    // Spring Festival of that same year and calculate the day before it.
                    const cnyDate = getSolarDateForLunar(year, 1, 1);
                    if (cnyDate) {
                        let eveDate = new Date(cnyDate);
                        eveDate.setDate(eveDate.getDate() - 1);
                        // Only add it if the calculated Eve date actually falls in the target year.
                        if (eveDate.getFullYear() === year) {
                            allEvents.push({ name: 'Èô§Â§ï', date: eveDate });
                        }
                    }
                } else {
                    const lMonth = parseInt(holiday.date.substr(0, 2));
                    const lDay = parseInt(holiday.date.substr(2, 2));
                    const holidayDate = getSolarDateForLunar(year, lMonth, lDay);
                    if (holidayDate) allEvents.push({ name: holiday.name, date: holidayDate });
                }
            });

            // ËäÇÊ∞î
            solarTerm.forEach((termName, i) => {
                const offDate = new Date((31556925974.7 * (year - 1900) + sTermInfo[i] * 60000) + Date.UTC(1900, 0, 6, 2, 5));
                allEvents.push({ name: termName, date: new Date(offDate.getUTCFullYear(), offDate.getUTCMonth(), offDate.getUTCDate()) });
            });

            // Âë®Êó•ËÆ°ÁÆóÁöÑËäÇÊó•
            const mayFirst = new Date(year, 4, 1);
            const mothersDay = new Date(year, 4, 1 + (7 - mayFirst.getDay() + 7) % 7 + 7);
            allEvents.push({ name: 'ÊØç‰∫≤ËäÇ', date: mothersDay });

            const juneFirst = new Date(year, 5, 1);
            const fathersDay = new Date(year, 5, 1 + (7 - juneFirst.getDay() + 7) % 7 + 14);
            allEvents.push({ name: 'Áà∂‰∫≤ËäÇ', date: fathersDay });

            const novFirst = new Date(year, 10, 1);
            const thanksgivingDay = new Date(year, 10, 1 + (4 - novFirst.getDay() + 7) % 7 + 21);
            allEvents.push({ name: 'ÊÑüÊÅ©ËäÇ', date: thanksgivingDay });
            
            // Ê∑ªÂä†‰∏â‰ºèÂ§©
            const sanfuDates = getSanfuDates(year);
            allEvents.push(...sanfuDates);

            // ÊéíÂ∫èÂπ∂ËøîÂõû
            return allEvents.sort((a, b) => a.date - b.date);
        }

        // --- ‰∏ªÂÄíËÆ°Êó∂Âç°ÁâáÊõ¥Êñ∞ ---
        function updateCountdown() {
            const countdownDisplay = document.getElementById('countdown-display');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const currentYearEvents = getAllHolidaysForYear(now.getFullYear());
            const nextYearEvents = getAllHolidaysForYear(now.getFullYear() + 1);

            const upcomingEvents = [...currentYearEvents, ...nextYearEvents].filter(event => event.date >= today);

            if (upcomingEvents.length > 0) {
                const nextHoliday = upcomingEvents[0];
                const diffTime = nextHoliday.date - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    countdownDisplay.innerHTML = `<span style="color: var(--text-color-primary);">Ë∑ùÁ¶ª</span><br><span class="text-2xl font-bold" style="color: var(--text-color-primary);">${nextHoliday.name}</span><br><strong class="text-4xl font-bold" style="color: var(--accent-color);">‰ªäÂ§©</strong>`;
                } else if (diffDays === 1) {
                    countdownDisplay.innerHTML = `<span style="color: var(--text-color-primary);">Ë∑ùÁ¶ª</span><br><span class="text-2xl font-bold" style="color: var(--text-color-primary);">${nextHoliday.name}</span><br><strong class="text-4xl font-bold" style="color: var(--accent-color);">ÊòéÂ§©</strong>`;
                } else {
                    countdownDisplay.innerHTML = `<span style="color: var(--text-color-primary);">Ë∑ùÁ¶ª</span><br><strong class="text-2xl" style="color: var(--text-color-primary);">${nextHoliday.name}</strong><br><span class="font-bold text-5xl align-baseline">${diffDays}</span><span class="text-lg align-baseline ml-1">Â§©</span>`;
                }
            } else {
                countdownDisplay.textContent = 'ÊâÄÊúâËäÇÊó•ÈÉΩÂ∑≤ËÆ°ÁÆóÂÆåÊØïÔºÅ';
            }
        }

        // --- ËäÇÊó•ÂàóË°®ËßÜÂõæÊõ¥Êñ∞ ---
        function displayHolidayList(year, isAnimated = false) {
            const container = document.getElementById('holiday-list-container');
            const yearDisplay = document.getElementById('holiday-list-year');

            const updateContent = () => {
                yearDisplay.textContent = year;
            
                const allHolidays = getAllHolidaysForYear(year);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                const firstUpcoming = [...getAllHolidaysForYear(now.getFullYear()), ...getAllHolidaysForYear(now.getFullYear() + 1)]
                    .filter(e => e.date >= today)[0];

                const holidaysByMonth = allHolidays.reduce((acc, holiday) => {
                    const month = holiday.date.getMonth();
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(holiday);
                    return acc;
                }, {});

                let html = '';
                for (let month = 0; month < 12; month++) {
                    if (holidaysByMonth[month]) {
                        html += `<div class="mb-3"><h3 class="text-lg font-semibold border-b pb-1 mb-2" style="color: var(--text-color-secondary); border-color: var(--separator-color);">${month + 1}Êúà</h3>`;
                        holidaysByMonth[month].forEach(holiday => {
                            const diffTime = holiday.date - today;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            let statusText = '';

                            if (holiday.date.getFullYear() < now.getFullYear() || (holiday.date.getFullYear() === now.getFullYear() && diffDays < -1)) {
                                statusText = `<span style="color: var(--status-past);">Â∑≤Ëøá</span>`;
                            } else if (diffDays === -1) {
                                statusText = `<span style="color: var(--status-yesterday);">Êò®Â§©</span>`;
                            } else if (diffDays === 0) {
                                statusText = `<span style="color: var(--status-today); font-weight: bold;">‰ªäÂ§©</span>`;
                            } else if (diffDays === 1) {
                                statusText = `<span style="color: var(--status-tomorrow); font-weight: bold;">ÊòéÂ§©</span>`;
                            } else {
                                statusText = `
                                    <div class="flex items-baseline" style="color: var(--accent-color);">
                                        <span class="text-2xl font-bold">${diffDays}</span>
                                        <span class="text-sm ml-1">Â§©</span>
                                    </div>
                                `;
                            }
                            
                            const isHighlighted = firstUpcoming && firstUpcoming.name === holiday.name && firstUpcoming.date.getTime() === holiday.date.getTime();
                            const highlightClass = isHighlighted ? 'highlight-holiday' : '';

                            const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
                            const dayOfWeek = weekdays[holiday.date.getDay()];
                            const formattedDate = `${holiday.date.getMonth() + 1}Êúà${holiday.date.getDate()}Êó•`;

                            html += `
                                <div class="flex justify-between items-center p-2 rounded-lg ${highlightClass}">
                                    <div>
                                        <div style="color: var(--text-color-primary);">${holiday.name}</div>
                                        <div class="text-sm" style="color: var(--text-color-secondary);">${formattedDate} | ${dayOfWeek}</div>
                                    </div>
                                    ${statusText}
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                }
                container.innerHTML = html;
                // [NEW] Update button visibility after content is rendered
                setTimeout(updateTodayButtonVisibility, 50);
            };

            if (isAnimated) {
                container.style.opacity = 0;
                yearDisplay.style.opacity = 0;
                setTimeout(() => {
                    updateContent();
                    container.style.opacity = 1;
                    yearDisplay.style.opacity = 1;
                }, 100);
            } else {
                updateContent();
            }
        }

        // [NEW] Custom smooth scroll implementation for speed control
        function customSmoothScrollTo(targetElement, options) {
            const { duration = 300, block = 'center' } = options;
            // SimpleBar creates a specific wrapper for the scrollable content.
            const scrollContainer = document.getElementById('holiday-list-container-wrapper').querySelector('.simplebar-content-wrapper');

            if (!scrollContainer || !targetElement) return;

            let targetY;
            if (block === 'center') {
                targetY = targetElement.offsetTop + (targetElement.offsetHeight / 2) - (scrollContainer.offsetHeight / 2);
            } else if (block === 'start') {
                targetY = targetElement.offsetTop;
            } else { // 'end'
                targetY = targetElement.offsetTop + targetElement.offsetHeight - scrollContainer.offsetHeight;
            }
            
            // Ensure targetY is within scrollable bounds
            targetY = Math.max(0, Math.min(targetY, scrollContainer.scrollHeight - scrollContainer.clientHeight));

            const startY = scrollContainer.scrollTop;
            const distance = targetY - startY;
            let startTime = null;

            // easeInOutCubic easing function for a slightly smoother start/end
            function ease(t, b, c, d) {
                t /= d / 2;
                if (t < 1) return c / 2 * t * t * t + b;
                t -= 2;
                return c / 2 * (t * t * t + 2) + b;
            }

            function animation(currentTime) {
                if (startTime === null) startTime = currentTime;
                const timeElapsed = currentTime - startTime;
                const run = ease(timeElapsed, startY, distance, duration);
                scrollContainer.scrollTop = run;
                if (timeElapsed < duration) {
                    requestAnimationFrame(animation);
                }
            }

            requestAnimationFrame(animation);
        }

        // [NEW] Core function to scroll to the target festival
        const scrollToTargetFestival = (isAnimated = true) => {
            // Use a timeout to ensure the DOM has updated, e.g., after a year change
            setTimeout(() => {
                const container = document.getElementById('holiday-list-container');
                if (!container) return;

                let targetElement = container.querySelector('.highlight-holiday');

                // If no highlighted holiday in the current view (e.g., all passed for the year)
                if (!targetElement) {
                    // As per user request, find the last festival of the displayed year
                    const allHolidays = container.querySelectorAll('.flex.justify-between.items-center');
                    if (allHolidays.length > 0) {
                        targetElement = allHolidays[allHolidays.length - 1];
                    }
                }

                if (targetElement) {
                    if (isAnimated) {
                        customSmoothScrollTo(targetElement, { duration: 300, block: 'center' });
                    } else {
                        targetElement.scrollIntoView({ behavior: 'auto', block: 'center' });
                    }
                }
            }, 160); // Must be slightly longer than the list update animation (150ms)
        };

        // [NEW] Logic for the "Today" button's visibility
        let todayButtonObserver;
        function updateTodayButtonVisibility() {
            const backToTodayBtn = document.getElementById('back-to-today-btn');
            const currentYear = new Date().getFullYear();

            if (todayButtonObserver) {
                todayButtonObserver.disconnect();
            }

            if (holidayListDisplayedYear !== currentYear) {
                backToTodayBtn.classList.add('visible'); // Always show for other years
                return;
            }

            // Logic for the current year
            const container = document.getElementById('holiday-list-container');
            let targetElement = container.querySelector('.highlight-holiday');

            if (!targetElement) {
                const allHolidays = container.querySelectorAll('.flex.justify-between.items-center');
                if (allHolidays.length > 0) {
                    targetElement = allHolidays[allHolidays.length - 1];
                }
            }

            if (targetElement) {
                const scrollWrapper = document.getElementById('holiday-list-container-wrapper');
                todayButtonObserver = new IntersectionObserver((entries) => {
                    const [entry] = entries;
                    // Show button if target is NOT visible
                    if (entry.isIntersecting) {
                        backToTodayBtn.classList.remove('visible');
                    } else {
                        backToTodayBtn.classList.add('visible');
                    }
                }, {
                    root: scrollWrapper,
                    threshold: 0.5 // 50% of the element is visible
                });
                todayButtonObserver.observe(targetElement);
            } else {
                // No target element found, hide the button
                backToTodayBtn.classList.remove('visible');
            }
        }

        // --- Hitokoto ‰∏ÄË®Ä ÂäüËÉΩ ---
        let isUpdatingQuote = false;
        async function fetchHitokoto() {
            if (isUpdatingQuote) return;
            isUpdatingQuote = true;
            const hitokotoText = document.getElementById('hitokoto-text');
            const hitokotoFrom = document.getElementById('hitokoto-from');
            hitokotoText.classList.add('opacity-0');
            hitokotoFrom.classList.add('opacity-0');
            try {
                await new Promise(resolve => setTimeout(resolve, 500));

                let apiUrl = 'https://v1.hitokoto.cn/?encode=json';
                if (appSettings.hitokoto.mode === 'custom' && appSettings.hitokoto.categories.length > 0) {
                    const categoryParams = appSettings.hitokoto.categories.map(cat => `c=${cat}`).join('&');
                    apiUrl += `&${categoryParams}`;
                }

                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                hitokotoText.textContent = data.hitokoto;
                hitokotoFrom.textContent = `‚Äî „Äå${data.from || 'Êú™Áü•Êù•Ê∫ê'}„Äç`;
            } catch (error) {
                console.error("Ëé∑Âèñ‰∏ÄË®ÄÂ§±Ë¥•:", error);
                hitokotoText.textContent = 'Ëé∑Âèñ‰∏ÄË®ÄÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ';
                hitokotoFrom.textContent = '';
            } finally {
                hitokotoText.classList.remove('opacity-0');
                hitokotoFrom.classList.remove('opacity-0');
                setTimeout(() => { isUpdatingQuote = false; }, 600);
            }
        }

        // --- Êó∂ÂÖâËÉ∂ÂõäÂäüËÉΩ ---
        function updateTimeCapsule() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const dayOfMonth = now.getDate();
            const dayOfWeek = now.getDay(); // 0 for Sunday, 1 for Monday, etc.
            const hour = now.getHours();

            // 1. ‰ªäÊó•ËøõÂ∫¶
            const dayPassed = hour;
            const dayLeft = 24 - dayPassed;
            const dayPercent = (dayPassed / 24) * 100;
            document.getElementById('day-passed').textContent = dayPassed;
            document.getElementById('day-left').textContent = dayLeft;
            document.getElementById('day-percent').textContent = `${dayPercent.toFixed(1)}%`;
            document.getElementById('day-progress').style.width = `${dayPercent}%`;

            // 2. Êú¨Âë®ËøõÂ∫¶ (Âë®‰∏Ä‰∏∫Á¨¨‰∏ÄÂ§©)
            const weekPassed = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const weekLeft = 7 - weekPassed;
            const weekPercent = ((weekPassed + (hour / 24)) / 7) * 100;
            document.getElementById('week-passed').textContent = weekPassed;
            document.getElementById('week-left').textContent = weekLeft;
            document.getElementById('week-percent').textContent = `${weekPercent.toFixed(1)}%`;
            document.getElementById('week-progress').style.width = `${weekPercent}%`;

            // 3. Êú¨ÊúàËøõÂ∫¶
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthPassed = dayOfMonth;
            const monthLeft = daysInMonth - monthPassed;
            const monthPercent = (monthPassed / daysInMonth) * 100;
            document.getElementById('month-passed').textContent = monthPassed;
            document.getElementById('month-left').textContent = monthLeft;
            document.getElementById('month-percent').textContent = `${monthPercent.toFixed(1)}%`;
            document.getElementById('month-progress').style.width = `${monthPercent}%`;

            // 4. ‰ªäÂπ¥ËøõÂ∫¶
            const startOfYear = new Date(year, 0, 1);
            const endOfYear = new Date(year, 11, 31);
            const totalDaysInYear = (endOfYear - startOfYear) / (1000 * 60 * 60 * 24) + 1;
            const yearPassed = Math.ceil((now - startOfYear) / (1000 * 60 * 60 * 24));
            const yearLeft = totalDaysInYear - yearPassed;
            const yearPercent = (yearPassed / totalDaysInYear) * 100;
            document.getElementById('year-passed').textContent = yearPassed;
            document.getElementById('year-left').textContent = yearLeft;
            document.getElementById('year-percent').textContent = `${yearPercent.toFixed(1)}%`;
            document.getElementById('year-progress').style.width = `${yearPercent}%`;
        }
        
        // --- ÁΩëÁ´ôËøêË°åÊó∂Èó¥ ---
        function updateSiteRuntime() {
             const startTime = new Date('2025-07-30T18:30:00');
            const now = new Date();
            const diff = now - startTime;

            const displayElement = document.getElementById('site-runtime-display');
            if (!displayElement) return;

            if (diff < 0) {
                displayElement.textContent = 'Â∞èÁ†¥Á´ôÂ∞öÊú™ÂêØËà™...';
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            displayElement.innerHTML = `Â∞èÁ†¥Á´ôÂ∑≤ÁªèÂú®È£éÈõ®‰∏≠Â∫¶Ëøá‰∫Ü <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${days}</span> Â§© <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${hours}</span> Â∞èÊó∂ <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${minutes}</span> ÂàÜ <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${seconds}</span> Áßí`;
        }

        // --- GitHub Chart Loader Logic ---
        function setupGitHubChartLoader() {
            const spinner = document.getElementById('gh-chart-spinner');
            const errorContainer = document.getElementById('gh-chart-error');
            const errorMessage = document.getElementById('gh-chart-error-message');
            const imgLink = document.getElementById('gh-chart-link');
            const img = document.getElementById('gh-chart-img');
            const loadingContainer = document.getElementById('gh-chart-loading');
            const chartWrapper = document.getElementById('gh-chart-wrapper');

            const loadImage = () => {
                // Reset image state for re-loads
                img.classList.remove('loaded');
                imgLink.classList.add('invisible');
                errorContainer.classList.remove('visible');

                // Show loading UI
                chartWrapper.classList.add('hidden');
                loadingContainer.classList.remove('hidden');
                spinner.classList.add('visible');

                const originalSrc = img.dataset.src;
                const baseUrl = originalSrc.split('?')[0];
                // Reconstruct URL to safely add cache-busting parameter
                img.src = `${baseUrl}?theme=dark&v=${new Date().getTime()}`;
            };

            img.onload = () => {
                // Hide loading UI
                spinner.classList.remove('visible');
                loadingContainer.classList.add('hidden');
                
                // Show the chart wrapper so its contents can be animated
                chartWrapper.classList.remove('hidden');
                
                // Defer the animation trigger to the next paint cycle for reliability
                requestAnimationFrame(() => {
                    imgLink.classList.remove('invisible');
                    imgLink.classList.add('visible');
                    img.classList.add('loaded');
                });
            };

            img.onerror = () => {
                // Hide loading UI
                spinner.classList.remove('visible');
                loadingContainer.classList.add('hidden');

                // Show the chart wrapper to display the error message
                chartWrapper.classList.remove('hidden');

                errorContainer.classList.add('visible');
                errorMessage.textContent = 'Ë¥°ÁåÆÂõæÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂπ∂ÈáçËØï„ÄÇ';
            };

            errorContainer.addEventListener('click', () => {
                loadImage();
            });

            // Initial load
            loadImage();
        }


        // --- [NEW] Settings Management ---
        let appSettings = {
            background: {
                source: 'default',
                specifier: 'random',
                customUrl: null,
                customType: 'unknown' // 'image', 'api', or 'unknown'
            },
            appearance: {
                glassEffect: true,
                cardBorderRadius: 16,
                cardBlurAmount: 16
            },
            theme: 'system', // 'system', 'light', 'dark'
            timeFormat: '24h', // '12h' or '24h'
            immersiveBlinkingColon: false,
            view: 'github', // 'github' or 'weather'
            weather: {
                source: 'auto', // 'auto' or 'manual'
                city: null, // User-overridden city
                lastFetchedCity: null // City from last successful fetch
            },
            hitokoto: {
                mode: 'default', // 'default' or 'custom'
                categories: ['a'] // Array of selected category codes
            },
            developer: {
                masterSwitchEnabled: true, // Master switch for the entire feature
        uiToggleState: true,       // State of the toggle in the UI
        forceNewYearTheme: false // [NEW] Developer toggle for New Year theme
            },
            newYearTheme: {
                backgroundEnabled: true
            }
        };

// --- [NEW] New Year Theme Logic ---
function isNewYearPeriod() {
    const today = new Date();
    const lunarDate = new Dianaday(today);

    // Case 1: It's the first lunar month, from day 1 to day 10.
    if (lunarDate.month === 1 && lunarDate.day >= 1 && lunarDate.day <= 10) {
        return true;
    }

    // Case 2: It's the last day of the 12th lunar month (New Year's Eve).
    if (lunarDate.month === 12) {
        const daysInLastMonth = monthDays(lunarDate.year, 12);
        if (lunarDate.day === daysInLastMonth) {
            return true;
        }
    }

    return false;
}

let newYearMusicIntroPlayed = false;
const NY_MUSIC_LOOP_START = 85.16; // 01:25:16
const NY_MUSIC_LOOP_END = 173.20;   // 02:53:20

function stopNewYearMusic() {
    const audio = document.getElementById('new-year-audio');
    if (audio) {
        audio.pause();
        audio.currentTime = 0;
    }
}


function applyNewYearMode() {
    const body = document.body;
    const musicBtn = document.getElementById('new-year-music-btn');

    const isThemeAvailable = isNewYearPeriod() || appSettings.developer.forceNewYearTheme;
    const isThemeEnabledByUser = appSettings.newYearTheme.backgroundEnabled;
    const shouldBeActive = isThemeAvailable && isThemeEnabledByUser;

    const isCurrentlyActive = body.classList.contains('new-year-active');

    const bgSettingsWrapper = document.getElementById('main-background-settings-wrapper');
    if (bgSettingsWrapper) {
        bgSettingsWrapper.classList.toggle('disabled', shouldBeActive);
    }

    if (shouldBeActive) {
        // --- Activate or Keep Active ---
        musicBtn.classList.add('visible'); // [MODIFIED] Use 'visible' class for transition
        musicBtn.classList.add('is-paused'); // Set initial state
        if (!isCurrentlyActive) {
            // It needs to be turned ON
            body.classList.add('new-year-active');
            backgroundFader.update('new_year_bg.svg', true);
            // Music is not auto-played, user must click.
        }
        // If it's already active, do nothing to prevent re-renders.
    } else {
        // --- Deactivate or Keep Inactive ---
        musicBtn.classList.remove('visible'); // [MODIFIED] Use 'visible' class for transition
        stopNewYearMusic();
        if (isCurrentlyActive) {
            // It needs to be turned OFF
            body.classList.remove('new-year-active');
            applyCurrentBackground();
        }
        // If it's already inactive, do nothing.
    }
}


        const WEATHER_TIPS = {
            spring: {
                morning: {
                    clear: ["Êò•Êó•ÊÇ†ÊÇ†ÔºåÈò≥ÂÖâÂî§ÈÜí‰∏áÁâ©Ôºå‰πüÂî§ÈÜí‰Ω†„ÄÇ", "Êó©‰∏äÂ•ΩÔºå‰ªäÂ§©ÈÄÇÂêàË∏èÈùíÔºåËÆ∞ÂæóÈò≤ÊôíÂì¶„ÄÇ", "‰∏ÄÂπ¥‰πãËÆ°Âú®‰∫éÊò•Ôºå‰∏ÄÊó•‰πãËÆ°Âú®‰∫éÊô®ÔºåÂä†Ê≤πÔºÅ"],
                    cloudy: ["Êó©ÂÆâÔºå‰∫ëÊúµÈÅÆ‰∏ç‰Ωè‰Ω†ÁöÑÂ•ΩÂøÉÊÉÖ„ÄÇ", "ÂæÆÈ£éÊãÇÈù¢ÔºåÊò•ÊÑèÁõéÁÑ∂ÔºåÂ§ö‰∫ëÂ§©‰πüÂæàËàíÊúç„ÄÇ", "Ê≥°‰∏ÄÊùØÈ¶ôËåóÔºåÈùôÂæÖ‰∫ëÊï£È£éÊ∏Ö„ÄÇ"],
                    overcast: ["Â§©Á©∫ËôΩÈò¥Ôºå‰ΩÜÊª°ÊòØÊò•Â§©Ê∞îÊÅØ„ÄÇ", "Èò¥Â§©ÔºåÂÆúÈùôÂøÉÊÄùËÄÉÔºåËßÑÂàíÊñ∞ÁöÑ‰∏ÄÂë®„ÄÇ", "ËÆ∞ÂæóÂ∏¶‰ª∂ËñÑÂ§ñÂ•óÔºåÂ∞èÂøÉÊò•ÂØíÊñôÂ≥≠„ÄÇ"],
                    rain: ["Êò•Èõ®Ë¥µÂ¶ÇÊ≤πÔºåÊó©ÂÆâ„ÄÇÂá∫Èó®Â∏¶‰ºûÔºåÂ∞èÂøÉË∑ØÊªë„ÄÇ", "ÁªÜÈõ®ËíôËíôÔºåÊò•Â§©‰ΩéËØ≠ÔºåÂÆúÁ™óËæπÈòÖËØª„ÄÇ", "Èõ®Â§©ÂæÆÂáâÔºåÊ≥®ÊÑè‰øùÊöñÔºåÁÉ≠Ëå∂Êõ¥ÊÉ¨ÊÑè„ÄÇ"],
                    fog: ["ÈõæÊ∞îÂº•Êº´ÁöÑÊ∏ÖÊô®Ôºå‰ªø‰ΩõÁΩÆË∫´‰ªôÂ¢É„ÄÇ", "Â§ßÈõæÂ§©Ê∞îÔºåÂá∫Ë°åËØ∑Ê≥®ÊÑèÂÆâÂÖ®ÔºåÂáèÈÄüÊÖ¢Ë°å„ÄÇ", "ÈõæÊï£‰πãÂêéÔºå‰æøÊòØÊ∏ÖÊñ∞ÁöÑ‰∏ñÁïåÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ„ÄÇ"],
                    windy: ["Êò•È£éÊãÇÈù¢ÔºåÂ∏¶Êù•Ëä±ËçâËÆØÊÅØ„ÄÇÊà¥Â•ΩÂ∏ΩÂ≠êÂì¶„ÄÇ", "È£éÊúâÁÇπÂ§ßÔºåËØ∑ÂÖ≥Â•ΩÈó®Á™óÔºåÈò≤Ê≠¢Êù®ÁµÆÈ£ûÂÖ•„ÄÇ", "Âú®È£é‰∏≠ÔºåÊÑüÂèóÊò•Â§©ÁöÑÂäõÈáè‰∏éÊ¥ªÂäõ„ÄÇ"],
                    default: ["Êó©ÂÆâÔºåÊÑø‰Ω†ÁöÑ‰∏ÄÂ§©Â¶ÇÊò•Êó•Ëà¨ÂÖÖÊª°Â∏åÊúõ„ÄÇ"]
                },
                afternoon: {
                    clear: ["ÂçàÂêéÈò≥ÂÖâÊ≠£Â•ΩÔºåÈÄÇÂêàÂÖ¨Âõ≠Êï£Ê≠•„ÄÇ", "Êò•Êó•ÊöñÈò≥Ôºå‰∏çÂ¶®Â∞èÊÜ©ÁâáÂàªÔºåÊÅ¢Â§çÁ≤æÂäõ„ÄÇ", "Á¥´Â§ñÁ∫øÊ∏êÂº∫ÔºåÂçàÂêéÂá∫Èó®Âà´ÂøòÈò≤Êôí„ÄÇ"],
                    cloudy: ["Â§ö‰∫ëÂçàÂêéÔºåÊó†ÁÉàÊó•ÔºåÂÆúÊà∑Â§ñÊ¥ªÂä®„ÄÇ", "Â§©Á©∫Â¶ÇÁîªÂ∏ÉÔºå‰∫ëÊúµÊòØËá™Áî±ÁöÑÁîªÁ¨îÔºå‰∏ãÂçàÂ•Ω„ÄÇ", "ÂñùÊùØ‰∏ãÂçàËå∂Ôºå‰∫´ÂèóËøô‰ªΩÂÆÅÈùôÁöÑÊò•Êó•Êó∂ÂÖâ„ÄÇ"],
                    overcast: ["Èò¥Â§©ÂçàÂêéÔºåÈÄÇÂêàÂÆ§ÂÜÖËøêÂä®ÊàñÁúãÁîµÂΩ±„ÄÇ", "Â§©Ê∞îÂæÆÂáâÔºå‰∏Ä‰ª∂ÈíàÁªáË°´‰ºöËÆ©‰Ω†Êõ¥ËàíÈÄÇ„ÄÇ", "ËôΩÁÑ∂Ê≤°ÊúâÈò≥ÂÖâÔºå‰ΩÜÂøÉÊÉÖË¶Å‰øùÊåÅÊòéÂ™öÂì¶„ÄÇ"],
                    rain: ["Êò•Èõ®ÁªµÁªµÔºåÂçàÂêéÂê¨Èõ®Âà´ÊúâÈ£éÂë≥„ÄÇ", "Èõ®Â§©Ë∑ØÊªëÔºåÂ§ñÂá∫ËØ∑Ê≥®ÊÑèËÑö‰∏ãÂÆâÂÖ®„ÄÇ", "‰∏ãÈõ®Â§©ÂíåÂ∑ßÂÖãÂäõÊõ¥ÈÖçÂì¶ÔºÅ"],
                    fog: ["ÂçàÂêéÈõæÊú™Êï£ÔºåËßÜÈáéÂèóÈôêÔºåÂ∞ëÂ§ñÂá∫„ÄÇ", "ÂÆ§ÂÜÖÂºÄÁ™óÈÄöÈ£éÊó∂ÔºåÊ≥®ÊÑèÈõæ‰∏≠ÁöÑÊπøÊ∞î„ÄÇ", "‰∏ÄÊùØÁÉ≠ÂíñÂï°ÔºåÂèØ‰ª•È©±Êï£ÈõæÊ∞îÂ∏¶Êù•ÁöÑÊ≤âÈó∑„ÄÇ"],
                    windy: ["È£éÂíåÊó•‰∏ΩÔºåÊ≠£ÊòØÊîæÈ£éÁ≠ùÁöÑÂ•ΩÊó∂ËäÇ„ÄÇ", "Êò•È£éÂæóÊÑèÔºåË°£ËßíÈ£ûÊâ¨ÔºåÊÑø‰Ω†ÂøÉÊÉÖËΩªÂø´„ÄÇ", "È£éÂ§ßÁöÑÂçàÂêéÔºåÁöÆËÇ§ÂÆπÊòìÂπ≤Áá•ÔºåËÆ∞Âæó‰øùÊπø„ÄÇ"],
                    default: ["‰∏ãÂçàÂ•ΩÔºåÊÑøÊò•È£éÂ∏¶Ëµ∞‰Ω†ÁöÑÁñ≤ÊÉ´„ÄÇ"]
                },
                evening: {
                    clear: ["Êô¥ÊúóÂ§úÊôöÔºåÊòüÁ©∫ÁíÄÁí®ÔºåÈÄÇÂêàÊï£Ê≠•„ÄÇ", "Êò•Â§©ÁöÑÂ§úÊôöÔºåÂæÆÈ£éÂíåÁÖ¶ÔºåÊúàËâ≤Ê∏©Êüî„ÄÇ", "ÂøôÁ¢å‰∫Ü‰∏ÄÂ§©Ôºå‰∫´ÂèóËøôÂÆÅÈùôÁöÑÊò•Â§úÂêß„ÄÇ"],
                    cloudy: ["‰∫ëÈÅÆÊúàÂÖâÔºå‰ΩÜÂüéÂ∏ÇÁÅØÁÅ´‰æùÁÑ∂Ê∏©Êöñ„ÄÇ", "Â§ö‰∫ëÂ§úÊôöÔºåÂÆúÊúãÂèãÂ∞èËÅöÊàñÁã¨Ëá™Èùô‰∫´„ÄÇ", "ÊôöÂÆâÔºåÊÑø‰Ω†Ê¢¶ÈáåÊúâÁπÅËä±ÂíåÊòüËæ∞„ÄÇ"],
                    overcast: ["Èò¥Ê≤âÂ§úÊôöÔºåÂÆúÁÇπÁÅØËØªÂá†È°µÈó≤‰π¶„ÄÇ", "Â§©Ê∞îËΩ¨ÂáâÔºåÁù°ÂâçËÆ∞ÂæóÂÖ≥Â•ΩÁ™óÊà∑„ÄÇ", "‰ªäÂ§úÔºåËÆ©Ê∏©ÊöñÁöÑË¢´Á™ùÊ≤ªÊÑà‰Ω†‰∏ÄÂ§©ÁöÑÁñ≤ÊÉ´„ÄÇ"],
                    rain: ["Âê¨ÔºåÁ™óÂ§ñÈõ®ÊâìËä≠ËïâÔºåÊòØÊò•Â§úÁöÑ‰∫§ÂìçÊõ≤„ÄÇ", "Èõ®Â§úÔºåÂÆúÊó©Áù°Ôºå‰º¥ÁùÄÈõ®Â£∞ÂÆâÁÑ∂ÂÖ•Ê¢¶„ÄÇ", "Áù°ÂâçÂñùÊùØÊ∏©ÁâõÂ•∂ÔºåÈ©±Êï£Èõ®Â§úÁöÑÊπøÂÜ∑„ÄÇ"],
                    fog: ["Â§úÈõæÊ∏êÊµìÔºåÊó©ÁÇπÂõûÂÆ∂ÔºåÊ≥®ÊÑèÂÆâÂÖ®„ÄÇ", "Èõæ‰∏≠ÁöÑÂüéÂ∏ÇÔºåÂà´Êúâ‰∏ÄÁï™Êú¶ËÉßÁöÑÁæéÊÑü„ÄÇ", "ÊôöÂÆâÔºåÊÑø‰Ω†ÁöÑÊ¢¶Â¢ÉÊ∏ÖÊô∞ËÄåÁæéÂ•Ω„ÄÇ"],
                    windy: ["ÊôöÈ£éËΩªÊãÇÔºåÂêπÊï£‰∏ÄÂ§©ÁöÑÁÉ¶ÊÅº„ÄÇ", "È£éÂ§ßÁöÑÂ§úÊôöÔºåÂèØËÉΩ‰ºöÊúâ‰∫õÂ£∞ÂìçÔºå‰∏çÁî®ÊãÖÂøÉ„ÄÇ", "Âê¨ÁùÄÈ£éÂ£∞ÂÖ•Áù°Ôºå‰ªø‰ΩõÁù°Âú®Ëá™ÁÑ∂ÁöÑÊÄÄÊä±Èáå„ÄÇ"],
                    default: ["ÊôöÂÆâÔºåÊÑø‰Ω†Êã•Êä±‰∏Ä‰∏™Ê∏©ÊüîÁöÑÊò•Â§ú„ÄÇ"]
                }
            },
            summer: {
                morning: {
                    clear: ["Â§èÊó•ÁÇéÁÇéÔºåÊó©ÂÆâÔºÅÂá∫Èó®ËÆ∞ÂæóÈò≤ÊôíË°•Ê∞¥„ÄÇ", "Èò≥ÂÖâÊ≠£Â•ΩÔºåÂæÆÈ£é‰∏çÁá•ÔºåÊòØÂ§èÊó•ÊúÄÁæéÁöÑÊ∏ÖÊô®„ÄÇ", "ÂÖÉÊ∞îÊª°Êª°ÁöÑ‰∏ÄÂ§©Ôºå‰ªéÂÜ∞ÁæéÂºèÂºÄÂßãÔºÅ"],
                    cloudy: ["Â§ö‰∫ëÁöÑÊó©Êô®ÔºåË∫≤ÈÅø‰∫ÜÁÉàÊó•Ôºå‰∫´ÂèóÁâáÂàªÂáâÁàΩ„ÄÇ", "Êó©ÂÆâÔºå‰ªäÂ§©ÊàñÊúâÈòµÈõ®ÔºåÂá∫Èó®ËØ∑Â∏¶‰ºû„ÄÇ", "‰∫ëÂ±ÇÊòØÂ§©ÁÑ∂ÁöÑÈÅÆÈò≥‰ºûÔºåÊó©Ëµ∑ÈîªÁÇºÊ≠£ÂêàÈÄÇ„ÄÇ"],
                    overcast: ["Èò¥Â§©ÁöÑÊó©Êô®ÔºåÈó∑ÁÉ≠ÊÑüÊàñ‰ºöÂä†ÈáçÔºåÊ≥®ÊÑèÈÄöÈ£é„ÄÇ", "ËôΩÊó†Â§™Èò≥ÔºåÁ¥´Â§ñÁ∫ø‰ªçÂú®ÔºåÈò≤ÊôíÂà´ÊùæÊáà„ÄÇ", "Èò¥Â§©ÔºåËÆ©Â§èÊó•ÁöÑÊµÆË∫ÅÊ≤âÊ∑Ä‰∏ãÊù•ÔºåÊó©ÂÆâ„ÄÇ"],
                    rain: ["Â§èÊó•Èõ∑Èõ®Â§öÔºåÊó©ÂÆâ„ÄÇÈõ∑È∏£Êó∂ËØ∑ËøúÁ¶ªÁ™óÊà∑„ÄÇ", "‰∏ÄÂú∫Â§ßÈõ®‰∏∫Â§èÂ§©ÈôçÊ∏©ÔºåÁ©∫Ê∞îÈÉΩÊ∏ÖÊñ∞‰∫Ü„ÄÇ", "Èõ®Â§©Âá∫Ë°åÔºåÊ≥®ÊÑèÂÆâÂÖ®ÔºåÂΩìÂøÉÁßØÊ∞¥„ÄÇ"],
                    hot: ["Ê∏ÖÊô®Â∑≤ÁÉ≠Êµ™ÊªöÊªöÔºå‰ªäÂ§©Ê≥®ÂÆöÁÉ≠ÊÉÖ‰ººÁÅ´„ÄÇ", "Èò≤ÊöëÈôçÊ∏©ÊòØ‰ªäÊó•‰∏ªÈ¢òÔºåÊó©ÂÆâÔºÅ", "ÁªøË±ÜÊ±§„ÄÅË•øÁìúÔºå‰Ω†ÁöÑËß£ÊöëÁ•ûÂô®Â§áÂ•Ω‰∫ÜÂêóÔºü"],
                    windy: ["Ê∏ÖÊô®ÁöÑÈ£éÔºåÂêπËµ∞‰∫Ü‰∫õËÆ∏Èó∑ÁÉ≠ÔºåÂ∏¶Êù•‰∏Ä‰∏ùÊ∏ÖÂáâ„ÄÇ", "È£éÂ§ßÁöÑÊó©Êô®ÔºåÈÄÇÂêàÂú®ÂÆ§ÂÜÖÂÅö‰∫õËàíÁºìËøêÂä®„ÄÇ", "Âê¨ÔºåÊòØÂ§èÂ§©ÁöÑÈ£éÂú®Âî±Ê≠å„ÄÇ"],
                    default: ["Êó©ÂÆâÔºåÊÑø‰Ω†Êã•Êúâ‰∏Ä‰∏™ÂÖÖÊª°Ê¥ªÂäõÁöÑÂ§èÊó•ÂºÄÁ´Ø„ÄÇ"]
                },
                afternoon: {
                    clear: ["ÁÉàÊó•ÂΩìÁ©∫ÔºåÈÖ∑ÊöëÈöæËÄêÔºåÂçàÂêéÂ∞ëÂá∫Èó®„ÄÇ", "‰∏ãÂçàÂ•ΩÔºåÂÜ∞È•ÆË•øÁìúÊòØÊ≠§ÂàªÊúÄÂ•ΩÁöÑÊÖ∞Ëóâ„ÄÇ", "ÂøÉÈùôËá™ÁÑ∂ÂáâÔºå‰ΩÜÁ©∫Ë∞ÉÂèØËÉΩÊòØÊõ¥Â•ΩÁöÑÈÄâÊã©„ÄÇ"],
                    cloudy: ["Â§ö‰∫ëÂ§©Á¥´Â§ñÁ∫ø‰ªçÂº∫ÔºåÂ§áÂ•ΩÈò≤ÊôíÁî®ÂÖ∑„ÄÇ", "ÂçàÂêéÁäØÂõ∞ÔºåÂ∞èÁù°‰∏Ä‰ºöÊàñÂê¨Èü≥‰πêÊèêÁ•û„ÄÇ", "Â§©Ê∞îÈó∑ÁÉ≠ÔºåË∞®Èò≤‰∏≠ÊöëÔºåÂ§öË°•ÂÖÖÁîµËß£Ë¥®„ÄÇ"],
                    overcast: ["Èò¥Ê≤âÁöÑÂçàÂêéÔºåÊàñÊúâÈõ∑ÈòµÈõ®ÔºåËØ∑ÊèêÂâçÂáÜÂ§á„ÄÇ", "ÂÆ§ÂÜÖÊòèÊöóÔºåÂºÄÁõèÁÅØËÆ©ÂøÉÊÉÖ‰πüÊòé‰∫Æ„ÄÇ", "ËøôÊ†∑ÁöÑÂ§©Ê∞îÔºåÊúÄÈÄÇÂêàÂú®Á©∫Ë∞ÉÊàøÈáåËøΩÂâß‰∫Ü„ÄÇ"],

                    rain: ["ÂçàÂêéÊö¥Èõ®ÔºåÊù•ÂéªÂåÜÂåÜÔºåÁ®çÁ≠âÁâáÂàªÂÜçÂá∫Èó®„ÄÇ", "Èõ®ÂêéÁöÑÁ©∫Ê∞îÊ†ºÂ§ñÊ∏ÖÊñ∞ÔºåÈÄÇÂêàÂºÄÁ™óÈÄöÈ£é„ÄÇ", "Èõ®Â£∞ÊòØÊúÄÂ•ΩÁöÑÁôΩÂô™Èü≥ÔºåÈÄÇÂêàÂçàÁù°„ÄÇ"],
                    hot: ["ÁÉ≠ÔºÅ‰∏ãÂçàÊúÄÁÉ≠ÔºåËØ∑Â§ö‰øùÈáç„ÄÇ", "ÂáèÂ∞ëÂ§ñÂá∫ÔºåÈùôÂøÉÂÖªÁ•ûÔºåÂπ≥ÂÆâÂ∫¶Â§è„ÄÇ", "Â¶ÇÊûúÂèØ‰ª•ÔºåÊ∏∏Ê≥≥ÊòØ‰∏ãÂçàÊúÄÂ•ΩÁöÑÈÄâÊã©„ÄÇ"],
                    windy: ["Â§ßÈ£éÂêπËøáÔºåÊàñ‰ºöÂ∏¶Êù•ÈôçÈõ®ÔºåÊ≥®ÊÑèÂ§©Ê∞îÂèòÂåñ„ÄÇ", "È£éÂ§ßÁöÑÂçàÂêéÔºå‰∏çÂÆúËøõË°åÊ∞¥‰∏äÊ¥ªÂä®„ÄÇ", "Âú®ÂÆ§ÂÜÖÊÑüÂèóÈ£éÁöÑÂáâÊÑèÔºå‰πüÊòØ‰∏ÄÁßç‰∫´Âèó„ÄÇ"],
                    default: ["‰∏ãÂçàÂ•ΩÔºåÁÇéÁÇéÂ§èÊó•ÔºåËÆ∞Âæó‰øùÊåÅÂøÉÂπ≥Ê∞îÂíå„ÄÇ"]
                },
                evening: {
                    clear: ["Êó•ËêΩ‰ΩôÊôñÔºåÊôöÈúû‰ººÁÅ´Ôºå‰∏ÄÂ§©‰∏≠ÊúÄÁæé„ÄÇ", "Â§èÂ§úÊôöÈ£éÂêπÊï£Áá•ÁÉ≠ÔºåÈÄÇÂêàÂá∫Èó®Á∫≥Âáâ„ÄÇ", "Ëê§ÁÅ´Ëô´„ÄÅÊòüÁ©∫„ÄÅÂÜ∞Ë•øÁìúÔºåÊòØÂ§èÂ§úÁöÑÊµ™Êº´„ÄÇ"],
                    cloudy: ["‰∫ëÂ±ÇÈÅÆ‰Ωè‰∫ÜÊúà‰∫ÆÔºå‰ΩÜÊå°‰∏ç‰ΩèÂ§èÂ§úÁöÑÊÉ¨ÊÑè„ÄÇ", "ÊôöÈ•≠ÂêéÔºåÂíåÂÆ∂‰∫∫ÊúãÂèãÊï£Êï£Ê≠•ÔºåËÅäËÅäÂ§©Âêß„ÄÇ", "Â§ö‰∫ëÁöÑÂ§úÊôöÔºåËöäËô´ÂèØËÉΩËæÉÂ§öÔºåÊ≥®ÊÑèÈò≤Ëöä„ÄÇ"],
                    overcast: ["Èò¥Ê≤âÁöÑÂ§úÊôöÔºåÈó∑ÁÉ≠‰æùÊóßÔºåÂºÄÁ©∫Ë∞É‰ºöÊõ¥ËàíÈÄÇ„ÄÇ", "ÊôöÂÆâÔºåÊÑø‰Ω†ÊëÜËÑ±ÁÉ¶Èó∑ÔºåÊã•ÊúâÊ∏ÖÁàΩÁöÑÊ¢¶„ÄÇ", "Áù°ÂâçÂÜ≤‰∏™Ê∏©Ê∞¥Êæ°ÔºåÊúâÂä©‰∫éÁù°Áú†„ÄÇ"],
                    rain: ["Èõ®ÂêéÂ§úÊôöÔºåÂáâÁàΩËàíÈÄÇÔºåÂÆúÂÆâÁÑ∂ÂÖ•Áù°„ÄÇ", "Âê¨ÁùÄÈõ®Â£∞ÔºåÊîæ‰∏ãÊâãÊú∫ÔºåËÆ©Ë∫´ÂøÉÈÉΩÂæóÂà∞ÊîæÊùæ„ÄÇ", "ÊôöÊù•È£éÊÄ•ÔºåÈõ®Â£∞ÊΩ∫ÊΩ∫ÔºåÁ•ù‰Ω†Â•ΩÊ¢¶„ÄÇ"],
                    hot: ["Â§úÊôö‰æùÊóßÈó∑ÁÉ≠ÔºåÁ©∫Ë∞ÉÁîµÊâáÊòØÂ•Ω‰ºô‰º¥„ÄÇ", "Áù°ÂâçÂñùÁÇπÊ∏©Ê∞¥ÔºåË°•ÂÖÖË∫´‰ΩìÊµÅÂ§±ÁöÑÊ∞¥ÂàÜ„ÄÇ", "‰∏ÄÂº†ÂáâÂ∏≠Ôºå‰∏Ä‰∏™Â•ΩÊ¢¶ÔºåÊôöÂÆâ„ÄÇ"],
                    windy: ["ÊôöÈ£éÈÄÅÁàΩÔºåÁªà‰∫éÂèØ‰ª•Â§ßÂè£ÂëºÂê∏‰∫Ü„ÄÇ", "È£éÂ§ßÁöÑÂ§úÊôöÔºåÊôæÊôíÁöÑË°£Áâ©Ë¶ÅÊî∂Â•ΩÂì¶„ÄÇ", "Âú®È£éÂ£∞‰∏≠ÔºåÁªìÊùüËøôÂñßÂö£ÁöÑ‰∏ÄÂ§©Âêß„ÄÇ"],
                    default: ["ÊôöÂÆâÔºåÊÑøÂ§èÂ§úÁöÑÂáâÈ£éÂêπËµ∞‰Ω†ÊâÄÊúâÁöÑÁñ≤ÊÉ´„ÄÇ"]
                }
            },
            autumn: {
                morning: {
                    clear: ["ÁßãÈ´òÊ∞îÁàΩÔºåÂ§©ÊúóÊ∞îÊ∏ÖÔºåÊó©ÂÆâÔºÅ", "ÈáëËâ≤ÁöÑÈò≥ÂÖâÊ¥íÊª°Â§ßÂú∞ÔºåÊòØÊî∂Ëé∑ÁöÑÈ¢úËâ≤„ÄÇ", "Â§©Ê∞îÂæÆÂáâÔºåÂá∫Èó®ËÆ∞ÂæóÂä†‰ª∂ËñÑÂ§ñÂ•ó„ÄÇ"],
                    cloudy: ["Â§ö‰∫ëÁöÑÊó©Êô®ÔºåÁßãÊÑèÊõ¥Êµì„ÄÇ", "‰∫ëÂ±Ç‰πã‰∏äÔºåÊòØÊπõËìùÁöÑÁßãÊó•Â§©Á©∫„ÄÇ", "‰∏ÄÊùØÁÉ≠ÂíñÂï°ÔºåÂºÄÂêØÂÖÉÊ∞îÊª°Êª°ÁöÑ‰∏ÄÂ§©„ÄÇ"],
                    overcast: ["ÁßãÊó•Èò¥Â§©ÔºåÂà´Êúâ‰∏ÄÁï™ËêßÁëü‰πãÁæé„ÄÇ", "Â§©Ê∞îËΩ¨ÂáâÔºåÊ≥®ÊÑè‰øùÊöñÔºåÈ¢ÑÈò≤ÊÑüÂÜí„ÄÇ", "Èò¥Â§©ÔºåËÆ©ÂøÉÁª™Ê≤âÊ∑ÄÔºåÈÄÇÂêàÊ∑±Â∫¶ÈòÖËØª„ÄÇ"],
                    rain: ["‰∏ÄÂú∫ÁßãÈõ®‰∏ÄÂú∫ÂØíÔºåÊ≥®ÊÑèÂèäÊó∂Ê∑ªË°£„ÄÇ", "ÁßãÈõ®ÁªµÁªµÔºåÊ¥óÂ∞ΩÂ∞òÂüÉÔºåÁ©∫Ê∞îÊ†ºÂ§ñÊ∏ÖÊñ∞„ÄÇ", "Èõ®Â§©Ë∑ØÊªëÔºåÊó©ÂÆâÔºåÂá∫Ë°åËØ∑ÊÖ¢Ë°å„ÄÇ"],
                    fog: ["ÁßãÈõæÂº•Êº´ÔºåËÉΩËßÅÂ∫¶‰ΩéÔºåÊô®ÁªÉÂèØÊîπ‰∏∫ÂÆ§ÂÜÖ„ÄÇ", "ÂºÄËΩ¶ËØ∑ÊâìÂºÄÈõæÁÅØÔºå‰øùÊåÅÂÆâÂÖ®ËΩ¶Ë∑ù„ÄÇ", "‰∫ëÂºÄÈõæÊï£Êó∂Ôºå‰æøÊòØÁßãÊó•Â•Ω‚ÄúÊû´‚ÄùÂÖâ„ÄÇ"],
                    windy: ["ÁßãÈ£éÁëüÁëüÔºåËêΩÂè∂Á∫∑È£û„ÄÇÊà¥Â•ΩÂõ¥Â∑æ‰øùÊöñ„ÄÇ", "È£éËµ∑ÔºåÊòØÁßãÂ§©Âú®ÊèêÈÜí‰Ω†Âä†Ë°£ÊúçÂï¶„ÄÇ", "Â§ßÈ£éÂ§©Á©∫Ê∞îÂπ≤Áá•ÔºåÂ§öÂñùÊ∞¥Ê∂¶Áá•„ÄÇ"],
                    default: ["Êó©ÂÆâÔºåÊÑø‰Ω†ÁöÑÂøÉÊÉÖÂ¶ÇÁßãÊó•Ëà¨ÈùôÁæé„ÄÇ"]
                },
                afternoon: {
                    clear: ["ÁßãÊó•ÂçàÂêéÔºåÈò≥ÂÖâÊ≠£Â•ΩÔºå‰∏çÂÜ∑‰∏çÁÉ≠ÊúÄÂÆú‰∫∫„ÄÇ", "Ê≥°‰∏ÄÂ£∂Ê°ÇËä±Ëå∂Ôºå‰∫´ÂèóËøô‰ªΩÁßãÊó•ÈôêÂÆö„ÄÇ", "Â§©Ê∞îÂπ≤Áá•ÔºåÂà´Âøò‰∫ÜÁªôÁöÆËÇ§Ë°•Ê∞¥„ÄÇ"],
                    cloudy: ["Â§ö‰∫ëÁöÑ‰∏ãÂçàÔºåÈÄÇÂêàÂéªÈÉäÂ§ñËµ∞Ëµ∞ÔºåÁúãÁúãÁ∫¢Âè∂„ÄÇ", "Ê≤°ÊúâÈò≥ÂÖâÁõ¥Â∞ÑÔºåÊòØÊëÑÂΩ±ÁöÑÂ•ΩÊó∂Êú∫„ÄÇ", "Áßã‰πèÊù•Ë¢≠ÔºåËµ∑Êù•Ëµ∞Âä®Ëµ∞Âä®Ôºå‰º∏‰∏™ÊáíËÖ∞Âêß„ÄÇ"],
                    overcast: ["Èò¥Â§©ÁöÑÂçàÂêéÔºåÈÄÇÂêàÈÄõÈÄõÂçöÁâ©È¶ÜÊàñ‰π¶Â∫ó„ÄÇ", "‰∏ÄÊùØÊöñÊöñÁöÑ‰∏ãÂçàËå∂ÔºåËÉΩÈ©±Êï£Èò¥Â§©ÁöÑÊ≤âÈó∑„ÄÇ", "Â§©Ëâ≤ÊöóÂæóÊó©ÔºåËØ∑ÂêàÁêÜÂÆâÊéíÊó∂Èó¥Âì¶„ÄÇ"],
                    rain: ["ÁßãÈõ®Ê∑ÖÊ≤•ÔºåÂÆúÁ™ùÂú®Ê≤ôÂèëÁúãÊöñÂøÉÁîµÂΩ±„ÄÇ", "Èõ®Ê∞¥Â∏¶Êù•‰∫ÜÈôçÊ∏©ÔºåÊ≥®ÊÑè‰øùÊöñ„ÄÇ", "ËøôÁßçÂ§©Ê∞îÔºåÂêÉÈ°øÁÉ≠ËÖæËÖæÁöÑÁÅ´ÈîÖÂêßÔºü"],
                    fog: ["ÂçàÂêéÊúâÈõæÔºå‰∏çÂ¶ÇÂú®ÂÆ∂Êï¥ÁêÜÊàøÈó¥ÔºåÊç¢‰∏™Â•ΩÂøÉÊÉÖ„ÄÇ", "ÈõæÂ§©ÊπøÊ∞îÈáçÔºåÂèØ‰ª•ÊâìÂºÄÈô§ÊπøÊú∫„ÄÇ", "Ëø∑Èõæ‰πã‰∏≠ÔºåÊõ¥Ë¶ÅÁúãÊ∏ÖÂâçË°åÁöÑÊñπÂêë„ÄÇ"],
                    windy: ["È£éÂêπËµ∞‰∫ÜÂ§èÊó•ÁöÑÊöëÊ∞îÔºåÂ∏¶Êù•‰∫ÜÁßãÁöÑËÆØÊÅØ„ÄÇ", "ÁôªÈ´òÊúõËøúÔºåÊÑüÂèóÁßãÈ£éÊãÇÈù¢ÁöÑËæΩÈòî„ÄÇ", "È£éÂπ≤Áâ©Áá•ÔºåÊ≥®ÊÑèÁî®ÁÅ´ÂÆâÂÖ®„ÄÇ"],
                    default: ["‰∏ãÂçàÂ•ΩÔºåÊÑøÁßãÊó•ÁöÑÂÆÅÈùôËÉΩÊäöÂπ≥‰Ω†ÁöÑÁÉ¶Âøß„ÄÇ"]
                },
                evening: {
                    clear: ["ÁöìÊúàÂΩìÁ©∫ÔºåÁßãÂ§úÈùôË∞ßÔºåÂÆúËµèÊúàÔºåÂÆúÊÄùÂøµ„ÄÇ", "Â§©ÂáâÂ¶ÇÊ∞¥ÔºåÊôöÂΩíÁöÑ‰∫∫ËÆ∞ÂæóÂ§öÁ©ø‰∏Ä‰ª∂„ÄÇ", "ÊôöÂÆâÔºåÊÑø‰Ω†Ê¢¶ÈáåÊúâÊ°ÇËä±È¶ôÂíåÈáëËâ≤È∫¶Êµ™„ÄÇ"],
                    cloudy: ["‰∫ëÈÅÆÊúàÔºåÊòüÁ®ÄÁñèÔºå‰ΩÜÁßãÂ§úÁöÑÂáâÁàΩ‰æùÁÑ∂„ÄÇ", "ÈÄÇÂêà‰∏éÂÆ∂‰∫∫Âõ¥ÂùêÔºåÂÖ±‰∫´Â§©‰º¶‰πã‰πê„ÄÇ", "Â§úÊ∑±‰∫ÜÔºåÊó©ÁÇπ‰ºëÊÅØÔºåÂÖªË∂≥Á≤æÁ•û„ÄÇ"],
                    overcast: ["Èò¥ÂÜ∑ÁöÑÁßãÂ§úÔºåÂÆúÊó©Áù°ÔºåÂÆúÂ•ΩÊ¢¶„ÄÇ", "Áù°ÂâçÁî®ÁÉ≠Ê∞¥Ê≥°Ê≥°ËÑöÔºåÊúâÂä©‰∫éÈ©±ÂØí‰øùÊöñ„ÄÇ", "ÊôöÂÆâÔºåÊòéÂ§©Âèà‰ºöÊòØÊñ∞ÁöÑ‰∏ÄÂ§©„ÄÇ"],
                    rain: ["Á™óÂ§ñÈõ®Â£∞Êª¥Á≠îÔºåÊòØÁßãÂ§úÁöÑÂÇ¨Áú†Êõ≤„ÄÇ", "Èõ®Â§úÂØíÊÑèÈáçÔºåÁõñÂ•ΩË¢´Â≠êÔºåÂà´ÁùÄÂáâ„ÄÇ", "Âê¨Èõ®ÂÖ•Áú†Ôºå‰∏ÄÂ§úÂÆâÁù°Âà∞Â§©Êòé„ÄÇ"],
                    fog: ["Â§úÈõæÂõõËµ∑ÔºåÈùûÂøÖË¶Å‰∏çÂ§ñÂá∫„ÄÇ", "Âú®ÂÆ∂‰∫´Âèó‰∏Ä‰∏™ÂÆâÈùôÁöÑÂ§úÊôöÂêß„ÄÇ", "ÊôöÂÆâÔºåÊÑø‰Ω†Êã®ÂºÄÁîüÊ¥ªÁöÑËø∑ÈõæÔºåÊâæÂà∞ÊñπÂêë„ÄÇ"],
                    windy: ["È£éÂ£∞Èπ§Âî≥ÔºåÂÖ≥Â•ΩÈó®Á™óÔºåÂÆâÂøÉÂÖ•Áù°„ÄÇ", "ÁßãÈ£éËµ∑ÔºåËüπËÑöÁóíÔºåÊòØÂìÅÂ∞ùÂ§ßÈó∏ËüπÁöÑÂ•ΩÊó∂ËäÇ„ÄÇ", "Âú®È£éÂ£∞‰∏≠ÔºåÈùôÈùôÂú∞‰∏é‰∏ñÁïåÈÅìÊôöÂÆâ„ÄÇ"],
                    default: ["ÊôöÂÆâÔºåÊÑø‰Ω†Âú®ËøôÊî∂Ëé∑ÁöÑÂ≠£ËäÇÈáåÔºåÊî∂Ëé∑Â•ΩÊ¢¶„ÄÇ"]
                }
            },
            winter: {
                morning: {
                    clear: ["ÂÜ¨Êó•ÊöñÈò≥ÁèçË¥µÔºåÊó©ÂÆâÔºåÂá∫Èó®ÊôíÂ§™Èò≥ÂêßÔºÅ", "Êô¥ÊúóÁöÑÂÜ¨Êô®ÔºåÂ§©Á©∫ÊπõËìùÔºåÂøÉÊÉÖ‰πüÈöè‰πãÊòéÂ™ö„ÄÇ", "ËôΩÂÜ∑Ôºå‰ΩÜÊúâÈò≥ÂÖâÁöÑÊó©Êô®ÊÄªÊòØÂÖÖÊª°Â∏åÊúõ„ÄÇ"],
                    cloudy: ["Ê≤°ÊúâÂ§™Èò≥ÁöÑÂÜ¨Êô®Êõ¥ÂÜ∑ÔºåÂ§öÁ©ø‰∏ÄÁÇπÂì¶„ÄÇ", "Ëµ∑Â∫äÂ§ß‰ΩúÊàòÊàêÂäü‰∫ÜÂêóÔºü‰∏∫‰Ω†ÁÇπËµûÔºÅ", "‰∏ÄÊùØÁÉ≠ÂèØÂèØÔºåÊ∏©Êöñ‰Ω†ÁöÑÊï¥‰∏™Êó©Êô®„ÄÇ"],
                    overcast: ["Èò¥Ê≤âÁöÑÊó©Êô®Ôºå‰ªø‰Ωõ‰∏ñÁïåÈÉΩÊåâ‰∏ã‰∫ÜÈùôÈü≥ÈîÆ„ÄÇ", "Ê≥®ÊÑè‰øùÊöñÔºåÁâπÂà´ÊòØÂ§¥ÈÉ®ÂíåËÑöÈÉ®„ÄÇ", "‰∏ÄÈ°øÁÉ≠ËÖæËÖæÁöÑÊó©È§êÔºåÊòØÂØπÂÜ¨Â§©ÊúÄÂ§ßÁöÑÂ∞äÈáç„ÄÇ"],
                    snow: ["‰∏ãÈõ™Âï¶ÔºÅÈì∂Ë£ÖÁ¥†Ë£πÁöÑ‰∏ñÁïåÔºåÊó©ÂÆâ„ÄÇ", "ÁëûÈõ™ÂÖÜ‰∏∞Âπ¥Ôºå‰ªäÂ§©‰ºöÊòØÂÖÖÊª°ÊÉäÂñúÁöÑ‰∏ÄÂ§©„ÄÇ", "Âá∫Èó®ËØ∑Ê≥®ÊÑèÈò≤ÊªëÔºåÊÖ¢Ëµ∞Ê¨£ËµèÈõ™ÊôØ„ÄÇ"],
                    fog: ["Â§ßÈõæÈîÅÂüéÔºå‰ªäÂ§©ÁöÑ‰∏ñÁïåÂÖÖÊª°‰∫ÜÁ•ûÁßòÊÑü„ÄÇ", "ËÉΩËßÅÂ∫¶ÊûÅ‰ΩéÔºåÂá∫Ë°åÊ≥®ÊÑèÂÆâÂÖ®Ôºå‰ºòÈÄâÂÖ¨‰∫§„ÄÇ", "ÂæÖÂú®ÂÆ§ÂÜÖÔºå‰πüÊòØ‰∏ÄÁßçÂÆâÂÖ®ÁöÑÈÄâÊã©„ÄÇ"],
                    windy: ["ÂØíÈ£éÂáõÂÜΩÂ¶ÇÂàÄÂâ≤ÔºåÊà¥Â•ΩÂ∏ΩÂ≠êÂõ¥Â∑æÊâãÂ•óÔºÅ", "‰ªäÂ§©ÁöÑÈ£éÔºåÊòØÂÜ¨Â§©ÁöÑ‰ø°‰Ωø„ÄÇ", "Â§ßÈ£éÂ§©Ôºå‰ΩìÊÑüÊ∏©Â∫¶Êõ¥‰ΩéÔºåÊ≥®ÊÑèÈò≤ÂØí„ÄÇ"],
                    cold: ["‰ªäÂ§©‚ÄúÂÜª‚ÄùÂäõÂçÅË∂≥Ôºå‰Ω†ÊòØ‚ÄúÊäóÂÜª‚ÄùÂãáÂ£´ÔºÅ", "Á¶ªÂºÄÊ∏©ÊöñÁöÑË¢´Á™ùÔºåÊòØ‰ªäÂ§©ÊúÄÂ§ßÁöÑÊåëÊàò„ÄÇ", "Â§öÂñùÁÉ≠Ê∞¥ÔºåÊòØÂÜ¨Â§©ÈáåÊúÄÊú¥Á¥†ÁöÑÂÖ≥ÂøÉ„ÄÇ"],
                    default: ["Êó©ÂÆâÔºåÊÑø‰Ω†ÊúâÊöñÈò≥ÁÖßË∫´ÔºåÊúâÁÉ≠Ëå∂ÊöñÂøÉ„ÄÇ"]
                },
                afternoon: {
                    clear: ["ÂçàÂêéÈò≥ÂÖâÊ≠£Â•ΩÔºåÊòØÊôíÂ§™Èò≥Ë°•ÈíôÁöÑÂ•ΩÊó∂Êú∫„ÄÇ", "Êâæ‰∏™ÊúùÂçóÁöÑÁ™óËæπÔºåÊÑüÂèóÁå´‰∏ÄÊ†∑ÁöÑÂçàÂêé„ÄÇ", "Â§©Ê∞îËôΩÂÜ∑Ôºå‰ΩÜÈò≥ÂÖâËÉΩÂ∏¶Êù•Ê∏©ÊöñÂíåÂäõÈáè„ÄÇ"],
                    cloudy: ["Â§ö‰∫ëÁöÑÂçàÂêéÔºåÂÖâÁ∫øÊüîÂíåÔºåÈÄÇÂêàÂú®ÂÆ§ÂÜÖÊãçÁÖß„ÄÇ", "ÂÆ§Â§ñÂØíÂÜ∑Ôºå‰∏çÂ¶ÇÂú®ÂÆ∂ÂÅöËøêÂä®ÊöñÊöñË∫´Â≠ê„ÄÇ", "‰∏ÄÊùØÂßúËå∂ÔºåÂèØ‰ª•Â∏Æ‰Ω†È©±Êï£ÂØíÊÑè„ÄÇ"],
                    overcast: ["Èò¥ÂÜ∑ÁöÑ‰∏ãÂçàÔºåÊúÄÈÄÇÂêàÂíåÊúãÂèã‰∏ÄËµ∑ÂêÉÁÅ´ÈîÖ„ÄÇ", "Â§©Ëâ≤ÊòèÊöóÔºåÂºÄÁõèÊöñÈªÑÁÅØÔºåËê•ÈÄ†Ê∏©È¶®Ê∞õÂõ¥„ÄÇ", "Á¶ªÂ§©ÈªëÂèàËøë‰∫Ü‰∏ÄÊ≠•ÔºåÁèçÊÉúÁôΩÂ§©ÁöÑÊó∂ÂÖâ„ÄÇ"],
                    snow: ["Èõ™ËøòÂú®‰∏ãÔºå‰∏çÂ¶ÇÂ†ÜÈõ™‰∫∫ÊâìÈõ™‰ªóÊâæÂõûÁ´•Ë∂£„ÄÇ", "Èõ™ÊôØËôΩÁæéÔºå‰ΩÜÊà∑Â§ñ‰∏çÂÆú‰πÖÁïôÔºåÂ∞èÂøÉÂÜª‰º§„ÄÇ", "‰∏ÄÊùØÁÉ≠Á∫¢ÈÖíÔºåÈÖç‰∏äÁ™óÂ§ñÁöÑÈõ™ÊôØÔºåÁªù‰∫Ü„ÄÇ"],
                    fog: ["ÈõæÊ∞îÊ≤âÊ≤âÔºå‰∏çÂ¶ÇÈùôÂøÉËØª‰∏ÄÊú¨ÊÉ≥ËØªÁöÑ‰π¶„ÄÇ", "ÂáèÂ∞ëÂ§ñÂá∫Ôºå‰∫´Âèó‰∏Ä‰∏™ÂÆâÈÄ∏ÁöÑ‰∏ãÂçà„ÄÇ", "Â§ßÈõæÂ§©Á©∫Ê∞îË¥®ÈáèÊàñ‰∏ç‰Ω≥ÔºåÂ∞ΩÈáèÂ∞ëÂºÄÁ™ó„ÄÇ"],
                    windy: ["ÁãÇÈ£éÂëºÂï∏ÔºåÊòØÂÜ¨Â§©ÁöÑÂíÜÂìÆ„ÄÇÂú®ÂÆ∂ÊúÄÂÆâÂÖ®„ÄÇ", "Ê£ÄÊü•Á™óÊà∑ÊòØÂê¶ÂÖ≥Á¥ßÔºå‰ª•Èò≤ÂÜ∑È£é‰æµÂÖ•„ÄÇ", "ËøôÊ†∑ÁöÑÂ§©Ê∞îÔºåÂÆú‚ÄúÁå´ÂÜ¨‚ÄùÔºå‰∏çÂÆúÂá∫Èó®„ÄÇ"],
                    cold: ["Êª¥Ê∞¥ÊàêÂÜ∞ÁöÑ‰∏ãÂçàÔºå‰Ω†ËøòÂ•ΩÂêóÔºü", "Áî®‰∏Ä‰∏™ÁÉ≠Ê∞¥Ë¢ãÊçÇÊçÇÊâãÔºå‰ºöËàíÊúçÂæàÂ§ö„ÄÇ", "Â§©ÂØíÂú∞ÂÜªÔºå‰ΩÜÊàë‰ª¨ÂØπÁîüÊ¥ªÁöÑÁÉ≠ÊÉÖ‰∏çÁªìÂÜ∞„ÄÇ"],
                    default: ["‰∏ãÂçàÂ•ΩÔºåË∂äÊòØÂØíÂÜ∑ÔºåË∂äË¶ÅÊ¥ªÂæóÁÉ≠Ê∞îËÖæËÖæ„ÄÇ"]
                },
                evening: {
                    clear: ["ÂÜ¨Â§úÁöÑÊòüÁ©∫ÔºåÊ∏ÖÊæàËÄåÂØíÂÜ∑ÔºåÂà´Êúâ‰∏ÄÁï™È£éÂë≥„ÄÇ", "Â§©Ê∞îÂØíÂÜ∑ÔºåÊó©ÁÇπÁªìÊùüÂøôÁ¢åÔºåÂõûÂÆ∂ÂèñÊöñÂêß„ÄÇ", "ÊôöÂÆâÔºåÊÑø‰Ω†Ê¢¶ÈáåÊò•ÊöñËä±ÂºÄ„ÄÇ"],
                    cloudy: ["Ê≤°ÊúâÊòüÊúàÁöÑÂ§úÊôöÔºåÊõ¥ÊòæÂÆÅÈùô„ÄÇ", "ÈÄÇÂêàÁ™ùÂú®Ê≤ôÂèëÈáåÔºåÁúã‰∏ÄÈÉ®Ê≤ªÊÑàÁöÑÁîµÂΩ±„ÄÇ", "Áù°ÂâçÁî®ÁÉ≠Ê∞¥Ê≥°ËÑöÔºåÂèØ‰ª•ÊèêÈ´òÁù°Áú†Ë¥®Èáè„ÄÇ"],
                    overcast: ["Èò¥ÂÜ∑ÂÜ¨Â§úÔºåÂÆú‰∏éÂÆ∂‰∫∫Èó≤ÂùêÔºåÁÅØÁÅ´ÂèØ‰∫≤„ÄÇ", "Á™óÂ§ñÂ§©ÂØíÂú∞ÂÜªÔºåÂ±ãÂÜÖÊ∏©ÊöñÂ¶ÇÊò•ÊòØÂπ∏Á¶è„ÄÇ", "ÊôöÂÆâÔºåÁõñÂ•ΩË¢´Â≠êÔºåÂà´ËÆ©ÂØíÊ∞îÂÖ•‰æµ„ÄÇ"],
                    snow: ["Èõ™Â§úÔºåÂÆúÂõ¥ÁÇâÂ§úËØùÔºåÂÆúÈùôÊÄùÔºåÂÆúÂ•ΩÊ¢¶„ÄÇ", "Á™óÂ§ñÁöÑ‰∏ñÁïå‰∏ÄÁâáÊ¥ÅÁôΩÔºåÂÜÖÂøÉ‰πüÂèòÂæóÂÆÅÈùô„ÄÇ", "ÊôöÂÆâÔºåÈõ™Ëä±‰ºö‰∏∫‰Ω†Ë¶ÜÁõñ‰∏ÄÊï¥Â§úÁöÑÊ∏©Êüî„ÄÇ"],
                    fog: ["Â§úÈõæËå´Ëå´ÔºåÊó©ÁÇπ‰ºëÊÅØÔºåÊòéÂ§©ÂèàÊòØÊñ∞ÁöÑ‰∏ÄÂ§©„ÄÇ", "ÊâÄÊúâÁúã‰∏çÊ∏ÖÁöÑÔºåÊó∂Èó¥ÈÉΩ‰ºöÁªô‰Ω†Á≠îÊ°à„ÄÇ", "Á•ù‰Ω†Êúâ‰∏™Ê∏ÖÊô∞Ê∏©ÊöñÁöÑÊ¢¶„ÄÇ"],
                    windy: ["Âê¨ÁùÄÁ™óÂ§ñÁöÑÈ£éÂ£∞ÔºåÊÑüËßâË¢´Á™ùÈáåÊ†ºÂ§ñÊ∏©Êöñ„ÄÇ", "È£é‰ºöÂ∏¶Ëµ∞ÊâÄÊúâ‰∏çÂºÄÂøÉÔºåÊôöÂÆâ„ÄÇ", "‰ªäÂ§úÔºåÂÆúÊã•Êä±ÔºåÂÆúÂèñÊöñ„ÄÇ"],
                    cold: ["ËøôÊòØÈúÄË¶ÅÂãáÊ∞îÊâçËÉΩÁ¶ªÂºÄË¢´Á™ùÁöÑÂ§úÊôö„ÄÇ", "ÊôöÂÆâÔºåËØ∑Êü•Êî∂‰∏Ä‰ªΩÊù•Ëá™ÂÜ¨Â§úÁöÑÊ∏©Êöñ„ÄÇ", "Áù°‰∏™Â•ΩËßâÔºå‰∏∫Ë∫´‰ΩìÂÖÖÊª°ÊäµÂæ°‰∏•ÂØíÁöÑËÉΩÈáè„ÄÇ"],
                    default: ["ÊôöÂÆâÔºåÊÑø‰Ω†Âú®ËøôÂØíÂÜ∑ÁöÑÂÜ¨Â§úÈáåÔºåË¢´Ê∏©Êüî‰ª•ÂæÖ„ÄÇ"]
                }
            },
            default: {
                default: [
                    "ÊÑø‰Ω†ÁúºÈáåÁöÑÊòüÊòüÔºåÊ∞∏ËøúÈó™‰∫Æ„ÄÇ",
                    "ÁîüÊ¥ªÊàñËÆ∏‰∏çÊòìÔºå‰ΩÜËØ∑Âà´Âøò‰∫ÜÂæÆÁ¨ë„ÄÇüòä",
                    "ÊØè‰∏ÄÂ§©ÈÉΩÊòØ‰∏Ä‰ªΩÁã¨‰∏ÄÊó†‰∫åÁöÑÁ§ºÁâ©„ÄÇ",
                    "Êó†ËÆ∫Â§©Ê∞îÂ¶Ç‰ΩïÔºåËÆ∞ÂæóÂ∏¶‰∏äËá™Â∑±ÁöÑÈò≥ÂÖâ„ÄÇ",
                    "ÂòøÔºåÈôåÁîü‰∫∫ÔºåÁ•ù‰Ω†‰ªäÂ§©ÂºÄÂøÉ„ÄÇ"
                ]
            }
        };

        function getWeatherTip(weatherData) {
            const now = new Date();
            const month = now.getMonth() + 1;
            const hour = now.getHours();

            // 1. Determine Season
            let season = 'default';
            if (month >= 3 && month <= 5) season = 'spring';
            else if (month >= 6 && month <= 8) season = 'summer';
            else if (month >= 9 && month <= 11) season = 'autumn';
            else season = 'winter';

            // 2. Determine Time of Day
            let timeOfDay = 'night';
            if (hour >= 5 && hour < 12) timeOfDay = 'morning';
            else if (hour >= 12 && hour < 18) timeOfDay = 'afternoon';
            else if (hour >= 18 && hour < 22) timeOfDay = 'evening';

            // 3. Determine Weather Condition
            let condition = 'default';
            const tempC = parseInt(weatherData.tempC, 10);
            const weatherDesc = weatherData.weatherDesc.toLowerCase();
            const windSpeed = parseInt(weatherData.windSpeedKmph, 10);

            if (tempC > 32) condition = 'hot';
            else if (tempC < 0) condition = 'cold';
            else if (weatherDesc.includes('snow') || weatherDesc.includes('sleet') || weatherDesc.includes('blizzard')) condition = 'snow';
            else if (weatherDesc.includes('rain') || weatherDesc.includes('shower') || weatherDesc.includes('drizzle')) condition = 'rain';
            else if (weatherDesc.includes('fog') || weatherDesc.includes('mist')) condition = 'fog';
            else if (weatherDesc.includes('haze') || weatherDesc.includes('smoke') || weatherDesc.includes('dust')) condition = 'haze';
            else if (windSpeed > 25) condition = 'windy';
            else if (weatherDesc.includes('overcast')) condition = 'overcast';
            else if (weatherDesc.includes('cloudy')) condition = 'cloudy';
            else if (weatherDesc.includes('clear') || weatherDesc.includes('sunny')) condition = 'clear';

            // 4. Retrieve Tip with Fallbacks
            let tips = WEATHER_TIPS[season]?.[timeOfDay]?.[condition];

            if (!tips || tips.length === 0) {
                tips = WEATHER_TIPS[season]?.[timeOfDay]?.default;
            }
            if (!tips || tips.length === 0) {
                // Fallback to season-level default if time-of-day default is missing
                tips = WEATHER_TIPS[season]?.default?.default;
            }
            if (!tips || tips.length === 0) {
                // Ultimate fallback
                tips = WEATHER_TIPS.default.default;
            }
            
            // 5. Return a random tip from the selected array
            return tips[Math.floor(Math.random() * tips.length)];
        }

        // --- [NEW] Weather API Fallback Logic ---

        function setWeatherSpinner(isSpinning) {
            const refreshBtn = document.getElementById('weather-refresh-btn');
            if (refreshBtn) {
                const icon = refreshBtn.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-spin', isSpinning);
                }
            }
        }

        function getWeatherIconName(weatherData) {
            const { weatherDesc: desc, windSpeedKmph: wind, isDay, weatherCode } = weatherData;
            const weatherDesc = desc.toLowerCase();
            const iconPrefix = 'https://basmilius.github.io/weather-icons/production/fill/all/';
            let iconName = 'not-available.svg';

            if (weatherDesc.includes('thunder') && weatherDesc.includes('snow')) {
                iconName = isDay ? 'thunderstorms-day-snow.svg' : 'thunderstorms-night-snow.svg';
            } else if (weatherDesc.includes('thunder') && weatherDesc.includes('rain')) {
                iconName = isDay ? 'thunderstorms-day-rain.svg' : 'thunderstorms-night-rain.svg';
            } else if (weatherDesc.includes('thunder')) {
                iconName = isDay ? 'thunderstorms-day.svg' : 'thunderstorms-night.svg';
            } else if (weatherDesc.includes('snow') || weatherDesc.includes('blizzard')) {
                iconName = isDay ? 'partly-cloudy-day-snow.svg' : 'partly-cloudy-night-snow.svg';
                if (weatherDesc.includes('heavy') || weatherDesc.includes('blizzard')) iconName = 'snow.svg';
            } else if (weatherDesc.includes('sleet')) {
                iconName = isDay ? 'partly-cloudy-day-sleet.svg' : 'partly-cloudy-night-sleet.svg';
            } else if (weatherDesc.includes('rain') || weatherDesc.includes('shower')) {
                if (weatherDesc.includes('light') || weatherDesc.includes('drizzle')) {
                    iconName = isDay ? 'partly-cloudy-day-drizzle.svg' : 'partly-cloudy-night-drizzle.svg';
                } else if (weatherDesc.includes('heavy')) {
                    iconName = 'rain.svg';
                } else {
                    iconName = isDay ? 'partly-cloudy-day-rain.svg' : 'partly-cloudy-night-rain.svg';
                }
            } else if (weatherDesc.includes('hail')) {
                iconName = 'hail.svg';
            } else if (weatherDesc.includes('fog')) {
                iconName = isDay ? 'fog-day.svg' : 'fog-night.svg';
            } else if (weatherDesc.includes('haze') || weatherDesc.includes('smoke') || weatherDesc.includes('dust')) {
                iconName = isDay ? 'haze-day.svg' : 'haze-night.svg';
            } else if (parseInt(wind) > 30) {
                iconName = 'wind.svg';
            } else if (weatherDesc.includes('overcast')) {
                iconName = isDay ? 'overcast-day.svg' : 'overcast-night.svg';
            } else if (weatherDesc.includes('cloudy')) {
                iconName = isDay ? 'partly-cloudy-day.svg' : 'partly-cloudy-night.svg';
            } else if (weatherDesc.includes('clear') || weatherDesc.includes('sunny')) {
                iconName = isDay ? 'clear-day.svg' : 'clear-night.svg';
            } else {
                // Fallback to code if description is not specific enough
                const codeStr = String(weatherCode);
                switch (codeStr) {
                    case '113': iconName = isDay ? 'clear-day.svg' : 'clear-night.svg'; break;
                    case '116': iconName = isDay ? 'partly-cloudy-day.svg' : 'partly-cloudy-night.svg'; break;
                    case '119': iconName = 'cloudy.svg'; break;
                    case '122': iconName = 'overcast.svg'; break;
                    case '143': iconName = 'fog.svg'; break; // Generic fog
                    case '176': case '263': case '266': case '293': case '296': case '353':
                        iconName = isDay ? 'partly-cloudy-day-rain.svg' : 'partly-cloudy-night-rain.svg'; break;
                    case '179': case '323': case '326': case '368':
                        iconName = isDay ? 'partly-cloudy-day-snow.svg' : 'partly-cloudy-night-snow.svg'; break;
                    case '182': case '317': case '362': case '365':
                        iconName = isDay ? 'partly-cloudy-day-sleet.svg' : 'partly-cloudy-night-sleet.svg'; break;
                    case '185': iconName = isDay ? 'partly-cloudy-day-drizzle.svg' : 'partly-cloudy-night-drizzle.svg'; break;
                    case '200': case '386': case '389':
                        iconName = isDay ? 'thunderstorms-day-rain.svg' : 'thunderstorms-night-rain.svg'; break;
                    case '227': case '230': iconName = 'wind.svg'; break;
                    case '248': case '260': iconName = 'fog.svg'; break;
                    case '281': case '284': case '311': case '314': iconName = 'sleet.svg'; break;
                    case '299': case '302': case '305': case '308': case '356': case '359': iconName = 'rain.svg'; break;
                    case '329': case '332': case '335': case '338': case '371': iconName = 'snow.svg'; break;
                    case '350': case '374': case '377': iconName = 'hail.svg'; break;
                    case '392': case '395': iconName = isDay ? 'thunderstorms-day-snow.svg' : 'thunderstorms-night-snow.svg'; break;
                }
            }
            return iconPrefix + iconName;
        }

        function getWeatherDataHtml(weatherData) {
            const iconUrl = getWeatherIconName(weatherData);
            
            const sunriseTime = appSettings.timeFormat === '24h' ? convert12hto24h(weatherData.sunrise) : weatherData.sunrise.replace(' ', '');
            const sunsetTime = appSettings.timeFormat === '24h' ? convert12hto24h(weatherData.sunset) : weatherData.sunset.replace(' ', '');

            return `
                <div class="flex flex-col md:flex-row gap-y-4 md:gap-x-8 items-center md:items-stretch w-full">
                    <!-- Column 1: ÂõæÊ†áÂíå‰∏ªÊ∏©Â∫¶ (Âõ∫ÂÆöÂÆΩÂ∫¶, Â±Ö‰∏≠) -->
                    <div class="flex-shrink-0 flex flex-row md:flex-col items-center justify-center w-full md:w-32 gap-x-4">
                        <img id="weather-icon-img" src="${iconUrl}" alt="${weatherData.weatherDesc}" class="w-16 h-16 weather-icon-initial">
                        <p class="font-bold text-3xl" style="color: var(--text-color-primary);">${weatherData.tempC}¬∞</p>
                    </div>

                    <!-- Column 2: Location, Condition, Tip (Flexible, Center-aligned on mobile) -->
                    <div class="flex-1 flex flex-col text-center md:text-left justify-between space-y-1">
                        <p class="font-bold text-xl truncate" style="color: var(--text-color-primary);" title="${weatherData.location}">${weatherData.location}</p>
                        <p class="text-base font-medium" style="color: var(--text-color-secondary);">${weatherData.weatherDesc}</p>
                        <p class="text-base font-medium" style="color: var(--text-color-secondary);">ÊúÄÈ´ò ${weatherData.maxTempC}¬∞ ÊúÄ‰Ωé ${weatherData.minTempC}¬∞</p>
                        <p class="text-sm" style="color: var(--text-color-tertiary);">${weatherData.tip}</p>
                    </div>

                    <!-- Column 3: ËØ¶ÁªÜ‰ø°ÊÅØ (Âõ∫ÂÆöÂÆΩÂ∫¶, Â∑¶ÂØπÈΩê) -->
                    <div class="flex-shrink-0 flex flex-col text-sm space-y-2 w-56">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center w-20">
                                <i class="far fa-sun fa-fw w-5 text-center" style="color: var(--text-color-secondary);"></i>
                                <span class="ml-2" style="color: var(--text-color-secondary);">Êó•Âá∫/ËêΩ</span>
                            </div>
                            <span class="font-semibold" style="color: var(--text-color-primary);">${sunriseTime} / ${sunsetTime}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center w-20">
                                <i class="fas fa-temperature-half fa-fw w-5 text-center" style="color: var(--text-color-secondary);"></i>
                                <span class="ml-2" style="color: var(--text-color-secondary);">‰ΩìÊÑü</span>
                            </div>
                            <span class="font-semibold" style="color: var(--text-color-primary);">${weatherData.feelsLikeC}¬∞</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center w-20">
                                <i class="fas fa-droplet fa-fw w-5 text-center" style="color: var(--text-color-secondary);"></i>
                                <span class="ml-2" style="color: var(--text-color-secondary);">ÊπøÂ∫¶</span>
                            </div>
                            <span class="font-semibold" style="color: var(--text-color-primary);">${weatherData.humidity}%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center w-20">
                                <i class="fas fa-wind fa-fw w-5 text-center" style="color: var(--text-color-secondary);"></i>
                                <span class="ml-2" style="color: var(--text-color-secondary);">È£éÈÄü</span>
                            </div>
                            <span class="font-semibold" style="color: var(--text-color-primary);">${weatherData.windSpeedKmph} km/h</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWeatherData(newHtml, isError = false) {
            const weatherLoader = document.getElementById('weather-loader');
            const dataContainer = document.getElementById('weather-data-container');
            const wrapper = document.getElementById('weather-content-wrapper');
            
            if (!dataContainer || !wrapper) return;

            // 1. Fade out current content
            dataContainer.style.opacity = 0;

            // 2. After fade-out, update content and fade back in
            setTimeout(() => {
                setWeatherSpinner(false); // Stop spinner on success or error
                isFetchingWeather = false; // Release the lock
                dataContainer.innerHTML = newHtml;
                if (weatherLoader) {
                    weatherLoader.classList.remove('visible');
                }

                // Handle icon fade-in after image load
                const iconImg = document.getElementById('weather-icon-img');
                if (iconImg) {
                    const fadeInIcon = () => {
                        iconImg.classList.remove('weather-icon-initial');
                        iconImg.classList.add('weather-icon-loaded');
                    };
                    if (iconImg.complete) {
                        fadeInIcon();
                    } else {
                        iconImg.onload = fadeInIcon;
                    }
                }

                dataContainer.style.opacity = 1; // Fade in new content

                // This was in the old render function, so keep it for error cases
                if (isError) {
                    appSettings.weather.lastFetchedCity = 'Âä†ËΩΩÂ§±Ë¥•';
                    updateSettingsUI();
                }
            }, 300); // Match CSS transition duration
        }

        function convert12hto24h(time12h) {
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');

            if (hours === '12') {
                hours = '00';
            }

            if (modifier.toUpperCase() === 'PM') {
                hours = parseInt(hours, 10) + 12;
            }

            return `${String(hours).padStart(2, '0')}:${minutes}`;
        }

        // API Handler for wttr.in
        async function handleWttrIn(locationQuery, locationName) {
            const response = await fetch(`https://wttr.in/${encodeURIComponent(locationQuery)}?format=j1`);
            if (!response.ok) {
                throw new Error(`wttr.in API returned status ${response.status}`);
            }
            const data = await response.json();

            const current = data.current_condition[0];
            const forecast = data.weather[0];
            const nearestArea = data.nearest_area[0];
            const astronomy = forecast.astronomy[0];

            // Helper to convert 12h AM/PM time to a comparable number
            const timeToMinutes = (timeStr) => {
                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':').map(Number);
                if (modifier === 'PM' && hours < 12) {
                    hours += 12;
                }
                if (modifier === 'AM' && hours === 12) { // 12 AM is midnight
                    hours = 0;
                }
                return hours * 60 + minutes;
            };

            const now = new Date();
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
            const sunriseMinutes = timeToMinutes(astronomy.sunrise);
            const sunsetMinutes = timeToMinutes(astronomy.sunset);
            const isDay = currentTimeMinutes >= sunriseMinutes && currentTimeMinutes < sunsetMinutes;

            const standardizedData = {
                location: nearestArea.areaName[0].value,
                country: nearestArea.country[0].value,
                tempC: current.temp_C,
                feelsLikeC: current.FeelsLikeC,
                weatherCode: current.weatherCode,
                weatherDesc: current.weatherDesc[0].value,
                maxTempC: forecast.maxtempC,
                minTempC: forecast.mintempC,
                windSpeedKmph: current.windspeedKmph,
                humidity: current.humidity,
                sunrise: astronomy.sunrise, // Pass raw 12h string e.g. "6:04 AM"
                sunset: astronomy.sunset,   // Pass raw 12h string e.g. "7:12 PM"
                isDay: isDay,
                tip: "" // Tip will be generated after the object is created
            };
            
            // Generate tip after all data is available
            standardizedData.tip = getWeatherTip(standardizedData);

            appSettings.weather.lastFetchedCity = `${standardizedData.location}, ${standardizedData.country}`;
            saveSettings();
            return standardizedData;
        }
        
        // API Handler for Open-Meteo
        async function handleOpenMeteo(locationQuery, locationName) {
            // 1. Geocoding step
            const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationQuery)}&count=1&language=en&format=json`);
            if (!geoResponse.ok) {
                throw new Error(`Open-Meteo Geocoding API failed with status ${geoResponse.status}`);
            }
            const geoData = await geoResponse.json();
            if (!geoData.results || geoData.results.length === 0) {
                throw new Error(`Open-Meteo could not find location for "${locationQuery}"`);
            }
            const { latitude, longitude, name: foundName, country } = geoData.results[0];

            // 2. Forecast step
            const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&wind_speed_unit=kmh&timezone=auto`;
            const forecastResponse = await fetch(forecastUrl);
            if (!forecastResponse.ok) {
                throw new Error(`Open-Meteo Forecast API failed with status ${forecastResponse.status}`);
            }
            const forecastData = await forecastResponse.json();

            // 3. Parsing and Standardization step
            const WMO_CODES = {
                0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing rime fog',
                51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
                61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                66: 'Light freezing rain', 67: 'Heavy freezing rain',
                71: 'Slight snow fall', 73: 'Moderate snow fall', 75: 'Heavy snow fall',
                77: 'Snow grains',
                80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                85: 'Slight snow showers', 86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail',
            };

            const current = forecastData.current;
            const daily = forecastData.daily;
            const weatherDesc = WMO_CODES[current.weather_code] || 'Unknown';

            const standardizedData = {
                location: foundName,
                country: country,
                tempC: current.temperature_2m,
                feelsLikeC: current.apparent_temperature,
                weatherDesc: weatherDesc,
                maxTempC: daily.temperature_2m_max[0],
                minTempC: daily.temperature_2m_min[0],
                windSpeedKmph: current.wind_speed_10m,
                humidity: current.relative_humidity_2m,
                tip: "" // Tip will be generated after the object is created
            };

            // Generate tip after all data is available
            standardizedData.tip = getWeatherTip(standardizedData);

            appSettings.weather.lastFetchedCity = `${standardizedData.location}, ${standardizedData.country}`;
            saveSettings();
            return standardizedData;
        }

        // Controller that tries a list of API handlers in order.
        async function tryWeatherApis(locationQuery, locationName) {
            const apiHandlers = [
                handleWttrIn,
                handleOpenMeteo,
            ];

            for (const handler of apiHandlers) {
                try {
                    const weatherData = await handler(locationQuery, locationName);
                    if (weatherData) {
                        const html = getWeatherDataHtml(weatherData);
                        renderWeatherData(html);
                        return; // Success, exit the loop.
                    }
                } catch (error) {
                    console.warn(`API handler ${handler.name} failed:`, error);
                    // Log the error and continue to the next handler.
                }
            }

            // If all handlers failed
            const errorHtml = `<div class="text-center"><p style="color: var(--accent-color);">Â§©Ê∞î‰ø°ÊÅØÂΩìÂâç‰∏çÂèØÁî®„ÄÇ</p><p class="text-xs mt-2" style="color: var(--text-color-tertiary);">ËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï„ÄÇ</p></div>`;
            renderWeatherData(errorHtml, true);
        }

        // Main entry point for the weather feature.
        async function fetchAndDisplayWeather() {
            if (isFetchingWeather) {
                console.log("Weather fetch already in progress. Ignoring request.");
                return;
            }
            isFetchingWeather = true;

            const weatherLoader = document.getElementById('weather-loader');
            const dataContainer = document.getElementById('weather-data-container');
            const wrapper = document.getElementById('weather-content-wrapper');

            if (!weatherLoader || !dataContainer || !wrapper) return;

            // --- [FIX] Fade out old content before showing loader ---
            dataContainer.style.opacity = 0;

            setTimeout(async () => {
                // Show loader and set initial state after fade out
                weatherLoader.classList.add('visible');
                dataContainer.innerHTML = `<p class="text-center" style="color: var(--text-color-secondary);">Ê≠£Âú®Ëé∑ÂèñÂ§©Ê∞î...</p>`;
                dataContainer.style.opacity = 1; // Fade in the "Loading..." text

                let locationQuery = appSettings.weather.city;
                let locationName = locationQuery;

                // This part remains the same: get the location first.
                if (appSettings.weather.source === 'auto' && !locationQuery) {
                    try {
                        const ipResponse = await fetch('https://cors.eu.org/http://ip-api.com/json');
                        if (!ipResponse.ok) throw new Error('IP API request failed');
                        const ipData = await ipResponse.json();
                        locationQuery = ipData.city || 'auto:ip';
                        locationName = ipData.city;
                    } catch (e) {
                        setWeatherSpinner(false);
                        isFetchingWeather = false; // Release the lock on early error
                        console.error("IP-based geolocation failed.", e);
                        const errorHtml = `<div class="text-center"><p style="color: var(--accent-color);">Êó†Ê≥ïËá™Âä®Á°ÆÂÆöÊÇ®ÁöÑ‰ΩçÁΩÆ</p><p class="text-xs mt-2" style="color: var(--text-color-tertiary);">ËØ∑Âú®ËÆæÁΩÆ‰∏≠ÊâãÂä®ËæìÂÖ•ÂüéÂ∏Ç„ÄÇ</p></div>`;
                        renderWeatherData(errorHtml, true);
                        return;
                    }
                }

                if (!locationQuery) {
                    const errorHtml = `<div class="text-center"><p style="color: var(--accent-color);">Êú™ËÆæÁΩÆÂüéÂ∏Ç</p><p class="text-xs mt-2" style="color: var(--text-color-tertiary);">ËØ∑Âú®ËÆæÁΩÆ‰∏≠ÊâãÂä®ËæìÂÖ•‰∏Ä‰∏™ÂüéÂ∏ÇÂêçÁß∞„ÄÇ</p></div>`;
                    renderWeatherData(errorHtml, true);
                    return;
                }
                
                // Hand off to the controller function.
                await tryWeatherApis(locationQuery, locationName || locationQuery);
            }, 300); // Match CSS transition duration
        }


        function saveSettings() {
            localStorage.setItem('qing-homepage-settings', JSON.stringify(appSettings));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('qing-homepage-settings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Merge saved settings with defaults to ensure compatibility with future updates
                    appSettings = {
                        ...appSettings,
                        ...parsedSettings,
                        background: { ...appSettings.background, ...(parsedSettings.background || {}) },
                        weather: { ...appSettings.weather, ...(parsedSettings.weather || {}) },
                        developer: { ...appSettings.developer, ...(parsedSettings.developer || {}) },
                        newYearTheme: { ...appSettings.newYearTheme, ...(parsedSettings.newYearTheme || {}) },
                        appearance: { ...appSettings.appearance, ...(parsedSettings.appearance || {}) }
                    };

                    // Backward compatibility: If old setting `view: 'weather'` exists, but new `weather.source` doesn't, default it.
                    if (appSettings.view === 'weather' && !appSettings.weather.source) {
                        appSettings.weather.source = 'auto';
                    }
                } catch (e) {
                    console.error("Failed to parse settings from localStorage", e);
                    // If parsing fails, use default settings
                }
            }
        }
        
        let currentBgUrl = ''; // Holds the resolved URL of the current background
        let currentImageBlob = null; // Holds the raw image data for original-quality download
        let currentImageExtension = 'jpg'; // Holds the file extension for the blob

        // --- [NEW] Download Image Helper ---
        function downloadImage() {
            const downloadBtn = document.getElementById('bg-preview-download-btn');
            if (!downloadBtn) return;
            
            const originalIcon = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const restoreIcon = () => {
                downloadBtn.innerHTML = originalIcon;
            };

            // Prioritize downloading the original blob if it exists
            if (currentImageBlob) {
                try {
                    const objectUrl = URL.createObjectURL(currentImageBlob);
                    const a = document.createElement('a');
                    a.href = objectUrl;
                    a.download = `background-${Date.now()}.${currentImageExtension}`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(objectUrl);
                    setTimeout(restoreIcon, 100);
                } catch (error) {
                    console.error('Blob download failed:', error);
                    if (currentBgUrl) window.open(currentBgUrl, '_blank');
                    restoreIcon();
                }
            } else {
                // Fallback to canvas method for static images or if blob capture failed
                console.warn("No image blob available, falling back to canvas download.");
                try {
                    const img = document.getElementById('bg-preview-img');
                    if (!img || !img.src || !img.complete || img.naturalWidth === 0) {
                        throw new Error('Preview image is not available or ready for canvas download.');
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob((blob) => {
                        if (!blob) throw new Error('Canvas toBlob returned null.');
                        const objectUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = objectUrl;
                        a.download = `background-${Date.now()}.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(objectUrl);
                        restoreIcon();
                    }, 'image/png');
                } catch (error) {
                    console.error('Canvas download fallback failed:', error);
                    if (currentBgUrl) window.open(currentBgUrl, '_blank');
                    restoreIcon();
                }
            }
        }

        const showPreviewError = () => {
            const errorContainer = document.getElementById('bg-preview-error');
            const loader = document.getElementById('preview-loader');
            const previewImg = document.getElementById('bg-preview-img');

            if (!errorContainer || !loader || !previewImg) return;

            loader.classList.remove('visible');
            previewImg.classList.remove('breathing-effect');
            
            errorContainer.classList.remove('hidden');
            setTimeout(() => {
                errorContainer.classList.add('visible');
            }, 10);
        };

        const hidePreviewError = () => {
            const errorContainer = document.getElementById('bg-preview-error');
            if (!errorContainer) return;

            errorContainer.classList.remove('visible');
            setTimeout(() => {
                if (!errorContainer.classList.contains('visible')) {
                    errorContainer.classList.add('hidden');
                }
            }, 300);
        };
        
        const showPreview = (displayUrl, originalUrl) => {
            const requestId = ++latestPreviewRequestId;
            const previewImg = document.getElementById('bg-preview-img');
            const loader = document.getElementById('preview-loader');
            const downloadBtn = document.getElementById('bg-preview-download-btn');
            const refreshBtn = document.getElementById('bg-preview-refresh-btn');

            if (!previewImg || !loader) return;

            previewImg.classList.remove('breathing-effect');
            loader.classList.remove('visible');
            
            downloadBtn.classList.add('visible');
            refreshBtn.classList.add('visible');

            currentBgUrl = originalUrl;

            const preloader = new Image();
            preloader.src = displayUrl;

            preloader.onload = () => {
                if (requestId !== latestPreviewRequestId) return;

                previewImg.classList.remove('hidden');
                previewImg.style.transition = 'opacity 0.2s ease-in-out';
                previewImg.style.opacity = 0;

                setTimeout(() => {
                    previewImg.src = preloader.src;
                    previewImg.style.opacity = 1;
                }, 200);
            };

            preloader.onerror = () => {
                if (requestId !== latestPreviewRequestId) return;
                console.error(`Preview image failed to load: ${displayUrl}`);
                showPreviewError();
            };
        };

        async function applyCurrentBackground() {
            // [FIX] Add a guard clause to prevent overriding the active New Year theme.
            // This check is now based on settings state, not DOM state, to avoid race conditions on page load.
            const isThemeAvailable = isNewYearPeriod() || (appSettings.developer && appSettings.developer.forceNewYearTheme);
            const isThemeEnabledByUser = appSettings.newYearTheme && appSettings.newYearTheme.backgroundEnabled;
            if (isThemeAvailable && isThemeEnabledByUser) {
                return; // Do nothing if the New Year background should be showing.
            }

            const requestId = ++latestBgRequestId;
            const { source, specifier } = appSettings.background;

            hidePreviewError();

            const stopSpinner = () => {
                const refreshBtn = document.getElementById('bg-preview-refresh-btn');
                if (refreshBtn) {
                    const icon = refreshBtn.querySelector('i');
                    if (icon) icon.classList.remove('fa-spin');
                }
            };

            const hideStaticPreviewElements = () => {
                const container = document.getElementById('background-preview-container');
                if (container) container.classList.remove('visible');
            };
            
            const handleError = (error, source) => {
                if (requestId !== latestBgRequestId) return;
                console.error(`Error fetching background from source: ${source}`, error);
                stopSpinner();
                showPreviewError();
            };

            try {
                const { source, specifier, customUrl, customType } = appSettings.background;
                const isDynamicSource = ['bing', 'anime', 'random'].includes(source);
                const shouldShowPreview = isDynamicSource || source === 'custom';
                
                if (shouldShowPreview) {
                    const container = document.getElementById('background-preview-container');
                    const previewImg = document.getElementById('bg-preview-img');
                    const loader = document.getElementById('preview-loader');
                    const refreshBtn = document.getElementById('bg-preview-refresh-btn');

                    if (container) container.classList.add('visible');

                    if (previewImg && loader) {
                        previewImg.classList.add('breathing-effect');
                        loader.classList.add('visible');
                    }
                    
                    // Logic for refresh button visibility
                    const showRefresh = isDynamicSource || (source === 'custom' && customType === 'api');
                    if (refreshBtn) {
                        // Use a class to control visibility for animation purposes
                        refreshBtn.classList.toggle('visible', showRefresh);
                    }
                } else {
                    hideStaticPreviewElements();
                }

                let finalUrl;
                let displayUrl;

                if (source === 'custom') {
                    if (!customUrl) {
                        stopSpinner();
                        const errContainer = document.getElementById('bg-preview-error');
                        if (errContainer) {
                           const firstP = errContainer.querySelector('p:first-child');
                           const secondP = errContainer.querySelector('p:last-child');
                           if (firstP) firstP.textContent = 'Êú™Êèê‰æõÈìæÊé•';
                           if (secondP) secondP.textContent = 'ËØ∑Âú®‰∏äÊñπËæìÂÖ•Ëá™ÂÆö‰πâÈìæÊé•Âπ∂‰øùÂ≠ò';
                        }
                        showPreviewError();
                        return;
                    }

                    if (customType === 'image') {
                        finalUrl = customUrl;
                        displayUrl = finalUrl;
                        currentImageBlob = null;
                    } else { // API - Now with robust content-type checking
                        const apiResponse = await fetch(`https://cors.eu.org/${customUrl.split('?')[0]}?v=${new Date().getTime()}`);
                        if (!apiResponse.ok) throw new Error(`Custom API fetch failed with status: ${apiResponse.status}`);
                        
                        const contentType = apiResponse.headers.get('content-type');

                        if (contentType && contentType.includes('application/json')) {
                            const data = await apiResponse.json();
                            let imageUrl;
                            const target = Array.isArray(data) ? data[Math.floor(Math.random() * data.length)] : data;

                            if (typeof target === 'object' && target !== null) {
                                imageUrl = target.url || target.image || target.img_url;
                            }

                            if (!imageUrl) throw new Error('Could not find a valid image URL in JSON API response.');
                            
                            finalUrl = imageUrl;
                            const imageResponse = await fetch(`https://cors.eu.org/${finalUrl}`);
                            if (!imageResponse.ok) throw new Error(`Failed to fetch image from API's URL: ${finalUrl}`);
                            
                            const imageBlob = await imageResponse.blob();
                            currentImageBlob = imageBlob;
                            const imageContentType = imageResponse.headers.get('content-type');
                            const mimeToExt = { 'image/jpeg': 'jpg', 'image/png': 'png', 'image/gif': 'gif', 'image/bmp': 'bmp', 'image/webp': 'webp' };
                            currentImageExtension = mimeToExt[imageContentType] || 'jpg';
                            displayUrl = URL.createObjectURL(imageBlob);

                        } else if (contentType && contentType.startsWith('image/')) {
                            // This is a direct image API
                            finalUrl = customUrl;
                            const imageBlob = await apiResponse.blob();
                            currentImageBlob = imageBlob;
                            const mimeToExt = { 'image/jpeg': 'jpg', 'image/png': 'png', 'image/gif': 'gif', 'image/bmp': 'bmp', 'image/webp': 'webp' };
                            currentImageExtension = mimeToExt[contentType] || 'jpg';
                            displayUrl = URL.createObjectURL(imageBlob);
                        } else {
                            throw new Error(`Unsupported API response content-type: ${contentType}`);
                        }
                    }
                } else if (source === 'default') {
                    finalUrl = (specifier && specifier !== 'random' && DEFAULT_BG_IMAGES.includes(specifier))
                        ? specifier
                        : DEFAULT_BG_IMAGES[Math.floor(Math.random() * DEFAULT_BG_IMAGES.length)];
                    displayUrl = finalUrl;
                    currentImageBlob = null; 
                } else { // bing, anime, random
                    if (source === 'bing') {
                        const bingApiResponse = await fetch('https://cors.eu.org/https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=zh-CN');
                        if (!bingApiResponse.ok) throw new Error('Bing API request failed');
                        const bingData = await bingApiResponse.json();
                        finalUrl = `https://www.bing.com${bingData.images[0].urlbase}_1920x1080.jpg`;
                    } else {
                        const apiUrl = source === 'anime' 
                            ? 'https://api.sretna.cn/api/anime.php'
                            : 'https://imgapi.cn/api.php?zd=zsy&fl=fengjing&gs=images';
                        finalUrl = `${apiUrl}?v=${new Date().getTime()}`;
                    }

                    const imageResponse = await fetch(`https://cors.eu.org/${finalUrl}`);
                    if (!imageResponse.ok) throw new Error(`Failed to fetch image from proxy: ${finalUrl}`);
                    
                    const imageBlob = await imageResponse.blob();
                    currentImageBlob = imageBlob;
                    const contentType = imageResponse.headers.get('content-type');
                    const mimeToExt = { 'image/jpeg': 'jpg', 'image/png': 'png', 'image/gif': 'gif', 'image/bmp': 'bmp', 'image/webp': 'webp' };
                    currentImageExtension = mimeToExt[contentType] || 'jpg';

                    displayUrl = URL.createObjectURL(imageBlob);
                }

                if (requestId !== latestBgRequestId) {
                    if (displayUrl && displayUrl.startsWith('blob:')) URL.revokeObjectURL(displayUrl);
                    return;
                }

                await backgroundFader.update(displayUrl, true);
                if (shouldShowPreview) {
                    showPreview(displayUrl, finalUrl);
                }
                
                stopSpinner();

            } catch (error) {
                handleError(error, source);
            }
        }

        function updateBgSettingsUI() {
            const { source, specifier } = appSettings.background;

            // Update radio buttons
            const radio = document.querySelector(`input[name="background-source"][value="${source}"]`);
            if (radio) {
                radio.checked = true;
            }

            // Update thumbnail selection
            const defaultOptionsContainer = document.getElementById('default-bg-options');
            const allThumbs = defaultOptionsContainer.querySelectorAll('.thumb-item');
            allThumbs.forEach(thumb => thumb.classList.remove('active'));
            
            const activeThumb = defaultOptionsContainer.querySelector(`.thumb-item[data-bg-url="${specifier}"]`);
            if (activeThumb) {
                activeThumb.classList.add('active');
            }

            // Show/hide thumbnail section
            if (source === 'default') {
                defaultOptionsContainer.classList.add('open');
            } else {
                defaultOptionsContainer.classList.remove('open');
            }

            // --- [NEW] Update Custom URL Input ---
            const customBgInputWrapper = document.getElementById('custom-bg-input-wrapper');
            const customBgInput = document.getElementById('custom-bg-input');
            if (customBgInputWrapper && customBgInput) {
                if (source === 'custom') {
                    customBgInputWrapper.style.maxHeight = '80px';
                    customBgInputWrapper.classList.add('mt-2');
                    customBgInput.value = appSettings.background.customUrl || '';
                } else {
                    customBgInputWrapper.style.maxHeight = '0';
                    customBgInputWrapper.classList.remove('mt-2');
                }
            }

            // Preview container should be visible for all dynamic sources, including custom
            const previewContainer = document.getElementById('background-preview-container');
            if (['bing', 'anime', 'random', 'custom'].includes(source)) {
                previewContainer.classList.add('visible');
            } else {
                previewContainer.classList.remove('visible');
            }
        }

        function updateThemeSettingsUI(isInstant = false) {
            const slider = document.querySelector('.theme-slider');
            const parent = slider ? slider.parentElement : null;
            const currentTheme = appSettings.theme;
            const activeButton = document.querySelector(`.setting-btn[data-theme='${currentTheme}']`);

            if (!slider || !parent || !activeButton) {
                return; // Exit if any required element is missing
            }

            if (isInstant) {
                slider.style.transition = 'none';
            }

            // Update active classes on all buttons
            document.querySelectorAll('.setting-btn-group .setting-btn').forEach(btn => {
                btn.classList.toggle('active', btn === activeButton);
            });

            // Use getBoundingClientRect for precise positioning
            const parentRect = parent.getBoundingClientRect();
            const buttonRect = activeButton.getBoundingClientRect();

            const left = buttonRect.left - parentRect.left;
            const width = buttonRect.width;

            slider.style.width = `${width}px`;
            slider.style.transform = `translateX(${left}px)`;

            if (isInstant) {
                // Force reflow to apply styles synchronously before re-enabling the transition
                void slider.offsetHeight;
                slider.style.transition = '';
            }
        }

        function initializeThemeSlider() {
            const settingsWindow = document.getElementById('settings-window');
            if (!settingsWindow) return;

            // 1. Temporarily make the modal measurable but invisible to the user
            const originalTransition = settingsWindow.style.transition;
            settingsWindow.style.transition = 'none';
            settingsWindow.style.visibility = 'hidden';
            settingsWindow.style.display = 'flex'; // Ensure it's not display:none

            // 2. Force it to its final "open" state to get correct dimensions
            document.body.classList.add('settings-open');
            
            // 3. Now, take the measurement and set the slider's state instantly
            updateThemeSettingsUI(true);

            // 4. Immediately revert all changes so the user sees nothing.
            // This happens synchronously before the browser can paint.
            document.body.classList.remove('settings-open');
            settingsWindow.style.display = ''; // Revert to default
            settingsWindow.style.visibility = ''; // Revert to default
            settingsWindow.style.transition = originalTransition;
        }
        
        // --- [NEW] Settings Panel UI Generation ---
        function setupSettingsUI() {
            // --- 1. Background Settings ---
            const bgSettingsContainer = document.getElementById('background-settings-content');
            if (bgSettingsContainer) {
                const bgOptions = [
                    { value: 'default', label: 'ÈªòËÆ§ÂõæÁâá', description: 'ÈöèÊú∫ÈÄâÊã©‰∏ÄÂº†ÂÜÖÁΩÆÂõæÁâá‰Ωú‰∏∫ËÉåÊôØ' },
                    { value: 'bing', label: 'ÊØèÊó•‰∏ÄBing', description: 'Â±ïÁ§∫ Bing ÊêúÁ¥¢ÁöÑÊØèÊó•Â£ÅÁ∫∏' },
                    { value: 'anime', label: 'ÈöèÊú∫Âä®Êº´', description: '‰ªéÂÖ¨ÂÖ±Âä®Êº´ÂõæÂ∫ìÈöèÊú∫Âä†ËΩΩ‰∏ÄÂº†È´òÊ∏ÖÂ£ÅÁ∫∏' },
                    { value: 'random', label: 'ÈöèÊú∫ÂõæÁâá', description: '‰ªéÂÖ¨ÂÖ±ÂõæÂ∫ì‰∏≠ÈöèÊú∫Âä†ËΩΩ‰∏ÄÂº†È£éÊôØÂõæ' },
                    { value: 'custom', label: 'Ëá™ÂÆö‰πâÊù•Ê∫ê', description: '‰ΩøÁî®Âçï‰∏™ÂõæÁâáÈìæÊé•ÊàñÂÖ¨ÂÖ±ÂõæÂ∫ìAPI' } // ÊµãËØï‰ΩøÁî® https://www.loliapi.com/acg/
                ];

                const newYearToggleHTML = `
                    <div id="new-year-bg-toggle-section" class="hidden">
                        <div class="flex justify-between items-center p-2">
                            <div>
                                <span class="font-medium">ÂêØÁî®Êñ∞Âπ¥ËäÇÊó•ËÉåÊôØ</span>
                                <div class="setting-description">ÂÖ≥Èó≠ÂêéÂ∞ÜÊÅ¢Â§çÊÇ®ÈÄâÊã©ÁöÑÂ∏∏ËßÑËÉåÊôØ</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="new-year-bg-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="border-t border-[var(--separator-color)] my-4"></div>
                    </div>
                `;

                let mainBgSettingsHTML = `<div id="main-background-settings-wrapper" class="relative">`;
                mainBgSettingsHTML += `<div id="main-background-settings-content">`;

                let radioOptionsHTML = '';
                bgOptions.forEach(option => {
                    radioOptionsHTML += `
                        <div>
                            <input type="radio" id="bg-radio-${option.value}" name="background-source" value="${option.value}" class="setting-radio-input">
                            <label for="bg-radio-${option.value}" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>${option.label}</span>
                                    <div class="setting-description">${option.description}</div>
                                </div>
                            </label>
                        </div>
                    `;
                });

                const customBgInputHTML = `
                    <div id="custom-bg-input-wrapper" class="pl-2 pr-2" style="max-height: 0; overflow: hidden; transition: all 0.3s ease-in-out;">
                        <div class="relative flex items-center">
                            <input type="text" id="custom-bg-input" placeholder="ËæìÂÖ•ÂõæÁâáÊàñAPIÈìæÊé•" class="w-full rounded-md border px-3 py-1.5 text-sm" style="background-color: var(--progress-bar-bg); color: var(--text-color-primary); border-color: var(--separator-color); padding-right: 5.5rem;">
                            <div class="absolute right-1 flex items-center justify-end h-full w-14">
                                <div id="custom-bg-btn-group" class="flex items-center space-x-1">
                                    <button id="clear-custom-bg-btn" data-tooltip="Ê∏ÖÁ©∫" class="tooltip-container p-1 rounded-full text-gray-400 hover:text-white transition-all relative w-8 h-8">
                                        <i class="fas fa-times w-5 h-5 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center justify-center"></i>
                                    </button>
                                    <button id="save-custom-bg-btn" data-tooltip="‰øùÂ≠ò" class="tooltip-container p-1 rounded-full text-gray-400 hover:text-white transition-all relative w-8 h-8">
                                        <i class="fas fa-save w-5 h-5 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transition-opacity duration-200 opacity-100 flex items-center justify-center"></i>
                                        <i class="fas fa-check w-5 h-5 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transition-opacity duration-200 opacity-0 flex items-center justify-center" style="color: var(--status-today);"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="custom-bg-input-error" class="text-xs mt-1 pl-1 hidden" style="color: #ef4444;"></div>
                    </div>
                `;
                
                let defaultOptionsHTML = `
                    <div id="default-bg-options">
                        <div class="thumb-container">
                            <div class="thumb-item" data-bg-url="random">
                                <div class="thumb-overlay">ÈöèÊú∫</div>
                            </div>
                `;
                DEFAULT_BG_IMAGES.forEach((url, index) => {
                    defaultOptionsHTML += `
                        <div class="thumb-item" data-bg-url="${url}">
                            <img src="${url}" alt="Default Background ${index + 1}" loading="lazy">
                        </div>
                    `;
                });
                defaultOptionsHTML += `</div></div>`;

                const previewHTML = `
                    <div id="background-preview-container">
                        <div id="bg-preview-wrapper" class="relative w-full aspect-[16/9] rounded-lg overflow-hidden bg-white/5 transition-all duration-300 ease-in-out">
                            <img id="bg-preview-img" src="${DEFAULT_BG_IMAGES[0]}" alt="ËÉåÊôØÈ¢ÑËßà" class="w-full h-full object-cover hidden" crossorigin="anonymous">
                            <div id="preview-loader"></div>
                            <div id="bg-preview-error" class="absolute inset-0 hidden grid place-items-center cursor-pointer rounded-lg transition-all bg-black/30 backdrop-blur-sm text-center">
                                <div>
                                    <p class="font-bold text-lg">ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</p>
                                    <p class="mt-1 text-sm">ËØ∑ÁÇπÂáªÈ¢ÑËßàÁîªÈù¢ÈáçËØï</p>
                                </div>
                            </div>
                            <a id="bg-preview-download-btn" href="#" download="background.jpg" data-tooltip="‰øùÂ≠òËØ•ÂõæÁâá" class="tooltip-container absolute bottom-2 right-2 w-9 h-9 rounded-full bg-black/40 text-white flex items-center justify-center hover:bg-black/60 transition-all scale-0 duration-300">
                                <i class="fas fa-download"></i>
                            </a>
                            <button id="bg-preview-refresh-btn" data-tooltip="Êç¢‰∏ÄÂº†" class="tooltip-container absolute bottom-2 right-12 w-9 h-9 rounded-full bg-black/40 text-white flex items-center justify-center hover:bg-black/60 transition-all scale-0 duration-300">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                mainBgSettingsHTML += radioOptionsHTML + customBgInputHTML + defaultOptionsHTML + previewHTML;
                mainBgSettingsHTML += `</div>`; // closes main-background-settings-content

                mainBgSettingsHTML += `
                    <div id="background-settings-overlay" class="absolute inset-0 bg-[var(--card-bg-color)] bg-opacity-80 rounded-lg flex items-center justify-center text-sm font-bold cursor-not-allowed p-4 text-center">
                        <i class="fas fa-lock mr-2"></i>
                        <span>Êñ∞Âπ¥‰∏ªÈ¢òÂ∑≤ÊøÄÊ¥ªÔºåÂ¶ÇË¶Å‰ΩøÁî®ËÉåÊôØÂäüËÉΩËØ∑ÂÖ≥Èó≠Êñ∞Âπ¥‰∏ªÈ¢ò</span>
                    </div>
                `;

                mainBgSettingsHTML += `</div>`; // closes main-background-settings-wrapper
                
                bgSettingsContainer.innerHTML = newYearToggleHTML + mainBgSettingsHTML;
            }

            // --- 2. Theme Mode Settings ---
            const themeSettingsContainer = document.getElementById('theme-settings-content').parentElement;
            if (themeSettingsContainer) {
                const container = themeSettingsContainer.querySelector('#theme-settings-content');
                container.innerHTML = `
                <div class="setting-description text-center mb-3">ÈÄâÊã©‰∏Ä‰∏™‰∏ªÈ¢òÔºåÊàñËÆ©ÂÆÉÈöèÁ≥ªÁªüËá™Âä®Êõ¥Êîπ</div>
                    <div class="setting-btn-group w-full relative">
                        <div class="theme-slider absolute h-full transition-all duration-300"></div>
                        <button class="setting-btn relative z-10" data-theme="system"><i class="fas fa-desktop fa-fw mr-2"></i>Ë∑üÈöèÁ≥ªÁªü</button>
                        <button class="setting-btn relative z-10" data-theme="light"><i class="fas fa-sun fa-fw mr-2"></i>Êó•Èó¥Ê®°Âºè</button>
                        <button class="setting-btn relative z-10" data-theme="dark"><i class="fas fa-moon fa-fw mr-2"></i>Â§úÈó¥Ê®°Âºè</button>
                    </div>
                `;
            }

            // --- NEW: Time Format Settings ---
            const timeFormatContainer = document.getElementById('time-format-settings-content');
            if (timeFormatContainer) {
                timeFormatContainer.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-2">
                            <div>
                                <span class="font-medium">Ê≤âÊµ∏Ê®°ÂºèÂÜíÂè∑Èó™ÁÉÅ</span>
                                <div class="setting-description">‰ªÖÂú®ÂÖ®Â±èÊó∂Èíü‰∏ãÁîüÊïà</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="immersive-blink-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="time-format-24h" name="time-format" value="24h" class="setting-radio-input">
                            <label for="time-format-24h" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>24Â∞èÊó∂Âà∂Ôºà 19:30 Ôºâ</span>
                                    <div class="setting-description">‰ª• 00:00 Ëá≥ 23:59 ÁöÑÊ†ºÂºèÊòæÁ§∫Êó∂Èó¥</div>
                                </div>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="time-format-12h" name="time-format" value="12h" class="setting-radio-input">
                            <label for="time-format-12h" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>12Â∞èÊó∂Âà∂Ôºà 7:30 AM / 7:30 PM Ôºâ</span>
                                    <div class="setting-description">‰ΩøÁî® AM/PM Êù•Âå∫ÂàÜ‰∏äÂçàÂíå‰∏ãÂçàÔºåÁ¨¶ÂêàÈÉ®ÂàÜÁî®Êà∑‰π†ÊÉØ</div>
                                </div>
                            </label>
                        </div>
                    </div>
                `;
            }

            // --- 3. View Toggle Settings ---
            const viewToggleContainer = document.getElementById('view-toggle-content');
            if (viewToggleContainer) {
                viewToggleContainer.innerHTML = `
                    <div class="space-y-2">
                        <div>
                            <input type="radio" id="view-radio-github" name="view-source" value="github" class="setting-radio-input">
                            <label for="view-radio-github" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>ÊòæÁ§∫ GitHub Ë¥°ÁåÆÂõæ</span>
                                    <div class="setting-description">‰∏ªÂç°ÁâáÂå∫ÂüüÂ±ïÁ§∫ÊÇ®ÁöÑ GitHub Êèê‰∫§Ê¥ªÂä®ÂõæË°®</div>
                                </div>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="view-radio-weather-auto" name="view-source" value="weather-auto" class="setting-radio-input">
                            <label for="view-radio-weather-auto" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>Â§©Ê∞î‰ø°ÊÅØÔºà IP Ëá™Âä®ÂÆö‰Ωç Ôºâ</span>
                                    <div class="setting-description">Ê†πÊçÆÊÇ®ÁöÑÁΩëÁªú‰ΩçÁΩÆËá™Âä®Ëé∑ÂèñÂπ∂ÊòæÁ§∫ÂΩìÂú∞ÁöÑÂ§©Ê∞îÊÉÖÂÜµ</div>
                                </div>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="view-radio-weather-manual" name="view-source" value="weather-manual" class="setting-radio-input">
                            <label for="view-radio-weather-manual" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>Â§©Ê∞î‰ø°ÊÅØÔºà ÊâãÂä®ËæìÂÖ• Ôºâ</span>
                                    <div class="setting-description">ÊâãÂä®ËæìÂÖ•ÂüéÂ∏ÇÂêçÁß∞Êù•Ëé∑ÂèñÊåáÂÆöÂú∞ÁÇπÁöÑÂ§©Ê∞îÈ¢ÑÊä•</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div id="manual-city-input-wrapper" class="mt-2 pl-2 pr-2" style="max-height: 0; overflow: hidden; transition: all 0.3s ease-in-out;">
                        <div class="relative flex items-center">
                            <input type="text" id="weather-city-input" placeholder="ËæìÂÖ•ÂüéÂ∏ÇÂêéÂõûËΩ¶ (‰æãÂ¶Ç: Âåó‰∫¨)" class="w-full rounded-md border px-3 py-1.5 text-sm" style="background-color: var(--progress-bar-bg); color: var(--text-color-primary); border-color: var(--separator-color);">
                            <button id="save-city-btn" data-tooltip="‰øùÂ≠ò" class="tooltip-container absolute right-1 p-1 rounded-full text-gray-400 hover:text-white">
                                <i class="fas fa-save w-5 h-5 flex items-center justify-center"></i>
                            </button>
                            <div id="confirm-city-icon" class="absolute right-1 p-1 hidden opacity-0" style="color: var(--status-today);">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </div>
                        <div id="city-input-error" class="text-xs mt-1 pl-1 hidden" style="color: #ef4444;"></div>
                    </div>
                `;
            }

            // --- 4. Hitokoto Settings ---
            const hitokotoContainer = document.getElementById('hitokoto-settings-content');
            if (hitokotoContainer) {
                const categories = [
                    { id: 'a', name: 'Âä®Áîª' }, { id: 'b', name: 'Êº´Áîª' }, { id: 'c', name: 'Ê∏∏Êàè' },
                    { id: 'd', name: 'ÊñáÂ≠¶' }, { id: 'e', name: 'ÂéüÂàõ' }, { id: 'f', name: 'ÁΩëÁªú' },
                    { id: 'g', name: 'ÂÖ∂‰ªñ' }, { id: 'h', name: 'ÂΩ±ËßÜ' }, { id: 'i', name: 'ËØóËØç' },
                    { id: 'j', name: 'ÁΩëÊòì‰∫ë' }, { id: 'k', name: 'Âì≤Â≠¶' }, { id: 'l', name: 'ÊäñÊú∫ÁÅµ' }
                ];

                let checkboxesHTML = categories.map(cat => `
                    <div>
                        <input type="checkbox" id="hitokoto-cat-${cat.id}" name="hitokoto-category" value="${cat.id}" class="setting-radio-input hitokoto-checkbox-input">
                        <label for="hitokoto-cat-${cat.id}" class="hitokoto-checkbox-label">
                            <span class="custom-checkbox">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </span>
                            <span>${cat.name}</span>
                        </label>
                    </div>
                `).join('');

                hitokotoContainer.innerHTML = `
                    <div class="space-y-2">
                        <div>
                            <input type="radio" id="hitokoto-mode-default" name="hitokoto-mode" value="default" class="setting-radio-input">
                            <label for="hitokoto-mode-default" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>ÈªòËÆ§</span>
                                    <div class="setting-description">ÈöèÊú∫‰ªéÊâÄÊúâÂàÜÁ±ª‰∏≠Ëé∑ÂèñÂè•Â≠ê</div>
                                </div>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="hitokoto-mode-custom" name="hitokoto-mode" value="custom" class="setting-radio-input">
                            <label for="hitokoto-mode-custom" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <div>
                                    <span>Ëá™ÂÆö‰πâ</span>
                                    <div class="setting-description">ÊâãÂä®ÈÄâÊã©ÊÉ≥Ë¶ÅËé∑ÂèñÁöÑÂè•Â≠êÂàÜÁ±ª</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div id="hitokoto-custom-options">
                        <div class="border-t border-[var(--separator-color)] pt-3">
                            <div class="hitokoto-checkbox-container">
                                ${checkboxesHTML}
                            </div>
                             <div class="mt-4 flex items-center">
                                <div class="flex-shrink-0">
                                    <input type="checkbox" id="hitokoto-select-all" class="setting-radio-input hitokoto-checkbox-input">
                                    <label for="hitokoto-select-all" class="hitokoto-checkbox-label font-medium">
                                        <span class="custom-checkbox">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                        </span>
                                        <span>ÂÖ®ÈÄâ / ÂÖ®‰∏çÈÄâ</span>
                                    </label>
                                </div>
                                <div class="flex-grow text-center">
                                    <div id="hitokoto-validation-msg" class="inline-flex items-center">
                                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                        <span>ÂøÖÈ°ª‰øùÁïô‰∏Ä‰∏™Á±ªÂûã</span>
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <button id="hitokoto-save-btn" data-tooltip="‰øùÂ≠ò" class="tooltip-container p-2 rounded-full icon-btn transition-all active:scale-95 relative w-9 h-9">
                                        <i class="fas fa-save fa-lg absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transition-opacity duration-300"></i>
                                        <div id="hitokoto-confirm-icon" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-300" style="color: var(--status-today);">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function updateTimeFormatUI() {
            const selectedFormat = appSettings.timeFormat;
            const radio = document.querySelector(`input[name="time-format"][value="${selectedFormat}"]`);
            if (radio) {
                radio.checked = true;
            }
        }

        function updateViewToggleUI() {
            const cityInputWrapper = document.getElementById('manual-city-input-wrapper');
            const cityInput = document.getElementById('weather-city-input');

            let selectedViewValue;
            if (appSettings.view === 'github') {
                selectedViewValue = 'github';
            } else { // view is 'weather'
                selectedViewValue = `weather-${appSettings.weather.source}`;
            }

            const radio = document.querySelector(`input[name="view-source"][value="${selectedViewValue}"]`);
            if (radio) {
                radio.checked = true;
            }

            const isManual = appSettings.view === 'weather' && appSettings.weather.source === 'manual';
            cityInputWrapper.style.maxHeight = isManual ? '60px' : '0';
            cityInputWrapper.style.marginTop = isManual ? '0.75rem' : '0';

            if (isManual) {
                cityInput.placeholder = appSettings.weather.city || 'ËæìÂÖ•ÂüéÂ∏ÇÂêéÂõûËΩ¶ (‰æãÂ¶Ç: Âåó‰∫¨)';
                cityInput.value = appSettings.weather.city || '';
            }
        }

        function updateHitokotoSettingsUI() {
            const { mode, categories } = appSettings.hitokoto;

            // Update radio buttons
            const radio = document.querySelector(`input[name="hitokoto-mode"][value="${mode}"]`);
            if (radio) {
                radio.checked = true;
            }

            // Show/hide custom options panel
            const customOptionsContainer = document.getElementById('hitokoto-custom-options');
            if (mode === 'custom') {
                customOptionsContainer.classList.add('open');
            } else {
                customOptionsContainer.classList.remove('open');
            }

            // Update checkboxes
            const allCheckboxes = document.querySelectorAll('input[name="hitokoto-category"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = categories.includes(checkbox.value);
            });

            // Update "Select All" checkbox state
            const selectAllCheckbox = document.getElementById('hitokoto-select-all');
            if (selectAllCheckbox) {
                const allCategories = Array.from(allCheckboxes).map(cb => cb.value);
                selectAllCheckbox.checked = categories.length === allCategories.length;
            }
        }

        function updateImmersiveBlinkUI() {
            const toggle = document.getElementById('immersive-blink-toggle');
            if (toggle) {
                toggle.checked = appSettings.immersiveBlinkingColon;
            }
        }

        function updateDeveloperSettingsUI() {
            const devToggle = document.getElementById('dev-options-toggle');
            const forceNewYearToggle = document.getElementById('force-new-year-theme-toggle');

            if (devToggle) {
                devToggle.checked = appSettings.developer.uiToggleState;
            }
            if (forceNewYearToggle) {
                forceNewYearToggle.checked = appSettings.developer.forceNewYearTheme;
            }
        }

        function updateSliderProgress(slider) {
            const min = slider.min;
            const max = slider.max;
            const value = slider.value;
            const percentage = ((value - min) / (max - min)) * 100;
            slider.style.backgroundSize = `${percentage}% 100%`;
        }

        function updateAppearanceSettingsUI() {
            const { glassEffect, cardBorderRadius, cardBlurAmount } = appSettings.appearance;

            const glassEffectToggle = document.getElementById('glass-effect-toggle');
            if (glassEffectToggle) {
                glassEffectToggle.checked = glassEffect;
            }

            const radiusSlider = document.getElementById('card-border-radius-slider');
            const radiusValue = document.getElementById('card-border-radius-value');
            if (radiusSlider && radiusValue) {
                radiusSlider.value = cardBorderRadius;
                radiusValue.textContent = `${cardBorderRadius}px`;
                updateSliderProgress(radiusSlider);
            }

            const blurSlider = document.getElementById('card-blur-amount-slider');
            const blurValue = document.getElementById('card-blur-amount-value');
            if (blurSlider && blurValue) {
                blurSlider.value = cardBlurAmount;
                blurValue.textContent = `${cardBlurAmount}px`;
                updateSliderProgress(blurSlider);
            }
        }

        function updateSettingsUI() {
            updateBgSettingsUI();
            // updateThemeSettingsUI(); // This is now handled by a dedicated initializer
            updateTimeFormatUI();
            updateViewToggleUI();
            updateHitokotoSettingsUI();
            updateImmersiveBlinkUI();
            updateDeveloperSettingsUI();
            updateAppearanceSettingsUI();

            // Logic for New Year background toggle
            const newYearBgToggleSection = document.getElementById('new-year-bg-toggle-section');
            const newYearBgToggle = document.getElementById('new-year-bg-toggle');
            const shouldThemeBeActive = isNewYearPeriod() || appSettings.developer.forceNewYearTheme;

            if (newYearBgToggleSection && newYearBgToggle) {
                if (shouldThemeBeActive) {
                    newYearBgToggleSection.classList.remove('hidden');
                    newYearBgToggle.checked = appSettings.newYearTheme.backgroundEnabled;
                } else {
                    newYearBgToggleSection.classList.add('hidden');
                }
            }
        }

        // --- [NEW] View (GitHub/Weather) Management ---
        function applyCurrentView() {
            const githubView = document.getElementById('github-view');
            const weatherView = document.getElementById('weather-view');
            
            if (appSettings.view === 'weather') {
                githubView.classList.add('hidden');
                weatherView.classList.remove('hidden');
                fetchAndDisplayWeather();
            } else {
                weatherView.classList.add('hidden');
                githubView.classList.remove('hidden');
                setupGitHubChartLoader();
            }
        }

        function applyCurrentTheme() {
            const body = document.body;
            // Clear all theme-* classes before adding the new one
            body.classList.forEach(className => {
                if (className.startsWith('theme-')) {
                    body.classList.remove(className);
                }
            });

            let themeToApply;
            if (appSettings.theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                themeToApply = prefersDark ? 'theme-dark' : 'theme-light';
            } else {
                themeToApply = `theme-${appSettings.theme}`;
            }
            body.classList.add(themeToApply);
        }

        function applyBlinkingEffect() {
            document.body.classList.toggle('immersive-blink-enabled', appSettings.immersiveBlinkingColon);
        }

        function applyGlassEffect() {
            document.body.classList.toggle('glass-effect-disabled', !appSettings.appearance.glassEffect);
            
            const blurSlider = document.getElementById('card-blur-amount-slider');
            const blurContainer = document.getElementById('blur-setting-container'); // Target the new container
            if (blurSlider && blurContainer) {
                const isGlassEnabled = appSettings.appearance.glassEffect;
                blurSlider.disabled = !isGlassEnabled;
                blurContainer.classList.toggle('disabled', !isGlassEnabled);
            }
        }

        function applyCardSettings() {
            const { cardBorderRadius, cardBlurAmount } = appSettings.appearance;
            document.documentElement.style.setProperty('--card-border-radius', `${cardBorderRadius}px`);
            document.documentElement.style.setProperty('--card-backdrop-blur', `${cardBlurAmount}px`);
        }

        // --- [NEW] Immersive Time View Logic ---
        let immersiveTimeInterval = null;

        function updateImmersiveTime() {
            // We need to call the original updateTime to get the most up-to-date values,
            // then copy them over. This avoids code duplication.
            updateTime();
            
            const timeDisplay = document.getElementById('time-display').innerHTML;
            const dateDisplay = document.getElementById('date-display').textContent;
            const greeting = document.getElementById('greeting').textContent;
            
            // For 12h format, the time is in a span, so innerHTML is needed.
            document.getElementById('immersive-time-display').innerHTML = timeDisplay;
            document.getElementById('immersive-date-display').textContent = dateDisplay;
            document.getElementById('immersive-greeting').textContent = greeting;
        }


        // --- [NEW] ‰ªäÊó•‰∫∫ÂìÅ ÂäüËÉΩÈÄªËæë ---
        const luckTiers = {
            0: ["ÊòØ‰∏çÊòØÊìç‰ΩúÁ≥ªÁªüÁöÑÈîÖÔºüË¶Å‰∏çÈáçÂêØ‰∏Ä‰∏ãÔºü", "‰ªäÊó•‰∏çÂÆúÂá∫Èó®ÔºåÂª∫ËÆÆÂíåÂ∫äÈîÅÊ≠ª„ÄÇ", "‰Ω†ËøôËøêÊ∞îÔºåÊòØ‰∏çÊòØÂøòÁªôËÄÅÂ§©Áà∑Áª≠Ë¥π‰∫ÜÔºü", "Ê≤°‰∫ãÔºåÈáçÂú®ÂèÇ‰∏éÔºå‰∏ãÊ¨°‰∏ÄÂÆö„ÄÇ"],
            1: ["ËøòÂ•ΩÂêóÔºüË¶Å‰∏çË¶ÅÁªô‰Ω†ÁÇπ‰∏ÄÈ¶ñ„ÄäÂáâÂáâ„ÄãÔºü", "emm...‰ªäÂ§©ÂèØËÉΩÂè™ÈÄÇÂêàË∫∫Âπ≥„ÄÇ", "Ê∞¥ÈÄÜÊú¨ÈÄÜÔºå‰∏á‰∫ãÂ∞èÂøÉÔºÅ", "Âà´ÊãÖÂøÉÔºåËß¶Â∫ïÊâçËÉΩÂèçÂºπÔºÅ"],
            2: ["ËøêÊ∞îÂÄºÊ≠£Âú®ÂÖÖÂÄº‰∏≠ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ", "‰ªäÂ§©ÁöÑ‰∏ªÁ∫ø‰ªªÂä°ÊòØÔºöÊ¥ªÁùÄ„ÄÇ", "‰∏Ä‰ªΩËÄïËÄòÔºå‰∏Ä‰ªΩÊî∂Ëé∑...‰ΩÜ‰ªäÂ§©ÂèØËÉΩË¶ÅÂä†ÂÄçËÄïËÄò„ÄÇ", "Âª∫ËÆÆÔºöÂ§öÂñùÁÉ≠Ê∞¥ÔºåÂ∞ëÂÅöÂÜ≥ÂÆö„ÄÇ"],
            3: ["ËøêÊ∞îÊ≠£Âú®Âä†ËΩΩÔºå‰ΩÜÁΩëÈÄüÊúâÁÇπÊÖ¢...", "ÊúâÁÇπÂ¥éÂ≤ñÔºå‰ΩÜÈóÆÈ¢ò‰∏çÂ§ßÔºåÁ®≥‰ΩèÔºÅ", "È£éÊ∞¥ËΩÆÊµÅËΩ¨ÔºåÊòéÂ§©Â∞±Âà∞‰Ω†ÂÆ∂„ÄÇ", "‰øùÊåÅÂÜ∑ÈùôÔºå‰ΩõÁ≥ªÈù¢ÂØπ‰∏ÄÂàá„ÄÇ"],
            4: ["‰∏çÂ•Ω‰∏çÂùèÔºå‰πüÊòØ‰∏ÄÁßçÂÆâÁ®≥ÁöÑÂπ∏Á¶è„ÄÇ", "ËøêÊ∞îÂπ≥Âπ≥Ôºå‰ΩÜÂä™ÂäõÂèØ‰ª•ÂàõÈÄ†Â•áËøπ„ÄÇ", "‰ªäÂ§©ÈÄÇÂêàÂΩì‰∏™ÂÆâÈùôÁöÑÁæéÁî∑Â≠ê/Â•≥Â≠ê„ÄÇ", "Âú®Ôºü‰∏∫‰ªÄ‰πà‰∏çÂä™ÂäõÔºüÂ∞±‰ºöÊÄ™ËøêÊ∞îÔºü"],
            5: ["ÂèäÊ†º‰∫ÜÔºÅÂèàÊòØÂπ≥Â∏∏ÁöÑ‰∏ÄÂ§©Âë¢„ÄÇ", "Á®≥‰∏≠ÂêëÂ•ΩÔºåÊú™Êù•ÂèØÊúü„ÄÇ", "ÊØî‰∏ä‰∏çË∂≥ÔºåÊØî‰∏ãÊúâ‰ΩôÔºåÁü•Ë∂≥Â∏∏‰πê„ÄÇ", "‰Ω†ÁöÑÂ•ΩËøêÊ≠£Âú®Ê¥æÈÄÅ‰∏≠ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ„ÄÇ"],
            6: ["‰ªäÂ§©ËøêÊ∞î‰∏çÈîôÔºåÂèØ‰ª•Â∞ùËØï‰∏Ä‰∫õÊñ∞‰∏úË•ø„ÄÇ", "ÊÑüËßâËâØÂ•ΩÔºåÂ•ΩÂÉèÊúâ‰ªÄ‰πàÂ•Ω‰∫ãË¶ÅÂèëÁîüÔºü", "‰∏á‰∫ãÂºÄÂ§¥ÈöæÔºå‰ΩÜ‰Ω†‰ªäÂ§©ÂºÄÂ§¥‰∏çÈöæ„ÄÇ", "Áä∂ÊÄÅÂú®Á∫øÔºåÂÆúÁßØÊûÅÂêë‰∏ä„ÄÇ"],
            7: ["Â•ΩËøêÊ≠£Âú®Âêë‰Ω†ÊãõÊâãÔºÅ", "‰ªäÂ§©‰Ω†Â∞±ÊòØËá™Â∑±ÁöÑÈî¶È≤§ÔºÅ", "Ëµ∞ÔºåÂéª‰π∞Âº†ÂΩ©Á•®ËØïËØïÊâãÊ∞îÔºÅ", "ÂøÉÊÉÖ‰∏çÈîôÔºåÁúã‰ªÄ‰πàÈÉΩÈ°∫Áúº„ÄÇ"],
            8: ["ÂìáÂì¶ÔºÅÊòØÈáëËâ≤‰º†ËØ¥ÔºÅ", "Ê¨ßÊ∞îÊª°Êª°ÔºåÂèØ‰ª•Âá∫Âéª‚ÄúÊ®™‚ÄùÁùÄËµ∞‰∫Ü„ÄÇ", "‰ªäÂ§©‰Ω†ÊòØ‰∏çÊòØÂÅ∑ÂÅ∑ÊãúËøáË∞Å‰∫ÜÔºü", "Ê∞¥ÈÄÜÈÄÄÊï£ÔºåËØ∏‰∫ãÁöÜÂÆúÔºÅ"],
            9: ["Â§™Âº∫‰∫ÜÔºåÂÆáÂÆôÁöÑËÉΩÈáèÈÉΩÊ±áËÅö‰∫é‰Ω†ÔºÅ", "‰Ω†Â∞±ÊòØÂ§©ÈÄâ‰πãÂ≠êÔºåÂ•ΩËøêÁàÜÊ£öÔºÅ", "Ê¨ßÁöáÈôÑ‰ΩìÔºåÊâÄÂêëÊä´Èù°ÔºÅ", "Âª∫ËÆÆÁõ¥Êé•ÂéªÈæôÁéãÈÇ£ÂÑø‰∏äÁè≠ÔºåÂà´Âú®ËøôÂÑøÂ±àÊâç‰∫Ü„ÄÇ"],
            10: ["100ÂàÜÔºÅÂÆåÁæéÔºÅ‰ªäÂ§©Âú∞ÁêÉ‰∏∫‰Ω†ËÄåËΩ¨ÔºÅ", "ËøôÊòØ‰ªÄ‰πàÁ•û‰ªôËøêÊ∞îÔºüÂø´ÂéªÊãØÊïë‰∏ñÁïåÔºÅ", "Á≥ªÁªüÊèêÁ§∫ÔºöÊÇ®ÁöÑÂ•ΩËøêÂ∑≤Ê∫¢Âá∫ÔºÅ", "ÊàëÁÆóÂá∫Êù•‰∫ÜÔºå‰Ω†Â∞±ÊòØÁàΩÊñá/ÁàΩÂâß‰∏ªËßí„ÄÇ"]
        };
        let dailyLuckData = null; // Stored as { date, value, phrase }
        const luckMilestoneMessages = {
            50: "ÊâãÈÄü‰∏çÈîôÔºåÁªßÁª≠‰øùÊåÅÔºÅ",
            100: "‰Ω†Â∑≤Ëß£ÈîÅ„ÄåÁôæËøûÁÇπÂáª„ÄçÊàêÂ∞±ÔºÅ",
            200: "Èº†Ê†áÔºöÊàëÂΩìÊó∂ÂÆ≥ÊÄïÊûÅ‰∫Ü„ÄÇ",
            500: "ËøôÂ∞±ÊòØÂçïË∫´20Âπ¥ÁöÑÊâãÈÄüÂêóÔºü",
            1000: "‰Ω†...Ëé´ÈùûÂ∞±ÊòØ‰º†ËØ¥‰∏≠ÁöÑÁÇπËµûÁãÇÈ≠îÔºü",
            2000: "Â∑≤ÈÄöÁü•ÂêâÂ∞ºÊñØ‰∏ñÁïåÁ∫™ÂΩïÂÆòÊñπ‰∫∫Âëò„ÄÇ",
            5000: "ÂÅú‰∏ãÔºÅ‰Ω†ÁöÑÈº†Ê†áÂú®ÂÜíÁÉü‰∫ÜÔºÅ",
            10000: "ÊÇ®Â•ΩÔºåÂú∞ÁêÉ‰∫∫ÔºåÁúãÊù•Êàë‰ª¨Êö¥Èú≤‰∫Ü..."
        };
        let luckGameState = 'initial'; // initial, result_shown, prompt_1, prompt_2, prompt_3, counting
        let luckClickCount = 0;
        let countdownAnimationHandle = null; // Add this to the global scope
        let luckResetTimer = null;
        let hasPlayedGameToday = false;
        let resetClickCount = 0;
        let resetClickTimer = null;

        function getScoreColorClass(score) {
            if (score >= 90) return 'text-amber-500';
            if (score >= 70) return 'text-green-500';
            if (score >= 40) return 'text-sky-400'; // Default accent color
            return 'text-gray-400';
        }

        // --- Inlined Particle Animation Logic ---
        const particleEffects = (() => {
            /*
             * --- [ÂºÄÂèëËÄÖÊåáÂçó] Â¶Ç‰ΩïÊ∑ªÂä†Ëá™ÂÆö‰πâSVGÁ≤íÂ≠êÂΩ¢Áä∂ ---
             *
             * Ë¶Å‰ΩøÁî®ÊÇ®Ëá™Â∑±ÁöÑSVGÂõæÊ†áÊâ©Â±ïÁ≤íÂ≠êÊïàÊûúÔºåËØ∑ÈÅµÂæ™‰ª•‰∏ãÊ≠•È™§Ôºö
             *
             * 1. Âú®‰∏ãÊñπÁöÑ `svgShapes` Êï∞ÁªÑ‰∏≠Ê∑ªÂä†‰∏Ä‰∏™Êñ∞ÁöÑJavaScriptÂØπË±°„ÄÇ
             * 2. ÊØè‰∏™ÂØπË±°Ëá≥Â∞ëÈúÄË¶Å `svg` Âíå `randomColor` Â±ûÊÄßÔºåÂπ∂ÂèØÈÄâÊã©ÊÄßÂú∞Ê∑ªÂä† `size`„ÄÇ
             *
             * --- [ÈáçË¶Å] SVG‰ª£Á†ÅÂáÜÂ§á ---
             *
             * [!!] Ë≠¶ÂëäÔºöËØ∑ÂãøÁõ¥Êé•‰ΩøÁî®‰ªéËÆæËÆ°ËΩØ‰ª∂ÔºàÂ¶ÇIllustrator„ÄÅFigmaÔºâÂØºÂá∫ÁöÑÂéüÂßãSVG‰ª£Á†Å„ÄÇ
             * ÂéüÂßã‰ª£Á†ÅÂ∏∏Â∏∏ÂåÖÂê´XMLÂ£∞Êòé„ÄÅÂÖÉÊï∞ÊçÆ(<metadata>)„ÄÅÂÆö‰πâ(<defs>)ÂíåÂâ™ÂàáË∑ØÂæÑ(<clipPath>)Á≠â
             * ÈùûÂèØËßÜÂÖÉÁ¥†ÔºåËøô‰ºöÂØºËá¥Á≤íÂ≠êÊó†Ê≥ïÊ≠£Â∏∏Ê∏≤Êüì„ÄÇ
             *
             * Ê∏ÖÊ¥ÅÊåáÂçóÔºö
             * 1. ÊâìÂºÄSVGÊñá‰ª∂ÔºåÂè™Â§çÂà∂ `<svg ...>` Ê†áÁ≠æÂèäÂÖ∂ÂÜÖÈÉ®ÁöÑÊâÄÊúâË∑ØÂæÑ(<path>)„ÄÅ
             *    ÁºñÁªÑ(<g>)Á≠âÁªòÂõæÂÖÉÁ¥†„ÄÇ
             * 2. Á°Æ‰øùÊÇ®ÁöÑ `<svg>` Ê†áÁ≠æ‰∏≠Âê´Êúâ `viewBox` Â±ûÊÄßÔºåËøôÊòØÊ≠£Á°ÆÁº©ÊîæÁöÑÂÖ≥ÈîÆ„ÄÇ
             * 3. Â∞ÜÊ∏ÖÊ¥ÅÂêéÁöÑ‰ª£Á†Å‰Ωú‰∏∫ÂçïË°åJavaScriptÂ≠óÁ¨¶‰∏≤Á≤òË¥¥Âà∞ÈÖçÁΩÆ‰∏≠„ÄÇ
             *
             * --- ÈÖçÁΩÆÂ±ûÊÄßËØ¶ÊÉÖ ---
             *
             * `svg`: (Â≠óÁ¨¶‰∏≤)
             *   - ÊÇ®Ê∏ÖÊ¥ÅÂêéÁöÑ„ÄÅÂçïË°åÁöÑSVG‰ª£Á†ÅÂ≠óÁ¨¶‰∏≤„ÄÇ
             *
             * `randomColor`: (Â∏ÉÂ∞îÂÄº)
             *   - `true`: Á≤íÂ≠êÂ∞ÜË¢´Ëµã‰∫à‰∏Ä‰∏™ÈöèÊú∫È¢úËâ≤„ÄÇË¶Å‰ΩøÊ≠§ÂäüËÉΩÁîüÊïàÔºåÊÇ®ÁöÑSVG‰ª£Á†Å‰∏≠
             *     ÁöÑ `fill` Â±ûÊÄßÂøÖÈ°ªË¢´ËÆæÁΩÆ‰∏∫ `currentColor`„ÄÇ
             *   - `false`: Á≤íÂ≠êÂ∞Ü‰øùÊåÅÂÖ∂Âú®SVG‰ª£Á†Å‰∏≠ÂÆö‰πâÁöÑÂõ∫ÂÆöÈ¢úËâ≤„ÄÇ
             *
             * `size`: (Êï∞Â≠ó, ÂèØÈÄâ)
             *   - ‰∏∫Ê≠§ÁâπÂÆöSVGÁ≤íÂ≠êËÆæÁΩÆ‰∏Ä‰∏™Âõ∫ÂÆöÁöÑÂ∞∫ÂØ∏ÔºàÂçï‰Ωç‰∏∫ÂÉèÁ¥†Ôºâ„ÄÇ
             *   - Â¶ÇÊûú‰∏çÊèê‰æõÊ≠§Â±ûÊÄßÔºåÁ≤íÂ≠êÂ∞Ü‰ΩøÁî®ÈªòËÆ§ÁöÑÈöèÊú∫Â∞∫ÂØ∏ËåÉÂõ¥ (8-15px)„ÄÇ
             *
             * --- ÂÆåÊï¥Á§∫‰æã ---
             *
             * svgShapes: [
             *   // Á§∫‰æã1: Âõ∫ÂÆöÈ¢úËâ≤ÔºåËá™ÂÆö‰πâÂ§ßÂ∞∫ÂØ∏
             *   { 
             *     svg: '<svg viewBox="0 0 24 24" fill="#E74C3C">...</svg>',
             *     randomColor: false,
             *     size: 30
             *   },
             *   // Á§∫‰æã2: ÈöèÊú∫È¢úËâ≤Ôºå‰ΩøÁî®ÈªòËÆ§ÈöèÊú∫Â∞∫ÂØ∏
             *   { 
             *     svg: '<svg viewBox="0 0 24 24" fill="currentColor">...</svg>',
             *     randomColor: true 
             *   },
             *   // ... Âú®Ê≠§Ê∑ªÂä†Êõ¥Â§öSVGÂØπË±°
             * ]
             */
            const PARTICLE_CONFIG = {
                shapes: ['circle', 'square', 'triangle', 'heart', 'star'],
                // [JULES] Add a new array for custom SVG shapes.
                // For 'randomColor: true', ensure the SVG's fill property is set to "currentColor".
                // For 'randomColor: false', the SVG will use its own hardcoded fill colors.
                svgShapes: [
                    {
                        svg: '<svg viewBox="0 0 3840 1984" version="1.1" xmlns="http://www.w3.org/2000/svg"><g><path fill="currentColor" d="M 2372.53125 1499.746094 L 2752.230469 1499.746094 L 2125.871094 596.851562 C 2082.519531 534.171875 2021.230469 484.921875 1928.550781 484.921875 C 1832.878906 484.921875 1771.589844 538.640625 1728.238281 596.851562 L 1088.421875 1499.746094 L 1453.179688 1499.746094 L 1686.921875 1169.773438 L 1912.691406 1499.746094 L 2292.390625 1499.746094 L 1881.039062 895.75 L 1922.570312 837.121094 Z"/></g></svg>',
                        randomColor: true,
                        size: 60
                    },
                    {
                        svg: '<svg viewBox="0 0 609 609" version="1.1" xmlns="http://www.w3.org/2000/svg"><g><path fill="currentColor" opacity="1.00" d=" M 178.09 290.24 C 221.60 235.87 247.22 168.49 255.84 99.70 C 270.31 99.54 284.78 99.65 299.24 99.61 C 299.40 158.87 299.23 218.12 299.29 277.37 C 291.77 279.95 284.84 285.04 281.48 292.43 C 275.46 304.41 280.05 320.58 291.81 327.22 C 300.57 332.33 312.13 332.11 320.65 326.58 C 332.26 319.50 336.31 303.07 329.73 291.25 C 326.17 284.59 319.82 279.69 312.69 277.35 C 312.78 218.13 312.62 158.91 312.78 99.69 C 327.22 99.59 341.66 99.59 356.10 99.69 C 360.47 138.24 370.88 176.05 386.49 211.56 C 398.60 239.80 414.78 266.14 433.59 290.40 C 425.11 303.70 416.62 317.03 409.44 331.09 C 396.14 356.77 385.17 383.73 377.84 411.74 C 330.02 411.94 282.20 411.81 234.38 411.80 C 225.19 378.28 211.36 346.10 193.98 316.03 C 189.03 307.22 183.36 298.85 178.09 290.24 Z" /><path fill="currentColor" opacity="1.00" d=" M 227.44 425.74 C 233.83 424.06 240.49 425.13 247.00 425.12 C 284.34 425.19 321.68 424.72 359.02 424.98 C 367.19 425.01 375.46 424.24 383.57 425.55 C 394.59 428.28 399.99 441.78 396.13 451.95 C 393.75 459.12 386.58 464.23 379.03 464.14 C 330.35 464.19 281.68 464.18 233.00 464.14 C 225.75 464.31 218.85 459.47 216.24 452.75 C 211.70 442.82 216.66 429.05 227.44 425.74 Z" /><path fill="currentColor" opacity="1.00" d=" M 229.96 477.29 C 280.70 477.21 331.45 477.29 382.20 477.29 C 382.19 488.90 382.23 500.50 382.21 512.11 C 331.56 512.35 280.91 511.94 230.26 512.32 C 230.09 510.56 229.83 508.81 229.89 507.05 C 230.16 497.13 229.55 487.21 229.96 477.29 Z" /></g></svg>',
                        randomColor: true,
                        size: 40
                    }
                ],
                colors: ['#FF69B4', '#87CEEB', '#FFFACD', '#98FB98', '#E6E6FA', '#FFA500', '#DC143C', '#20B2AA', '#FFD700'],
                size: { min: 12, max: 15 },
                gravity: 0.08,
                // 1. Lowered particle height by reducing initial upward velocity
                initialVelocity: { x_range: [-2.5, 2.5], y_range: [-3.5, -5.5] },
                rotationSpeed: { min: -2, max: 2 },
                fadeOutDuration: 500,
            };
            let particleContainer;
            const rand = (min, max) => Math.random() * (max - min) + min;

            function createParticleElement() {
                const particle = document.createElement('div');
                // Combine default shapes and new SVG shapes for random selection
                const allShapes = [...PARTICLE_CONFIG.shapes, ...(PARTICLE_CONFIG.svgShapes || [])];
                const shape = allShapes[Math.floor(Math.random() * allShapes.length)];
                const color = PARTICLE_CONFIG.colors[Math.floor(Math.random() * PARTICLE_CONFIG.colors.length)];
                
                // NEW: Determine size based on shape config, with a fallback to the default random size.
                const size = (typeof shape === 'object' && typeof shape.size === 'number')
                    ? shape.size 
                    : rand(PARTICLE_CONFIG.size.min, PARTICLE_CONFIG.size.max);
                
                particle.classList.add('particle');

                // Handle new SVG shape objects
                if (typeof shape === 'object' && shape.svg) {
                    // The SVG string is cleaned to remove width/height attributes
                    // which might interfere with styling.
                    particle.innerHTML = shape.svg.replace(/width=".*?"/g, '').replace(/height=".*?"/g, '');
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    // Default to random color unless explicitly set to false
                    if (shape.randomColor !== false) {
                        particle.style.color = color;
                    }
                } 
                // Handle old string-based shapes
                else {
                    particle.classList.add(shape);
                    if (shape === 'triangle') {
                        particle.style.width = '0';
                        particle.style.height = '0';
                        particle.style.borderLeft = `${size / 2}px solid transparent`;
                        particle.style.borderRight = `${size / 2}px solid transparent`;
                        particle.style.borderBottom = `${size}px solid ${color}`;
                    } else if (shape === 'heart') {
                        particle.style.width = `${size}px`;
                        particle.style.height = `${size}px`;
                        particle.style.backgroundColor = color;
                    } else if (shape === 'star') {
                        particle.style.width = `${size}px`;
                        particle.style.height = `${size}px`;
                        particle.style.setProperty('--star-color', color);
                    } else { // circle, square
                        particle.style.width = `${size}px`;
                        particle.style.height = `${size}px`;
                        particle.style.backgroundColor = color;
                    }
                }
                return particle;
            }

            function animateParticle(particle, origin) {
                const vx = rand(PARTICLE_CONFIG.initialVelocity.x_range[0], PARTICLE_CONFIG.initialVelocity.x_range[1]);
                let vy = rand(PARTICLE_CONFIG.initialVelocity.y_range[0], PARTICLE_CONFIG.initialVelocity.y_range[1]);
                let x = origin.x;
                let y = origin.y;
                let rot = 0;
                const rotSpeed = rand(PARTICLE_CONFIG.rotationSpeed.min, PARTICLE_CONFIG.rotationSpeed.max);
                
                // [JULES] MODIFICATION: Add fade-in variables
                const FADE_IN_DURATION = 200; // ms
                const creationTime = Date.now();
                let fadeOutStartTime = null;

                function frame() {
                    vy += PARTICLE_CONFIG.gravity;
                    x += vx;
                    y += vy;
                    rot += rotSpeed;
                    particle.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px) rotate(${rot}deg)`;

                    // [JULES] MODIFICATION: Combined fade-in and fade-out logic
                    const lifeTime = Date.now() - creationTime;
                    let opacity = 1;

                    // Calculate fade-in
                    if (lifeTime < FADE_IN_DURATION) {
                        opacity = lifeTime / FADE_IN_DURATION;
                    }

                    // Calculate fade-out
                    const groundLevel = particleContainer.clientHeight * 0.9;
                    if (y > groundLevel && fadeOutStartTime === null) {
                        fadeOutStartTime = Date.now();
                    }

                    if (fadeOutStartTime !== null) {
                        const fadeOutElapsedTime = Date.now() - fadeOutStartTime;
                        const fadeOutProgress = fadeOutElapsedTime / PARTICLE_CONFIG.fadeOutDuration;
                        if (fadeOutProgress < 1) {
                            // Apply the lower of the two opacities
                            opacity = Math.min(opacity, 1 - fadeOutProgress);
                        } else {
                            if (particle.parentNode) particle.parentNode.removeChild(particle);
                            return; // End animation
                        }
                    }
                    
                    particle.style.opacity = opacity;
                    requestAnimationFrame(frame);
                }
                requestAnimationFrame(frame);
            }

            // 2. Corrected particle origin calculation
            function getParticleOrigin() {
                const luckResultEl = document.getElementById('luck-result');
                const luckButtonEl = document.getElementById('luck-button');
                if (!luckResultEl || !luckButtonEl) {
                    return { x: particleContainer.clientWidth / 2, y: particleContainer.clientHeight / 2 };
                }
                
                const containerRect = particleContainer.getBoundingClientRect();
                const resultRect = luckResultEl.getBoundingClientRect();
                
                // If the result div has no width, it means it's hidden (e.g. in the clicker game phase).
                // In this case, we should originate from the button's center.
                if (resultRect.width === 0) {
                     const buttonRect = luckButtonEl.getBoundingClientRect();
                     return {
                        x: (buttonRect.left - containerRect.left) + buttonRect.width / 2,
                        y: (buttonRect.top - containerRect.top) + buttonRect.height / 2
                    };
                }

                // [JULES] MODIFICATION: Pinpoint the number for a more precise origin.
                // Try to find the specific number element (the one with the large text).
                const numberEl = luckResultEl.querySelector('.text-4xl');
                // Use the number's bounding box if it exists, otherwise fall back to the whole container's box.
                const targetRect = numberEl ? numberEl.getBoundingClientRect() : resultRect;
                
                // Return the calculated center of the target element, relative to the particle container.
                return {
                    x: (targetRect.left - containerRect.left) + targetRect.width / 2,
                    y: (targetRect.top - containerRect.top) + targetRect.height / 2
                };
            }

            return {
                init: () => {
                    particleContainer = document.getElementById('particle-container');
                    if (!particleContainer) console.error('Particle container #particle-container not found!');
                },
                triggerSingleParticle: () => {
                    if (!particleContainer) return;
                    const particle = createParticleElement();
                    particleContainer.appendChild(particle);
                    const origin = getParticleOrigin();
                    animateParticle(particle, origin);
                },
                triggerBurstEffect: (count = 20) => {
                    if (!particleContainer) return;
                    for (let i = 0; i < count; i++) {
                        setTimeout(() => particleEffects.triggerSingleParticle(), i * 15);
                    }
                }
            };
        })();

        function displayLuckResult(data, isAnimated = false) {
            const luckResult = document.getElementById('luck-result');
            if (!luckResult) return;

            const contentWrapper = document.createElement('div');
            const colorClass = getScoreColorClass(data.value);
            contentWrapper.innerHTML = `
                <p>‰Ω†‰ªäÂ§©ÁöÑ‰∫∫ÂìÅÂÄºÊòØ</p>
                <p class="text-4xl font-bold ${colorClass} leading-tight">${data.value}!</p>
                <p class="min-w-0">${data.phrase}</p>
            `;

            if (isAnimated) {
                contentWrapper.classList.add('bounce-in');
                // 3. Delayed burst animation
                setTimeout(() => {
                    particleEffects.triggerBurstEffect(20);
                }, 500);
            }
            
            luckResult.innerHTML = '';
            luckResult.appendChild(contentWrapper);
            
            luckResult.classList.add('flex', 'flex-col', 'justify-center', 'flex-1', 'min-w-0', 'relative');
            requestAnimationFrame(() => {
                luckResult.classList.add('visible');
            });
        }

        function generateWeightedLuck() {
            // Using Bates distribution (sum of n uniform variables) to approximate a normal distribution.
            // n=4 provides a decent bell curve.
            let x = 0;
            for (let i = 0; i < 4; i++) {
                x += Math.random();
            }
            x = x / 4; // Now x is in [0, 1] with a peak at 0.5

            // Apply a power function with k < 1 to shift the peak upwards, as requested.
            // k=0.5 is tuned to produce a sub-60 score roughly 15-20% of the time.
            const skewedX = Math.pow(x, 0.5);

            // Scale to 0-100. Let's scale to 102 to make 100 a bit more reachable.
            let finalValue = Math.floor(skewedX * 102);
            
            // Cap the value at 100 to handle any edge cases where the result might exceed 100.
            if (finalValue > 100) {
                finalValue = 100;
            }
            return finalValue;
        }

        function openBlindBox() {
            const value = generateWeightedLuck();
            const tier = value === 100 ? 10 : Math.floor(value / 10);
            const phrases = luckTiers[tier];
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];
            
            const todayStr = new Date().toISOString().split('T')[0];
            dailyLuckData = { date: todayStr, value, phrase };
            
            try {
                localStorage.setItem('dailyLuckData', JSON.stringify(dailyLuckData));
            } catch (e) {
                console.error("Failed to save luck data to localStorage", e);
            }

            displayLuckResult(dailyLuckData, true);
            luckGameState = 'result_shown';
        }

        function updateLuckResultText(text, animationClass = null) {
            const luckResult = document.getElementById('luck-result');
            if (!luckResult) return;
            
            luckResult.innerHTML = `<p>${text}</p>`;
            
            if (animationClass === 'luck-shake') {
                luckResult.classList.add(animationClass);
                luckResult.addEventListener('animationend', () => {
                    luckResult.classList.remove(animationClass);
                }, { once: true });
            }
        }

        function displayCounter() {
            const luckResult = document.getElementById('luck-result');
            if (!luckResult) return;
            luckResult.innerHTML = `
                <div id="luck-counter-container" class="flex items-center justify-center" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">
                    <span class="text-2xl font-bold" style="color: var(--text-color-secondary);">‚úï</span>
                    <span id="luck-counter-value" class="text-5xl font-bold leading-none luck-pop-anim">${luckClickCount}</span>
                </div>
            `;
        }

        function updateCounter() {
            const milestoneMessage = luckMilestoneMessages[luckClickCount];
            const luckResult = document.getElementById('luck-result');

            particleEffects.triggerSingleParticle();

            if (milestoneMessage) {
                updateLuckResultText(milestoneMessage);
                luckResult.classList.remove('luck-pop-anim');
                void luckResult.offsetWidth;
                luckResult.classList.add('luck-pop-anim');
            } else {
                const counterValue = document.getElementById('luck-counter-value');
                if (counterValue) {
                    counterValue.textContent = luckClickCount;
                    counterValue.classList.remove('luck-pop-anim');
                    void counterValue.offsetWidth;
                    counterValue.classList.add('luck-pop-anim');
                } else {
                    displayCounter();
                }
            }
        }

        function handleLuckClick() {
            clearTimeout(luckResetTimer);
            clearTimeout(countdownAnimationHandle); // NEW: Stop any countdown immediately

            if (luckGameState === 'initial') {
                openBlindBox();
                return; // No timer needed
            }

            if (luckGameState === 'result_shown') {
                if (hasPlayedGameToday) {
                    luckGameState = 'counting';
                    luckClickCount = 1;
                    displayCounter();
                } else {
                    luckGameState = 'prompt_1';
                    updateLuckResultText('‰Ω†‰ªäÂ§©Â∑≤ÁªèÂºÄËøá‰∫ÜÔºåËøòÂºÄÔºü', 'luck-shake');
                    hasPlayedGameToday = true;
                }
            } else if (luckGameState === 'prompt_1') {
                luckGameState = 'prompt_2';
                updateLuckResultText('ËøòÁÇπÔºü', 'luck-shake');
            } else if (luckGameState === 'prompt_2') {
                luckGameState = 'prompt_3';
                updateLuckResultText('ÈÇ£‰Ω†ÁÇπÂêß', 'luck-shake');
            } else if (luckGameState === 'prompt_3') {
                luckGameState = 'counting';
                luckClickCount = 1;
                displayCounter();
            } else if (luckGameState === 'counting') {
                luckClickCount++;
                updateCounter();
            }

            // Set the reset timer for all subsequent clicks
            luckResetTimer = setTimeout(() => {
                if (luckGameState === 'counting') {
                    startCountdownAnimation();
                } else {
                    // This handles resetting from prompt states
                    displayLuckResult(dailyLuckData, false);
                    luckGameState = 'result_shown';
                }
            }, 2000);
        }

        function startCountdownAnimation() {
            clearTimeout(countdownAnimationHandle); // Clear any ongoing animation
            let currentCount = luckClickCount;

            if (currentCount <= 0) {
                displayLuckResult(dailyLuckData, false);
                luckGameState = 'result_shown';
                return;
            }
            
            const counterValue = document.getElementById('luck-counter-value');
            // Make sure the 'x' is visible, in case it was hidden by old logic
            const counterX = document.querySelector('#luck-counter-container > span:first-child');
            if (counterX && counterX.style.opacity === '0') {
                counterX.style.opacity = 1;
            }

            function getDelay(num) {
                if (num > 20) return 15;
                if (num > 10) return 40;
                if (num > 5) return 80;
                return 150;
            }

            function countdownStep(i) {
                if (i > 0) {
                    if (counterValue) {
                        counterValue.textContent = i;
                    }
                    const nextDelay = getDelay(i - 1);
                    countdownAnimationHandle = setTimeout(() => countdownStep(i - 1), nextDelay);
                } else {
                    // Countdown finished. Animate out the counter, then show the result.
                    const luckResult = document.getElementById('luck-result');
                    const innerContent = luckResult.firstElementChild; // Use firstElementChild to get the actual DIV
                    
                    if (innerContent) {
                        // Fade out the current content (the counter)
                        innerContent.classList.add('fade-out-opacity-only');

                        // After the fade-out, display the final result with a bounce
                        countdownAnimationHandle = setTimeout(() => {
                            // FIX: Set isAnimated to false to prevent re-bursting
                            displayLuckResult(dailyLuckData, false); 
                            luckGameState = 'result_shown';
                            luckClickCount = 0;
                            countdownAnimationHandle = null;
                        }, 300); // Wait for fade-out (0.3s) to complete.
                    } else {
                        // Fallback if something goes wrong, just show the result.
                        displayLuckResult(dailyLuckData, false);
                        luckGameState = 'result_shown';
                        luckClickCount = 0;
                        countdownAnimationHandle = null;
                    }
                }
            }

            countdownStep(currentCount);
        }

        function setupLuckFeature() {
            const luckButton = document.getElementById('luck-button');
            if (!luckButton) return;

            const todayStr = new Date().toISOString().split('T')[0];
            
            try {
                const savedLuck = localStorage.getItem('dailyLuckData');
                if (savedLuck) {
                    const parsedLuck = JSON.parse(savedLuck);
                    if (parsedLuck.date === todayStr) {
                        dailyLuckData = parsedLuck;
                        displayLuckResult(dailyLuckData, false);
                        luckGameState = 'result_shown';
                    } else {
                        localStorage.removeItem('dailyLuckData');
                    }
                }
            } catch (e) {
                console.error("Failed to parse luck data from localStorage", e);
                localStorage.removeItem('dailyLuckData');
            }

            luckButton.addEventListener('click', handleLuckClick);
        }

        // --- [NEW] Card Slider Logic ---
        function createCardSlider(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;

            const wrapper = container.querySelector('.slider-wrapper');
            const track = container.querySelector('.slider-track');
            const slides = Array.from(container.querySelectorAll('.card-slide'));
            const dotsContainer = container.querySelector('.slider-dots');

            if (!wrapper || !track || !slides.length || !dotsContainer) {
                console.error('Slider missing required elements.');
                return;
            }

            let hasDragged = false;

            let state = {
                slidesToShow: 3,
                slidesToScroll: 3,
                totalSlides: slides.length,
                currentPage: 0,
                totalPages: 1,
                isDragging: false,
                startX: 0,
                currentTranslate: 0,
                startTranslate: 0,
                lastX: 0,
                velocity: 0,
                animationFrame: null,
            };

            const FRICTION = 0.92;
            const THRESHOLD = 50; // Min distance in px to trigger a slide

            function updateSliderConfig() {
                const screenWidth = window.innerWidth;
                if (screenWidth < 768) { // On mobile and small tablets, show 2 cards
                    state.slidesToShow = 2;
                    state.slidesToScroll = 2;
                } else { // On larger screens, show 3 cards
                    state.slidesToShow = 3;
                    state.slidesToScroll = 3;
                }
                state.totalPages = Math.ceil(state.totalSlides / state.slidesToScroll);
            }

            function applySlideWidths() {
                const gap = 16; // 1rem, from `gap-4`
                const style = window.getComputedStyle(wrapper);
                const paddingLeft = parseFloat(style.paddingLeft);
                const paddingRight = parseFloat(style.paddingRight);
                const contentWidth = wrapper.clientWidth - paddingLeft - paddingRight;
                const slideWidth = (contentWidth - (gap * (state.slidesToShow - 1))) / state.slidesToShow;
                slides.forEach(slide => {
                    slide.style.width = `${slideWidth}px`;
                });
            }

            function createDots() {
                dotsContainer.innerHTML = '';
                if (state.totalPages <= 1) {
                    container.style.display = 'none'; // Hide the whole thing
                    return;
                }
                container.style.display = '';

                for (let i = 0; i < state.totalPages; i++) {
                    const dot = document.createElement('button');
                    dot.classList.add('dot');
                    dot.setAttribute('data-page', i);
                    dot.addEventListener('click', () => goToPage(i));
                    dotsContainer.appendChild(dot);
                }
            }

            function updateDots() {
                const dots = dotsContainer.querySelectorAll('.dot');
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === state.currentPage);
                });
            }
            
            function goToPage(page, animated = true) {
                state.currentPage = Math.max(0, Math.min(page, state.totalPages - 1));
                
                const gap = 16;
                const style = window.getComputedStyle(wrapper);
                const paddingLeft = parseFloat(style.paddingLeft);
                const paddingRight = parseFloat(style.paddingRight);
                const contentWidth = wrapper.clientWidth - paddingLeft - paddingRight;
                
                // Since slidesToScroll is always equal to slidesToShow, the total distance
                // to scroll for one page is the width of the content area plus one gap.
                const scrollAmount = contentWidth + gap;
                const newTranslate = -state.currentPage * scrollAmount;

                if (animated) {
                    track.style.transition = `transform 0.5s cubic-bezier(0.165, 0.84, 0.44, 1)`;
                    track.style.transform = `translateX(${newTranslate}px)`;
                } else {
                    track.style.transition = 'none';
                    track.style.transform = `translateX(${newTranslate}px)`;
                }

                state.currentTranslate = newTranslate;
                updateDots();
            }

            function onDragStart(event) {
                hasDragged = false;
                event.preventDefault();
                state.isDragging = true;
                state.startX = event.type.includes('touch') ? event.touches[0].clientX : event.clientX;
                state.startTranslate = state.currentTranslate;
                state.lastX = state.startX;
                state.velocity = 0;
                
                track.style.transition = 'none';
                wrapper.classList.add('grabbing');
                
                cancelAnimationFrame(state.animationFrame);
                state.animationFrame = requestAnimationFrame(updateVelocity);
            }

            function onDragMove(event) {
                if (!state.isDragging) return;
                const currentX = event.type.includes('touch') ? event.touches[0].clientX : event.clientX;
                const dx = currentX - state.startX;
                if (Math.abs(dx) > 10) {
                    hasDragged = true;
                }
                state.currentTranslate = state.startTranslate + dx;
                track.style.transform = `translateX(${state.currentTranslate}px)`;
            }
            
            function updateVelocity() {
                const now = performance.now();
                const currentX = state.lastX;
                const dx = currentX - state.lastX;
                const dt = now - (state.lastTime || now);
                state.lastTime = now;
                
                if (dt > 0) {
                    state.velocity = (dx / dt) * 10; // Scale up for more oomph
                }
                state.lastX = currentX;
                state.animationFrame = requestAnimationFrame(updateVelocity);
            }

            function onDragEnd() {
                if (!state.isDragging) return;
                state.isDragging = false;
                wrapper.classList.remove('grabbing');
                cancelAnimationFrame(state.animationFrame);

                const dragDistance = state.currentTranslate - state.startTranslate;
                const targetPage = state.currentPage;

                if (Math.abs(dragDistance) > THRESHOLD) {
                    // Move to next/prev page
                    const direction = dragDistance < 0 ? 1 : -1;
                    goToPage(state.currentPage + direction);
                } else {
                    // Snap back to current page
                    goToPage(state.currentPage);
                }
            }

            function init() {
                updateSliderConfig();
                applySlideWidths();
                createDots();
                goToPage(0, false); // Initialize position

                slides.forEach(slide => {
                    slide.addEventListener('click', (e) => {
                        if (hasDragged) {
                            e.preventDefault();
                        }
                    });
                });

                wrapper.addEventListener('mousedown', onDragStart);
                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('mouseup', onDragEnd);
                wrapper.addEventListener('mouseleave', onDragEnd);

                wrapper.addEventListener('touchstart', onDragStart, { passive: true });
                wrapper.addEventListener('touchmove', onDragMove, { passive: true });
                wrapper.addEventListener('touchend', onDragEnd);
                wrapper.addEventListener('touchcancel', onDragEnd);

                let lastWheelTime = 0;
                const wheelThrottle = 500; // 500ms delay between wheel scrolls

                wrapper.addEventListener('wheel', (event) => {
                    // Ignore wheel events that are more horizontal than vertical
                    if (Math.abs(event.deltaX) > Math.abs(event.deltaY)) {
                        return;
                    }

                    event.preventDefault();
                    const now = Date.now();
                    if (now - lastWheelTime < wheelThrottle) {
                        return;
                    }
                    lastWheelTime = now;

                    const direction = event.deltaY > 0 ? 1 : -1;
                    const newPage = state.currentPage + direction;

                    if (newPage >= 0 && newPage < state.totalPages) {
                        goToPage(newPage);
                    }
                }, { passive: false });
            }

            const resizeObserver = new ResizeObserver(() => {
                const oldTotalPages = state.totalPages;
                updateSliderConfig();
                applySlideWidths();
                if (state.totalPages !== oldTotalPages) {
                    createDots();
                }
                goToPage(state.currentPage, false);
            });
            resizeObserver.observe(container);

            init();
        }

        // --- [NEW] About Card Commit Fetching ---
        function formatTimeAgo(dateString) {
            const now = new Date();
            const commitDate = new Date(dateString);
            const diffSeconds = Math.round((now - commitDate) / 1000);
            const diffMinutes = Math.round(diffSeconds / 60);
            const diffHours = Math.round(diffMinutes / 60);

            if (diffHours < 1) {
                return "Êèê‰∫§‰∫é ÂàöÂàö";
            }
            if (diffHours < 24) {
                return `Êèê‰∫§‰∫é ${diffHours} Â∞èÊó∂Ââç`;
            }
            
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const commitDay = new Date(commitDate.getFullYear(), commitDate.getMonth(), commitDate.getDate());
            const dayDiff = (today - commitDay) / (1000 * 60 * 60 * 24);

            if (dayDiff === 1) {
                return "Êèê‰∫§‰∫é Êò®Â§©";
            }
            if (dayDiff < 7) {
                return `Êèê‰∫§‰∫é ${dayDiff} Â§©Ââç`;
            }
            
            return `Êèê‰∫§‰∫é ${commitDate.getFullYear()}-${String(commitDate.getMonth() + 1).padStart(2, '0')}-${String(commitDate.getDate()).padStart(2, '0')}`;
        }

        async function fetchAndRenderCommits(forceRefresh = false) {
            const container = document.getElementById('recent-commits-container');
            if (!container) return;

            if (areCommitsCached && !forceRefresh) {
                return; // Should be handled by toggleAboutCard, but acts as a safeguard.
            }

            const simplebarInstance = SimpleBar.instances.get(container);
            const contentEl = simplebarInstance ? simplebarInstance.getContentElement() : container;
            const refreshBtn = document.getElementById('refresh-commits-btn');
            const refreshIcon = refreshBtn ? refreshBtn.querySelector('i') : null;

            const executeFetch = async () => {
                try {
                    const response = await fetch(`https://cors.eu.org/https://api.github.com/repos/Qing90bing/Qing_Webcard/commits?per_page=30&v=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);
                    const allCommits = await response.json();

                    if (allCommits.length === 0) {
                        renderContent(`<div class="commit-loader-wrapper"><p style="color: var(--text-color-secondary);">Êú™ËÉΩÊâæÂà∞‰ªª‰ΩïÊèê‰∫§ËÆ∞ÂΩï„ÄÇ</p></div>`, false);
                        return;
                    }

                    const commitsToDisplay = allCommits.slice(0, 15);

                    const groupedByDate = new Map();
                    commitsToDisplay.forEach(commitData => {
                        const date = new Date(commitData.commit.author.date);
                        const dateStr = date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
                        
                        if (!groupedByDate.has(dateStr)) {
                            groupedByDate.set(dateStr, []);
                        }
                        groupedByDate.get(dateStr).push(commitData);
                    });

                    let commitsHTML = '';
                    for (const [date, dateCommits] of groupedByDate.entries()) {
                        commitsHTML += `
                            <div class="timeline-item">
                                <div class="timeline-node"></div>
                                <div class="timeline-content">
                                    <h4 class="text-base font-semibold" style="color: var(--text-color-primary);">
                                        <i class="far fa-calendar-alt mr-2"></i>${date}
                                    </h4>
                                    <div class="mt-2 space-y-2">
                        `;
                        
                        dateCommits.forEach(commitData => {
                            const message = commitData.commit.message.split('\n')[0];
                            const url = commitData.html_url;
                            const authorName = commitData.commit.author.name;
                            const avatarUrl = commitData.author?.avatar_url;
                            const timeAgo = formatTimeAgo(commitData.commit.author.date);
                            
                            let authorHTML = `
                                <span class="flex items-center">
                                    <i class="fas fa-user-edit fa-fw mr-2"></i>
                            `;

                            if (avatarUrl) {
                                authorHTML += `<img src="${avatarUrl}" class="tooltip-container w-4 h-4 rounded-full mr-2 commit-avatar" alt="${authorName}'s avatar" data-tooltip="${authorName}" onload="this.classList.add('loaded')">`;
                            }
                            
                            authorHTML += `<span>${authorName}</span>`;

                            authorHTML += `</span>`;

                            commitsHTML += `
                                <a href="${url}" target="_blank" class="block p-2 rounded-lg themed-hover-bg transition-colors duration-200">
                                    <p class="tooltip-container font-semibold commit-message-text" style="color: var(--text-color-primary);" data-tooltip="${message}">${message}</p>
                                    <div class="text-xs mt-1 flex justify-between items-center" style="color: var(--text-color-tertiary);">
                                        ${authorHTML}
                                        <span>${timeAgo}</span>
                                    </div>
                                </a>
                            `;
                        });

                        commitsHTML += `
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    if (allCommits.length === 30) {
                        commitsHTML += `
                            <div class="timeline-item">
                                <div class="timeline-node"></div>
                                <div class="timeline-content">
                                    <a href="https://github.com/Qing90bing/Qing_Webcard/commits" target="_blank" class="inline-flex items-center text-sm font-semibold p-2 rounded-lg themed-hover-bg transition-colors duration-200" style="color: var(--accent-color);">
                                        ÂâçÂæÄ Github Êü•ÁúãÊõ¥Â§ö
                                        <i class="fas fa-external-link-alt ml-2 fa-xs"></i>
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                    
                    renderContent(`<div class="timeline-wrapper">${commitsHTML}</div>`, true);

                } catch (error) {
                    console.error("Failed to fetch commits:", error);
                    renderContent(`<div class="commit-loader-wrapper"><p style="color: var(--status-past);">Âä†ËΩΩÊèê‰∫§ËÆ∞ÂΩïÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ</p></div>`, false);
                }
            };

            const renderContent = (html, isSuccess) => {
                if (isSuccess) {
                    cachedCommitsHTML = html;
                    areCommitsCached = true;
                }
                container.style.opacity = '0';
                setTimeout(() => {
                    contentEl.innerHTML = html;
                    container.style.opacity = '1';
                    simplebarInstance?.recalculate();
                    // --- Restore button state ---
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.classList.remove('is-refreshing');
                    }
                    refreshIcon?.classList.remove('fa-spin');
                    // Update mask after content is rendered
                    setTimeout(updateCommitMask, 50);
                }, 300);
            };

            const showLoaderAndFetch = () => {
                contentEl.innerHTML = `
                    <div class="commit-loader-wrapper">
                        <div class="commit-spinner"></div>
                        <p style="color: var(--text-color-secondary);">Ê≠£Âú®Âä†ËΩΩÊèê‰∫§ËÆ∞ÂΩï...</p>
                    </div>
                `;
                container.style.opacity = '1';
                executeFetch();
            };

            // --- Manage Button and Loading State ---
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.classList.add('is-refreshing');
            }
            refreshIcon?.classList.add('fa-spin');

            if (forceRefresh) {
                container.style.opacity = '0';
                setTimeout(showLoaderAndFetch, 300);
            } else {
                showLoaderAndFetch();
            }
        }

        function updateCommitMask() {
            const container = document.getElementById('recent-commits-container');
            if (!container) return;

            const simplebarInstance = SimpleBar.instances.get(container);
            if (!simplebarInstance) return;

            const scrollElement = simplebarInstance.getScrollElement();
            const { scrollTop, scrollHeight, clientHeight } = scrollElement;
            const maxFadeSize = 24; // Desired fade height in px

            // If content is not scrollable, set fades to 0 and exit.
            if (scrollHeight <= clientHeight) {
                container.style.setProperty('--fade-top-size', '0px');
                container.style.setProperty('--fade-bottom-size', '0px');
                return;
            }

            const scrollBottom = scrollHeight - clientHeight - scrollTop;
            
            const topFade = Math.min(scrollTop, maxFadeSize);
            const bottomFade = Math.min(scrollBottom, maxFadeSize);

            container.style.setProperty('--fade-top-size', `${topFade}px`);
            container.style.setProperty('--fade-bottom-size', `${bottomFade}px`);
        }

        // --- ‰∫§‰∫í‰∫ã‰ª∂ÁõëÂê¨ ---
        function setupEventListeners() {
            // --- Theme Settings Listeners ---
            document.querySelectorAll('.setting-btn-group .setting-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    appSettings.theme = theme;
                    applyCurrentTheme();
                    saveSettings();
                    updateThemeSettingsUI(); // Update active state
                });
            });

            // --- Background Settings Listeners ---
            const bgRadioButtons = document.querySelectorAll('input[name="background-source"]');
            const defaultOptionsContainer = document.getElementById('default-bg-options');

            const customBgInputWrapper = document.getElementById('custom-bg-input-wrapper');

            bgRadioButtons.forEach(radio => {
                radio.addEventListener('change', () => {
                    const source = radio.value;
                    appSettings.background.source = source;

                    if (source === 'default') {
                        defaultOptionsContainer.classList.add('open');
                    } else {
                        defaultOptionsContainer.classList.remove('open');
                    }

                    if (source === 'custom') {
                        customBgInputWrapper.style.maxHeight = '80px';
                        customBgInputWrapper.classList.add('mt-2');
                    } else {
                        customBgInputWrapper.style.maxHeight = '0';
                        customBgInputWrapper.classList.remove('mt-2');
                    }

                    // When a source is selected, apply the background.
                    // The applyCurrentBackground function will handle logic for new/empty custom URLs.
                    applyCurrentBackground();
                    
                    saveSettings();
                });
            });

            const thumbItems = defaultOptionsContainer.querySelectorAll('.thumb-item');
            thumbItems.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    // This listener only matters when the 'default' source is active
                    if (appSettings.background.source !== 'default') {
                        // To be safe, check the 'default' radio
                        document.getElementById('bg-radio-default').checked = true;
                        appSettings.background.source = 'default';
                    }
                    
                    const specifier = thumb.dataset.bgUrl;
                    appSettings.background.specifier = specifier;
                    
                    // Update UI immediately for responsiveness
                    thumbItems.forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                    
                    applyCurrentBackground();
                    saveSettings();
                });
            });

            // --- [NEW] Preview Buttons Listeners ---
            const refreshBtn = document.getElementById('bg-preview-refresh-btn');
            const downloadBtn = document.getElementById('bg-preview-download-btn');

            if (refreshBtn) {
                refreshBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    if (icon && !icon.classList.contains('fa-spin')) {
                        icon.classList.add('fa-spin');
                        applyCurrentBackground();
                    }
                });
            }

            if (downloadBtn) {
                downloadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    downloadImage();
                });
            }

            const previewErrorContainer = document.getElementById('bg-preview-error');
            if (previewErrorContainer) {
                previewErrorContainer.addEventListener('click', () => {
                    hidePreviewError();
                    setTimeout(() => {
                        // We call this again to retry loading a background.
                        applyCurrentBackground();
                    }, 300); // Wait for the fade-out transition to complete before retrying.
                });
            }


            // --- Time Format Listeners ---
            document.querySelectorAll('input[name="time-format"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    appSettings.timeFormat = radio.value;
                    saveSettings();
                    updateTime(); // Immediately update the main clock
                    // If weather view is active, re-render it to update sunrise/sunset
                    if (appSettings.view === 'weather') {
                        applyCurrentView();
                    }
                });
            });

            // --- [NEW] Immersive Blink Toggle Listener ---
            const immersiveBlinkToggle = document.getElementById('immersive-blink-toggle');
            if (immersiveBlinkToggle) {
                immersiveBlinkToggle.addEventListener('change', () => {
                    appSettings.immersiveBlinkingColon = immersiveBlinkToggle.checked;
                    saveSettings();
                    applyBlinkingEffect();
                });
            }

            // --- [NEW] Appearance Settings Listener ---
            const glassEffectToggle = document.getElementById('glass-effect-toggle');
            if (glassEffectToggle) {
                glassEffectToggle.addEventListener('change', () => {
                    appSettings.appearance.glassEffect = glassEffectToggle.checked;
                    saveSettings();
                    applyGlassEffect();
                });
            }

            const radiusSlider = document.getElementById('card-border-radius-slider');
            const radiusValue = document.getElementById('card-border-radius-value');
            if (radiusSlider && radiusValue) {
                radiusSlider.addEventListener('input', (e) => {
                    const newValue = e.target.value;
                    radiusValue.textContent = `${newValue}px`;
                    appSettings.appearance.cardBorderRadius = parseInt(newValue, 10);
                    applyCardSettings();
                    updateSliderProgress(e.target);
                });
                radiusSlider.addEventListener('change', () => {
                    saveSettings(); // Save only when the user releases the mouse
                });
            }

            const blurSlider = document.getElementById('card-blur-amount-slider');
            const blurValue = document.getElementById('card-blur-amount-value');
            if (blurSlider && blurValue) {
                blurSlider.addEventListener('input', (e) => {
                    const newValue = e.target.value;
                    blurValue.textContent = `${newValue}px`;
                    appSettings.appearance.cardBlurAmount = parseInt(newValue, 10);
                    applyCardSettings();
                    updateSliderProgress(e.target);
                });
                blurSlider.addEventListener('change', () => {
                    saveSettings(); // Save only when the user releases the mouse
                });
            }

            // --- View Toggle Listeners ---
            const cityInput = document.getElementById('weather-city-input');
            const saveCityBtn = document.getElementById('save-city-btn');
            const confirmCityIcon = document.getElementById('confirm-city-icon');
            const cityInputError = document.getElementById('city-input-error');

            const saveCity = () => {
                const newCity = cityInput.value.trim();

                // Validation for length
                if (newCity.length > 20) {
                    cityInput.classList.add('invalid');
                    cityInputError.textContent = 'ÂÜÖÂÆπËøáÈïø (ÊúÄÂ§ö20‰∏™Â≠óÁ¨¶)';
                    cityInputError.classList.add('visible');
                    cityInputError.classList.remove('hidden');
                    return;
                }

                // Clear previous errors
                cityInput.classList.remove('invalid');
                cityInputError.classList.remove('visible');
                // Use a timeout to hide it after the transition
                setTimeout(() => { cityInputError.classList.add('hidden'); }, 200);

                // Save logic
                appSettings.weather.city = newCity;
                applyCurrentView();
                saveSettings();
                cityInput.blur();

                // Feedback animation
                saveCityBtn.style.opacity = '0';
                confirmCityIcon.classList.remove('hidden');
                setTimeout(() => { 
                    confirmCityIcon.style.opacity = '1';
                    confirmCityIcon.style.transform = 'scale(1)';
                }, 10);

                setTimeout(() => {
                    confirmCityIcon.style.opacity = '0';
                    confirmCityIcon.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        confirmCityIcon.classList.add('hidden');
                        saveCityBtn.style.opacity = '1';
                    }, 200);
                }, 2000); 
            };

            document.querySelectorAll('input[name="view-source"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const value = radio.value;
                    if (value === 'github') {
                        appSettings.view = 'github';
                    } else {
                        appSettings.view = 'weather';
                        if (value === 'weather-auto') {
                            appSettings.weather.source = 'auto';
                            appSettings.weather.city = null; 
                        } else { // weather-manual
                            appSettings.weather.source = 'manual';
                        }
                    }
                    
                    applyCurrentView();
                    updateViewToggleUI();
                    saveSettings();
                });
            });

            cityInput.addEventListener('focus', () => {
                cityInput.classList.remove('invalid');
                cityInputError.classList.remove('visible');
                setTimeout(() => { cityInputError.classList.add('hidden'); }, 200);
            });

            cityInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveCity();
                }
            });

            saveCityBtn.addEventListener('click', saveCity);


            // --- Settings Modal Logic ---
            const openSettingsBtn = document.getElementById('open-settings-btn');
            const settingsOverlay = document.getElementById('settings-overlay');
            const closeSettingsBtn = document.getElementById('close-settings-btn');

            function openSettings() {
                updateSettingsUI(); // Refresh UI to match saved settings
                const settingsWindow = document.getElementById('settings-window');
                
                // [FIX] Temporarily disable transitions on overlays to prevent animation on panel open
                const overlay1 = document.getElementById('background-settings-overlay');
                const overlay2 = document.getElementById('blur-slider-overlay');

                if (overlay1) overlay1.style.transition = 'none';
                if (overlay2) overlay2.style.transition = 'none';

                document.body.classList.add('settings-open');
                
                // Restore transitions after the panel has appeared.
                setTimeout(() => {
                    if (overlay1) overlay1.style.transition = '';
                    if (overlay2) overlay2.style.transition = '';
                }, 300);


                // Initialize SimpleBar on the content area if it hasn't been already
                if (!settingsSimpleBar) {
                    const contentWrapper = settingsWindow.querySelector('[data-simplebar]');
                    if (contentWrapper) {
                        settingsSimpleBar = new SimpleBar(contentWrapper);
                        const scrollElement = settingsSimpleBar.getScrollElement();
                        const maskContainer = contentWrapper; // The element with the mask is the one with data-simplebar
                        const maxFadeSize = 24; // Corresponds to the CSS variable

                        const updateSettingsMask = () => {
                            const { scrollTop, scrollHeight, clientHeight } = scrollElement;
                            const tolerance = 1;
                            // If content is not scrollable, remove fades
                            if (scrollHeight <= clientHeight + tolerance) {
                                maskContainer.style.setProperty('--fade-top-size', '0px');
                                maskContainer.style.setProperty('--fade-bottom-size', '0px');
                                return;
                            }
                            const scrollBottom = scrollHeight - clientHeight - scrollTop;
                            const topFade = Math.min(scrollTop, maxFadeSize);
                            const bottomFade = Math.min(scrollBottom, maxFadeSize);
                            maskContainer.style.setProperty('--fade-top-size', `${topFade}px`);
                            maskContainer.style.setProperty('--fade-bottom-size', `${bottomFade}px`);
                        };

                        scrollElement.addEventListener('scroll', updateSettingsMask);
                        // Call once to set initial state, delayed to allow rendering
                        setTimeout(updateSettingsMask, 50);
                    }
                }
            }

            function closeSettings() {
                document.body.classList.remove('settings-open');
                // The line that removed the 'visible' class from the preview container
                // has been removed to prevent the re-animation issue.
            }

            openSettingsBtn.addEventListener('click', openSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);
            // settingsOverlay.addEventListener('click', (e) => {
            //     if (e.target === settingsOverlay) closeSettings();
            // });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Priority 0: Close immersive view
                    if (document.body.classList.contains('immersive-active')) {
                        document.getElementById('exit-immersive-btn').click();
                        return;
                    }
                    
                    // Priority 1: Close developer settings modal if it's open
                    if (document.body.classList.contains('developer-settings-open')) {
                        closeDeveloperSettings();
                        return;
                    }

                    // Priority 2: Close settings modal if it's open
                    if (document.body.classList.contains('settings-open')) {
                        closeSettings();
                        return;
                    }

                    // [USER FEEDBACK] Priority 3: Close "About" card if it's open
                    if (!aboutCard.classList.contains('hidden')) {
                        toggleAboutCard();
                        return;
                    }

                    // Priority 4: Close holiday list card if it's open
                    if (!holidayListCard.classList.contains('hidden')) {
                        holidayListCard.classList.add('hidden');
                        rightColumn.classList.remove('hidden');
                        animateRightColumnIn();
                        return;
                    }

                    // Priority 5: Close time capsule card if it's open
                    if (!timeCapsuleCard.classList.contains('hidden')) {
                        timeCapsuleCard.classList.add('hidden');
                        rightColumn.classList.remove('hidden');
                        animateRightColumnIn();
                        return;
                    }
                }
            });

            // --- [NEW] Developer Mode Logic ---
            let logoClickCount = 0;
            let logoClickTimer = null;

            const aboutCardLogo = document.getElementById('about-card-logo');
            const developerIconContainer = document.getElementById('developer-icon-container');
            const developerIcon = document.getElementById('developer-icon');
            const developerSettingsOverlay = document.getElementById('developer-settings-overlay');
            const closeDeveloperSettingsBtn = document.getElementById('close-developer-settings-btn');

            const openDeveloperSettings = () => {
                updateDeveloperSettingsUI(); // Update the UI from the latest settings state
                document.body.classList.add('developer-settings-open');
            };
            const closeDeveloperSettings = () => document.body.classList.remove('developer-settings-open');

            if (aboutCardLogo) {
                aboutCardLogo.addEventListener('click', () => {
                    // Re-trigger animation for a satisfying click feel
                    aboutCardLogo.classList.remove('logo-click-bounce-anim');
                    void aboutCardLogo.offsetWidth; // Force reflow to restart animation
                    aboutCardLogo.classList.add('logo-click-bounce-anim');

                    // [FIX] Check the master switch to see if the feature is enabled at all
                    if (!appSettings.developer.masterSwitchEnabled) return;

                    clearTimeout(logoClickTimer);
                    logoClickCount++;

                    if (logoClickCount >= 5) {
                        if (!developerIconContainer.classList.contains('visible')) {
                            developerIconContainer.classList.add('visible');
                            // [NEW] Save unlock state
                            try {
                                localStorage.setItem('developerModeUnlocked', 'true');
                            } catch (e) {
                                console.error("Failed to save to localStorage", e);
                            }
                        }
                        // [FIX] When re-unlocking, always reset the toggle's state to ON.
                        appSettings.developer.uiToggleState = true;
                        saveSettings();

                        logoClickCount = 0;
                        clearTimeout(logoClickTimer); // Stop timer once icon is shown
                    } else {
                        logoClickTimer = setTimeout(() => {
                            logoClickCount = 0;
                        }, 1500); // 1.5-second window for consecutive clicks
                    }
                });
            }

            if (developerIcon) developerIcon.addEventListener('click', openDeveloperSettings);
            if (closeDeveloperSettingsBtn) closeDeveloperSettingsBtn.addEventListener('click', closeDeveloperSettings);

            // [FIX] Remove the click animation class after it finishes to prevent re-playing on show/hide
            if (aboutCardLogo) {
                aboutCardLogo.addEventListener('animationend', () => {
                    aboutCardLogo.classList.remove('logo-click-bounce-anim');
                });
            }
            // --- End Settings Modal Logic ---

            const animateRightColumnIn = () => {
                const elementsToAnimate = rightColumn.querySelectorAll(':scope > div');
                elementsToAnimate.forEach(el => {
                    el.classList.remove('bounce-in');
                    void el.offsetWidth;
                    el.classList.add('bounce-in');
                });
            };

            // ÂàáÊç¢Âà∞Êó∂ÂÖâËÉ∂Âõä
            profileCard.addEventListener('click', (e) => { // 1. Êé•Êî∂ event ÂØπË±°ÔºåÂëΩÂêç‰∏∫ e
                // 2. Â¢ûÂä†Âà§Êñ≠ÔºöÂ¶ÇÊûúÁÇπÂáªÁöÑÁõÆÊ†áÊòØ <a> Ê†áÁ≠æÊàñÂÖ∂ÂÜÖÈÉ®ÂÖÉÁ¥†ÔºåÂàôÁõ¥Êé•ËøîÂõû
                if (e.target.closest('a')) {
                    return;
                }

                // If the time capsule is already visible, hide it and show the main column.
                if (!timeCapsuleCard.classList.contains('hidden')) {
                    timeCapsuleCard.classList.add('hidden');
                    rightColumn.classList.remove('hidden');
                    animateRightColumnIn();
                } else { // Otherwise, show it.
                    rightColumn.classList.add('hidden');
                    holidayListCard.classList.add('hidden'); // Hide other cards
                    aboutCard.classList.add('hidden'); // Hide other cards
                    timeCapsuleCard.classList.remove('hidden');
                    timeCapsuleCard.classList.add('bounce-in');
                    updateTimeCapsule();
                }
            });

            // ÂÖ≥Èó≠Êó∂ÂÖâËÉ∂Âõä
            document.getElementById('close-time-capsule').addEventListener('click', (e) => {
                e.stopPropagation();
                timeCapsuleCard.classList.add('hidden');
                rightColumn.classList.remove('hidden');
                animateRightColumnIn();
            });

            // --- [NEW] About Card Listeners ---
            const aboutCardTrigger = document.getElementById('about-card-trigger');
            const closeAboutCardBtn = document.getElementById('close-about-card');
            const refreshCommitsBtn = document.getElementById('refresh-commits-btn');

            const toggleAboutCard = () => {
                if (!aboutCard.classList.contains('hidden')) {
                    aboutCard.classList.add('hidden');
                    rightColumn.classList.remove('hidden');
                    animateRightColumnIn();
                } else {
                    rightColumn.classList.add('hidden');
                    timeCapsuleCard.classList.add('hidden');
                    holidayListCard.classList.add('hidden');
                    aboutCard.classList.remove('hidden');
                    
                    if (!aboutCardHasAnimated) {
                        aboutCard.classList.add('bounce-in');
                        aboutCardHasAnimated = true;
                    }

                    const commitsContainer = document.getElementById('recent-commits-container');
                    if (commitsContainer && !SimpleBar.instances.get(commitsContainer)) {
                        const simplebarInstance = new SimpleBar(commitsContainer);
                        simplebarInstance.getScrollElement().addEventListener('scroll', updateCommitMask);
                    }
                    
                    if (areCommitsCached) {
                        const simplebarInstance = SimpleBar.instances.get(commitsContainer);
                        const contentEl = simplebarInstance ? simplebarInstance.getContentElement() : commitsContainer;
                        contentEl.innerHTML = cachedCommitsHTML;
                        simplebarInstance?.recalculate();
                    } else {
                        fetchAndRenderCommits();
                    }
                }
            };

            if (aboutCardTrigger) {
                aboutCardTrigger.addEventListener('click', toggleAboutCard);
            }

            if (refreshCommitsBtn) {
                refreshCommitsBtn.addEventListener('click', () => {
                    fetchAndRenderCommits(true); // Force refresh
                });
            }

            if (closeAboutCardBtn) {
                closeAboutCardBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleAboutCard();
                });
            }

            // ÂàáÊç¢Âà∞ËäÇÊó•ÂàóË°®
            countdownCard.addEventListener('click', () => {
                if (!holidayListCard.classList.contains('hidden')) {
                    holidayListCard.classList.add('hidden');
                    rightColumn.classList.remove('hidden');
                    animateRightColumnIn();
                } else {
                    hasManuallyScrolled = false; // Reset scroll flag
                    rightColumn.classList.add('hidden');
                    timeCapsuleCard.classList.add('hidden'); // Hide other cards
                    aboutCard.classList.add('hidden'); // Hide other cards
                    holidayListCard.classList.remove('hidden');
                    holidayListCard.classList.add('bounce-in');
                    holidayListDisplayedYear = new Date().getFullYear();
                    displayHolidayList(holidayListDisplayedYear, true);
                    updateWarningMessage(holidayListDisplayedYear);
                    
                    // Only initialize SimpleBar and listeners once to prevent bugs
                    if (!holidayListSimpleBar) {
                        holidayListSimpleBar = new SimpleBar(document.getElementById('holiday-list-container-wrapper'));
                        const scrollElement = holidayListSimpleBar.getScrollElement();
                        const maskContainer = document.getElementById('holiday-list-container-wrapper');
                        const maxFadeSize = 40;

                        const updateMask = () => {
                            const { scrollTop, scrollHeight, clientHeight } = scrollElement;
                            const tolerance = 1;
                            if (scrollHeight <= clientHeight + tolerance) {
                                maskContainer.style.setProperty('--fade-top-size', '0px');
                                maskContainer.style.setProperty('--fade-bottom-size', '0px');
                                return;
                            }
                            const scrollBottom = scrollHeight - clientHeight - scrollTop;
                            const topFade = Math.min(scrollTop, maxFadeSize);
                            const bottomFade = Math.min(scrollBottom, maxFadeSize);
                            maskContainer.style.setProperty('--fade-top-size', `${topFade}px`);
                            maskContainer.style.setProperty('--fade-bottom-size', `${bottomFade}px`);
                        };

                        scrollElement.addEventListener('scroll', updateMask);
                        
                        // Also handle the original manual scroll flag listener
                        scrollElement.addEventListener('scroll', () => {
                            hasManuallyScrolled = true;
                        }, { once: true });

                        // Call once after a short delay to ensure layout is calculated correctly
                        setTimeout(updateMask, 50);
                    }

                    // Initial scroll is now animated
                    setTimeout(() => {
                        scrollToTargetFestival(true);
                    }, 50);
                }
            });

            // ÂÖ≥Èó≠ËäÇÊó•ÂàóË°®
            document.getElementById('close-holiday-list').addEventListener('click', (e) => {
                e.stopPropagation();
                holidayListCard.classList.add('hidden');
                rightColumn.classList.remove('hidden');
                animateRightColumnIn();
            });

            // "ÂõûÂà∞‰ªäÂ§©"ÊåâÈíÆÈÄªËæë
            document.getElementById('back-to-today-btn').addEventListener('click', () => {
                const currentYear = new Date().getFullYear();
                if (holidayListDisplayedYear !== currentYear) {
                    handleYearChange(currentYear);
                }
                scrollToTargetFestival(true);
            });

            // [NEW] Warning message logic
            const updateWarningMessage = (year) => {
                const yearWarning = document.getElementById('year-range-warning');
                if (year < 1900 || year > 2049) {
                    yearWarning.innerHTML = `<svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span>${year}Âπ¥ÁöÑÂÜúÂéÜËäÇÊó•ÂèØËÉΩ‰∏çÂáÜÁ°Æ</span>`;
                    if (yearWarning.classList.contains('hidden')) {
                        yearWarning.classList.remove('hidden', 'animate-fade-out');
                        yearWarning.classList.add('animate-fade-in');
                        setTimeout(() => yearWarning.classList.remove('animate-fade-in'), 100);
                    }
                } else {
                    if (!yearWarning.classList.contains('hidden')) {
                        yearWarning.classList.add('animate-fade-out');
                        setTimeout(() => {
                            yearWarning.classList.add('hidden');
                            yearWarning.classList.remove('animate-fade-out');
                        }, 100);
                    }
                }
            };

            // ËäÇÊó•ÂàóË°®Âπ¥‰ªΩÂàáÊç¢
            const handleYearChange = (newYear) => {
                const yearBeforeChange = holidayListDisplayedYear;
                const currentSystemYear = new Date().getFullYear();
                
                holidayListDisplayedYear = newYear;
                displayHolidayList(holidayListDisplayedYear, true);
                updateWarningMessage(newYear); // Centralized call to handle warning

                // Check for smart scroll condition
                if (hasManuallyScrolled && holidayListDisplayedYear === currentSystemYear && yearBeforeChange !== currentSystemYear) {
                    scrollToTargetFestival(true);
                    hasManuallyScrolled = false; // Reset flag after use
                }
            };

            document.getElementById('prev-year').addEventListener('click', () => {
                handleYearChange(holidayListDisplayedYear - 1);
            });
            document.getElementById('next-year').addEventListener('click', () => {
                handleYearChange(holidayListDisplayedYear + 1);
            });

            // --- [NEW] Year Input Logic ---
            const enterEditMode = () => {
                yearDisplayControls.classList.add('animate-fade-out');
                setTimeout(() => {
                    yearDisplayControls.classList.add('hidden');
                    yearDisplayControls.classList.remove('animate-fade-out');

                    yearEditControls.classList.remove('hidden');
                    yearEditControls.classList.add('animate-fade-in');
                    yearInput.value = holidayListDisplayedYear;
                    yearInput.focus();
                    yearInput.select();

                    setTimeout(() => {
                        yearEditControls.classList.remove('animate-fade-in');
                    }, 100);
                }, 100);
            };

            const exitEditMode = () => {
                yearInput.classList.remove('invalid');
                yearInputError.classList.add('hidden');

                yearEditControls.classList.add('animate-fade-out');
                setTimeout(() => {
                    yearEditControls.classList.add('hidden');
                    yearEditControls.classList.remove('animate-fade-out');

                    yearDisplayControls.classList.remove('hidden');
                    yearDisplayControls.classList.add('animate-fade-in');
                    setTimeout(() => {
                        yearDisplayControls.classList.remove('animate-fade-in');
                    }, 100);
                }, 100);
            };

            const submitNewYear = () => {
                const newYear = parseInt(yearInput.value, 10);
                // Relaxed validation as per user request.
                if (!isNaN(newYear) && newYear > 0 && newYear < 9999) {
                    handleYearChange(newYear);
                    exitEditMode();
                } else {
                    yearInputError.textContent = 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ4‰ΩçÂπ¥‰ªΩ';
                    yearInputError.classList.remove('hidden');
                    yearInput.classList.add('invalid');
                    setTimeout(() => {
                        yearInput.classList.remove('invalid');
                    }, 500);
                    setTimeout(() => {
                         yearInputError.classList.add('hidden');
                    }, 2500);
                }
            };

            holidayListYearSpan.addEventListener('click', enterEditMode);
            confirmYearBtn.addEventListener('click', submitNewYear);
            cancelYearBtn.addEventListener('click', exitEditMode);
            yearInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { submitNewYear(); }
                else if (e.key === 'Escape') { exitEditMode(); }
            });

            // ÁÇπÂáª‰∏ÄË®ÄÂç°ÁâáÂà∑Êñ∞
            document.getElementById('hitokoto-card').addEventListener('click', fetchHitokoto);
            
            // Â§©Ê∞îÂà∑Êñ∞ÊåâÈíÆ
            document.getElementById('weather-refresh-btn').addEventListener('click', () => {
                setWeatherSpinner(true);
                fetchAndDisplayWeather();
            });

            // --- [NEW] Custom Background Input Listeners ---
            const customBgInput = document.getElementById('custom-bg-input');
            const saveCustomBgBtn = document.getElementById('save-custom-bg-btn');
            const clearCustomBgBtn = document.getElementById('clear-custom-bg-btn');
            const customBgError = document.getElementById('custom-bg-input-error');
            const btnGroup = document.getElementById('custom-bg-btn-group');
            const confirmIcon = document.getElementById('confirm-custom-bg-icon');

            const saveCustomBg = () => {
                if (saveCustomBgBtn.disabled) return; // Prevent spam-clicking

                const url = customBgInput.value.trim();
                const originalPlaceholder = "ËæìÂÖ•ÂõæÁâáÊàñAPIÈìæÊé•";
                
                if (!url || !url.startsWith('http')) {
                    customBgInput.classList.add('invalid');
                    customBgInput.value = ''; // Clear input to show placeholder
                    customBgInput.placeholder = 'Êó†ÊïàÈìæÊé•ÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•';
                    
                    // Restore after a delay
                    setTimeout(() => {
                        customBgInput.classList.remove('invalid');
                        customBgInput.placeholder = originalPlaceholder;
                    }, 2500);
                    return;
                }

                appSettings.background.customUrl = url;
                appSettings.background.source = 'custom';
                
                const isImage = /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(url);
                appSettings.background.customType = isImage ? 'image' : 'api';

                saveSettings();
                applyCurrentBackground();

                // --- New Save Button Animation ---
                saveCustomBgBtn.disabled = true;
                const saveIcon = saveCustomBgBtn.querySelector('.fa-save');
                const checkIcon = saveCustomBgBtn.querySelector('.fa-check');

                if (saveIcon && checkIcon) {
                    saveIcon.style.opacity = '0';
                    checkIcon.style.opacity = '1';

                    setTimeout(() => {
                        saveIcon.style.opacity = '1';
                        checkIcon.style.opacity = '0';
                        saveCustomBgBtn.disabled = false;
                    }, 2000);
                }
            };
            
            customBgInput.addEventListener('focus', () => {
                if (customBgInput.classList.contains('invalid')) {
                    customBgInput.classList.remove('invalid');
                    customBgInput.placeholder = "ËæìÂÖ•ÂõæÁâáÊàñAPIÈìæÊé•";
                }
            });

            saveCustomBgBtn.addEventListener('click', saveCustomBg);
            customBgInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveCustomBg();
                }
            });

            clearCustomBgBtn.addEventListener('click', () => {
                customBgInput.value = '';
                appSettings.background.customUrl = null;
                appSettings.background.customType = 'unknown';
                saveSettings();
                customBgInput.focus();
            });

            // --- [NEW] Hitokoto Settings Listeners ---
            const hitokotoModeRadios = document.querySelectorAll('input[name="hitokoto-mode"]');
            const customOptionsContainer = document.getElementById('hitokoto-custom-options');
            const categoryCheckboxes = document.querySelectorAll('input[name="hitokoto-category"]');
            const selectAllCheckbox = document.getElementById('hitokoto-select-all');
            const saveBtn = document.getElementById('hitokoto-save-btn');

            hitokotoModeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const newMode = radio.value;
                    appSettings.hitokoto.mode = newMode;
                    if (newMode === 'default') {
                        customOptionsContainer.classList.remove('open');
                        saveSettings();
                        fetchHitokoto(); // Immediately fetch on switching to default
                    } else {
                        customOptionsContainer.classList.add('open');
                        // If entering custom mode and no categories are checked (e.g. first time), check the first one.
                        const checkedCount = document.querySelectorAll('input[name="hitokoto-category"]:checked').length;
                        if (checkedCount === 0) {
                            const firstCategoryCheckbox = document.getElementById('hitokoto-cat-a');
                            if (firstCategoryCheckbox) {
                                firstCategoryCheckbox.checked = true;
                            }
                        }
                    }
                });
            });

            selectAllCheckbox.addEventListener('change', () => {
                categoryCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
            });

            categoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checkedCount = document.querySelectorAll('input[name="hitokoto-category"]:checked').length;
                    
                    // Prevent unchecking the last box
                    if (checkedCount === 0) {
                        checkbox.checked = true;
                    }

                    // Update "Select All" checkbox state
                    selectAllCheckbox.checked = checkedCount === categoryCheckboxes.length;
                });
            });

            saveBtn.addEventListener('click', () => {
                const selectedCategories = Array.from(document.querySelectorAll('input[name="hitokoto-category"]:checked')).map(cb => cb.value);
                
                if (selectedCategories.length === 0) {
                    const validationMsg = document.getElementById('hitokoto-validation-msg');
                    // Add the class to trigger the animation
                    validationMsg.classList.add('visible');
                    // Remove the class after the animation is done to allow it to be re-triggered
                    setTimeout(() => {
                        validationMsg.classList.remove('visible');
                    }, 3000);
                    return;
                }

                appSettings.hitokoto.categories = selectedCategories;
                saveSettings();
                fetchHitokoto();

                // --- [FIX] Refined Save button animation & spam prevention ---
                const saveIcon = saveBtn.querySelector('i');
                const confirmIcon = document.getElementById('hitokoto-confirm-icon');
                
                saveBtn.disabled = true; // Disable button
                saveIcon.style.opacity = '0';
                
                setTimeout(() => {
                    confirmIcon.style.opacity = '1';

                    setTimeout(() => {
                        confirmIcon.style.opacity = '0';
                        setTimeout(() => {
                            saveIcon.style.opacity = '1';
                            saveBtn.disabled = false; // Re-enable button
                        }, 300);
                    }, 3000);
                }, 300);
            });

            // --- [NEW] Immersive Time Listeners ---
            const immersiveView = document.getElementById('immersive-time-view');
            const timeCard = document.getElementById('time-card');
            const exitImmersiveBtn = document.getElementById('exit-immersive-btn');

            const handleImmersiveMouseMove = (event) => {
                const { clientX, clientY } = event;
                const { innerWidth, innerHeight } = window;
                if (clientX > innerWidth / 2 && clientY < innerHeight / 2) {
                    exitImmersiveBtn.classList.add('visible');
                } else {
                    exitImmersiveBtn.classList.remove('visible');
                }
            };

            const handleImmersiveMouseLeave = () => {
                exitImmersiveBtn.classList.remove('visible');
            };

            timeCard.addEventListener('click', (event) => {
                // Do not trigger if a sub-element that is a link was clicked
                if (event.target.closest('a')) {
                    return;
                }
                document.body.classList.add('immersive-active');
                updateImmersiveTime(); // Initial population
                if (immersiveTimeInterval) clearInterval(immersiveTimeInterval);
                immersiveTimeInterval = setInterval(updateImmersiveTime, 1000);

                // Add mouse listeners for the exit button
                immersiveView.addEventListener('mousemove', handleImmersiveMouseMove);
                immersiveView.addEventListener('mouseleave', handleImmersiveMouseLeave);
            });

            exitImmersiveBtn.addEventListener('click', () => {
                document.body.classList.remove('immersive-active');
                if (immersiveTimeInterval) {
                    clearInterval(immersiveTimeInterval);
                    immersiveTimeInterval = null;
                }
                
                // Clean up button visibility and remove listeners
                exitImmersiveBtn.classList.remove('visible');
                immersiveView.removeEventListener('mousemove', handleImmersiveMouseMove);
                immersiveView.removeEventListener('mouseleave', handleImmersiveMouseLeave);
            });

            // --- [NEW] Hidden Reset Feature ---
            const luckTitleIcon = document.querySelector('#time-capsule-card h2 svg');
            if (luckTitleIcon) {
                luckTitleIcon.addEventListener('click', () => {
                    resetClickCount++;
                    clearTimeout(resetClickTimer);
                    resetClickTimer = setTimeout(() => {
                        resetClickCount = 0;
                    }, 3000);

                    if (resetClickCount === 5) {
                        resetClickCount = 0;
                        clearTimeout(resetClickTimer);
                        localStorage.removeItem('dailyLuckData');
                        
                        const luckResult = document.getElementById('luck-result');
                        if (luckResult) {
                            // Reset all JS state immediately
                            luckGameState = 'initial';
                            dailyLuckData = null;
                            hasPlayedGameToday = false;
                            luckClickCount = 0;
                            clearTimeout(luckResetTimer);
                            clearTimeout(countdownAnimationHandle);

                            // Start the collapse animation
                            luckResult.classList.remove('visible');

                            // After the animation finishes, clean up the DOM properties
                            setTimeout(() => {
                                // Only clean up if another game hasn't started in the meantime
                                if(luckGameState === 'initial') {
                                    luckResult.classList.remove('flex', 'flex-col', 'justify-center', 'flex-1', 'min-w-0', 'relative');
                                    luckResult.innerHTML = '';
                                }
                            }, 500);
                        }
                    }
                });
            }

            // --- [REVISED] Developer Options Toggle Listener ---
            const devOptionsToggle = document.getElementById('dev-options-toggle');
            if (devOptionsToggle) {
                devOptionsToggle.addEventListener('change', () => {
                    const isEnabled = devOptionsToggle.checked;
                    appSettings.developer.uiToggleState = isEnabled;
                    const developerIconContainer = document.getElementById('developer-icon-container');

                    if (isEnabled) {
                        // When turned ON, just ensure the icon is marked as visible for the next time the 'About' panel is opened.
                        // This fixes the bug where the icon would disappear.
                        if (developerIconContainer) {
                            developerIconContainer.classList.add('visible');
                        }
                    } else {
                        // When turned OFF, perform all reset actions as requested.
                        // 1. Reset sub-settings in the settings object.
                        appSettings.developer.forceNewYearTheme = false;
                        
                        // 2. Update the UI of all sub-settings to reflect the change.
                        const forceNewYearToggle = document.getElementById('force-new-year-theme-toggle');
                        if (forceNewYearToggle) {
                            forceNewYearToggle.checked = false;
                        }
                        
                        // 3. Apply changes triggered by settings reset (e.g., turn off NY theme).
                        applyNewYearMode(); 
                        
                        // 4. Hide the developer icon in the 'About' panel.
                        if (developerIconContainer) {
                            developerIconContainer.classList.remove('visible');
                        }

                        // 5. Remove the unlock flag from localStorage to re-lock the feature.
                        try {
                            localStorage.removeItem('developerModeUnlocked');
                        } catch (e) {
                            console.error("Failed to remove from localStorage", e);
                        }

                        // 6. Close the developer settings window immediately.
                        closeDeveloperSettings();
                    }
                    
                    saveSettings(); // Save all settings changes.
                });
            }

            // --- [NEW] New Year Theme Event Listeners ---
            const forceNewYearToggle = document.getElementById('force-new-year-theme-toggle');
            if (forceNewYearToggle) {
                forceNewYearToggle.addEventListener('change', () => {
                    appSettings.developer.forceNewYearTheme = forceNewYearToggle.checked;
                    saveSettings();
                    applyNewYearMode();
                });
            }

            const musicBtn = document.getElementById('new-year-music-btn');
            if (musicBtn) {
                const audio = document.getElementById('new-year-audio');

                musicBtn.addEventListener('click', () => {
                    if (!audio) return;
                    if (audio.paused) {
                        audio.play().catch(e => console.error("Music play failed on click:", e));
                    } else {
                        audio.pause();
                    }
                });

                if (audio) {
                    audio.addEventListener('play', () => {
                        musicBtn.classList.add('is-playing');
                        musicBtn.classList.remove('is-paused');
                    });
                    audio.addEventListener('pause', () => {
                        musicBtn.classList.remove('is-playing');
                        musicBtn.classList.add('is-paused');
                    });
                }
            }

            const newYearAudio = document.getElementById('new-year-audio');
            if (newYearAudio) {
                newYearAudio.addEventListener('timeupdate', () => {
                    if (newYearAudio.paused) return;

                    if (!newYearMusicIntroPlayed) {
                        if (newYearAudio.currentTime >= NY_MUSIC_LOOP_END) {
                            newYearMusicIntroPlayed = true;
                            newYearAudio.currentTime = NY_MUSIC_LOOP_START;
                        }
                    } else {
                        if (newYearAudio.currentTime >= NY_MUSIC_LOOP_END) {
                            newYearAudio.currentTime = NY_MUSIC_LOOP_START;
                        }
                    }
                });
            }

            const newYearBgToggle = document.getElementById('new-year-bg-toggle');
            if (newYearBgToggle) {
                newYearBgToggle.addEventListener('change', () => {
                    appSettings.newYearTheme.backgroundEnabled = newYearBgToggle.checked;
                    saveSettings();
                    applyNewYearMode(); // Re-evaluate the whole theme state
                });
            }

            // --- [NEW] Reset Settings Logic ---
            const resetSettingsBtn = document.getElementById('reset-settings-btn');
            const resetConfirmOverlay = document.getElementById('reset-confirm-overlay');
            const cancelResetBtn = document.getElementById('cancel-reset-btn');
            const confirmResetBtn = document.getElementById('confirm-reset-btn');
            const resetConfirmState = document.getElementById('reset-confirm-state');
            const resetSuccessState = document.getElementById('reset-success-state');

            const openResetModal = () => {
                // Ensure the modal is in the correct initial state when opening
                resetConfirmState.classList.remove('hidden');
                resetSuccessState.classList.add('hidden');
                if(confirmResetBtn) confirmResetBtn.disabled = false;
                if(cancelResetBtn) cancelResetBtn.disabled = false;

                if (resetConfirmOverlay) {
                    resetConfirmOverlay.classList.remove('hidden');
                    setTimeout(() => {
                        document.body.classList.add('reset-confirm-open');
                    }, 10); 
                }
            };

            const closeResetModal = () => {
                document.body.classList.remove('reset-confirm-open');
            };
            
            if (resetConfirmOverlay) {
                resetConfirmOverlay.addEventListener('transitionend', (event) => {
                    if (event.propertyName === 'opacity' && !document.body.classList.contains('reset-confirm-open')) {
                        resetConfirmOverlay.classList.add('hidden');
                    }
                });
            }

            if (resetSettingsBtn) {
                resetSettingsBtn.addEventListener('click', openResetModal);
            }
            if (cancelResetBtn) {
                cancelResetBtn.addEventListener('click', closeResetModal);
            }
            if (resetConfirmOverlay) {
                resetConfirmOverlay.addEventListener('click', (e) => {
                    if (e.target === resetConfirmOverlay) {
                        closeResetModal();
                    }
                });
            }
            if (confirmResetBtn) {
                confirmResetBtn.addEventListener('click', () => {
                    // Disable buttons immediately to prevent multiple clicks
                    confirmResetBtn.disabled = true;
                    if(cancelResetBtn) cancelResetBtn.disabled = true;

                    // 1. Fade out the confirmation content
                    if(resetConfirmState) resetConfirmState.style.opacity = '0';

                    // 2. After fade-out, switch content and fade in success message
                    setTimeout(() => {
                        if(resetConfirmState) resetConfirmState.classList.add('hidden');
                        
                        if(resetSuccessState) {
                            resetSuccessState.style.opacity = '0'; // Start transparent
                            resetSuccessState.classList.remove('hidden');
                            
                            // A tiny delay to allow the browser to apply display:block before transitioning opacity
                            setTimeout(() => {
                                resetSuccessState.style.opacity = 1;
                            }, 20);
                        }

                        // 3. Perform the actual reset
                        localStorage.removeItem('qing-homepage-settings');
                        localStorage.removeItem('developerModeUnlocked');

                        // 4. Reload the page after showing the success message
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }, 250); // This duration should match the CSS transition
                });
            }
        }

        // --- [NEW] JS-Powered Tooltip Logic ---
        function setupTooltips() {
            let tooltipEl = null;
            let showTimer = null;

            function createTooltipElement() {
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.classList.add('js-tooltip');
                    document.body.appendChild(tooltipEl);
                }
            }

            function showTooltip(target) {
                const tooltipText = target.getAttribute('data-tooltip');
                if (!tooltipText) return;

                createTooltipElement();
                tooltipEl.textContent = tooltipText;
                positionTooltip(target);

                tooltipEl.style.opacity = '1';
                tooltipEl.style.transform = 'scale(1) translateY(0)';
            }

            function hideTooltip() {
                if (tooltipEl) {
                    tooltipEl.style.opacity = '0';
                    tooltipEl.style.transform = 'scale(0.95) translateY(5px)';
                }
            }

            function positionTooltip(target) {
                if (!tooltipEl || !target) return;

                const targetRect = target.getBoundingClientRect();
                const tooltipRect = tooltipEl.getBoundingClientRect();
                const offset = 10; 

                let top = targetRect.top - tooltipRect.height - offset;
                let left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);

                if (top < 0) {
                    top = targetRect.bottom + offset;
                }
                if (left < 0) {
                    left = 5;
                }
                if (left + tooltipRect.width > window.innerWidth) {
                    left = window.innerWidth - tooltipRect.width - 5;
                }

                tooltipEl.style.top = `${top}px`;
                tooltipEl.style.left = `${left}px`;
            }
            
            document.body.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-tooltip]');
                if (target) {
                    clearTimeout(showTimer);
                    showTimer = setTimeout(() => {
                        showTooltip(target);
                    }, 200);
                }
            });

            document.body.addEventListener('mouseout', (e) => {
                const target = e.target.closest('[data-tooltip]');
                if (target) {
                    clearTimeout(showTimer);
                    hideTooltip();
                }
            });

            window.addEventListener('scroll', () => {
                clearTimeout(showTimer);
                hideTooltip();
            }, true);
        }


        // --- È°µÈù¢Âä†ËΩΩÊó∂ÊâßË°åÁöÑÂáΩÊï∞ ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            // Initialize Faders
            const bgLayers = document.querySelectorAll('#bg-wrapper .bg-layer');
            backgroundFader = createCrossfader(Array.from(bgLayers));

            // --- [FIX] Correct Initialization Order ---
            setupTooltips(); // Initialize the new tooltip system
            // 1. Build the settings panel UI first, so other functions can find its elements.
            setupSettingsUI();
            setupEventListeners();
            setupLuckFeature(); // Activate the new luck feature
            particleEffects.init(); // Initialize particle system

            // [NEW] Check for persisted developer mode unlock
            try {
                if (localStorage.getItem('developerModeUnlocked') === 'true') {
                    const developerIconContainer = document.getElementById('developer-icon-container');
                    if (developerIconContainer) {
                        developerIconContainer.classList.add('visible');
                    }
                }
            } catch (e) {
                console.error("Failed to read developerModeUnlocked from localStorage", e);
            }

            // 2. Pre-calculate the theme slider's correct position before it's ever shown.
            initializeThemeSlider();
            
            // 3. Now apply all other settings.
            applyCurrentTheme();
            applyBlinkingEffect();
            applyGlassEffect();
            applyCardSettings();
            applyCurrentBackground();
            applyCurrentView();
            updateSettingsUI();
            applyNewYearMode(); // [NEW] Apply New Year theme on load

            // 3. Initial data fetches and updates.
            updateTime();
            updateGreeting();
            updateCountdown();
            fetchHitokoto();
            setupGitHubChartLoader();
            updateSiteRuntime();
            updateTimeCapsule();
            
            // 4. Defer non-critical layout calculations.
            setTimeout(() => {
                if (window.innerWidth >= 1024) {
                    cachedRightColumnHeight = rightColumn.offsetHeight;
                }
            }, 100);

            // --- [NEW] Initialize Card Slider ---
            createCardSlider('#link-slider-container');
            
            setInterval(updateTime, 1000);
            setInterval(updateSiteRuntime, 1000);
            setInterval(updateGreeting, 1800000); 
            setInterval(updateCountdown, 3600000); 
            setInterval(updateTimeCapsule, 60000);

            // [NEW] Auto-refresh weather data every 30 minutes
            setInterval(() => {
                if (appSettings.view === 'weather') {
                    fetchAndDisplayWeather();
                }
            }, 30 * 60 * 1000);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (appSettings.theme === 'system') {
                    applyCurrentTheme();
                }
            });
        });
    </script>
</body>
</html>
