<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qing90bing的主页</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css" />
    <script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- CSS Variables and Theming --- */
        body.theme-dark {
            --bg-color: #0d1a26;
            --card-bg-color: rgba(30, 41, 59, 0.7);
            --card-border-color: rgba(255, 255, 255, 0.1);
            --card-hover-bg-color: rgba(30, 41, 59, 0.75);
            --card-hover-border-color: rgba(255, 255, 255, 0.2);
            --text-color-primary: #e5e7eb; /* gray-200 */
            --text-color-secondary: #9ca3af; /* gray-400 */
            --text-color-tertiary: #6b7280; /* gray-500 */
            --accent-color: #38bdf8; /* sky-400 */
            --accent-color-highlight: rgba(56, 189, 248, 0.15);
            --progress-bar-bg: rgba(255, 255, 255, 0.1);
            --link-color: #e5e7eb;
            --link-hover-color: #fff;
            --separator-color: rgba(255, 255, 255, 0.1);
            --status-past: #6b7280; /* gray-500 */
            --status-yesterday: #eab308; /* yellow-500 */
            --status-today: #22c55e; /* green-500 */
            --status-tomorrow: #60a5fa; /* blue-400 */
        }
        body.theme-light {
            --bg-color: #f1f5f9; /* slate-100 */
            --card-bg-color: rgba(255, 255, 255, 0.7);
            --card-border-color: rgba(0, 0, 0, 0.08);
            --card-hover-bg-color: rgba(255, 255, 255, 0.75);
            --card-hover-border-color: rgba(0, 0, 0, 0.12);
            --text-color-primary: #1e293b; /* slate-800 */
            --text-color-secondary: #475569; /* slate-600 */
            --text-color-tertiary: #64748b; /* slate-500 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-color-highlight: rgba(59, 130, 246, 0.1);
            --progress-bar-bg: rgba(0, 0, 0, 0.08);
            --link-color: #1e293b;
            --link-hover-color: #000;
            --separator-color: rgba(0, 0, 0, 0.1);
            --status-past: #64748b; /* slate-500 */
            --status-yesterday: #ca8a04; /* yellow-600 */
            --status-today: #16a34a; /* green-600 */
            --status-tomorrow: #2563eb; /* blue-600 */
        }

        /* 自定义样式 */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* 防止出现双滚动条 */
        }
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            transition: background-color 0.1s ease, color 0.1s ease;
        }

        /* 背景图片容器 */
        #bg-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .bg-layer.active {
            opacity: 1;
        }

        .glass-card {
            background: var(--card-bg-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid var(--card-border-color);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            background: var(--card-hover-bg-color);
            border: 1px solid var(--card-hover-border-color);
        }

        /* Override for settings window to disable hover effect */
        #settings-window.glass-card:hover {
            background: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
        }

        #time-display, .runtime-number, #countdown-display, #holiday-list-container, #time-capsule-card {
            font-variant-numeric: tabular-nums;
        }
        
        #time-display {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            text-shadow: 0 0 10px var(--accent-color);
        }

        .simplebar-scrollbar:before {
            background-color: var(--accent-color);
            border-radius: 4px;
        }
        .simplebar-track.simplebar-vertical {
            width: 8px;
        }

        /* [FIXED] Q弹动画 - 移除了opacity属性以修复背景透明问题 */
        @keyframes bounce-in {
            0% { transform: scale(0.95); }
            60% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .bounce-in {
            animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* 进度条样式 */
        .progress-bar {
            background-color: var(--progress-bar-bg);
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-inner {
            background-color: var(--accent-color);
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }
        
        /* 高亮最近的节日 */
        .highlight-holiday {
            background-color: var(--accent-color-highlight);
            border-left: 3px solid var(--accent-color);
        }

        #holiday-list-container {
            transition: opacity 0.1s ease-in-out;
        }
        #holiday-list-year {
            transition: opacity 0.1s ease-in-out, color 0.2s ease-in-out;
        }
        #holiday-list-year:hover {
            color: var(--accent-color);
        }

        #holiday-list-container-wrapper {
            --fade-top-size: 40px;
            --fade-bottom-size: 40px;
            -webkit-mask-image: linear-gradient(transparent, black var(--fade-top-size), black calc(100% - var(--fade-bottom-size)), transparent);
            mask-image: linear-gradient(transparent, black var(--fade-top-size), black calc(100% - var(--fade-bottom-size)), transparent);
        }

        #back-to-today-btn {
            display: flex;
            border: 1px solid var(--card-border-color);
            background-color: var(--accent-color);
            opacity: 0;
            transform: scale(0.9);
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, visibility 0.2s, background-color 0.2s ease;
        }
        #back-to-today-btn:hover {
            opacity: 0.85 !important;
        }
        #back-to-today-btn.visible {
            opacity: 0.7;
            transform: scale(1);
            visibility: visible;
            pointer-events: auto;
        }

        #main-wrapper {
            height: 100vh;
            transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        
        /* --- Settings Modal States --- */
        #settings-overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0s linear 0.2s;
        }
        #settings-window {
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.15s ease-in-out;
        }

        body.settings-open #main-wrapper {
            transform: scale(0.98);
            filter: blur(8px);
            opacity: 0;
            pointer-events: none;
        }
        body.settings-open #settings-overlay {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }
        body.settings-open #settings-window {
            transform: scale(1);
            opacity: 1;
        }

    @media (max-width: 1023px) {
        html, body {
            height: auto;
            overflow-y: auto;
        }
        #main-wrapper {
            height: auto;
        }
        #holiday-list-card {
            height: 50vh;
        }
    }

    /* Animations for Year Input */
    @keyframes fade-in-anim {
        from { opacity: 0; transform: scale(0.98); }
        to { opacity: 1; transform: scale(1); }
    }

    @keyframes fade-out-anim {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.98); }
    }

    .animate-fade-in {
        animation: fade-in-anim 0.1s ease-out forwards;
    }

    .animate-fade-out {
        animation: fade-out-anim 0.1s ease-in forwards;
    }
    
    /* Shake animation for error feedback */
    @keyframes shake-anim {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-3px); }
      40%, 60% { transform: translateX(3px); }
    }

    #year-input.invalid {
        border-color: #ef4444 !important; /* red-500, a consistent error color */
        animation: shake-anim 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    /* GitHub Chart Placeholder Styles */
    #gh-chart-wrapper {
        aspect-ratio: 892 / 140;
        border-radius: 0.375rem; /* 6px */
        overflow: hidden;
    }

    @keyframes gh-chart-pulse {
        0%, 100% {
            opacity: 0.5;
        }
        50% {
            opacity: 1;
        }
    }

    #gh-chart-loader {
        background-color: var(--progress-bar-bg);
        animation: gh-chart-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    #gh-chart-img.loaded {
        opacity: 1;
    }

    #gh-chart-link.visible {
        visibility: visible;
    }

    #gh-chart-error.visible {
        display: flex;
    }

    /* --- [NEW] Preview Loader and Animations --- */
    #preview-loader {
        position: absolute;
        top: 0.75rem; /* 12px */
        right: 0.75rem; /* 12px */
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 10;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        opacity: 0;
        visibility: hidden;
    }
    #preview-loader.visible {
        opacity: 1;
        visibility: visible;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @keyframes breathing {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .breathing-effect {
        animation: breathing 2s ease-in-out infinite;
    }
    
    /* Utility to hide elements cleanly */
    .hidden {
      display: none !important;
    }

    /* --- Settings UI Styles --- */
    #background-preview-container {
        transition: max-height 0.35s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.3s ease-in-out;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
    }
    #background-preview-container.visible {
        max-height: 400px;
        opacity: 1;
        margin-top: 0.75rem;
    }

    #bg-preview-wrapper.visible {
        max-height: 200px;
        opacity: 1;
    }
    #bg-preview-img {
        transition: opacity 0.3s ease-in-out;
        background-color: var(--progress-bar-bg); /* [FIX] Add placeholder background */
    }

    #bg-preview-download-btn.visible {
        transform: scale(1) !important;
    }

    #bg-preview-download-btn:hover {
        transform: scale(1.1) !important;
    }

    #bg-preview-refresh-btn.visible {
        transform: scale(1) !important;
    }

    #bg-preview-refresh-btn:hover {
        transform: scale(1.1) !important;
    }

    .setting-section {
        border-top: 1px solid var(--separator-color);
        padding-top: 1.5rem;
    }
    .setting-section:first-child {
        border-top: none;
        padding-top: 0;
    }
    .setting-radio-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out;
        border: 1px solid transparent;
    }
    .setting-radio-label:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    .setting-radio-input {
        display: none; /* Hide original radio button */
    }
    .setting-radio-input:checked + .setting-radio-label {
        background-color: rgba(56, 189, 248, 0.15);
        border-color: rgba(56, 189, 248, 0.5);
    }
    .custom-radio-button {
        width: 1.25em;
        height: 1.25em;
        border: 2px solid #9ca3af; /* gray-400 */
        border-radius: 50%;
        margin-right: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: border-color 0.2s;
        flex-shrink: 0;
    }
    .setting-radio-input:checked + .setting-radio-label .custom-radio-button {
        border-color: #38bdf8; /* sky-500 */
    }
    .custom-radio-button::after {
        content: '';
        width: 0.75em;
        height: 0.75em;
        background-color: #38bdf8; /* sky-500 */
        border-radius: 50%;
        transform: scale(0);
        transition: transform 0.15s ease-in-out;
    }
    .setting-radio-input:checked + .setting-radio-label .custom-radio-button::after {
        transform: scale(1);
    }

    #default-bg-options {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-in-out, padding-top 0.3s ease;
        opacity: 0;
        padding-left: 0.5rem; /* Symmetrical padding */
        padding-right: 0.5rem; /* Symmetrical padding */
    }
    #default-bg-options.open {
        max-height: 300px; /* Adjust as needed */
        opacity: 1;
        padding-top: 0.75rem;
        padding-bottom: 0.5rem; /* Add space for hover effect */
    }
    .thumb-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.75rem;
        justify-content: center;
    }
    .thumb-item {
        aspect-ratio: 16 / 9;
        border-radius: 0.5rem; /* Softer corners */
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s, transform 0.2s;
        position: relative;
        background-color: rgba(255, 255, 255, 0.05);
    }
    .thumb-item:hover {
        transform: scale(1.05);
    }
    .thumb-item.active {
        border-color: #38bdf8; /* sky-500 */
    }
    .thumb-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .thumb-item .thumb-overlay {
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.875rem;
    }

    .theme-swatch {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        cursor: pointer;
        padding: 4px;
        border: 2px solid transparent;
        transition: border-color 0.2s, transform 0.2s;
    }
    .theme-swatch:hover {
        transform: scale(1.1);
    }
    .theme-swatch.active {
        border-color: var(--accent-color);
        transform: scale(1.1);
    }
    .swatch-color {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    body.theme-light .swatch-color {
        border-color: rgba(0, 0, 0, 0.2);
    }

    .setting-btn-group {
        display: flex;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 1px solid var(--separator-color);
    }
    .setting-btn {
        flex-grow: 1;
        padding: 0.5rem 0.75rem;
        background-color: transparent;
        color: var(--text-color-secondary);
        border: none;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        font-size: 0.875rem;
    }
    .setting-btn:not(:last-child) {
        border-right: 1px solid var(--separator-color);
    }
    .setting-btn.active {
        background-color: var(--accent-color);
        color: white;
        font-weight: 500;
    }
    .setting-btn:hover:not(.active) {
        background-color: var(--card-hover-bg-color);
    }

    .progress-bar-text {
        color: var(--text-color-primary);
        text-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    body.theme-light .progress-bar-text {
        /* In light mode, the primary text is dark, so a light shadow is better for contrast against the accent-colored bar */
        text-shadow: 0 0 4px rgba(255,255,255,0.5);
    }
    
    /* --- Toggle Switch --- */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--text-color-tertiary);
        transition: .3s;
        border-radius: 28px;
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-radius: 50%;
    }
    input:checked + .toggle-slider {
        background-color: var(--accent-color);
    }
    input:focus + .toggle-slider {
        box-shadow: 0 0 1px var(--accent-color);
    }
    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }
    </style>
</head>
<body>
    <div id="bg-wrapper">
        <div class="bg-layer"></div>
        <div class="bg-layer"></div>
    </div>
    <div id="main-wrapper">
        <div class="flex items-center justify-center min-h-screen px-8 sm:px-16 lg:px-24">
            <main class="grid grid-cols-1 lg:grid-cols-4 gap-5 w-full max-w-6xl">

                <div class="lg:col-span-1 space-y-5 flex flex-col">
                    <div class="glass-card flex items-center justify-center p-5 gap-4">
                        <h1 class="text-3xl font-bold" style="color: var(--text-color-primary);">Qing90bing</h1>
                    </div>

                    <div id="countdown-card" class="glass-card p-5 cursor-pointer">
                        <h2 class="text-xl font-semibold mb-3 text-center" style="color: var(--text-color-primary);">日历倒计时</h2>
                        <div id="countdown-display" class="text-center text-lg leading-relaxed" style="color: var(--accent-color);">正在计算...</div>
                    </div>
                    
                    <div id="profile-card" class="glass-card p-5 flex flex-col justify-between flex-grow cursor-pointer">
                        <div class="relative px-4 py-2">
                            <span class="absolute top-0 left-0 text-6xl font-serif -translate-y-4 -translate-x-2 select-none" style="color: var(--separator-color);">“</span>
                            <p class="text-lg" style="color: var(--text-color-primary);">Hello, World!</p>
                            <p class="mt-1" style="color: var(--text-color-secondary);">一个建立于21世纪的小站，存活于互联网的边缘</p>
                            <span class="absolute bottom-0 right-0 text-6xl font-serif translate-y-6 translate-x-2 select-none" style="color: var(--separator-color);">”</span>
                        </div>
                        <div class="mt-8">
                            <p class="text-sm mb-4" style="color: var(--text-color-secondary);">与我联系:</p>
                            <div class="flex items-center gap-5">
                                <a href="https://github.com/Qing90bing" target="_blank" title="GitHub" style="color: var(--text-color-secondary); transition: color 0.2s;">
                                    <svg class="w-7 h-7" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                                </a>
                                <a href="mailto:1879495519@qq.com" target="_blank" title="Email" style="color: var(--text-color-secondary); transition: color 0.2s;">
                                    <svg class="w-7 h-7" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Email</title><path fill="currentColor" d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0l-8 5-8-5h16zm0 12H4V8l8 5 8-5v10z"/></svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="right-column" class="lg:col-span-3 space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="glass-card p-5 flex flex-col justify-center items-center">
                            <div id="date-display" class="text-lg" style="color: var(--text-color-secondary);"></div>
                            <div id="time-display" class="text-6xl my-1" style="color: var(--text-color-primary);"></div>
                            <div id="greeting" class="text-sm" style="color: var(--text-color-secondary);"></div>
                        </div>
                        <div id="hitokoto-card" class="glass-card p-5 flex flex-col justify-center cursor-pointer min-h-[120px] md:min-h-full">
                            <p id="hitokoto-text" class="text-center transition-opacity duration-500 ease-in-out" style="color: var(--text-color-primary);">正在加载一言...</p>
                            <p id="hitokoto-from" class="text-right text-sm mt-2 transition-opacity duration-500 ease-in-out" style="color: var(--text-color-secondary);"></p>
                        </div>
                    </div>
                    
                    <div class="glass-card p-5">
                        <div id="main-card-view-wrapper">
                            <!-- GitHub View -->
                            <div id="github-view">
                                <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color-primary);">
                                   <svg class="inline-block w-6 h-6 mr-2 -mt-1" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                                   GitHub 贡献图
                                </h2>
                                <div id="gh-chart-container" class="w-full rounded-md p-2" style="background-color: var(--progress-bar-bg);">
                                    <div id="gh-chart-wrapper" class="relative">
                                        <div id="gh-chart-loader" class="absolute inset-0 flex items-center justify-center"></div>
                                        <div id="gh-chart-error" class="absolute inset-0 hidden flex-col items-center justify-center cursor-pointer">
                                            <svg class="w-8 h-8" style="color: var(--text-color-tertiary);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.695v-2.286c0-1.033-.842-1.875-1.875-1.875H10.5a1.875 1.875 0 00-1.875 1.875v2.286m7.5 0l-3.181 3.183m0 0L12 21.354l-3.181-3.183m0 0l-3.181-3.183"></path></svg>
                                            <p id="gh-chart-error-message" class="mt-2 text-sm" style="color: var(--text-color-secondary);">加载贡献图失败，点击重试</p>
                                        </div>
                                        <a href="https://github.com/Qing90bing" target="_blank" id="gh-chart-link" class="invisible">
                                            <img id="gh-chart-img" data-src="https://ghchart.rshah.org/Qing90bing?theme=dark" alt="Qing90bing's GitHub Contribution Graph" class="w-full h-full block opacity-0 transition-opacity duration-500"/>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <!-- Weather View -->
                            <div id="weather-view" class="hidden">
                                 <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color-primary);">天气信息</h2>
                                 <div id="weather-content-wrapper" class="w-full rounded-md p-2" style="background-color: var(--progress-bar-bg);">
                                    <!-- Weather content will be injected here -->
                                    <p style="color: var(--text-color-secondary);">正在加载天气...</p>
                                 </div>
                            </div>
                        </div>

                        <h2 class="text-xl font-semibold mb-4 mt-6" style="color: var(--text-color-primary);">
                            <svg class="inline-block w-6 h-6 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                            网站列表
                        </h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                            <a href="https://qing90bing.github.io/QingNoteblog/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 transform-gpu" style="color: var(--text-color-primary);">
                                <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span class="font-medium">博客</span>
                            </a>
                            <a href="https://qing90bing.github.io/Qing_Music/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 transform-gpu" style="color: var(--text-color-primary);">
                                <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3"></path></svg>
                                <span class="font-medium">音乐</span>
                            </a>
                            <a href="https://qing90bing.github.io/Qing_Start/" target="_blank" class="glass-card p-4 flex flex-col items-center justify-center text-center hover:scale-105 transform-gpu" style="color: var(--text-color-primary);">
                                <svg class="w-8 h-8 mb-2" style="color: var(--accent-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                <span class="font-medium">起始页</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Holiday List Card -->
                <div id="holiday-list-card" class="lg:col-span-3 glass-card p-5 hidden flex flex-col">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold" style="color: var(--text-color-primary);">节日倒数列表</h2>
                        <div class="flex items-center gap-3">
                            <button id="back-to-today-btn" title="回到今天" class="w-8 h-8 rounded-full transition-all active:scale-95 flex-shrink-0 flex items-center justify-center font-bold text-white text-base">今</button>
                            <button id="close-holiday-list" title="关闭" class="transition-colors" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-center items-center h-8 relative">
                        <!-- Display Mode -->
                        <div id="year-display-controls" class="flex items-center gap-4 text-lg">
                            <button id="prev-year" title="上一年" class="p-1 rounded-full transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <span id="holiday-list-year" class="font-bold w-16 text-center cursor-pointer" style="color: var(--text-color-primary);"></span>
                            <button id="next-year" title="下一年" class="p-1 rounded-full transition-all active:scale-95" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <!-- Edit Mode -->
                        <div id="year-edit-controls" class="hidden flex items-center gap-2 text-lg">
                            <input type="text" id="year-input" class="font-bold w-20 text-center rounded-md border focus:ring-0 px-1 py-0.5 text-lg" style="background-color: var(--card-bg-color); color: var(--text-color-primary); border-color: var(--separator-color); outline: none;">
                            <button id="confirm-year-btn" title="确认" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: var(--status-today);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                            <button id="cancel-year-btn" title="取消" class="p-1 rounded-full hover:bg-white/10 transition-all active:scale-95" style="color: #ef4444;">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <!-- Error Message for input validation -->
                        <div id="year-input-error" class="hidden absolute -bottom-6 text-sm font-bold" style="color: #ef4444;"></div>
                    </div>
                    <div class="relative flex-1 min-h-0">
                        <!-- Warning is now absolutely positioned inside this container -->
                        <div id="year-range-warning" class="absolute top-0 left-0 right-0 z-10 hidden flex items-center justify-center text-amber-400 text-sm font-semibold"></div>
                        <div id="holiday-list-container-wrapper" class="absolute inset-0">
                           <div id="holiday-list-container" class="space-y-4">
                               <!-- Holiday list will be dynamically inserted here -->
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Time Capsule Card -->
                <div id="time-capsule-card" class="lg:col-span-3 glass-card p-5 hidden flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold" style="color: var(--text-color-primary);">时光胶囊</h2>
                        <div class="flex items-center gap-4">
                            <button id="open-settings-btn" title="设置" class="transition-colors" style="color: var(--text-color-secondary);">
                                <i class="fas fa-gear fa-lg"></i>
                            </button>
                            <button id="close-time-capsule" title="关闭" class="transition-colors" style="color: var(--text-color-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-5">
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>今日已过 <span id="day-passed">0</span> 小时</span>
                                <span>剩余 <span id="day-left">24</span> 小时</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="day-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="day-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>本周已过 <span id="week-passed">0</span> 天</span>
                                <span>剩余 <span id="week-left">7</span> 天</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="week-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="week-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>本月已过 <span id="month-passed">0</span> 天</span>
                                <span>剩余 <span id="month-left">30</span> 天</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="month-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="month-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-medium" style="color: var(--text-color-secondary);">
                                <span>今年已过 <span id="year-passed">0</span> 天</span>
                                <span>剩余 <span id="year-left">365</span> 天</span>
                            </div>
                            <div class="progress-bar h-5 flex items-center justify-center relative">
                                <div id="year-progress" class="progress-bar-inner absolute top-0 left-0 h-full" style="width: 0%;"></div>
                                <span id="year-percent" class="relative z-10 text-xs font-bold progress-bar-text">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center" style="color: var(--text-color-secondary);">
                        <p id="site-runtime-display">正在计算...</p>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4" style="z-index: 50;">
        <div id="settings-window" class="glass-card w-full max-w-2xl p-5 flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center ">
                <h2 class="text-xl font-semibold" style="color: var(--text-color-primary);">设置</h2>
                <button id="close-settings-btn" title="关闭" style="color: var(--text-color-secondary);">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <!-- Content -->
            <div class="flex-grow flex-1 min-h-0" data-simplebar>
                <div class="space-y-6 p-3">
                    <!-- 1. Background Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-color-primary);">背景来源</h3>
                        <div id="background-settings-content">
                            <!-- Background options will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- 2. Theme Color Settings -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-color-primary);">主题模式</h3>
                        <div id="theme-settings-content" class="flex flex-wrap">
                            <!-- Theme color swatches will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- 3. GitHub/Weather Toggle -->
                    <div class="setting-section">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-color-primary);">主卡片视图</h3>
                        <div id="view-toggle-content">
                            <!-- The toggle switch for GitHub/Weather will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- 初始状态和常量 ---
        const DEFAULT_BG_IMAGES = [
            'https://s21.ax1x.com/2025/08/10/pVdEmM6.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEnsK.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEuqO.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEQde.jpg',
            'https://s21.ax1x.com/2025/08/10/pVdEMZD.jpg'
        ];
        const lunarInfo = [0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2, 0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977, 0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970, 0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950, 0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557, 0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0, 0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0, 0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6, 0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570, 0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0, 0x0c960, 0xd954, 0x0d4a0, 0xda50, 0x07552, 0x056a0, 0xabb7, 0x025d0, 0x092d0, 0x0cab5, 0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930, 0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530, 0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45, 0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0];
        const solarTerm = ["小寒", "大寒", "立春", "雨水", "惊蛰", "春分", "清明", "谷雨", "立夏", "小满", "芒种", "夏至", "小暑", "大暑", "立秋", "处暑", "白露", "秋分", "寒露", "霜降", "立冬", "小雪", "大雪", "冬至"];
        const sTermInfo = [0, 21208, 42467, 63836, 85337, 107014, 128867, 150921, 173149, 195551, 218072, 240693, 263343, 285989, 308563, 331033, 353350, 375494, 397447, 419210, 440795, 462224, 483532, 504758];
        const sFtv = [
            { date: "0101", name: "元旦", start: 1949 },
            { date: "0110", name: "警察节", start: 2021 },
            { date: "0214", name: "情人节" },
            { date: "0308", name: "妇女节", start: 1949 },
            { date: "0312", name: "植树节", start: 1979 },
            { date: "0315", name: "消费者日", start: 1983 },
            { date: "0401", name: "愚人节" },
            { date: "0501", name: "劳动节", start: 1949 },
            { date: "0504", name: "青年节", start: 1949 },
            { date: "0512", name: "护士节", start: 1912 },
            { date: "0601", name: "儿童节", start: 1949 },
            { date: "0701", name: "建党节", start: 1921 },
            { date: "0801", name: "建军节", start: 1927 },
            { date: "0815", name: "日本投降日", start: 1945 },
            { date: "0903", name: "抗战胜利纪念日", start: 1945 },
            { date: "0910", name: "教师节", start: 1985 },
            { date: "0918", name: "九一八事变", start: 1931 },
            { date: "1001", name: "国庆节", start: 1949 },
            { date: "1213", name: "国家公祭日", start: 2014 },
            { date: "1224", name: "平安夜" },
            { date: "1225", name: "圣诞节" },
        ];
        const lFtv = [
            { date: "0101", name: "春节" },
            { date: "0115", name: "元宵节" },
            { date: "0202", name: "龙抬头" },
            { date: "0505", name: "端午节" },
            { date: "0707", name: "七夕" },
            { date: "0715", name: "中元节" },
            { date: "0815", name: "中秋节" },
            { date: "0909", name: "重阳节" },
            { date: "1208", name: "腊八节" },
            { date: "1223", name: "北方小年" },
            { date: "1224", name: "南方小年" },
        ];
        let holidayListDisplayedYear = new Date().getFullYear();
        let hasManuallyScrolled = false;
        let holidayListSimpleBar; // Instance for the holiday list scrollbar
        let settingsSimpleBar = null; // Instance for the settings scrollbar

        // --- [NEW] Reusable Cross-fade Logic ---
        function createCrossfader(layers) {
            let activeIndex = 0;

            // Return an update function that handles the cross-fade
            const update = (newUrl, isBackgroundImage = false) => {
                return new Promise((resolve, reject) => {
                    const nextIndex = (activeIndex + 1) % 2;
                    const activeLayer = layers[activeIndex];
                    const nextLayer = layers[nextIndex];

                    if (!nextLayer || !activeLayer) {
                        return reject('Cross-fade layers not found.');
                    }

                    const preloader = new Image();
                    preloader.src = newUrl;

                    preloader.onload = () => {
                        // Apply the new image to the hidden layer
                        if (isBackgroundImage) {
                            nextLayer.style.backgroundImage = `url('${newUrl}')`;
                        } else {
                            nextLayer.src = newUrl;
                        }

                        // Trigger the cross-fade
                        activeLayer.classList.remove('active');
                        nextLayer.classList.add('active');
                        
                        // Update the active index for the next cycle
                        activeIndex = nextIndex;
                        resolve(); // Transition has started
                    };

                    preloader.onerror = () => {
                        console.error(`Crossfader failed to load image: ${newUrl}`);
                        reject('Image load error');
                    };
                });
            };
            
            return { update };
        }

        let backgroundFader;
        // previewFader is no longer needed

        let latestBgRequestId = 0;
        let latestPreviewRequestId = 0;

        // --- DOM 元素获取 (部分移至DOMContentLoaded) ---
        const countdownCard = document.getElementById('countdown-card');
        const profileCard = document.getElementById('profile-card');
        const rightColumn = document.getElementById('right-column');
        const timeCapsuleCard = document.getElementById('time-capsule-card');
        const holidayListCard = document.getElementById('holiday-list-card');
        let rightColumnInitialHeight = 0;
        let cachedRightColumnHeight = 0; // Cache the height of the right column

        // --- [NEW] Year Input Feature Elements ---
        const yearDisplayControls = document.getElementById('year-display-controls');
        const yearEditControls = document.getElementById('year-edit-controls');
        const holidayListYearSpan = document.getElementById('holiday-list-year');
        const yearInput = document.getElementById('year-input');
        const confirmYearBtn = document.getElementById('confirm-year-btn');
        const cancelYearBtn = document.getElementById('cancel-year-btn');
        const yearInputError = document.getElementById('year-input-error');
        const yearRangeWarning = document.getElementById('year-range-warning');
        
        // --- 动态时钟功能 ---
        function updateTime() {
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            const now = new Date();
            timeDisplay.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            dateDisplay.textContent = `${now.getFullYear()}年${String(now.getMonth() + 1).padStart(2, '0')}月${String(now.getDate()).padStart(2, '0')}日 ${weekdays[now.getDay()]}`;
        }

        // --- 问候语功能 ---
        function updateGreeting() {
            const greetingEl = document.getElementById('greeting');
            const now = new Date();
            const hour = now.getHours();
            const month = now.getMonth() + 1; // getMonth() 返回 0-11, +1 变为 1-12

            // 定义问候语库
            const greetings = {
                spring: { // 春季 (3-5月)
                    morning: [
                        "早上好，春意盎然，愿你的一天如诗如画。🌿",
                        "清晨的露水，伴着花香，道一声早安。🌸",
                        "春日黎明，万物复苏，今天也要活力满满！",
                        "早安，愿春风为你吹来一天的好运。🍃",
                        "听，窗外是不是有鸟儿在歌唱？早安！🐦",
                        "新的一天，从一个清新的春日早晨开始。",
                        "一年之计在于春，一日之计在于晨，加油！",
                        "拉开窗帘，让第一缕春光拥抱你。☀️"
                    ],
                    afternoon: [
                        "下午好，春日暖阳，适合小憩片刻。☀️",
                        "午后时光，泡杯花茶，享受春日的悠闲吧。🍵",
                        "愿你心情如春日午后的阳光，明媚不忧伤。",
                        "春天到，别春困，起来活动一下筋骨吧！",
                        "天气这么好，不去公园散散步吗？",
                        "午后的阳光，暖得让人想打瞌睡。😴",
                        "泡一壶龙井，静品春日的午后时光。",
                        "春雷阵阵，说不定会有一场春雨，记得带伞。"
                    ],
                    evening: [
                        "晚上好，春风拂面，一天的疲惫都消散了。🎑",
                        "夜幕降临，静享春夜的温柔与宁静。",
                        "春夜的星空格外明朗，祝你晚安好梦。✨",
                        "在温柔的春夜里，和世界道一句晚安。",
                        "春天的晚霞总是格外温柔，晚上好。",
                        "忙碌了一天，是时候享受一顿美味的晚餐了。🍲",
                        "晚风轻轻，吹来青草和泥土的芬芳。",
                        "今晚月色真美，风也温柔，祝你愉快。"
                    ],
                    night: [
                        "夜深了，春夜微凉，记得盖好被子。🌙",
                        "晚安，愿你在梦里与最美的春天相遇。",
                        "放下手机，闭上眼睛，聆听春虫的鸣叫。😴",
                        "夜阑人静，祝你安眠，明日又是崭新的一天。",
                        "春夜宁静，宜读一本闲书，安然入睡。",
                        "把今天份的开心打包，睡个好觉吧。",
                        "晚安，愿你的梦里繁花似锦。🌸",
                        "夜了，全世界都睡了，你也要早点休息。"
                    ]
                },
                summer: { // 夏季 (6-8月)
                    morning: [
                        "早上好，夏日清晨，阳光正好，微风不燥。☀️",
                        "早安！今天也是元气满满的一天，别怕热！",
                        "夏日的清晨，是西瓜味的，是冰汽水味的。🍉",
                        "蝉鸣声声，唤醒了夏天的早晨，早安！",
                        "早安！今天的太阳也很热情呢！",
                        "赶在热浪来临前，享受清晨的片刻凉爽吧。",
                        "又是被阳光叫醒的一天，你好呀！🌞",
                        "新的一天，像加了冰块的汽水，充满活力！"
                    ],
                    afternoon: [
                        "下午好，夏日炎炎，记得多喝水防暑哦。💧",
                        "午后困倦，来根冰棍提提神吧！🍦",
                        "心静自然凉，愿你拥有一个清爽的下午。",
                        "夏日午后，宜开空调，宜听音乐，宜想你。😉",
                        "热到融化的下午，你还好吗？",
                        "“哪儿凉快哪儿待着去”绝对是夏天最真诚的祝福。",
                        "可能会有雷阵雨，出门记得带伞哦。⛈️",
                        "这个钟点，唯有空调和西瓜不可辜负。🍉"
                    ],
                    evening: [
                        "晚上好，夏夜晚风，吹散白天的燥热。🎐",
                        "提着一瓶汽水，坐在台阶上，感受夏天的晚风。",
                        "属于夏天的夜晚，是烧烤、小龙虾和冰啤酒。🍻",
                        "晚风轻踩着云朵，月亮在贩售快乐，晚安！",
                        "晚风吹走了热气，带来了夏夜的惬意。",
                        "又到了可以去夜市逛吃逛吃的季节！",
                        "小时候的夏夜，是蒲扇、凉席和满天繁星。✨",
                        "晚上好，去散散步吧，说不定能看到萤火虫。"
                    ],
                    night: [
                        "夜深了，晚安，愿你的梦里有凉爽的夏风。🌌",
                        "仲夏夜之梦，愿你拥抱整片星空。✨",
                        "关掉空调，可能会热；不关，可能会感冒。你看着办吧！",
                        "晚安，月亮警察已就位，请安心入睡。👮",
                        "嘘，静下心来，听听窗外的虫鸣。",
                        "晚安，空调调到26度刚刚好哦。😉",
                        "别熬夜了，你的皮肤和头发都需要休息。",
                        "祝你做个凉爽的梦，梦里没有蚊子。🦟"
                    ]
                },
                autumn: { // 秋季 (9-11月)
                    morning: [
                        "早上好，秋高气爽，天朗气清，又是美好的一天。🍁",
                        "早安，空气中有了秋天的味道，深呼吸一下吧。",
                        "秋日的晨光，温柔地洒在每一片落叶上，早安。",
                        "天凉了，记得多穿件衣服，别感冒了哦。🧥",
                        "秋日的天空，蓝得像一块画布，早安。",
                        "早晨的空气微凉，记得添一件薄外套。",
                        "秋天，是一个让一切都沉静下来的季节，早。",
                        "又是被梦想叫醒的一天，加油，打工人！"
                    ],
                    afternoon: [
                        "下午好，秋日的午后，阳光温暖得刚刚好。☕️",
                        "捧一杯热茶，读一本好书，享受秋日的静谧。",
                        "秋天是收获的季节，愿你的努力都有回报。",
                        "午安，愿秋风带走你的烦恼和疲惫。🍂",
                        "秋日的午后，每一帧都像电影画面。🎬",
                        "阳光正好，温度也正好，一切都刚刚好。",
                        "来块烤红薯或是糖炒栗子怎么样？🌰",
                        "下午犯困的话，就看看窗外的蓝天白云吧。"
                    ],
                    evening: [
                        "晚上好，秋风送爽，月色宜人。🌕",
                        "丹桂飘香的夜晚，适合思念和团圆。",
                        "秋天的夜晚，是思念的季节，也是养膘的季节。",
                        "晚来秋，天凉如水，早点休息吧。",
                        "晚上好，今天你看到美丽的落日了吗？",
                        "秋天的夜晚，总让人感觉格外宁静和舒适。",
                        "天气转凉，晚餐要吃得暖暖和和的。",
                        "月亮挂在枝头，像一颗熟透的果子。晚安。"
                    ],
                    night: [
                        "夜深了，秋意渐浓，晚安好梦。🌙",
                        "愿你伴着窗外的桂花香，甜甜地进入梦乡。",
                        "天阶夜色凉如水，卧看牵牛织女星。晚安。",
                        "被子要盖厚一点了，夜里会降温的。😴",
                        "夜深了，把心事放一边，好好睡觉最重要。",
                        "最舒服的事，莫过于在微凉的秋夜里盖着柔软的被子。",
                        "晚安，愿你梦里有金色的麦田和果实。",
                        "明天会更好，快睡吧。"
                    ]
                },
                winter: { // 冬季 (12-2月)
                    morning: [
                        "早上好，虽然天气寒冷，但也要拥抱阳光哦。❄️",
                        "早安，冬天最幸福的事，就是醒来时窗外有阳光。",
                        "起床大作战开始了！祝你成功！💪",
                        "冬日清晨，来一杯热饮，温暖一整天。☕️",
                        "早安！今天你和你的床分离成功了吗？",
                        "窗户上结了霜花，冬天真的来啦。❄️",
                        "吃一顿热气腾腾的早餐，是对冬天早晨最大的尊重。",
                        "呼一口气都是白色的，这才是冬天的感觉。"
                    ],
                    afternoon: [
                        "下午好，晒晒冬日的太阳，整个人都暖洋洋的。",
                        "泡个热水脚，是对冬天下午最好的尊重。",
                        "天气这么冷，不如…吃顿火锅？🍲",
                        "午安，愿这个冬天，有人与你立黄昏，有人问你粥可温。",
                        "冬日的午后短暂又珍贵，多晒晒太阳吧。",
                        "一杯热可可，一份好心情，送给这个下午的你。☕️",
                        "外面天寒地冻，还是待在室内最舒服了。",
                        "离天黑又近了一步，珍惜白天的时光。"
                    ],
                    evening: [
                        "晚上好，窗外天寒地冻，屋内温暖如春。",
                        "冬天最适合窝在沙发里，看一部温暖的电影。🎬",
                        "雪落下的声音，是冬夜的交响曲。",
                        "晚来天欲雪，能饮一杯无？",
                        "晚上好，回家路上注意保暖呀。",
                        "冬夜的灯火，看起来总是格外温暖。",
                        "忙了一天，窝在沙发里就是最大的幸福。",
                        "天冷了，今晚吃点热乎的吧！"
                    ],
                    night: [
                        "夜深了，钻进温暖的被窝，和世界说晚安。🛌",
                        "晚安，愿你一夜无梦，安睡到天亮。",
                        "冬天，是适合早睡的季节，晚安。",
                        "请查收你的冬日限定好梦。🌙",
                        "晚安，让温暖的被窝治愈你的一切。",
                        "听着窗外的风声，安稳地睡吧。",
                        "别熬夜了，对得起这么冷的天吗？快去睡觉！",
                        "晚安，愿你梦里阳光普照，春暖花开。"
                    ]
                },
                default: [ // 默认/备用问候语
                    "你好呀，今天过得怎么样？",
                    "愿你眼里的星星，永远闪亮。",
                    "无论天气如何，记得带上自己的阳光。",
                    "希望你今天也能开心！",
                    "嘿，陌生人，祝你今天开心。",
                    "生活或许不易，但请别忘了微笑。😊",
                    "每一天都是一份独一无二的礼物。",
                    "偷偷告诉你，你很棒！",
                    "愿你所到之处，皆为热土；愿你所遇之人，皆为良善。"
                ]
            };

            // 判断季节
            let season = 'default';
            if (month >= 3 && month <= 5) {
                season = 'spring';
            } else if (month >= 6 && month <= 8) {
                season = 'summer';
            } else if (month >= 9 && month <= 11) {
                season = 'autumn';
            } else { // 12, 1, 2月
                season = 'winter';
            }

            // 判断时间段
            let timeOfDay = 'night';
            if (hour >= 5 && hour < 12) {
                timeOfDay = 'morning';
            } else if (hour >= 12 && hour < 18) {
                timeOfDay = 'afternoon';
            } else if (hour >= 18 && hour < 22) {
                timeOfDay = 'evening';
            }

            // 获取对应的问候语列表
            const availableGreetings = greetings[season][timeOfDay] || greetings.default;
            
            // 随机选择一条问候语并显示
            const randomGreeting = availableGreetings[Math.floor(Math.random() * availableGreetings.length)];
            greetingEl.textContent = randomGreeting;
        }

        // --- [REFACTORED] 日历计算核心函数 ---
        function lYearDays(y) { let i, sum = 348; for (i = 0x8000; i > 0x8; i >>= 1) sum += (lunarInfo[y - 1900] & i) ? 1 : 0; return (sum + leapDays(y)); }
        function leapDays(y) { if (leapMonth(y)) return ((lunarInfo[y - 1900] & 0x10000) ? 30 : 29); else return (0); }
        function leapMonth(y) { return (lunarInfo[y - 1900] & 0xf); }
        function monthDays(y, m) { return ((lunarInfo[y - 1900] & (0x10000 >> m)) ? 30 : 29); }
        function Dianaday(objDate) {
            const msPerDay = 86400000; // 24 * 60 * 60 * 1000
            const utcTarget = Date.UTC(objDate.getFullYear(), objDate.getMonth(), objDate.getDate());
            const utcBase = Date.UTC(1900, 0, 31);
            var offset = (utcTarget - utcBase) / msPerDay;

            var i, leap = 0, temp = 0;
            this.dayCyl = offset + 40; this.monCyl = 14; for (i = 1900; i < 2050 && offset > 0; i++) { temp = lYearDays(i); offset -= temp; this.monCyl += 12; } if (offset < 0) { offset += temp; i--; this.monCyl -= 12; } this.year = i; this.yearCyl = i - 1864; leap = leapMonth(i); this.isLeap = false; for (i = 1; i < 13 && offset > 0; i++) { if (leap > 0 && i == (leap + 1) && this.isLeap == false) { --i; this.isLeap = true; temp = leapDays(this.year); } else { temp = monthDays(this.year, i); } if (this.isLeap == true && i == (leap + 1)) this.isLeap = false; offset -= temp; if (this.isLeap == false) this.monCyl++; } if (offset == 0 && leap > 0 && i == leap + 1) if (this.isLeap) { this.isLeap = false; } else { this.isLeap = true; --i; --this.monCyl; } if (offset < 0) { offset += temp; --i; --this.monCyl; } this.month = i; this.day = offset + 1;
        }
        
        // --- [NEW] 三伏天特定日期 ---
        // 由于三伏天计算复杂且与底层日历数据强相关，为保证准确性，此处使用预先查定的日期
        // 数据来源：公开的天文日历信息
        const sanfuData = {
            2023: { rufu: '07-11', zhongfu: '07-21', mofu: '08-10' },
            2024: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2025: { rufu: '07-20', zhongfu: '07-30', mofu: '08-09' },
            2026: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2027: { rufu: '07-15', zhongfu: '07-25', mofu: '08-14' },
            2028: { rufu: '07-19', zhongfu: '07-29', mofu: '08-08' },
            2029: { rufu: '07-14', zhongfu: '07-24', mofu: '08-13' },
            2030: { rufu: '07-19', zhongfu: '07-29', mofu: '08-08' },
        };

        function getSanfuDates(year) {
            const dates = sanfuData[year];
            if (!dates) return [];
            
            const rufuDateParts = dates.rufu.split('-');
            const zhongfuDateParts = dates.zhongfu.split('-');
            const mofuDateParts = dates.mofu.split('-');

            return [
                { name: '入伏', date: new Date(year, parseInt(rufuDateParts[0]) - 1, parseInt(rufuDateParts[1])) },
                { name: '中伏', date: new Date(year, parseInt(zhongfuDateParts[0]) - 1, parseInt(zhongfuDateParts[1])) },
                { name: '末伏', date: new Date(year, parseInt(mofuDateParts[0]) - 1, parseInt(mofuDateParts[1])) }
            ];
        }
        
        function getAllHolidaysForYear(year) {
            let allEvents = [];
            
            function getSolarDateForLunar(targetYear, lunarMonth, lunarDay) {
                for (let i = 0; i < 366; i++) {
                    const checkDate = new Date(targetYear, 0, 1);
                    checkDate.setDate(checkDate.getDate() + i);
                    if (checkDate.getFullYear() !== targetYear) break;
                    const lunarDateInfo = new Dianaday(checkDate);
                    if (lunarDateInfo.month === lunarMonth && lunarDateInfo.day === lunarDay && !lunarDateInfo.isLeap) return checkDate;
                }
                return null;
            }

            // 公历节日
            sFtv.forEach(holiday => {
                if (holiday.start && year < holiday.start) {
                    return;
                }
                const month = parseInt(holiday.date.substr(0, 2));
                const day = parseInt(holiday.date.substr(2, 2));
                allEvents.push({ name: holiday.name, date: new Date(year, month - 1, day) });
            });

            // 农历节日
            const allLunarHolidays = [...lFtv, { date: "1230", name: "除夕" }];
            allLunarHolidays.forEach(holiday => {
                const name = holiday.name;
                if (name === '除夕') {
                    // To find the New Year's Eve that falls within a given Gregorian year, we find the
                    // Spring Festival of that same year and calculate the day before it.
                    const cnyDate = getSolarDateForLunar(year, 1, 1);
                    if (cnyDate) {
                        let eveDate = new Date(cnyDate);
                        eveDate.setDate(eveDate.getDate() - 1);
                        // Only add it if the calculated Eve date actually falls in the target year.
                        if (eveDate.getFullYear() === year) {
                            allEvents.push({ name: '除夕', date: eveDate });
                        }
                    }
                } else {
                    const lMonth = parseInt(holiday.date.substr(0, 2));
                    const lDay = parseInt(holiday.date.substr(2, 2));
                    const holidayDate = getSolarDateForLunar(year, lMonth, lDay);
                    if (holidayDate) allEvents.push({ name: holiday.name, date: holidayDate });
                }
            });

            // 节气
            solarTerm.forEach((termName, i) => {
                const offDate = new Date((31556925974.7 * (year - 1900) + sTermInfo[i] * 60000) + Date.UTC(1900, 0, 6, 2, 5));
                allEvents.push({ name: termName, date: new Date(offDate.getUTCFullYear(), offDate.getUTCMonth(), offDate.getUTCDate()) });
            });

            // 周日计算的节日
            const mayFirst = new Date(year, 4, 1);
            const mothersDay = new Date(year, 4, 1 + (7 - mayFirst.getDay() + 7) % 7 + 7);
            allEvents.push({ name: '母亲节', date: mothersDay });

            const juneFirst = new Date(year, 5, 1);
            const fathersDay = new Date(year, 5, 1 + (7 - juneFirst.getDay() + 7) % 7 + 14);
            allEvents.push({ name: '父亲节', date: fathersDay });

            const novFirst = new Date(year, 10, 1);
            const thanksgivingDay = new Date(year, 10, 1 + (4 - novFirst.getDay() + 7) % 7 + 21);
            allEvents.push({ name: '感恩节', date: thanksgivingDay });
            
            // 添加三伏天
            const sanfuDates = getSanfuDates(year);
            allEvents.push(...sanfuDates);

            // 排序并返回
            return allEvents.sort((a, b) => a.date - b.date);
        }

        // --- 主倒计时卡片更新 ---
        function updateCountdown() {
            const countdownDisplay = document.getElementById('countdown-display');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const currentYearEvents = getAllHolidaysForYear(now.getFullYear());
            const nextYearEvents = getAllHolidaysForYear(now.getFullYear() + 1);

            const upcomingEvents = [...currentYearEvents, ...nextYearEvents].filter(event => event.date >= today);

            if (upcomingEvents.length > 0) {
                const nextHoliday = upcomingEvents[0];
                const diffTime = nextHoliday.date - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    countdownDisplay.innerHTML = `<span class="text-lg" style="color: var(--text-color-primary);">今天</span><br><strong class="text-3xl font-bold" style="color: var(--accent-color);">${nextHoliday.name}</strong>`;
                } else if (diffDays === 1) {
                    countdownDisplay.innerHTML = `<span class="text-lg" style="color: var(--text-color-primary);">明天</span><br><strong class="text-3xl font-bold" style="color: var(--accent-color);">${nextHoliday.name}</strong>`;
                } else {
                    countdownDisplay.innerHTML = `<span style="color: var(--text-color-primary);">距离</span><br><strong class="text-xl" style="color: var(--text-color-primary);">${nextHoliday.name}</strong><br><span class="font-bold text-5xl align-baseline">${diffDays}</span><span class="text-lg align-baseline ml-1">天</span>`;
                }
            } else {
                countdownDisplay.textContent = '所有节日都已计算完毕！';
            }
        }

        // --- 节日列表视图更新 ---
        function displayHolidayList(year, isAnimated = false) {
            const container = document.getElementById('holiday-list-container');
            const yearDisplay = document.getElementById('holiday-list-year');

            const updateContent = () => {
                yearDisplay.textContent = year;
            
                const allHolidays = getAllHolidaysForYear(year);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                const firstUpcoming = [...getAllHolidaysForYear(now.getFullYear()), ...getAllHolidaysForYear(now.getFullYear() + 1)]
                    .filter(e => e.date >= today)[0];

                const holidaysByMonth = allHolidays.reduce((acc, holiday) => {
                    const month = holiday.date.getMonth();
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(holiday);
                    return acc;
                }, {});

                let html = '';
                for (let month = 0; month < 12; month++) {
                    if (holidaysByMonth[month]) {
                        html += `<div class="mb-3"><h3 class="text-lg font-semibold border-b pb-1 mb-2" style="color: var(--text-color-secondary); border-color: var(--separator-color);">${month + 1}月</h3>`;
                        holidaysByMonth[month].forEach(holiday => {
                            const diffTime = holiday.date - today;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            let statusText = '';
                            if (holiday.date.getFullYear() < now.getFullYear() || (holiday.date.getFullYear() === now.getFullYear() && diffDays < -1)) {
                                statusText = `<span style="color: var(--status-past);">已过</span>`;
                            } else if (diffDays === -1) {
                                statusText = `<span style="color: var(--status-yesterday);">昨天</span>`;
                            } else if (diffDays === 0) {
                                statusText = `<span style="color: var(--status-today); font-weight: bold;">今天</span>`;
                            } else if (diffDays === 1) {
                                statusText = `<span style="color: var(--status-tomorrow); font-weight: bold;">明天</span>`;
                            } else {
                                statusText = `<span style="color: var(--accent-color);">${diffDays} 天</span>`;
                            }
                            
                            const isHighlighted = firstUpcoming && firstUpcoming.name === holiday.name && firstUpcoming.date.getTime() === holiday.date.getTime();
                            const highlightClass = isHighlighted ? 'highlight-holiday' : '';

                            html += `
                                <div class="flex justify-between items-center p-2 rounded-lg ${highlightClass}">
                                    <div>
                                        <span style="color: var(--text-color-primary);">${holiday.name}</span>
                                        <span class="text-xs ml-2" style="color: var(--text-color-secondary);">${String(holiday.date.getMonth() + 1).padStart(2, '0')}-${String(holiday.date.getDate()).padStart(2, '0')}</span>
                                    </div>
                                    ${statusText}
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                }
                container.innerHTML = html;
                // [NEW] Update button visibility after content is rendered
                setTimeout(updateTodayButtonVisibility, 50);
            };

            if (isAnimated) {
                container.style.opacity = 0;
                yearDisplay.style.opacity = 0;
                setTimeout(() => {
                    updateContent();
                    container.style.opacity = 1;
                    yearDisplay.style.opacity = 1;
                }, 100);
            } else {
                updateContent();
            }
        }

        // [NEW] Custom smooth scroll implementation for speed control
        function customSmoothScrollTo(targetElement, options) {
            const { duration = 300, block = 'center' } = options;
            // SimpleBar creates a specific wrapper for the scrollable content.
            const scrollContainer = document.getElementById('holiday-list-container-wrapper').querySelector('.simplebar-content-wrapper');

            if (!scrollContainer || !targetElement) return;

            let targetY;
            if (block === 'center') {
                targetY = targetElement.offsetTop + (targetElement.offsetHeight / 2) - (scrollContainer.offsetHeight / 2);
            } else if (block === 'start') {
                targetY = targetElement.offsetTop;
            } else { // 'end'
                targetY = targetElement.offsetTop + targetElement.offsetHeight - scrollContainer.offsetHeight;
            }
            
            // Ensure targetY is within scrollable bounds
            targetY = Math.max(0, Math.min(targetY, scrollContainer.scrollHeight - scrollContainer.clientHeight));

            const startY = scrollContainer.scrollTop;
            const distance = targetY - startY;
            let startTime = null;

            // easeInOutCubic easing function for a slightly smoother start/end
            function ease(t, b, c, d) {
                t /= d / 2;
                if (t < 1) return c / 2 * t * t * t + b;
                t -= 2;
                return c / 2 * (t * t * t + 2) + b;
            }

            function animation(currentTime) {
                if (startTime === null) startTime = currentTime;
                const timeElapsed = currentTime - startTime;
                const run = ease(timeElapsed, startY, distance, duration);
                scrollContainer.scrollTop = run;
                if (timeElapsed < duration) {
                    requestAnimationFrame(animation);
                }
            }

            requestAnimationFrame(animation);
        }

        // [NEW] Core function to scroll to the target festival
        const scrollToTargetFestival = (isAnimated = true) => {
            // Use a timeout to ensure the DOM has updated, e.g., after a year change
            setTimeout(() => {
                const container = document.getElementById('holiday-list-container');
                if (!container) return;

                let targetElement = container.querySelector('.highlight-holiday');

                // If no highlighted holiday in the current view (e.g., all passed for the year)
                if (!targetElement) {
                    // As per user request, find the last festival of the displayed year
                    const allHolidays = container.querySelectorAll('.flex.justify-between.items-center');
                    if (allHolidays.length > 0) {
                        targetElement = allHolidays[allHolidays.length - 1];
                    }
                }

                if (targetElement) {
                    if (isAnimated) {
                        customSmoothScrollTo(targetElement, { duration: 300, block: 'center' });
                    } else {
                        targetElement.scrollIntoView({ behavior: 'auto', block: 'center' });
                    }
                }
            }, 160); // Must be slightly longer than the list update animation (150ms)
        };

        // [NEW] Logic for the "Today" button's visibility
        let todayButtonObserver;
        function updateTodayButtonVisibility() {
            const backToTodayBtn = document.getElementById('back-to-today-btn');
            const currentYear = new Date().getFullYear();

            if (todayButtonObserver) {
                todayButtonObserver.disconnect();
            }

            if (holidayListDisplayedYear !== currentYear) {
                backToTodayBtn.classList.add('visible'); // Always show for other years
                return;
            }

            // Logic for the current year
            const container = document.getElementById('holiday-list-container');
            let targetElement = container.querySelector('.highlight-holiday');

            if (!targetElement) {
                const allHolidays = container.querySelectorAll('.flex.justify-between.items-center');
                if (allHolidays.length > 0) {
                    targetElement = allHolidays[allHolidays.length - 1];
                }
            }

            if (targetElement) {
                const scrollWrapper = document.getElementById('holiday-list-container-wrapper');
                todayButtonObserver = new IntersectionObserver((entries) => {
                    const [entry] = entries;
                    // Show button if target is NOT visible
                    if (entry.isIntersecting) {
                        backToTodayBtn.classList.remove('visible');
                    } else {
                        backToTodayBtn.classList.add('visible');
                    }
                }, {
                    root: scrollWrapper,
                    threshold: 0.5 // 50% of the element is visible
                });
                todayButtonObserver.observe(targetElement);
            } else {
                // No target element found, hide the button
                backToTodayBtn.classList.remove('visible');
            }
        }

        // --- Hitokoto 一言 功能 ---
        let isUpdatingQuote = false;
        async function fetchHitokoto() {
            if (isUpdatingQuote) return;
            isUpdatingQuote = true;
            const hitokotoText = document.getElementById('hitokoto-text');
            const hitokotoFrom = document.getElementById('hitokoto-from');
            hitokotoText.classList.add('opacity-0');
            hitokotoFrom.classList.add('opacity-0');
            try {
                await new Promise(resolve => setTimeout(resolve, 500));
                const response = await fetch('https://v1.hitokoto.cn/?encode=json');
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                hitokotoText.textContent = data.hitokoto;
                hitokotoFrom.textContent = `— 「${data.from || '未知来源'}」`;
            } catch (error) {
                console.error("获取一言失败:", error);
                hitokotoText.textContent = '获取一言失败，请稍后再试。';
                hitokotoFrom.textContent = '';
            } finally {
                hitokotoText.classList.remove('opacity-0');
                hitokotoFrom.classList.remove('opacity-0');
                setTimeout(() => { isUpdatingQuote = false; }, 600);
            }
        }

        // --- 时光胶囊功能 ---
        function updateTimeCapsule() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const dayOfMonth = now.getDate();
            const dayOfWeek = now.getDay(); // 0 for Sunday, 1 for Monday, etc.
            const hour = now.getHours();

            // 1. 今日进度
            const dayPassed = hour;
            const dayLeft = 24 - dayPassed;
            const dayPercent = (dayPassed / 24) * 100;
            document.getElementById('day-passed').textContent = dayPassed;
            document.getElementById('day-left').textContent = dayLeft;
            document.getElementById('day-percent').textContent = `${dayPercent.toFixed(1)}%`;
            document.getElementById('day-progress').style.width = `${dayPercent}%`;

            // 2. 本周进度 (周一为第一天)
            const weekPassed = dayOfWeek === 0 ? 7 : dayOfWeek;
            const weekLeft = 7 - weekPassed;
            const weekPercent = (weekPassed / 7) * 100;
            document.getElementById('week-passed').textContent = weekPassed;
            document.getElementById('week-left').textContent = weekLeft;
            document.getElementById('week-percent').textContent = `${weekPercent.toFixed(1)}%`;
            document.getElementById('week-progress').style.width = `${weekPercent}%`;

            // 3. 本月进度
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthPassed = dayOfMonth;
            const monthLeft = daysInMonth - monthPassed;
            const monthPercent = (monthPassed / daysInMonth) * 100;
            document.getElementById('month-passed').textContent = monthPassed;
            document.getElementById('month-left').textContent = monthLeft;
            document.getElementById('month-percent').textContent = `${monthPercent.toFixed(1)}%`;
            document.getElementById('month-progress').style.width = `${monthPercent}%`;

            // 4. 今年进度
            const startOfYear = new Date(year, 0, 1);
            const endOfYear = new Date(year, 11, 31);
            const totalDaysInYear = (endOfYear - startOfYear) / (1000 * 60 * 60 * 24) + 1;
            const yearPassed = Math.ceil((now - startOfYear) / (1000 * 60 * 60 * 24));
            const yearLeft = totalDaysInYear - yearPassed;
            const yearPercent = (yearPassed / totalDaysInYear) * 100;
            document.getElementById('year-passed').textContent = yearPassed;
            document.getElementById('year-left').textContent = yearLeft;
            document.getElementById('year-percent').textContent = `${yearPercent.toFixed(1)}%`;
            document.getElementById('year-progress').style.width = `${yearPercent}%`;
        }
        
        // --- 网站运行时间 ---
        function updateSiteRuntime() {
             const startTime = new Date('2025-07-30T18:30:00');
            const now = new Date();
            const diff = now - startTime;

            const displayElement = document.getElementById('site-runtime-display');
            if (!displayElement) return;

            if (diff < 0) {
                displayElement.textContent = '小破站尚未启航...';
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            displayElement.innerHTML = `小破站已经在风雨中度过了 <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${days}</span> 天 <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${hours}</span> 小时 <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${minutes}</span> 分 <span class="font-semibold runtime-number" style="color: var(--text-color-primary);">${seconds}</span> 秒`;
        }

        // --- GitHub Chart Loader Logic ---
        function setupGitHubChartLoader() {
            const loader = document.getElementById('gh-chart-loader');
            const errorContainer = document.getElementById('gh-chart-error');
            const errorMessage = document.getElementById('gh-chart-error-message');
            const imgLink = document.getElementById('gh-chart-link');
            const img = document.getElementById('gh-chart-img');

            const loadImage = () => {
                // Show loader, hide error
                loader.style.display = 'flex';
                errorContainer.classList.add('hidden');
                errorContainer.classList.remove('flex');

                const originalSrc = img.dataset.src;
                const baseUrl = originalSrc.split('?')[0];
                // Reconstruct URL to safely add cache-busting parameter
                img.src = `${baseUrl}?theme=dark&v=${new Date().getTime()}`;
            };

            img.onload = () => {
                loader.style.display = 'none';
                imgLink.classList.remove('invisible');
                imgLink.classList.add('visible');
                img.classList.add('loaded');
            };

            img.onerror = () => {
                loader.style.display = 'none';
                errorContainer.classList.remove('hidden');
                errorContainer.classList.add('flex');
                errorMessage.textContent = '贡献图加载失败，请检查网络并重试。';
            };

            errorContainer.addEventListener('click', () => {
                loadImage();
            });

            // Initial load
            loadImage();
        }


        // --- [NEW] Settings Management ---
        let appSettings = {
            background: {
                source: 'default',
                specifier: 'random'
            },
            theme: 'system', // 'system', 'light', 'dark'
            view: 'github',
            weather: {
                city: null, // User-overridden city
                lastFetchedCity: null // City from last successful fetch
            }
        };

        const WEATHER_TIPS = {
            sunny: ["阳光明媚，适合出门散步。", "天气晴朗，心情也跟着阳光起来！", "今天紫外线可能较强，注意防晒哦。"],
            rain: ["下雨了，出门别忘了带伞。", "雨天路滑，出行请注意安全。", "细雨蒙蒙，最适合听音乐、读本书。"],
            snow: ["下雪啦！注意保暖，小心地滑。", "瑞雪兆丰年，冬天快乐！", "雪天路况复杂，请谨慎驾驶。"],
            cloudy: ["虽然是多云，但也要保持好心情。", "云层稍厚，但偶尔也会有阳光。", "阴天，是适合思念和放空的天气。"],
            overcast: ["天空阴沉沉的，但别让它影响你的好心情。", "阴天，适合静下心来，享受宁静。", "今天可能看不到蓝天白云了，但有另一番景致。"],
            hot: ["天气炎热，注意防暑降温，多喝水。", "热浪来袭，尽量避免午后长时间户外活动。", "心静自然凉，但空调也许是更好的选择。"],
            cold: ["天气转冷，及时增添衣物，谨防感冒。", "寒风凛冽，喝杯热茶暖暖身子吧。", "冬天到啦，保暖是第一要务。"],
            windy: ["今天风有点大，出门戴好帽子，小心发型。", "风大的日子，适合在室内感受安逸。", "听，风在唱歌。"],
            fog: ["大雾弥漫，能见度低，出行注意安全。", "雾天开车，请减速慢行，保持车距。", "今天的世界，仿佛加了一层朦胧滤镜。"],
            default: ["愿你眼里的星星，永远闪亮。", "生活或许不易，但请别忘了微笑。😊", "每一天都是一份独一無二的礼物。"]
        };

        function getWeatherTip(current, forecast) {
            const tempC = parseInt(current.temp_C);
            const weatherDesc = current.weatherDesc[0].value.toLowerCase();
            const month = new Date().getMonth() + 1; // 1-12
            const isWinter = month === 12 || month === 1 || month === 2;

            if (tempC > 30) return WEATHER_TIPS.hot[Math.floor(Math.random() * WEATHER_TIPS.hot.length)];
            if (tempC < 5) return WEATHER_TIPS.cold[Math.floor(Math.random() * WEATHER_TIPS.cold.length)];

            if (weatherDesc.includes('rain') || weatherDesc.includes('shower')) return WEATHER_TIPS.rain[Math.floor(Math.random() * WEATHER_TIPS.rain.length)];
            if (weatherDesc.includes('snow') || weatherDesc.includes('sleet') || weatherDesc.includes('blizzard')) return WEATHER_TIPS.snow[Math.floor(Math.random() * WEATHER_TIPS.snow.length)];
            
            if ((weatherDesc.includes('sunny') || weatherDesc.includes('clear')) && !isWinter) {
                 return WEATHER_TIPS.sunny[Math.floor(Math.random() * WEATHER_TIPS.sunny.length)];
            } else if (weatherDesc.includes('sunny') || weatherDesc.includes('clear')) {
                return "冬日暖阳，难得的好天气！";
            }

            if (weatherDesc.includes('overcast')) return WEATHER_TIPS.overcast[Math.floor(Math.random() * WEATHER_TIPS.overcast.length)];
            if (weatherDesc.includes('cloudy') || weatherDesc.includes('mist')) return WEATHER_TIPS.cloudy[Math.floor(Math.random() * WEATHER_TIPS.cloudy.length)];
            if (parseInt(current.windspeedKmph) > 30) return WEATHER_TIPS.windy[Math.floor(Math.random() * WEATHER_TIPS.windy.length)];
            if (weatherDesc.includes('fog')) return WEATHER_TIPS.fog[Math.floor(Math.random() * WEATHER_TIPS.fog.length)];

            return WEATHER_TIPS.default[Math.floor(Math.random() * WEATHER_TIPS.default.length)];
        }


        // --- [NEW] Weather Fetching Logic ---
        async function fetchAndDisplayWeather() {
            const weatherWrapper = document.getElementById('weather-content-wrapper');
            weatherWrapper.innerHTML = `<p style="color: var(--text-color-secondary);">正在获取天气...</p>`;

            let location = appSettings.weather.city;

            if (!location) {
                try {
                    const ipResponse = await fetch('https://ipapi.co/json/');
                    if (!ipResponse.ok) throw new Error('IP API request failed');
                    const ipData = await ipResponse.json();
                    location = ipData.city || 'auto:ip';
                } catch (e) {
                    console.error("IP-based geolocation failed.", e);
                    weatherWrapper.innerHTML = `<p style="color: var(--accent-color);">无法自动确定您的位置</p><p class="text-xs mt-2" style="color: var(--text-color-tertiary);">请在设置中手动输入城市。</p>`;
                    return;
                }
            }

            try {
                const weatherResponse = await fetch(`https://wttr.in/${encodeURIComponent(location)}?format=j1`);
                if (!weatherResponse.ok) throw new Error(`Weather data not found for ${location}`);
                const data = await weatherResponse.json();
                
                const current = data.current_condition[0];
                const forecast = data.weather[0];
                const nearestArea = data.nearest_area[0];
                
                appSettings.weather.lastFetchedCity = `${nearestArea.areaName[0].value}, ${nearestArea.country[0].value}`;
                saveSettings();
                
                const tip = getWeatherTip(current, forecast);

                // --- Render HTML ---
                weatherWrapper.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-2xl font-bold" style="color: var(--text-color-primary);">${current.temp_C}°C</p>
                            <p class="text-sm" style="color: var(--text-color-secondary);">${current.weatherDesc[0].value}, 体感 ${current.FeelsLikeC}°C</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold" style="color: var(--text-color-primary);">${nearestArea.areaName[0].value}</p>
                            <p class="text-xs" style="color: var(--text-color-secondary);">${nearestArea.country[0].value}</p>
                        </div>
                    </div>
                    <div class="mt-4 text-sm space-y-2">
                        <div class="flex justify-between">
                            <span style="color: var(--text-color-secondary);">最高/最低</span>
                            <span style="color: var(--text-color-primary);">${forecast.maxtempC}°C / ${forecast.mintempC}°C</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-color-secondary);">风速</span>
                            <span style="color: var(--text-color-primary);">${current.windspeedKmph} km/h</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-color-secondary);">湿度</span>
                            <span style="color: var(--text-color-primary);">${current.humidity}%</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 text-center text-xs" style="border-top: 1px solid var(--separator-color); color: var(--text-color-tertiary);">
                        ${tip}
                    </div>
                `;
                
                updateSettingsUI(); // Update UI with new city name if it was auto-detected
            } catch (e) {
                console.error("Failed to fetch weather data.", e);
                weatherWrapper.innerHTML = `<p style="color: var(--accent-color);">无法加载 "${location}" 的天气信息。</p><p class="text-xs mt-2" style="color: var(--text-color-tertiary);">请检查城市名称或网络连接。</p>`;
                appSettings.weather.lastFetchedCity = '加载失败';
                updateSettingsUI();
            }
        }


        function saveSettings() {
            localStorage.setItem('qing-homepage-settings', JSON.stringify(appSettings));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('qing-homepage-settings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Merge saved settings with defaults to ensure compatibility with future updates
                    appSettings = {
                        ...appSettings,
                        ...parsedSettings,
                        background: { ...appSettings.background, ...parsedSettings.background },
                    };
                } catch (e) {
                    console.error("Failed to parse settings from localStorage", e);
                    // If parsing fails, use default settings
                }
            }
        }
        
        let currentBgUrl = ''; // Holds the resolved URL of the current background
        let currentImageBlob = null; // Holds the raw image data for original-quality download
        let currentImageExtension = 'jpg'; // Holds the file extension for the blob

        // --- [NEW] Download Image Helper ---
        function downloadImage() {
            const downloadBtn = document.getElementById('bg-preview-download-btn');
            if (!downloadBtn) return;
            
            const originalIcon = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const restoreIcon = () => {
                downloadBtn.innerHTML = originalIcon;
            };

            // Prioritize downloading the original blob if it exists
            if (currentImageBlob) {
                try {
                    const objectUrl = URL.createObjectURL(currentImageBlob);
                    const a = document.createElement('a');
                    a.href = objectUrl;
                    a.download = `background-${Date.now()}.${currentImageExtension}`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(objectUrl);
                    setTimeout(restoreIcon, 100);
                } catch (error) {
                    console.error('Blob download failed:', error);
                    if (currentBgUrl) window.open(currentBgUrl, '_blank');
                    restoreIcon();
                }
            } else {
                // Fallback to canvas method for static images or if blob capture failed
                console.warn("No image blob available, falling back to canvas download.");
                try {
                    const img = document.getElementById('bg-preview-img');
                    if (!img || !img.src || !img.complete || img.naturalWidth === 0) {
                        throw new Error('Preview image is not available or ready for canvas download.');
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob((blob) => {
                        if (!blob) throw new Error('Canvas toBlob returned null.');
                        const objectUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = objectUrl;
                        a.download = `background-${Date.now()}.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(objectUrl);
                        restoreIcon();
                    }, 'image/png');
                } catch (error) {
                    console.error('Canvas download fallback failed:', error);
                    if (currentBgUrl) window.open(currentBgUrl, '_blank');
                    restoreIcon();
                }
            }
        }

        const showPreview = (displayUrl, originalUrl) => {
            const requestId = ++latestPreviewRequestId;
            const previewImg = document.getElementById('bg-preview-img');
            const loader = document.getElementById('preview-loader');
            const downloadBtn = document.getElementById('bg-preview-download-btn');
            const refreshBtn = document.getElementById('bg-preview-refresh-btn');

            if (!previewImg || !loader) return;

            // --- [NEW] Stop loading indicators ---
            previewImg.classList.remove('breathing-effect');
            loader.classList.remove('visible');
            
            // Ensure action buttons are visible
            downloadBtn.classList.add('visible');
            refreshBtn.classList.add('visible');

            currentBgUrl = originalUrl; // Store the original URL for the download fallback.

            // --- [NEW] Implement Fade-out, then Fade-in animation ---
            const preloader = new Image();
            preloader.src = displayUrl;

            preloader.onload = () => {
                if (requestId !== latestPreviewRequestId) return; // Ignore outdated request

                // 1. Set transition time and fade out
                previewImg.style.transition = 'opacity 0.2s ease-in-out';
                previewImg.style.opacity = 0;

                // 2. After fade-out, change src and fade back in
                setTimeout(() => {
                    previewImg.src = preloader.src;
                    previewImg.style.opacity = 1;
                }, 200); // Wait for fade-out to complete
            };

            preloader.onerror = () => {
                if (requestId !== latestPreviewRequestId) return;
                console.error(`Preview image failed to load: ${displayUrl}`);
                // If new image fails, just stop loading and show the old image
                previewImg.style.opacity = 1; 
            };
        };

        async function applyCurrentBackground() {
            const requestId = ++latestBgRequestId;
            const { source, specifier } = appSettings.background;

            const stopSpinner = () => {
                const refreshBtn = document.getElementById('bg-preview-refresh-btn');
                if (refreshBtn) {
                    const icon = refreshBtn.querySelector('i');
                    if (icon) icon.classList.remove('fa-spin');
                }
            };

            const hidePreview = () => {
                const container = document.getElementById('background-preview-container');
                const previewImg = document.getElementById('bg-preview-img');
                const loader = document.getElementById('preview-loader');

                if (container) container.classList.remove('visible');
                if (previewImg) previewImg.classList.remove('breathing-effect');
                if (loader) loader.classList.remove('visible');
            };
            
            const handleError = (error, source) => {
                if (requestId !== latestBgRequestId) return; // Ignore error from outdated request
                console.error(`Error fetching background from source: ${source}`, error);
                stopSpinner();
                const randomFallbackUrl = DEFAULT_BG_IMAGES[Math.floor(Math.random() * DEFAULT_BG_IMAGES.length)];
                backgroundFader.update(randomFallbackUrl, true);
                hidePreview();
            };

            try {
                const isDynamicSource = ['bing', 'anime', 'random'].includes(source);
                
                // --- [NEW] Immediate UI feedback for dynamic sources ---
                if (isDynamicSource) {
                    const container = document.getElementById('background-preview-container');
                    const previewImg = document.getElementById('bg-preview-img');
                    const loader = document.getElementById('preview-loader');

                    if (container && previewImg && loader) {
                        // Ensure the container is visible to show the loading state
                        if (!container.classList.contains('visible')) {
                             container.classList.add('visible');
                        }
                        previewImg.classList.add('breathing-effect');
                        loader.classList.add('visible');
                    }
                }

                let finalUrl; // The original URL of the image
                let displayUrl; // The URL to be used for display (object URL for dynamic, same as finalUrl for static)

                if (!isDynamicSource) {
                    hidePreview();
                    finalUrl = (specifier && specifier !== 'random' && DEFAULT_BG_IMAGES.includes(specifier))
                        ? specifier
                        : DEFAULT_BG_IMAGES[Math.floor(Math.random() * DEFAULT_BG_IMAGES.length)];
                    displayUrl = finalUrl;
                } else {
                    // Step 1: Get the original dynamic URL
                    if (source === 'bing') {
                        const bingApiResponse = await fetch('https://cors.eu.org/https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=zh-CN');
                        if (!bingApiResponse.ok) throw new Error('Bing API request failed');
                        const bingData = await bingApiResponse.json();
                        finalUrl = `https://www.bing.com${bingData.images[0].urlbase}_1920x1080.jpg`;
                    } else { // anime or random
                        const apiUrl = source === 'anime' 
                            ? 'https://api.sretna.cn/api/anime.php' 
                            : 'https://imgapi.cn/api.php?zd=zsy&fl=fengjing&gs=images';
                        finalUrl = `${apiUrl}?v=${new Date().getTime()}`;
                    }

                    // Step 2: Fetch the image data through the proxy, get a blob, and create an object URL
                    const imageResponse = await fetch(`https://cors.eu.org/${finalUrl}`);
                    if (!imageResponse.ok) throw new Error(`Failed to fetch image from proxy: ${finalUrl}`);
                    
                    const imageBlob = await imageResponse.blob();
                    currentImageBlob = imageBlob; // Store the blob globally for download
                    const contentType = imageResponse.headers.get('content-type');
                    const mimeToExt = {
                        'image/jpeg': 'jpg',
                        'image/png': 'png',
                        'image/gif': 'gif',
                        'image/bmp': 'bmp',
                        'image/webp': 'webp'
                    };
                    currentImageExtension = mimeToExt[contentType] || 'jpg'; // Store the extension

                    displayUrl = URL.createObjectURL(imageBlob);
                }

                if (requestId !== latestBgRequestId) {
                    if (displayUrl.startsWith('blob:')) URL.revokeObjectURL(displayUrl);
                    return; // Outdated request, abort.
                }

                // Step 3: Use the urls to update the UI
                if (isDynamicSource) {
                    showPreview(displayUrl, finalUrl); // Pass both URLs to showPreview
                }
                await backgroundFader.update(displayUrl, true);
                
                stopSpinner();

            } catch (error) {
                handleError(error, source);
            }
        }

        function updateBgSettingsUI() {
            const { source, specifier } = appSettings.background;

            // Update radio buttons
            const radio = document.querySelector(`input[name="background-source"][value="${source}"]`);
            if (radio) {
                radio.checked = true;
            }

            // Update thumbnail selection
            const defaultOptionsContainer = document.getElementById('default-bg-options');
            const allThumbs = defaultOptionsContainer.querySelectorAll('.thumb-item');
            allThumbs.forEach(thumb => thumb.classList.remove('active'));
            
            const activeThumb = defaultOptionsContainer.querySelector(`.thumb-item[data-bg-url="${specifier}"]`);
            if (activeThumb) {
                activeThumb.classList.add('active');
            }

            // Show/hide thumbnail section
            if (source === 'default') {
                defaultOptionsContainer.classList.add('open');
            } else {
                defaultOptionsContainer.classList.remove('open');
            }
        }

        function updateThemeSettingsUI() {
            const currentTheme = appSettings.theme;
            document.querySelectorAll('.setting-btn-group .setting-btn').forEach(btn => {
                if (btn.dataset.theme === currentTheme) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // --- [NEW] Settings Panel UI Generation ---
        function setupSettingsUI() {
            // --- 1. Background Settings ---
            const bgSettingsContainer = document.getElementById('background-settings-content');
            if (bgSettingsContainer) {
                const bgOptions = [
                    { value: 'default', label: '默认图片' },
                    { value: 'bing', label: '每日一Bing' },
                    { value: 'anime', label: '随机动漫' },
                    { value: 'random', label: '随机图片' }
                ];

                let bgSettingsHTML = '';
                bgOptions.forEach(option => {
                    bgSettingsHTML += `
                        <div>
                            <input type="radio" id="bg-radio-${option.value}" name="background-source" value="${option.value}" class="setting-radio-input">
                            <label for="bg-radio-${option.value}" class="setting-radio-label">
                                <span class="custom-radio-button"></span>
                                <span>${option.label}</span>
                            </label>
                        </div>
                    `;
                });
                
                let defaultOptionsHTML = `
                    <div id="default-bg-options">
                        <div class="thumb-container">
                            <div class="thumb-item" data-bg-url="random">
                                <div class="thumb-overlay">随机</div>
                            </div>
                `;
                DEFAULT_BG_IMAGES.forEach((url, index) => {
                    defaultOptionsHTML += `
                        <div class="thumb-item" data-bg-url="${url}">
                            <img src="${url}" alt="Default Background ${index + 1}" loading="lazy">
                        </div>
                    `;
                });
                defaultOptionsHTML += `</div></div>`;

                bgSettingsContainer.innerHTML = bgSettingsHTML + defaultOptionsHTML;

                // --- [NEW] Add background preview area ---
                const previewHTML = `
                    <div id="background-preview-container">
                        <div id="bg-preview-wrapper" class="relative w-full aspect-[16/9] rounded-lg overflow-hidden bg-white/5 transition-all duration-300 ease-in-out">
                            <img id="bg-preview-img" src="${DEFAULT_BG_IMAGES[0]}" alt="背景预览" class="w-full h-full object-cover" crossorigin="anonymous">
                            <div id="preview-loader"></div>
                            <a id="bg-preview-download-btn" href="#" download="background.jpg" title="保存该图片" class="absolute bottom-2 right-2 w-9 h-9 rounded-full bg-black/40 text-white flex items-center justify-center hover:bg-black/60 transition-all scale-0 duration-300">
                                <i class="fas fa-download"></i>
                            </a>
                            <button id="bg-preview-refresh-btn" title="换一张" class="absolute bottom-2 right-12 w-9 h-9 rounded-full bg-black/40 text-white flex items-center justify-center hover:bg-black/60 transition-all scale-0 duration-300">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                bgSettingsContainer.insertAdjacentHTML('beforeend', previewHTML);
            }

            // --- 2. Theme Mode Settings ---
            const themeSettingsContainer = document.getElementById('theme-settings-content').parentElement;
            if (themeSettingsContainer) {
                themeSettingsContainer.querySelector('h3').textContent = '主题模式';
                const container = themeSettingsContainer.querySelector('#theme-settings-content');
                container.innerHTML = `
                    <div class="setting-btn-group w-full">
                        <button class="setting-btn" data-theme="system">跟随系统</button>
                        <button class="setting-btn" data-theme="light">日间模式</button>
                        <button class="setting-btn" data-theme="dark">夜间模式</button>
                    </div>
                `;
            }

            // --- 3. View Toggle Settings ---
            const viewToggleContainer = document.getElementById('view-toggle-content');
            if (viewToggleContainer) {
                viewToggleContainer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="font-medium">是否切换GitHub贡献图为天气信息</span>
                            <span id="view-toggle-label" class="text-sm mt-1" style="color: var(--text-color-secondary);">当前显示: GitHub 贡献图</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="view-toggle-checkbox">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="manual-city-input-wrapper" class="mt-2 pl-1" style="max-height: 0; overflow: hidden; transition: all 0.3s ease;">
                         <input type="text" id="weather-city-input" placeholder="手动输入城市 (回车确认)" class="w-full rounded-md border px-3 py-1.5 text-sm" style="background-color: var(--progress-bar-bg); border-color: var(--separator-color); color: var(--text-color-primary);">
                    </div>
                `;
            }
        }

        function updateViewToggleUI() {
            const toggle = document.getElementById('view-toggle-checkbox');
            const label = document.getElementById('view-toggle-label');
            const cityInputWrapper = document.getElementById('manual-city-input-wrapper');
            const cityInput = document.getElementById('weather-city-input');

            const isWeatherView = appSettings.view === 'weather';
            toggle.checked = isWeatherView;
            label.textContent = isWeatherView ? '当前显示: 天气信息' : '当前显示: GitHub 贡献图';
            
            cityInputWrapper.style.maxHeight = isWeatherView ? '50px' : '0';
            cityInputWrapper.style.marginTop = isWeatherView ? '0.5rem' : '0';

            if (isWeatherView) {
                cityInput.placeholder = appSettings.weather.city || appSettings.weather.lastFetchedCity || '手动输入城市';
            }
        }

        function updateSettingsUI() {
            updateBgSettingsUI();
            updateThemeSettingsUI();
            updateViewToggleUI();
        }

        // --- [NEW] View (GitHub/Weather) Management ---
        function applyCurrentView() {
            const githubView = document.getElementById('github-view');
            const weatherView = document.getElementById('weather-view');
            
            if (appSettings.view === 'weather') {
                githubView.classList.add('hidden');
                weatherView.classList.remove('hidden');
                fetchAndDisplayWeather();
            } else {
                weatherView.classList.add('hidden');
                githubView.classList.remove('hidden');
            }
        }

        function applyCurrentTheme() {
            const body = document.body;
            // Clear all theme-* classes before adding the new one
            body.classList.forEach(className => {
                if (className.startsWith('theme-')) {
                    body.classList.remove(className);
                }
            });

            let themeToApply;
            if (appSettings.theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                themeToApply = prefersDark ? 'theme-dark' : 'theme-light';
            } else {
                themeToApply = `theme-${appSettings.theme}`;
            }
            body.classList.add(themeToApply);
        }

        // --- 交互事件监听 ---
        function setupEventListeners() {
            // --- Theme Settings Listeners ---
            document.querySelectorAll('.setting-btn-group .setting-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    appSettings.theme = theme;
                    applyCurrentTheme();
                    saveSettings();
                    updateThemeSettingsUI(); // Update active state
                });
            });

            // --- Background Settings Listeners ---
            const bgRadioButtons = document.querySelectorAll('input[name="background-source"]');
            const defaultOptionsContainer = document.getElementById('default-bg-options');

            bgRadioButtons.forEach(radio => {
                radio.addEventListener('change', () => {
                    const source = radio.value;
                    appSettings.background.source = source;

                    if (source === 'default') {
                        defaultOptionsContainer.classList.add('open');
                        // When switching to default, immediately apply the currently selected default image
                        applyCurrentBackground();
                    } else {
                        defaultOptionsContainer.classList.remove('open');
                        applyCurrentBackground();
                    }
                    saveSettings();
                });
            });

            const thumbItems = defaultOptionsContainer.querySelectorAll('.thumb-item');
            thumbItems.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    // This listener only matters when the 'default' source is active
                    if (appSettings.background.source !== 'default') {
                        // To be safe, check the 'default' radio
                        document.getElementById('bg-radio-default').checked = true;
                        appSettings.background.source = 'default';
                    }
                    
                    const specifier = thumb.dataset.bgUrl;
                    appSettings.background.specifier = specifier;
                    
                    // Update UI immediately for responsiveness
                    thumbItems.forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                    
                    applyCurrentBackground();
                    saveSettings();
                });
            });

            // --- [NEW] Preview Buttons Listeners ---
            const refreshBtn = document.getElementById('bg-preview-refresh-btn');
            const downloadBtn = document.getElementById('bg-preview-download-btn');

            if (refreshBtn) {
                refreshBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    if (icon && !icon.classList.contains('fa-spin')) {
                        icon.classList.add('fa-spin');
                        applyCurrentBackground();
                    }
                });
            }

            if (downloadBtn) {
                downloadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    downloadImage(); // Call the new function without arguments
                });
            }


            // --- View Toggle Listeners ---
            const viewToggle = document.getElementById('view-toggle-checkbox');
            const cityInput = document.getElementById('weather-city-input');

            viewToggle.addEventListener('change', () => {
                appSettings.view = viewToggle.checked ? 'weather' : 'github';
                applyCurrentView();
                updateViewToggleUI();
                saveSettings();
            });

            cityInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const newCity = e.target.value.trim();
                    if (newCity) {
                        appSettings.weather.city = newCity;
                        fetchAndDisplayWeather(); // Re-fetch with new city
                        e.target.blur();
                        e.target.value = ''; // Clear input after submission
                    }
                }
            });


            // --- Settings Modal Logic ---
            const openSettingsBtn = document.getElementById('open-settings-btn');
            const settingsOverlay = document.getElementById('settings-overlay');
            const closeSettingsBtn = document.getElementById('close-settings-btn');

            function openSettings() {
                const settingsWindow = document.getElementById('settings-window');
                
                // Use the cached height on larger screens
                if (window.innerWidth >= 1024 && cachedRightColumnHeight > 0) {
                    settingsWindow.style.height = `${cachedRightColumnHeight}px`;
                } else {
                    // On smaller screens, reset to auto height to remain responsive
                    settingsWindow.style.height = 'auto';
                }

                document.body.classList.add('settings-open');

                // Initialize SimpleBar on the content area if it hasn't been already
                if (!settingsSimpleBar) {
                    const contentWrapper = settingsWindow.querySelector('[data-simplebar]');
                    if (contentWrapper) {
                        settingsSimpleBar = new SimpleBar(contentWrapper);
                    }
                }
            }

            function closeSettings() {
                document.body.classList.remove('settings-open');
            }

            openSettingsBtn.addEventListener('click', openSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);

            settingsOverlay.addEventListener('click', (e) => {
                if (e.target === settingsOverlay) {
                    closeSettings();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.body.classList.contains('settings-open')) {
                    closeSettings();
                }
            });
            // --- End Settings Modal Logic ---

            const animateRightColumnIn = () => {
                const elementsToAnimate = rightColumn.querySelectorAll(':scope > div');
                elementsToAnimate.forEach(el => {
                    el.classList.remove('bounce-in');
                    void el.offsetWidth;
                    el.classList.add('bounce-in');
                });
            };

            // 切换到时光胶囊
            profileCard.addEventListener('click', (e) => { // 1. 接收 event 对象，命名为 e
                // 2. 增加判断：如果点击的目标是 <a> 标签或其内部元素，则直接返回
                if (e.target.closest('a')) {
                    return;
                }

                // If the time capsule is already visible, hide it and show the main column.
                if (!timeCapsuleCard.classList.contains('hidden')) {
                    timeCapsuleCard.classList.add('hidden');
                    rightColumn.classList.remove('hidden');
                    animateRightColumnIn();
                } else { // Otherwise, show it.
                    rightColumn.classList.add('hidden');
                    holidayListCard.classList.add('hidden');
                    timeCapsuleCard.classList.remove('hidden');
                    timeCapsuleCard.classList.add('bounce-in');
                    updateTimeCapsule();
                }
            });

            // 关闭时光胶囊
            document.getElementById('close-time-capsule').addEventListener('click', (e) => {
                e.stopPropagation();
                timeCapsuleCard.classList.add('hidden');
                rightColumn.classList.remove('hidden');
                animateRightColumnIn();
            });

            // 切换到节日列表
            countdownCard.addEventListener('click', () => {
                if (!holidayListCard.classList.contains('hidden')) {
                    holidayListCard.classList.add('hidden');
                    rightColumn.classList.remove('hidden');
                    animateRightColumnIn();
                } else {
                    hasManuallyScrolled = false; // Reset scroll flag
                    rightColumn.classList.add('hidden');
                    timeCapsuleCard.classList.add('hidden');
                    holidayListCard.classList.remove('hidden');
                    holidayListCard.classList.add('bounce-in');
                    holidayListDisplayedYear = new Date().getFullYear();
                    displayHolidayList(holidayListDisplayedYear, true);
                    updateWarningMessage(holidayListDisplayedYear);
                    
                    // Only initialize SimpleBar and listeners once to prevent bugs
                    if (!holidayListSimpleBar) {
                        holidayListSimpleBar = new SimpleBar(document.getElementById('holiday-list-container-wrapper'));
                        const scrollElement = holidayListSimpleBar.getScrollElement();
                        const maskContainer = document.getElementById('holiday-list-container-wrapper');
                        const maxFadeSize = 40;

                        const updateMask = () => {
                            const { scrollTop, scrollHeight, clientHeight } = scrollElement;
                            const tolerance = 1;
                            if (scrollHeight <= clientHeight + tolerance) {
                                maskContainer.style.setProperty('--fade-top-size', '0px');
                                maskContainer.style.setProperty('--fade-bottom-size', '0px');
                                return;
                            }
                            const scrollBottom = scrollHeight - clientHeight - scrollTop;
                            const topFade = Math.min(scrollTop, maxFadeSize);
                            const bottomFade = Math.min(scrollBottom, maxFadeSize);
                            maskContainer.style.setProperty('--fade-top-size', `${topFade}px`);
                            maskContainer.style.setProperty('--fade-bottom-size', `${bottomFade}px`);
                        };

                        scrollElement.addEventListener('scroll', updateMask);
                        
                        // Also handle the original manual scroll flag listener
                        scrollElement.addEventListener('scroll', () => {
                            hasManuallyScrolled = true;
                        }, { once: true });

                        // Call once after a short delay to ensure layout is calculated correctly
                        setTimeout(updateMask, 50);
                    }

                    // Initial scroll is now animated
                    setTimeout(() => {
                        scrollToTargetFestival(true);
                    }, 50);
                }
            });

            // 关闭节日列表
            document.getElementById('close-holiday-list').addEventListener('click', (e) => {
                e.stopPropagation();
                holidayListCard.classList.add('hidden');
                rightColumn.classList.remove('hidden');
                animateRightColumnIn();
            });

            // "回到今天"按钮逻辑
            document.getElementById('back-to-today-btn').addEventListener('click', () => {
                const currentYear = new Date().getFullYear();
                if (holidayListDisplayedYear !== currentYear) {
                    handleYearChange(currentYear);
                }
                scrollToTargetFestival(true);
            });

            // [NEW] Warning message logic
            const updateWarningMessage = (year) => {
                const yearWarning = document.getElementById('year-range-warning');
                if (year < 1900 || year > 2049) {
                    yearWarning.innerHTML = `<svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span>${year}年的农历节日可能不准确</span>`;
                    if (yearWarning.classList.contains('hidden')) {
                        yearWarning.classList.remove('hidden', 'animate-fade-out');
                        yearWarning.classList.add('animate-fade-in');
                        setTimeout(() => yearWarning.classList.remove('animate-fade-in'), 100);
                    }
                } else {
                    if (!yearWarning.classList.contains('hidden')) {
                        yearWarning.classList.add('animate-fade-out');
                        setTimeout(() => {
                            yearWarning.classList.add('hidden');
                            yearWarning.classList.remove('animate-fade-out');
                        }, 100);
                    }
                }
            };

            // 节日列表年份切换
            const handleYearChange = (newYear) => {
                const yearBeforeChange = holidayListDisplayedYear;
                const currentSystemYear = new Date().getFullYear();
                
                holidayListDisplayedYear = newYear;
                displayHolidayList(holidayListDisplayedYear, true);
                updateWarningMessage(newYear); // Centralized call to handle warning

                // Check for smart scroll condition
                if (hasManuallyScrolled && holidayListDisplayedYear === currentSystemYear && yearBeforeChange !== currentSystemYear) {
                    scrollToTargetFestival(true);
                    hasManuallyScrolled = false; // Reset flag after use
                }
            };

            document.getElementById('prev-year').addEventListener('click', () => {
                handleYearChange(holidayListDisplayedYear - 1);
            });
            document.getElementById('next-year').addEventListener('click', () => {
                handleYearChange(holidayListDisplayedYear + 1);
            });

            // --- [NEW] Year Input Logic ---
            const enterEditMode = () => {
                yearDisplayControls.classList.add('animate-fade-out');
                setTimeout(() => {
                    yearDisplayControls.classList.add('hidden');
                    yearDisplayControls.classList.remove('animate-fade-out');

                    yearEditControls.classList.remove('hidden');
                    yearEditControls.classList.add('animate-fade-in');
                    yearInput.value = holidayListDisplayedYear;
                    yearInput.focus();
                    yearInput.select();

                    setTimeout(() => {
                        yearEditControls.classList.remove('animate-fade-in');
                    }, 100);
                }, 100);
            };

            const exitEditMode = () => {
                yearInput.classList.remove('invalid');
                yearInputError.classList.add('hidden');

                yearEditControls.classList.add('animate-fade-out');
                setTimeout(() => {
                    yearEditControls.classList.add('hidden');
                    yearEditControls.classList.remove('animate-fade-out');

                    yearDisplayControls.classList.remove('hidden');
                    yearDisplayControls.classList.add('animate-fade-in');
                    setTimeout(() => {
                        yearDisplayControls.classList.remove('animate-fade-in');
                    }, 100);
                }, 100);
            };

            const submitNewYear = () => {
                const newYear = parseInt(yearInput.value, 10);
                // Relaxed validation as per user request.
                if (!isNaN(newYear) && newYear > 0 && newYear < 9999) {
                    handleYearChange(newYear);
                    exitEditMode();
                } else {
                    yearInputError.textContent = '请输入有效的4位年份';
                    yearInputError.classList.remove('hidden');
                    yearInput.classList.add('invalid');
                    setTimeout(() => {
                        yearInput.classList.remove('invalid');
                    }, 500);
                    setTimeout(() => {
                         yearInputError.classList.add('hidden');
                    }, 2500);
                }
            };

            holidayListYearSpan.addEventListener('click', enterEditMode);
            confirmYearBtn.addEventListener('click', submitNewYear);
            cancelYearBtn.addEventListener('click', exitEditMode);
            yearInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { submitNewYear(); }
                else if (e.key === 'Escape') { exitEditMode(); }
            });

            // 点击一言卡片刷新
            document.getElementById('hitokoto-card').addEventListener('click', fetchHitokoto);
        }

        // --- 页面加载时执行的函数 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            // Initialize Faders
            const bgLayers = document.querySelectorAll('#bg-wrapper .bg-layer');
            backgroundFader = createCrossfader(Array.from(bgLayers));

            // --- [FIX] Correct Initialization Order ---
            // 1. Build the settings panel UI first, so other functions can find its elements.
            setupSettingsUI();
            setupEventListeners();
            
            // 2. Now apply all settings, which will correctly update the newly created UI.
            applyCurrentTheme();
            applyCurrentBackground();
            applyCurrentView();
            updateSettingsUI();

            // 3. Initial data fetches and updates.
            updateTime();
            updateGreeting();
            updateCountdown();
            fetchHitokoto();
            setupGitHubChartLoader();
            updateSiteRuntime();
            updateTimeCapsule();
            
            // 4. Defer non-critical layout calculations.
            setTimeout(() => {
                if (window.innerWidth >= 1024) {
                    cachedRightColumnHeight = rightColumn.offsetHeight;
                }
            }, 100);
            
            setInterval(updateTime, 1000);
            setInterval(updateSiteRuntime, 1000);
            setInterval(updateGreeting, 1800000); 
            setInterval(updateCountdown, 3600000); 
            setInterval(updateTimeCapsule, 60000);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (appSettings.theme === 'system') {
                    applyCurrentTheme();
                }
            });
        });
    </script>
</body>
</html>
